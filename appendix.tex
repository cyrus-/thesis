% !TEX root = omar-thesis.tex
\part{Appendix}

\appendix
\chapter{Conventions}
\section{Typographic Conventions}\label{appendix:typographic-conventions}
We adopt \emph{PFPL}'s typographic conventions for operational forms throughout the paper. For example, consider the operational form for injections into a labeled sum type:
\[... 
\]
In particular, the names of operators and indexed families of operators are written in $\texttt{typewriter font}$, indexed families of operators specify non-symbolic indices within $[\text{mathematical braces}]$ and symbolic indices within \texttt{[}textual braces\texttt{]}, and term arguments are grouped arbitrarily (roughly, by sort) using \texttt{\{}textual curly braces\texttt{\}} and \texttt{(}textual rounded braces\texttt{)} \cite{pfpl}. \todo{do we actually use symbols anymore?}

Moreover, we write $\mapschema{\tau}{i}{\labelset}$ for a sequence of arguments $\tau_i$, one for each $i\in \labelset$, and similarly for arguments of other valences. Operations  that are parameterized by label sets, e.g. $\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$, are identified up to mutual reordering of the label set and the corresponding argument sequence. 

We write $\seqschemaX{r}$ for sequences of $n \geq 0$ rule arguments and $p.e$ for expressions binding the variables that appear in the pattern $p$.


Empty finite sets are written $\emptyset$, or omitted entirely within judgements, and non-empty finite sets are written as comma-separated finite sequences identified up to exchange and contraction. 

Empty typing contexts are written $\emptyset$, or omitted entirely within judgements, and non-empty typing contexts are written as finite sequences of hypotheses identified up to exchange and contraction. 


\section{Judgemental Conventions}\label{appendix:judgemental-conventions}

\chapter{\texorpdfstring{$\miniVerseUE$ and $\miniVersePat$}{miniVerseSE and miniVerseS}}\label{appendix:miniVerseSES}

This section defines $\miniVersePat$, the language of Chapter \ref{chap:uptsms}. The language of Chapter \ref{chap:uetsms}, $\miniVerseUE$, can be recovered by omitting the syntactic forms, judgements, rules, proof clauses and proof cases typeset with gray backgrounds below.

\clearpage

\section{Expanded Language (XL)}\label{appendix:SES-XL}
\subsection{Syntax}
% \begin{figure}[h!]
\[\begin{array}{lllllll}
\textbf{Sort} & & 
& \textbf{Operational Form} 
% & \textbf{Stylized Form} 
& \textbf{Description}\\
\mathsf{Typ} & \tau & ::= & t 
%& t 
& \text{variable}\\
&&& \aparr{\tau}{\tau} 
%& \parr{\tau}{\tau} 
& \text{partial function}\\
&&& \aall{t}{\tau} 
%& \forallt{t}{\tau} 
& \text{polymorphic}\\
&&& \arec{t}{\tau} 
%& \rect{t}{\tau} 
& \text{recursive}\\
&&& \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}} 
%& \prodt{\mapschema{\tau}{i}{\labelset}} 
& \text{labeled product}\\
&&& \asum{\labelset}{\mapschema{\tau}{i}{\labelset}} 
%& \sumt{\mapschema{\tau}{i}{\labelset}} 
& \text{labeled sum}\\
\mathsf{Exp} & e & ::= & x 
%& x 
& \text{variable}\\
&&& \aelam{\tau}{x}{e} 
%& \lam{x}{\tau}{e} 
& \text{abstraction}\\
&&& \aeap{e}{e} 
%& \ap{e}{e} 
& \text{application}\\
&&& \aetlam{t}{e} 
%& \Lam{t}{e} 
& \text{type abstraction}\\
&&& \aetap{e}{\tau} 
%& \App{e}{\tau} 
& \text{type application}\\
&&& \aefold{e} 
%& \fold{e} : \tau 
& \text{fold}\\
&&& \aeunfold{e} 
%& \unfold{e} 
& \text{unfold}\\
&&& \aetpl{\labelset}{\mapschema{e}{i}{\labelset}} 
%& \tpl{\mapschema{e}{i}{\labelset}} 
& \text{labeled tuple}\\
&&& \aepr{\ell}{e} 
%& \prj{e}{\ell} 
& \text{projection}\\
&&& \aein{\ell}{e} 
%& \inj{\ell}{e} 
& \text{injection}\\
&&& \aecase{\labelset}{e}{\mapschemab{x}{e}{i}{\labelset}} 
%& \caseof{e}{\mapschemab{x}{e}{i}{\labelset}} 
& \text{case analysis}\\
\LCC \lightgray & \lightgray & \lightgray 
% & \lightgray 
& \lightgray & \lightgray \\
&&
& \aematchwith{n}{e}{\seqschemaX{r}}
% & \matchwith{e}{\seqschemaX{r}} 
& \text{match}\\
\mathsf{Rule} & r & ::= 
& \aematchrule{p}{e} 
%& \matchrule{p}{e} 
& \text{rule}\\
\mathsf{Pat} & p & ::= 
& x  
%& x 
& \text{variable pattern}\\
&&& \aewildp 
%& \wildp 
& \text{wildcard pattern}\\
&&& \aefoldp{p} 
%& \foldp{p} 
& \text{fold pattern}\\
&&& \aetplp{\labelset}{\mapschema{p}{i}{\labelset}} 
%& \tplp{\mapschema{p}{i}{\labelset}} 
& \text{labeled tuple pattern}\\
&&& \aeinjp{\ell}{p} 
%& \injp{\ell}{p} 
& \text{injection pattern} \ECC
\end{array}\]
% \caption{Syntax of the $\miniVersePat$ expanded language (XL).}
% \end{figure}

\subsection{Statics}
\emph{Type formation contexts}, $\Delta$, are finite sets of hypotheses of the form $\Dhyp{t}$. We write $\Delta, \Dhyp{t}$ when $\Dhyp{t} \notin \Delta$ for $\Delta$ extended with the hypothesis $\Dhyp{t}$. %Finite sets are written as finite sequences identified up to exchange.% We write $\Dcons{\Delta}{\Delta'}$ for the union of $\Delta$ and $\Delta'$.

\emph{Typing contexts}, $\Gamma$, are finite functions that map each variable $x \in \domof{\Gamma}$, where $\domof{\Gamma}$ is a finite set of variables, to the hypothesis $\Ghyp{x}{\tau}$, for some $\tau$. We write $\Gamma, \Ghyp{x}{\tau}$, when $x \notin \domof{\Gamma}$, for the extension of $\Gamma$ with a mapping from $x$ to $\Ghyp{x}{\tau}$, and $\Gcons{\Gamma}{\Gamma'}$ when $\domof{\Gamma} \cap \domof{\Gamma'} = \emptyset$ for the typing context mapping each $x \in \domof{\Gamma} \cup \domof{\Gamma'}$ to $x : \tau$ if $x : \tau \in \Gamma$ or $x : \tau \in \Gamma'$. We write $\isctxU{\Delta}{\Gamma}$ if every type in $\Gamma$ is well-formed relative to $\Delta$.
\begin{definition}[Typing Context Formation] \label{def:isctxU}
$\isctxU{\Delta}{\Gamma}$ iff for each hypothesis $x : \tau \in \Gamma$, we have $\istypeU{\Delta}{\tau}$.
\end{definition}

\noindent\fbox{\strut$\istypeU{\Delta}{\tau}$}~~$\tau$ is a well-formed type
\begin{subequations}\label{rules:istypeU}
\begin{equation}\label{rule:istypeU-var}
\inferrule{ }{\istypeU{\Delta, \Dhyp{t}}{t}}
\end{equation}
\begin{equation}\label{rule:istypeU-parr}
\inferrule{
  \istypeU{\Delta}{\tau_1}\\
  \istypeU{\Delta}{\tau_2}
}{\istypeU{\Delta}{\aparr{\tau_1}{\tau_2}}}
\end{equation}
\begin{equation}\label{rule:istypeU-all}
  \inferrule{
    \istypeU{\Delta, \Dhyp{t}}{\tau}
  }{
    \istypeU{\Delta}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:istypeU-rec}
  \inferrule{
    \istypeU{\Delta, \Dhyp{t}}{\tau}
  }{
    \istypeU{\Delta}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:istypeU-prod}
  \inferrule{
    \{\istypeU{\Delta}{\tau_i}\}_{i \in \labelset}
  }{
    \istypeU{\Delta}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:istypeU-sum}
  \inferrule{
    \{\istypeU{\Delta}{\tau_i}\}_{i \in \labelset}
  }{
    \istypeU{\Delta}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\end{subequations}

\noindent\fbox{\strut$\hastypeU{\Delta}{\Gamma}{e}{\tau}$}~~$e$ is assigned type $\tau$
\begin{subequations}\label{rules:hastypeU}\label{rules:hastypeUP}
\begin{equation}\label{rule:hastypeU-var}
  \inferrule{ }{
    \hastypeU{\Delta}{\Gamma, \Ghyp{x}{\tau}}{x}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-lam}
  \inferrule{
    \istypeU{\Delta}{\tau}\\
    \hastypeU{\Delta}{\Gamma, \Ghyp{x}{\tau}}{e}{\tau'}
  }{
    \hastypeU{\Delta}{\Gamma}{\aelam{\tau}{x}{e}}{\aparr{\tau}{\tau'}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-ap}
  \inferrule{
    \hastypeU{\Delta}{\Gamma}{e_1}{\aparr{\tau}{\tau'}}\\
    \hastypeU{\Delta}{\Gamma}{e_2}{\tau}
  }{
    \hastypeU{\Delta}{\Gamma}{\aeap{e_1}{e_2}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-tlam}
  \inferrule{
    \hastypeU{\Delta, \Dhyp{t}}{\Gamma}{e}{\tau}
  }{
    \hastypeU{\Delta}{\Gamma}{\aetlam{t}{e}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-tap}
  \inferrule{
    \hastypeU{\Delta}{\Gamma}{e}{\aall{t}{\tau}}\\
    \istypeU{\Delta}{\tau'}
  }{
    \hastypeU{\Delta}{\Gamma}{\aetap{e}{\tau'}}{[\tau'/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-fold}
  \inferrule{\
    % \istypeU{\Delta, \Dhyp{t}}{\tau}\\
    \hastypeU{\Delta}{\Gamma}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \hastypeU{\Delta}{\Gamma}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-unfold}
  \inferrule{
    \hastypeU{\Delta}{\Gamma}{e}{\arec{t}{\tau}}
  }{
    \hastypeU{\Delta}{\Gamma}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-tpl}
  \inferrule{
    \{\hastypeU{\Delta}{\Gamma}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \hastypeU{\Delta}{\Gamma}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-pr}
  \inferrule{
    \hastypeU{\Delta}{\Gamma}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}}
  }{
    \hastypeU{\Delta}{\Gamma}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-in}
  \inferrule{
    % \{\istypeU{\Delta}{\tau_i}\}_{i \in \labelset}\\
    % \istypeU{\Delta}{\tau}\\
    \hastypeU{\Delta}{\Gamma}{e}{\tau}
  }{
    \hastypeU{\Delta}{\Gamma}{\aein{\ell}{e}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeU-case}
  \inferrule{
    \hastypeU{\Delta}{\Gamma}{e}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}\\
    % \istypeU{\Delta}{\tau}\\
    \{\hastypeU{\Delta}{\Gamma, x_i : \tau_i}{e_i}{\tau}\}_{i \in \labelset}
  }{
    \hastypeU{\Delta}{\Gamma}{\aecase{\labelset}{e}{\mapschemab{x}{e}{i}{\labelset}}}{\tau}
  }
\end{equation}
\begin{grayparbox}
\begin{equation}\label{rule:hastypeUP-match}
\graybox{\inferrule{
  \hastypeU{\Delta}{\Gamma}{e}{\tau}\\
  % \istypeU{\Delta}{\tau'}\\
  \{\ruleType{\Delta}{\Gamma}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}\\
}{\hastypeU{\Delta}{\Gamma}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}}}
\end{equation}
\end{grayparbox}
\end{subequations}

\vspace{-5px}\begin{grayparbox}
\vspace{5px}\noindent\fcolorbox{black}{lightgray}{\strut$\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$}~~$r$ takes values of type $\tau$ to values of type $\tau'$
\begin{equation}\label{rule:ruleType}
\graybox{\inferrule{
  \patType{\pctx'}{p}{\tau}\\
  \hastypeU{\Delta}{\Gcons{\Gamma}{\pctx'}}{e}{\tau'}
}{\ruleType{\Delta}{\Gamma}{\aematchrule{p}{e}}{\tau}{\tau'}}}
\end{equation}
Rule (\ref{rule:ruleType}) is defined mutually inductively with Rules (\ref{rules:hastypeUP}).

\noindent\fcolorbox{black}{lightgray}{\strut$\patType{\Gamma}{p}{\tau}$}~~$p$ matches values of type $\tau$ and generates hypotheses $\pctx$
\begin{subequations}\label{rules:patType}
\begin{equation}\label{rule:patType-var}
\graybox{\inferrule{ }{\patType{\Ghyp{x}{\tau}}{x}{\tau}}}
\end{equation}
\begin{equation}\label{rule:patType-wild}
\graybox{\inferrule{ }{\patType{\emptyset}{\aewildp}{\tau}}}
\end{equation}
\begin{equation}\label{rule:patType-fold}
\graybox{\inferrule{
  \patType{\pctx}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \patType{\pctx}{\aefoldp{p}}{\arec{t}{\tau}}
}}
\end{equation}
\begin{equation}\label{rule:patType-tpl}
\graybox{\inferrule{
  \{\patType{\pctx_i}{p_i}{\tau_i}\}_{i \in \labelset}
}{
  \patType{\Gconsi{i \in \labelset}{\pctx_i}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
}}
\end{equation}
\begin{equation}\label{rule:patType-inj}
\graybox{\inferrule{
  \patType{\pctx}{p}{\tau}
}{
  \patType{\pctx}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}}
\end{equation}
\end{subequations}
\end{grayparbox}

\subsubsection{Metatheory}
The rules above are syntax-directed, so we assume an inversion lemma for each rule as needed without stating it separately or proving it explicitly. The following standard lemmas also hold.

The Weakening Lemma establishes that extending the context with unnecessary hypotheses preserves well-formedness and typing.
\begin{lemma}[Weakening]\label{lemma:weakening-UP}\label{lemma:weakening-U} ~
\begin{enumerate} 
\item If $\istypeU{\Delta}{\tau}$ then $\istypeU{\Delta, \Dhyp{t}}{\tau}$.
%\item If $\isctxU{\Delta}{\Gamma}$ then $\isctxU{\Delta, \Dhyp{t}}{\Gamma}$.
\item \begin{enumerate}
  \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\hastypeU{\Delta, \Dhyp{t}}{\Gamma}{e}{\tau}$.
  \item \graytxtbox{If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ then $\ruleType{\Delta, \Dhyp{t}}{\Gamma}{r}{\tau}{\tau'}$.}
  \end{enumerate}
\item \begin{enumerate}
  \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ and $\istypeU{\Delta}{\tau''}$ then $\hastypeU{\Delta}{\Gamma, \Ghyp{x}{\tau''}}{e}{\tau}$.
  \item \graytxtbox{If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ and $\istypeU{\Delta}{\tau''}$ then $\ruleType{\Delta}{\Gamma, \Ghyp{x}{\tau''}}{r}{\tau}{\tau'}$.}
  \end{enumerate}
\item \graytxtbox{If $\patType{\pctx}{p}{\tau}$ then $\patTypeD{\Delta, \Dhyp{t}}{\pctx}{p}{\tau}$.}
\end{enumerate}
\end{lemma}
\begin{proof-sketch} ~
\begin{enumerate}
\item By rule induction over Rules (\ref{rules:istypeU}).
%\item By rule induction over Rules (\ref{rules:isctxU}).
\item By \graytxtbox{mutual} rule induction over Rules (\ref{rules:hastypeUP}) \graytxtbox{and Rule (\ref{rule:ruleType})}, and part 1.
\item By \graytxtbox{mutual} rule induction over Rules (\ref{rules:hastypeUP}) \graytxtbox{and Rule (\ref{rule:ruleType})}, and part 1.
\item \graytxtbox{By rule induction over Rules (\ref{rules:patType}).}
\end{enumerate}
\end{proof-sketch}

\begin{grayparbox}
The {pattern typing judgement} is \emph{linear} in the pattern typing context, i.e. it does \emph{not} obey weakening of the pattern typing context. This is to ensure that the pattern typing context captures exactly those hypotheses generated by a pattern, and no others.
\end{grayparbox}

The Substitution Lemma establishes that substitution of a well-formed type for a type variable, or an expanded expression of the appropriate type for an expanded expression variable, preserves well-formedness and typing.
\begin{lemma}[Substitution]\label{lemma:substitution-UP} ~
\begin{enumerate}
\item If $\istypeU{\Delta, \Dhyp{t}}{\tau}$ and $\istypeU{\Delta}{\tau'}$ then $\istypeU{\Delta}{[\tau'/t]\tau}$.
%\item If $\isctxU{\Delta, \Dhyp{t}}{\Gamma}$ and $\istypeU{\Delta}{\tau'}$ then $\isctxU{\Delta}{[\tau'/t]\Gamma}$.
\item \begin{enumerate}
  \item If $\hastypeU{\Delta, \Dhyp{t}}{\Gamma}{e}{\tau}$ and $\istypeU{\Delta}{\tau'}$ then $\hastypeU{\Delta}{[\tau'/t]\Gamma}{[\tau'/t]e}{[\tau'/t]\tau}$.
  \item \begin{grayparbox} 
  {If} $\ruleType{\Delta, \Dhyp{t}}{\Gamma}{r}{\tau}{\tau''}$ and $\istypeU{\Delta}{\tau'}$ then $\ruleType{\Delta}{[\tau'/t]\Gamma}{[\tau'/t]r}{[\tau'/t]\tau}{[\tau'/t]\tau''}$.
  \end{grayparbox}
  \end{enumerate}
\item \begin{enumerate}
  \item If $\hastypeU{\Delta}{\Gamma, \Ghyp{x}{\tau'}}{e}{\tau}$ and $\hastypeU{\Delta}{\Gamma}{e'}{\tau'}$ then $\hastypeU{\Delta}{\Gamma}{[e'/x]e}{\tau}$.
  \item \graytxtbox{
  If $\ruleType{\Delta}{\Gamma, \Ghyp{x}{\tau'}}{r}{\tau}{\tau''}$ and $\hastypeU{\Delta}{\Gamma}{e'}{\tau''}$ then $\ruleType{\Delta}{\Gamma}{[e'/x]r}{\tau}{\tau''}$.}
  \end{enumerate}
\end{enumerate}\end{lemma}
\begin{proof-sketch} ~
\begin{enumerate}
\item By rule induction over Rules (\ref{rules:istypeU}).
\item By \graytxtbox{mutual} rule induction over Rules (\ref{rules:hastypeUP}) \graytxtbox{and Rule (\ref{rule:ruleType})}.
\item By \graytxtbox{mutual} rule induction over Rules (\ref{rules:hastypeUP}) \graytxtbox{and Rule (\ref{rule:ruleType})}.
\end{enumerate}
\end{proof-sketch}

The Decomposition Lemma is the converse of the Substitution Lemma.
\begin{lemma}[Decomposition]\label{lemma:decomposition-UP} ~
\begin{enumerate}
\item If $\istypeU{\Delta}{[\tau'/t]\tau}$ and $\istypeU{\Delta}{\tau'}$ then $\istypeU{\Delta, \Dhyp{t}}{\tau}$.
%\item If $\isctxU{\Delta}{[\tau'/t]\Gamma}$ and $\istypeU{\Delta}{\tau'}$ then $\isctxU{\Delta, \Dhyp{t}}{\Gamma}$.
\item \begin{enumerate}
  \item If $\hastypeU{\Delta}{[\tau'/t]\Gamma}{[\tau'/t]e}{[\tau'/t]\tau}$ and $\istypeU{\Delta}{\tau'}$ then $\hastypeU{\Delta, \Dhyp{t}}{\Gamma}{e}{\tau}$.
  \item \begin{grayparbox}
  If $\ruleType{\Delta}{[\tau'/t]\Gamma}{[\tau'/t]r}{[\tau'/t]\tau}{[\tau'/t]\tau''}$ and $\istypeU{\Delta}{\tau'}$ then $\ruleType{\Delta, \Dhyp{t}}{\Gamma}{r}{\tau}{\tau''}$.
  \end{grayparbox}
  \end{enumerate}
\item \begin{enumerate}
  \item If $\hastypeU{\Delta}{\Gamma}{[e'/x]e}{\tau}$ and $\hastypeU{\Delta}{\Gamma}{e'}{\tau'}$ then $\hastypeU{\Delta}{\Gamma, \Ghyp{x}{\tau'}}{e}{\tau}$.
  \item \graytxtbox{If $\ruleType{\Delta}{\Gamma}{[e'/x]r}{\tau}{\tau''}$ and $\hastypeU{\Delta}{\Gamma}{e'}{\tau'}$ then $\ruleType{\Delta}{\Gamma, \Ghyp{x}{\tau'}}{r}{\tau}{\tau''}$.}
  \end{enumerate}
\end{enumerate}\end{lemma}
\begin{proof-sketch} ~
\begin{enumerate}
\item By rule induction over Rules (\ref{rules:istypeU}) and case analysis over the definition of substitution. In all cases, the derivation of $\istypeU{\Delta}{[\tau'/t]\tau}$ does not depend on the form of $\tau'$.
%\item Context formation of $[\tau'/t]\Gamma$ does not depend on the structure of $\tau'$.
\item By \graytxtbox{mutual} rule induction over Rules (\ref{rules:hastypeUP}) \graytxtbox{and Rule (\ref{rule:ruleType})} and case analysis over the definition of substitution. In all cases, the derivation of $\hastypeU{\Delta}{[\tau'/t]\Gamma}{[\tau'/t]e}{[\tau'/t]\tau}$ \graytxtbox{or $\ruleType{\Delta}{[\tau'/t]\Gamma}{[\tau'/t]r}{[\tau'/t]\tau}{[\tau'/t]\tau''}$} does not depend on the form of $\tau'$.
\item By \graytxtbox{mutual} rule induction over Rules (\ref{rules:hastypeUP}) \graytxtbox{and Rule (\ref{rule:ruleType})} and case analysis over the definition of substitution. In all cases, the derivation of $\hastypeU{\Delta}{\Gamma}{[e'/x]e}{\tau}$ \graytxtbox{or $\ruleType{\Delta}{\Gamma}{[e'/x]r}{\tau}{\tau''}$} does not depend on the form of $e'$.
\end{enumerate}
\end{proof-sketch}

\begin{grayparbox}
The Pattern Regularity Lemma establishes that the hypotheses generated by checking a pattern against a well-formed type involve only well-formed types.
\begin{lemma}[Pattern Regularity]\label{lemma:pattern-regularity-UP} 
If $\patType{\pctx}{p}{\tau}$ and $\istypeU{\Delta}{\tau}$ then $\isctxU{\Delta}{\pctx}$.
\end{lemma}
\begin{proof} By rule induction over Rules (\ref{rules:patType}).
\begin{byCases}
\item[\text{(\ref{rule:patType-var})}] ~
\begin{pfsteps*}
  \item $p=x$ \BY{assumption}
  \item $\pctx=x : \tau$ \BY{assumption}
  \item $\istypeU{\Delta}{\tau}$ \BY{assumption}\pflabel{istypeU}
  \item $\isctxU{\Delta}{\Ghyp{x}{\tau}}$ \BY{Definition \ref{def:isctxU} on \pfref{istypeU}}
 \end{pfsteps*}
 \resetpfcounter
\item[\text{(\ref{rule:patType-wild})}] ~
\begin{pfsteps}
\item \pctx=\emptyset \BY{assumption}
\item \isctxU{\Delta}{\emptyset} \BY{Definition \ref{def:isctxU}}
\end{pfsteps}
\resetpfcounter

\item[\text{(\ref{rule:patType-tpl})}] ~
\begin{pfsteps*}
  \item $p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}$ \BY{assumption}
  \item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
  \item $\pctx=\cup_{i \in \labelset} \pctx_i$ \BY{assumption}
  \item $\{\patType{\pctx_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption}\pflabel{patType}
  \item $\istypeU{\Delta}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{assumption} \pflabel{istypeU}
  \item $\{\istypeU{\Delta}{\tau_i}\}_{i \in \labelset}$ \BY{Inversion of Rule (\ref{rule:istypeU-prod}) on \pfref{istypeU}}\pflabel{istypeU-each}
  \item $\{\isctxU{\Delta}{\pctx_i}\}_{i \in \labelset}$ \BY{IH over \pfref{patType} and \pfref{istypeU-each}} \pflabel{biggy}
  \item $\isctxU{\Delta}{\cup_{i \in \labelset} \pctx_i}$ \BY{Definition \ref{def:isctxU} on \pfref{biggy}, then Definition \ref{def:isctxU} again, using the definition of typing context union iteratively}
\end{pfsteps*}
\resetpfcounter

\item[\text{(\ref{rule:patType-inj})}] ~
\begin{pfsteps*}
  \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
  \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
  \item $\istypeU{\Delta}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}$ \BY{assumption} \pflabel{istype}
  \item $\patType{\pctx}{p'}{\tau'}$ \BY{assumption} \pflabel{patType}
  \item $\istypeU{\Delta}{\tau'}$ \BY{Inversion of Rule (\ref{rule:istypeU-sum}) on \pfref{istype}} \pflabel{istypeTwo} 
  \item $\isctxU{\Delta}{\pctx}$ \BY{IH on \pfref{patType} and \pfref{istypeTwo}}
\end{pfsteps*}
\resetpfcounter
\end{byCases}
\end{proof}
\end{grayparbox}

% Finally, the Regularity Lemma establishes that the type assigned to an expression under a well-formed typing context is well-formed. 
% \begin{lemma}[Regularity]\label{lemma:regularity-UP} ~
% \begin{enumerate}
% \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ and $\isctxU{\Delta}{\Gamma}$ then $\istypeU{\Delta}{\tau}$.
% \item \graytxtbox{If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ and $\isctxU{\Delta}{\Gamma}$ then $\istypeU{\Delta}{\tau'}$.}
% \end{enumerate}
% \end{lemma}
% \begin{proof-sketch} By \graytxtbox{mutual} rule induction over Rules (\ref{rules:hastypeUP}) \graytxtbox{and Rule (\ref{rule:ruleType})}, and Lemma \ref{lemma:substitution-UP} \graytxtbox{and Lemma \ref{lemma:pattern-regularity-UP}}.
% \end{proof-sketch}

\subsection{Structural Dynamics}\vspace{-4px}
The \emph{structural dynamics} is specified as a transition system, and is organized around judgements of the following form:
\vspace{-4px}\[\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\stepsU{e}{e'} & \text{$e$ transitions to $e'$}\\
\isvalU{e} & \text{$e$ is a value}\\
\LCC \lightgray & \lightgray \\
\matchfail{e} & \text{$e$ raises match failure} \ECC
\end{array}\]\vspace{-4px}
We also define auxiliary judgements for \emph{iterated transition}, $\multistepU{e}{e'}$, and \emph{evaluation}, $\evalU{e}{e'}$.


\begin{definition}[Iterated Transition]\label{defn:iterated-transition-UP} Iterated transition, $\multistepU{e}{e'}$, is the reflexive, transitive closure of the transition judgement, $\stepsU{e}{e'}$.\end{definition}


\begin{definition}[Evaluation]\label{defn:evaluation-UP}  $\evalU{e}{e'}$ iff $\multistepU{e}{e'}$ and $\isvalU{e'}$. \end{definition}

Our subsequent developments do not make mention of particular rules in the dynamics, nor do they make mention of other judgements, not listed above,  that are used only for defining the dynamics of the match operator, so we do not produce these details here. Instead, it suffices to state the following conditions.

\begin{condition}[Canonical Forms]\label{condition:canonical-forms-UP} If $\hastypeUC{e}{\tau}$ and $\isvalU{e}$ then:
\begin{enumerate}
\item If $\tau=\aparr{\tau_1}{\tau_2}$ then $e=\aelam{\tau_1}{x}{e'}$ and $\hastypeUCO{\Ghyp{x}{\tau_1}}{e'}{\tau_2}$.
\item If $\tau=\aall{t}{\tau'}$ then $e=\aetlam{t}{e'}$ and $\hastypeUCO{\Dhyp{t}}{e'}{\tau'}$.
\item If $\tau=\arec{t}{\tau'}$ then $e=\aefold{e'}$ and $\hastypeUC{e'}{[\abop{rec}{t.\tau'}/t]\tau'}$ and $\isvalU{e'}$. 
\item If $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ then $e=\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}$ and $\hastypeUC{e_i}{\tau_i}$ and $\isvalU{e_i}$ for each $i \in \labelset$.
\item If $\tau=\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}$ then for some label set $L'$ and label $\ell$ and type $\tau'$, we have that $\labelset=\labelset', \ell$ and $\tau=\asum{\labelset', \ell}{\mapschema{\tau}{i}{\labelset'}; \mapitem{\ell}{\tau'}}$ and $e=\aein{\ell}{e'}$ and $\hastypeUC{e'}{\tau'}$ and $\isvalU{e'}$.
\end{enumerate}\end{condition}


\begin{condition}[Preservation]\label{condition:preservation-UP} If $\hastypeUC{e}{\tau}$ and $\stepsU{e}{e'}$ then $\hastypeUC{e'}{\tau}$. \end{condition}

\begin{condition}[Progress]\label{condition:progress-UP} If $\hastypeUC{e}{\tau}$ then either $\isvalU{e}$ \graytxtbox{or $\matchfail{e}$} or there exists an $e'$ such that $\stepsU{e}{e'}$. \end{condition}

\section{Unexpanded Language (UL)}\label{appendix:SES-uexps}
\subsection{Syntax}\label{appendix:SES-syntax}\label{appendix:SES-shared-forms}
\subsubsection{Stylized Syntax}
\[\begin{array}{lllllll}
\textbf{Sort} & &  
%&\textbf{Operational Form} 
& \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{UTyp} & \utau & ::= 
% &\ut 
& \ut & \text{identifier}\\
&& 
%& \auparr{\utau}{\utau} 
& \parr{\utau}{\utau} & \text{partial function}\\
&&
%& \auall{\ut}{\utau} 
& \forallt{\ut}{\utau} & \text{polymorphic}\\
&&
%& \aurec{\ut}{\utau} 
& \rect{\ut}{\utau} & \text{recursive}\\
&&
%& \auprod{\labelset}{\mapschema{\utau}{i}{\labelset}} 
& \prodt{\mapschema{\utau}{i}{\labelset}} & \text{labeled product}\\
&&
%& \ausum{\labelset}{\mapschema{\utau}{i}{\labelset}} 
& \sumt{\mapschema{\utau}{i}{\labelset}} & \text{labeled sum}\\
\mathsf{UExp} & \ue & ::= 
%& \ux 
& \ux & \text{identifier}\\
&&
%
& \asc{\ue}{\utau} & \text{ascription}\\
&&
%
& \letsyn{\ux}{\ue}{\ue} & \text{value binding}\\
&&
%& \aulam{\utau}{\ux}{\ue} 
& \lam{\ux}{\utau}{\ue} & \text{abstraction}\\
&&
%& \auap{\ue}{\ue} 
& \ap{\ue}{\ue} & \text{application}\\
&&
%& \autlam{\ut}{\ue} 
& \Lam{\ut}{\ue} & \text{type abstraction}\\
&&
%& \autap{\ue}{\utau} 
& \App{\ue}{\utau} & \text{type application}\\
&&
%& \aufold{\ut}{\utau}{\ue} 
& \fold{\ue} & \text{fold}\\
&&
%& \auunfold{\ue} 
& \unfold{\ue} & \text{unfold}\\
&&
%& \autpl{\labelset}{\mapschema{\ue}{i}{\labelset}} 
& \tpl{\mapschema{\ue}{i}{\labelset}} & \text{labeled tuple}\\
&&
%& \aupr{\ell}{\ue} 
& \prj{\ue}{\ell} & \text{projection}\\
&&
%& \auin{\labelset}{\ell}{\mapschema{\utau}{i}{\labelset}}{\ue} 
& \inj{\ell}{\ue} & \text{injection}\\
&&
%& \aucase{\labelset}{\utau}{\ue}{\mapschemab{\ux}{\ue}{i}{\labelset}} 
& \caseof{\ue}{\mapschemab{\ux}{\ue}{i}{\labelset}} & \text{case analysis}\\
&&
%& \audefuetsm{\utau}{e}{\tsmv}{\ue} 
& \uesyntax{\tsmv}{\utau}{e}{\ue} & \text{seTSM definition}\\ 
&&
%& \autsmap{b}{\tsmv} 
& \utsmap{\tsmv}{b} & \text{seTSM application}\\%\ECC
\LCC  \lightgray & \lightgray & \lightgray
& \lightgray 
& \lightgray & \lightgray \\
&&
%& \aumatchwith{n}{\utau}{\ue}{\seqschemaX{\urv}} 
& \matchwith{\ue}{\seqschemaX{\urv}} & \text{match}\\
&&
%& \audefuptsm{\utau}{e}{\tsmv}{\ue} 
& \usyntaxup{\tsmv}{\utau}{e}{\ue}
& \text{spTSM definition}\\
\mathsf{URule} & \urv & ::= 
%& \aumatchrule{\upv}{\ue} 
& \matchrule{\upv}{\ue} & \text{match rule}\\
\mathsf{UPat} & \upv & ::= 
%& \ux 
& \ux & \text{identifier pattern}\\
&&
%& \auwildp 
& \wildp & \text{wildcard pattern}\\
&&
%& \aufoldp{\upv} 
& \foldp{\upv} & \text{fold pattern}\\
&&
%& \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}} 
& \tplp{\mapschema{\upv}{i}{\labelset}} & \text{labeled tuple pattern}\\
&&
%& \auinjp{\ell}{\upv} 
& \injp{\ell}{\upv} & \text{injection pattern}\\
% \LCC &&& \lightgray & \lightgray & \lightgray\\
&&
%& \auapuptsm{b}{\tsmv} 
& \utsmap{\tsmv}{b} & \text{spTSM application}\ECC
\end{array}\]

\clearpage

\paragraph{Body Lengths}\label{appendix:SES-body-lengths}
We write $\sizeof{b}$ for the length of $b$. The metafunction $\sizeof{\ue}$ computes the sum of the lengths of expression literal bodies in $\ue$:
\[
\begin{array}{ll}
\sizeof{\ux} & = 0\\
\sizeof{\asc{\ue}{\utau}} & = \sizeof{\ue}\\
\sizeof{\letsyn{\ux}{\ue_1}{\ue_2}} & = \sizeof{\ue_1} + \sizeof{\ue_2}\\
\sizeof{\lam{\ux}{\utau}{\ue}} &= \sizeof{\ue}\\
\sizeof{\ap{\ue_1}{\ue_2}} & = \sizeof{\ue_1} + \sizeof{\ue_2}\\
\sizeof{\Lam{\ut}{\ue}} & = \sizeof{\ue}\\
\sizeof{\App{\ue}{\utau}} & = \sizeof{\ue}\\
\sizeof{\fold{\ue}} & = \sizeof{\ue}\\
\sizeof{\unfold{\ue}} & = \sizeof{\ue}\\
%\end{align*}
%\begin{align*}
\sizeof{\tpl{\mapschema{\ue}{i}{\labelset}}} & = \sum_{i \in \labelset} \sizeof{\ue_i}\\
\sizeof{\prj{\ell}{\ue}} & = \sizeof{\ue}\\
\sizeof{\inj{\ell}{\ue}} & = \sizeof{\ue}\\
\sizeof{\caseof{\ue}{\mapschemab{\ux}{\ue}{i}{\labelset}}} & = \sizeof{\ue} + \sum_{i \in \labelset} \sizeof{\ue_i}\\
\sizeof{\uesyntax{\tsmv}{\utau}{\eparse}{\ue}} & = \sizeof{\ue}\\
\sizeof{\utsmap{\tsmv}{b}} & = \sizeof{b}\\
\LCC \lightgray & \lightgray\\
\sizeof{\matchwith{\ue}{\seqschemaX{\urv}}} & = \sizeof{\ue} + \sum_{1 \leq i \leq n} \sizeof{r_i}\\
\sizeof{\usyntaxup{\tsmv}{\utau}{\eparse}{\ue}} & = \sizeof{\ue}\ECC
\end{array}
\]
\vspace{-3px}\begin{grayparbox}\vspace{3px}and $\sizeof{\urv}$ computes the sum of the lengths of expression literal bodies in $\urv$:
\begin{align*}
\sizeof{\matchrule{\upv}{\ue}} & = \sizeof{\ue}
\end{align*}
Similarly, the metafunction $\sizeof{\upv}$ computes the sum of the lengths of the pattern literal bodies in $\upv$:
\begin{align*}
\sizeof{\ux} & = 0\\
\sizeof{\foldp{\upv}} & = \sizeof{\upv}\\
\sizeof{\tplp{\mapschema{\upv}{i}{\labelset}}} & = \sum_{i \in \labelset} \sizeof{\upv_i}\\
\sizeof{\injp{\ell}{\upv}} & = \sizeof{\upv}\\
\sizeof{\utsmap{\tsmv}{b}} & = \sizeof{b}
\end{align*}
\end{grayparbox}

\paragraph{Common Unexpanded Forms} Each expanded form maps onto an unexpanded form. We refer to these as the \emph{common forms}. In particular:
\begin{itemize}
\item Each type variable, $t$, maps onto a unique {type identifier}, written $\sigilof{t}$.
\item Each type, $\tau$, maps onto an unexpanded type, $\Uof{\tau}$, as follows: 
  \begin{align*}
  \Uof{t} &= \sigilof{t}\\
  \Uof{\aparr{\tau_1}{\tau_2}} & = \parr{\Uof{\tau_1}}{\Uof{\tau_2}}\\
  \Uof{\aall{t}{\tau}} & = \forallt{\sigilof{t}}{\Uof{\tau}}\\
  \Uof{\arec{t}{\tau}} & = \rect{\sigilof{t}}{\Uof{\tau}}\\
  \Uof{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \prodt{\mapschemax{\Uofv}{\tau}{i}{\labelset}}\\
  \Uof{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \sumt{\mapschemax{\Uofv}{\tau}{i}{\labelset}}
  \end{align*}
\item Each expression variable, $x$, maps onto a unique expression identifier, written $\sigilof{x}$.
\item Each expanded expression, $e$, maps onto an unexpanded expression, $\Uof{e}$, as follows:
\[\arraycolsep=1pt\begin{array}{rl}
\Uof{x} & = \sigilof{x}\\
\Uof{\aelam{\tau}{x}{e}} & = \lam{\sigilof{x}}{\Uof{\tau}}{\Uof{e}}\\
\Uof{\aeap{e_1}{e_2}} & = \ap{\Uof{e_1}}{\Uof{e_2}}\\
\Uof{\aetlam{t}{e}} & = \Lam{\sigilof{t}}{\Uof{e}}\\
\Uof{\aetap{e}{\tau}} & = \App{\Uof{e}}{\Uof{\tau}}\\
\Uof{\aefold{e}} & = \fold{\Uof e}\\
\Uof{\aeunfold{e}} & = \unfold{\Uof{e}}\\
\Uof{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}} & = \tpl{\mapschemax{\Uofv}{e}{i}{\labelset}}\\
\Uof{\aepr{\ell}{e}} & = \prj{\Uof{e}}{\ell}\\
\Uof{\aein{\ell}{e}} &= \inj{\ell}{\Uof{e}}\\
\LCC \lightgray & \lightgray \\
\Uof{\aematchwith{n}{e}{\seqschemaX{r}}} & = \matchwith{\Uof{e}}{\seqschemaXx{\Uofv}{r}}\ECC
\end{array}\]
\end{itemize}
\begin{grayparbox}
\begin{itemize}
\item Each expanded rule, $r$, maps onto an unexpanded rule, $\Uof{r}$, as follows:
\[\arraycolsep=1pt\begin{array}{rl}
\LCC \lightgray & \lightgray \\
\Uof{\aematchrule{p}{e}} & = \aumatchrule{\Uof{p}}{\Uof{e}}\ECC
\end{array}\]
\item Each expanded pattern, $p$, maps onto the unexpanded pattern, $\Uof{p}$, as follows:
\[\arraycolsep=1pt\begin{array}{rl}
\LCC \lightgray & \lightgray \\
\Uof{x} & = \sigilof{x}\\
\Uof{\aewildp} &= \auwildp\\
\Uof{\aefoldp{p}} &= \aufoldp{\Uof{p}}\\
\Uof{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}} & = \autplp{\labelset}{\mapschemax{\Uofv}{p}{i}{\labelset}}\\
\Uof{\aeinjp{\ell}{p}} & = \auinjp{\ell}{\Uof{p}}\ECC
\end{array}\]
\end{itemize}
\end{grayparbox}
\vspace{-10px}
\subsubsection{Textual Syntax}\vspace{-3px} In addition to the stylized syntax, there is also a context-free textual syntax for the UL. For our purposes, we need only posit the existence of partial metafunctions $\parseUTypF{b}$ and $\parseUExpF{b}$\graytxtbox{~and $\parseUPatF{b}$}. 

\begin{condition}[Textual Representability]\label{condition:textual-representability-SES} ~
\begin{enumerate}
\item For each $\utau$, there exists $b$ such that $\parseUTyp{b}{\utau}$. 
\item For each $\ue$, there exists $b$ such that $\parseUExp{b}{\ue}$.
% \item For each $\urv$, there exists $b$ such that $\parseURule{b}{\urv}$.
\item \graytxtbox{For each $\upv$, there exists $b$ such that $\parseUPat{b}{\upv}$.}
\end{enumerate}
\end{condition}

We also impose the following technical condition\graytxtbox{s}.

\begin{condition}[Expression Parsing Monotonicity]\label{condition:body-parsing} If $\parseUExp{b}{\ue}$ then $\sizeof{\ue} < \sizeof{b}$.\end{condition}

\begin{grayparbox}\begin{condition}[Pattern Parsing Monotonicity]\label{condition:pattern-parsing} If $\parseUPat{b}{\upv}$ then $\sizeof{\upv} < \sizeof{b}$.\end{condition}\end{grayparbox}

\subsection{Type Expansion}
\emph{Unexpanded type formation contexts}, $\uDelta$, are of the form $\uDD{\uD}{\Delta}$, i.e. they consist of a \emph{type identifier expansion context}, $\uD$, paired with a type formation context, $\Delta$. 

A \emph{type identifier expansion context}, $\uD$, is a finite function that maps each type identifier $\ut \in \domof{\uD}$ to the hypothesis $\vExpands{\ut}{t}$, for some type variable $t$. We write $\ctxUpdate{\uD}{\ut}{t}$ for the type identifier expansion context that maps $\ut$ to $\vExpands{\ut}{t}$ and defers to $\uD$ for all other type identifiers (i.e. the previous mapping is \emph{updated}.) 

We define $\uDelta, \uDhyp{\ut}{t}$ when $\uDelta=\uDD{\uD}{\Delta}$ as an abbreviation of  \[\uDD{\ctxUpdate{\uD}{\ut}{t}}{\Delta, \Dhyp{t}}\]%type identifier expansion context is always extended/updated together with 

\begin{definition}[Unexpanded Type Formation Context Formation] $\uDOK{\uDD{\uD}{\Delta}}$ iff for each $\uDhyp{\ut}{t} \in \uD$ we have $\Dhyp{t} \in \Delta$. \end{definition}

\vspace{10px}\noindent\fbox{\strut$\expandsTU{\uDelta}{\utau}{\tau}$}~~$\utau$ has well-formed expansion $\tau$
\begin{subequations}\label{rules:expandsTU}
\begin{equation}\label{rule:expandsTU-var}
\inferrule{ }{\expandsTU{\uDelta, \uDhyp{\ut}{t}}{\ut}{t}}
\end{equation}
\begin{equation}\label{rule:expandsTU-parr}
\inferrule{
  \expandsTU{\uDelta}{\utau_1}{\tau_1}\\
  \expandsTU{\uDelta}{\utau_2}{\tau_2}
}{\expandsTU{\uDelta}{\auparr{\utau_1}{\utau_2}}{\aparr{\tau_1}{\tau_2}}}
\end{equation}
\begin{equation}\label{rule:expandsTU-all}
  \inferrule{
    \expandsTU{\uDelta, \uDhyp{\ut}{t}}{\utau}{\tau}
  }{
    \expandsTU{\uDelta}{\auall{\ut}{\utau}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:expandsTU-rec}
  \inferrule{
    \expandsTU{\uDelta, \uDhyp{\ut}{t}}{\utau}{\tau}
  }{
    \expandsTU{\uDelta}{\aurec{\ut}{\utau}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:expandsTU-prod}
  \inferrule{
    \{\expandsTU{\uDelta}{\utau_i}{\tau_i}\}_{i \in \labelset}
  }{
    \expandsTU{\uDelta}{\auprod{\labelset}{\mapschema{\utau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:expandsTU-sum}
  \inferrule{
    \{\expandsTU{\uDelta}{\utau_i}{\tau_i}\}_{i \in \labelset}
  }{
    \expandsTU{\uDelta}{\ausum{\labelset}{\mapschema{\utau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\end{subequations}
% \emph{Unexpanded type formation contexts}, $\uDelta$, are of the form $\uDD{\uD}{\Delta}$, where $\uD$ is a \emph{type identifier expansion context}, and $\Delta$ is a type formation context. A type identifier expansion context, $\uD$, is a finite function that maps each type identifier $\ut \in \domof{\uD}$ to the hypothesis $\vExpands{\ut}{t}$, for some type variable $t$. We write $\ctxUpdate{\uD}{\ut}{t}$ for the type identifier expansion context that maps $\ut$ to $\vExpands{\ut}{t}$ and defers to $\uD$ for all other type identifiers (i.e. the previous mapping, if it exists, is updated). 
% We define $\uDelta, \uDhyp{\ut}{t}$ when $\uDelta=\uDD{\uD}{\Delta}$ as an abbreviation of  \[\uDD{\ctxUpdate{\uD}{\ut}{t}}{\Delta, \Dhyp{t}}\]%type identifier expansion context is always extended/updated together with 
% %We write $\uDeltaOK{\uDelta}$ when $\uDelta=\uDD{\uD}{\Delta}$ and each type variable in $\uD$ also appears in $\Delta$.
% %\begin{definition}\label{def:uDeltaOK} $\uDeltaOK{\uDD{\uD}{\Delta}}$ iff for each $\vExpands{\ut}{t} \in \uD$, we have $\Dhyp{t} \in \Delta$.\end{definition}

\subsection{Typed Expression Expansion}\label{appendix:typed-expression-expansion-S}
\subsubsection{Contexts}
\emph{Unexpanded typing contexts}, $\uGamma$, are, similarly, of the form $\uGG{\uG}{\Gamma}$, where $\uG$ is an \emph{expression identifier expansion context}, and $\Gamma$ is a typing context. An expression identifier expansion context, $\uG$, is a finite function that maps each expression identifier $\ux \in \domof{\uG}$ to the hypothesis $\vExpands{\ux}{x}$, for some expression variable, $x$. We write $\ctxUpdate{\uG}{\ux}{x}$ for the expression identifier expansion context that maps $\ux$ to $\vExpands{\ux}{x}$ and defers to $\uG$ for all other expression identifiers (i.e. the previous mapping is updated.) 
%We write $\uGammaOK{\uGamma}$ when $\uGamma=\uGG{\uG}{\Gamma}$ and each expression variable in $\uG$ is assigned a type by $\Gamma$.
%\noindent 

We define $\uGamma, \uGhyp{\ux}{x}{\tau}$ when $\uGamma = \uGG{\uG}{\Gamma}$ as an abbreviation of \[\uGG{\uG, \vExpands{\ux}{x}}{\Gamma, \Ghyp{x}{\tau}}\]

\begin{definition}[Unexpanded Typing Context Formation] $\uGammaOK{\uGG{\uG}{\Gamma}}$ iff $\isctxU{\Delta}{\Gamma}$ and for each $\vExpands{\ux}{x} \in \uG$, we have $x \in \domof{\Gamma}$.\end{definition}


\subsubsection{Body Encoding and Decoding}
An assumed type abbreviated $\tBody$ classifies encodings of literal bodies, $b$. The mapping from literal bodies to values of type $\tBody$ is defined by the \emph{body encoding judgement} $\encodeBody{b}{\ebody}$. An inverse mapping is defined   by the \emph{body decoding judgement} $\decodeBody{\ebody}{b}$.
\[\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\encodeBody{b}{e} & \text{$b$ has encoding $e$}\\
\decodeBody{e}{b} & \text{$e$ has decoding $b$}
\end{array}\]
The following condition establishes an isomorphism between literal bodies and values of type $\tBody$ mediated by the judgements above.
\begin{condition}[Body Isomorphism]\label{condition:body-isomorphism} ~
\begin{enumerate}
\item For every literal body $b$, we have that $\encodeBody{b}{\ebody}$ for some $\ebody$ such that $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$.
\item If $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$ then $\decodeBody{\ebody}{b}$ for some $b$.
\item If $\encodeBody{b}{\ebody}$ then $\decodeBody{\ebody}{b}$.
\item If $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$ and $\decodeBody{\ebody}{b}$ then $\encodeBody{b}{\ebody}$. 
\item If $\encodeBody{b}{\ebody}$ and $\encodeBody{b}{\ebody'}$ then $\ebody = \ebody'$.
\item If $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$ and $\decodeBody{\ebody}{b}$ and $\decodeBody{\ebody}{b'}$ then $b=b'$.
\end{enumerate}
\end{condition}
We also assume a partial metafunction, $\bsubseq{b}{m}{n}$, which extracts a subsequence of $b$ starting at position $m$ and ending at position $n$, inclusive, where $m$ and $n$ are natural numbers. The following condition is technically necessary.
\begin{condition}[Body Subsequencing]\label{condition:body-subsequences} If $\bsubseq{b}{m}{n}=b'$ then $\sizeof{b'} \leq \sizeof{b}$. \end{condition}

\subsubsection{Parse Results}
 The type abbreviated $\tParseResultExp$, and an auxiliary abbreviation used below, is defined as follows:
\begin{align*}
L_\mathtt{SE} & \defeq \lbltxt{ParseError}, \lbltxt{SuccessE}\\
\tParseResultExp & \defeq \asum{L_\mathtt{SE}}{
  \mapitem{\lbltxt{ParseError}}{\prodt{}}, 
  \mapitem{\lbltxt{SuccessE}}{\tCEExp}
}\\
\lbltxt{SuccessE}\cdot e & \defeq \aein{L_\mathtt{SE}}{\mathtt{SuccessE}}{\mapitem{\mathtt{ParseError}}{\tpl{}}, \mapitem{\mathtt{SuccessE}}{\tCEExp}}{e}
\end{align*} %[\mapitem{\lbltxt{ParseError}}{\prodt{}}, \mapitem{\lbltxt{SuccessE}}{\tCEExp}]

\begin{grayparbox}
 The type abbreviated $\tParseResultPat$, and an auxiliary abbreviation used below, is defined as follows:
\begin{align*}
L_\mathtt{SP} & \defeq \lbltxt{ParseError}, \lbltxt{SuccessP}\\
\tParseResultExp & \defeq \asum{L_\mathtt{SP}}{
  \mapitem{\lbltxt{ParseError}}{\prodt{}}, 
  \mapitem{\lbltxt{SuccessP}}{\tCEPat}
}\\
\lbltxt{SuccessP}\cdot e & \defeq \aein{L_\mathtt{SP}}{\mathtt{SuccessP}}{\mapitem{\mathtt{ParseError}}{\tpl{}}, \mapitem{\mathtt{SuccessP}}{\tCEPat}}{e}
\end{align*} %[\mapitem{\lbltxt{ParseError}}{\prodt{}}, \mapitem{\lbltxt{SuccessE}}{\tCEExp}]
\end{grayparbox}

\subsubsection{seTSM Contexts}

\emph{seTSM contexts}, $\uPsi$, are of the form $\uAS{\uA}{\Psi}$, where $\uA$ is a \emph{TSM identifier expansion context} and $\Psi$ is a \emph{seTSM definition context}. 

A \emph{TSM identifier expansion context}, $\uA$, is a finite function mapping each TSM identifier $\tsmv \in \domof{\uA}$ to the \emph{TSM identifier expansion}, $\vExpands{\tsmv}{a}$, for some \emph{TSM name}, $a$. We write $\ctxUpdate{\uA}{\tsmv}{a}$ for the TSM identifier expansion context that maps $\tsmv$ to $\vExpands{\tsmv}{a}$, and defers to $\uA$ for all other TSM identifiers (i.e. the previous mapping is \emph{updated}.)

An \emph{seTSM definition context}, $\Psi$, is a finite function mapping each TSM name $a \in \domof{\Psi}$ to an \emph{expanded seTSM definition}, $\xuetsmbnd{a}{\tau}{\eparse}$, where $\tau$ is the seTSM's type annotation, and $\eparse$ is its parse function. We write $\Psi, \xuetsmbnd{a}{\tau}{\eparse}$ when $a \notin \domof{\Psi}$ for the extension of $\Psi$ that maps $a$ to $\xuetsmbnd{a}{\tau}{\eparse}$. We write $\uetsmenv{\Delta}{\Psi}$  when all the type annotations in $\Psi$ are well-formed assuming $\Delta$, and the parse functions in $\Psi$ are closed and of the appropriate type.

\begin{definition}[seTSM Definition Context Formation]\label{def:seTSM-def-ctx-formation} $\uetsmenv{\Delta}{\Psi}$ iff for each $\xuetsmbnd{a}{\tau}{\eparse} \in \Psi$, we have $\istypeU{\Delta}{\tau}$ and $\hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}}$.\end{definition}

\begin{definition}[seTSM Context Formation] $\uetsmctx{\Delta}{\uAS{\uA}{\Psi}}$ iff $\uetsmenv{\Delta}{\Psi}$ and for each $\vExpands{\tsmv}{a} \in \uA$ we have $a \in \domof{\Psi}$.
\end{definition}

We define $\uPsi, \uShyp{\tsmv}{a}{\tau}{\eparse}$, when $\uPsi=\uAS{\uA}{\Phi}$, as an abbreviation of \[\uAS{\ctxUpdate{\uA}{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}\]
%\vspace{10px}

\begin{grayparbox}\vspace{-15px}\subsubsection{spTSM Contexts}
\emph{spTSM contexts}, $\uPhi$, are of the form $\uAS{\uA}{\Phi}$, where $\uA$ is a {TSM identifier expansion context}, defined above, and $\Phi$ is a \emph{spTSM definition context}. 

An \emph{spTSM definition context}, $\Phi$, is a finite function mapping each TSM name $a \in \domof{\Phi}$ to an \emph{expanded seTSM definition}, $\xuptsmbnd{a}{\tau}{\eparse}$, where $\tau$ is the spTSM's type annotation, and $\eparse$ is its parse function. We write $\Phi, \xuptsmbnd{a}{\tau}{\eparse}$ when $a \notin \domof{\Phi}$ for the extension of $\Phi$ that maps $a$ to $\xuptsmbnd{a}{\tau}{\eparse}$. We write $\uptsmenv{\Delta}{\Phi}$  when all the type annotations in $\Phi$ are well-formed assuming $\Delta$, and the parse functions in $\Phi$ are closed and of the appropriate type.

\begin{definition}[spTSM Definition Context Formation]\label{def:spTSM-def-ctx-formation} $\uptsmenv{\Delta}{\Phi}$ iff for each $\xuptsmbnd{a}{\tau}{\eparse} \in \Phi$, we have $\istypeU{\Delta}{\tau}$ and $\hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPat}}$.\end{definition}

\begin{definition}[spTSM Context Formation] $\uptsmctx{\Delta}{\uAS{\uA}{\Phi}}$ iff $\uptsmenv{\Delta}{\Phi}$ and for each $\vExpands{\tsmv}{a} \in \uA$ we have $a \in \domof{\Phi}$.
\end{definition}

We define $\uPhi, \uPhyp{\tsmv}{a}{\tau}{\eparse}$, when $\uPhi=\uAS{\uA}{\Phi}$, as an abbreviation of \[\uAS{\ctxUpdate{\uA}{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}\]
\end{grayparbox}

\subsubsection{Typed Expression Expansion}\label{appendix:typed-expression-expansion-SES}
\vspace{8px}\noindent\fbox{\strut$\expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$}~~$\ue$ has expansion $e$ of type $\tau$
\begin{subequations}\label{rules:expandsU}
\begin{equation}\label{rule:expandsU-var}
  \inferrule{ }{
    \expandsSG{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ux}{x}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-asc}
  \inferrule{
    \expandsTU{\uDelta}{\utau}{\tau}\\
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\asc{\ue}{\utau}}{e}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-letsyn}
  \inferrule{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue_1}{e_1}{\tau_1}\\
    \expandsSG{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue_2}{e_2}{\tau_2}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\letsyn{\ux}{\ue_1}{\ue_2}}{
      \aeap{\aelam{\tau_1}{x}{e_2}}{e_1}
    }{\tau_2}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-lam}
  \inferrule{
    \expandsTU{\uDelta}{\utau}{\tau}\\
    \expandsSG{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\lam{\ux}{\utau}{\ue}}{\aelam{\tau}{x}{e}}{\aparr{\tau}{\tau'}}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-ap}
  \inferrule{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue_1}{e_1}{\aparr{\tau}{\tau'}}\\
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue_2}{e_2}{\tau}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ap{\ue_1}{\ue_2}}{\aeap{e_1}{e_2}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-tlam}
  \inferrule{
    \expandsSG{\uDelta, \uDhyp{\ut}{t}}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\Lam{\ut}{\ue}}{\aetlam{t}{e}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-tap}
  \inferrule{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\aall{t}{\tau}}\\
    \expandsTU{\uDelta}{\utau'}{\tau'}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\App{\ue}{\utau'}}{\aetap{e}{\tau'}}{[\tau'/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-fold}
  \inferrule{
    % \istypeU{\Delta, \Dhyp{t}}{\tau}\\
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\fold{\ue}}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-unfold}
  \inferrule{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\arec{t}{\tau}}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\unfold{\ue}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-tpl}
  \inferrule{
    \{\expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\tpl{\mapschema{\ue}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-pr}
  \inferrule{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\prj{\ue}{\ell}}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-in}
  \inferrule{
   % \{\istypeU{\Delta}{\tau_i}\}_{i \in \labelset}\\
    % \istypeU{\Delta}{\tau'}\\
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau'}
  }{
    % \left(\shortstack{
    %   $\uDelta~\uGamma~{\vdash_{\uPhi}}{\setlength{\fboxsep}{0px}\colorbox{lightgray}{$_{\mathstrut; \uPsi}$}}~ \inj{\ell}{\ue}$\\
    %   $\leadsto$\\
    %   $\aein{\ell}{e} : \asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}$\vspace{-1.2em}}\right)
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\inj{\ell}{\ue}}{\aein{\ell}{e}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau'}}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-case}
  \inferrule{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}\\
    % \istypeU{\Delta}{\tau}\\
    \{\expandsSG{\uDelta}{\uGamma, \uGhyp{\ux_i}{x_i}{\tau_i}}{\uPsi}{\uPhi}{\ue_i}{e_i}{\tau}\}_{i \in \labelset}
  }{
    \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\caseof{\ue}{\mapschemab{\ux}{\ue}{i}{\labelset}}}{\aecase{\labelset}{e}{\mapschemab{x}{e}{i}{\labelset}}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsU-syntax}
\inferrule{
  \expandsTU{\uDelta}{\utau}{\tau}\\
  \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}}\\\\
  \evalU{\eparse}{\eparse'}\\
  \expandsU{\uDelta}{\uGamma}{\uPsi, \uShyp{\tsmv}{a}{\tau}{\eparse'}}{\ue}{e}{\tau'}
}{
  \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\uesyntax{\tsmv}{\utau}{\eparse}{\ue}}{e}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:expandsU-tsmap}
\inferrule{
  \uPsi = \uPsi', \uShyp{\tsmv}{a}{\tau}{\eparse}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{\lbltxt{SuccessE}\cdot\ecand}\\
  \decodeCondE{\ecand}{\ce}\\\\
    \segOK{\segof{\ce}}{b}\\
  \cvalidE{\emptyset}{\emptyset}{\esceneSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}
}{
  \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\utsmap{\tsmv}{b}}{e}{\tau}
}
\end{equation}
\begin{grayparbox}
\begin{equation}\label{rule:expandsU-match}
\inferrule{
  \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}\\
  % \istypeU{\Delta}{\tau'}\\
  \{\ruleExpands{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\urv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}\\
}{
  \expandsSG
    {\uDelta}{\uGamma}{\uPsi}{\uPhi}
    {\matchwith
      {\ue}
      {\seqschemaX{\urv}}
    }{\aematchwith
      {n}
      {e}
      {\seqschemaX{r}}
    }{\tau'}
}
\end{equation}
\begin{equation}\label{rule:expandsU-defuptsm}
\graybox{\inferrule{
  \expandsTU{\uDelta}{\utau}{\tau}\\
  \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPat}}\\\\
  \evalU{\eparse}{\eparse'}\\
  \expandsUP{\uDelta}{\uGamma}{\uPsi}{\uPhi, \uPhyp{\tsmv}{a}{\tau}{\eparse'}}{\ue}{e}{\tau'}
}{
  \expandsUPX{\usyntaxup{\tsmv}{\utau}{\eparse}{\ue}}{e}{\tau'}
}}
\end{equation}
\end{grayparbox}
\end{subequations}

% \begin{subequations}\label{rules:expandsU}
% Rules (\ref*{rule:expandsU-var}) through (\ref*{rule:expandsU-case}) handle unexpanded expressions of common form. The first five of these rules are defined below:
% %Each of these rules is based on the corresponding typing rule, i.e. Rules (\ref{rule:hastypeU-var}) through (\ref{rule:hastypeU-case}), respectively. For example, the following typed expansion rules are based on the typing rules (\ref{rule:hastypeU-var}), (\ref{rule:hastypeU-lam}) and (\ref{rule:hastypeU-ap}), respectively:% for unexpanded expressions of variable, function and application form, respectively: 
% \begin{equation}\label{rule:expandsU-var}
%   \inferrule{ }{\expandsU{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\ux}{x}{\tau}}
% \end{equation}
% \begin{equation}\label{rule:expandsU-lam}
%   \inferrule{
%     \expandsTU{\uDelta}{\utau}{\tau}\\
%     \expandsU{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\ue}{e}{\tau'}
%   }{\expandsUX{\aulam{\utau}{\ux}{\ue}}{\aelam{\tau}{x}{e}}{\aparr{\tau}{\tau'}}}
% \end{equation}
% \begin{equation}\label{rule:expandsU-ap}
%   \inferrule{
%     \expandsUX{\ue_1}{e_1}{\aparr{\tau}{\tau'}}\\
%     \expandsUX{\ue_2}{e_2}{\tau}
%   }{
%     \expandsUX{\auap{\ue_1}{\ue_2}}{\aeap{e_1}{e_2}}{\tau'}
%   }
% \end{equation}
% \begin{equation}\label{rule:expandsU-tlam}
%   \inferrule{
%     \expandsU{\uDelta, \uDhyp{\ut}{t}}{\uGamma}{\uPsi}{\ue}{e}{\tau}
%   }{
%     \expandsUX{\autlam{\ut}{\ue}}{\aetlam{t}{e}}{\aall{t}{\tau}}
%   }
% \end{equation}
% \begin{equation}\label{rule:expandsU-tap}
%   \inferrule{
%     \expandsUX{\ue}{e}{\aall{t}{\tau}}\\
%     \expandsTU{\uDelta}{\utau'}{\tau'}
%   }{
%     \expandsUX{\autap{\ue}{\utau'}}{\aetap{e}{\tau'}}{[\tau'/t]\tau}
%   }
% \end{equation}
% Observe that, in each of these rules, the unexpanded and expanded expression forms in the conclusion correspond, and the premises correspond to those of the typing rule for the expanded expression form, i.e. Rules (\ref{rule:hastypeU-var}) through (\ref{rule:hastypeU-tap}), respectively. In particular, each type expansion premise in each rule above corresponds to a  type formation premise in the corresponding typing rule, and each typed expression expansion premise in each rule above corresponds to a typing premise in the corresponding typing rule. The type assigned in the conclusion of each rule above is identical to the type assigned in the conclusion of the corresponding typing rule. The ueTSM context, $\uPsi$, passes opaquely through these rules (we will define ueTSM contexts below). Rules (\ref{rules:expandsTU}) were similarly generated by mechanically transforming Rules (\ref{rules:istypeU}).

% We can express this scheme more precisely with the following rule transformation. For each rule in Rules (\ref{rules:istypeU}) and Rules (\ref{rules:hastypeU}),
% \begin{mathpar}
% \refstepcounter{equation}
% % \label{rule:expandsU-tlam}
% % \refstepcounter{equation}
% % \label{rule:expandsU-tap}
% % \refstepcounter{equation}
% \label{rule:expandsU-fold}
% \refstepcounter{equation}
% \label{rule:expandsU-unfold}
% \refstepcounter{equation}
% \label{rule:expandsU-tpl}
% \refstepcounter{equation}
% \label{rule:expandsU-pr}
% \refstepcounter{equation}
% \label{rule:expandsU-in}
% \refstepcounter{equation}
% \label{rule:expandsU-case}
% \inferrule{J_1\\ \cdots \\ J_k}{J}
% \end{mathpar}
% the corresponding typed expansion rule is 
% \begin{mathpar}
% \inferrule{
%   \Uof{J_1} \\
%   \cdots\\
%   \Uof{J_k}
% }{
%   \Uof{J}
% }
% \end{mathpar}
% where
% \[\begin{split}
% \Uof{\istypeU{\Delta}{\tau}} & = \expandsTU{\Uof{\Delta}}{\Uof{\tau}}{\tau} \\
% \Uof{\hastypeU{\Gamma}{\Delta}{e}{\tau}} & = \expandsU{\Uof{\Gamma}}{\Uof{\Delta}}{\uPsi}{\Uof{e}}{e}{\tau}\\
% \Uof{\{J_i\}_{i \in \labelset}} & = \{\Uof{J_i}\}_{i \in \labelset}
% \end{split}\]
% and where:
% \begin{itemize}
% \item $\Uof{\tau}$ is defined as follows:
%   \begin{itemize}
%   \item When $\tau$ is of definite form, $\Uof{\tau}$ is defined as in Sec. \ref{sec:syntax-U}.
%   \item When $\tau$ is of indefinite form, $\Uof{\tau}$ is a uniquely corresponding metavariable of sort $\mathsf{UTyp}$ also of indefinite form. For example, in Rule (\ref{rule:istypeU-parr}), $\tau_1$ and $\tau_2$ are of indefinite form, i.e. they match arbitrary types. The rule transformation simply ``hats'' them, i.e. $\Uof{\tau_1}=\utau_1$ and $\Uof{\tau_2}=\utau_2$.
%   \end{itemize}
% \item $\Uof{e}$ is defined as follows
% \begin{itemize}
% \item When $e$ is of definite form, $\Uof{e}$ is defined as in Sec. \ref{sec:syntax-U}. 
% \item When $e$ is of indefinite form, $\Uof{e}$ is a uniquely corresponding metavariable of sort $\mathsf{UExp}$ also of indefinite form. For example, $\Uof{e_1}=\ue_1$ and $\Uof{e_2}=\ue_2$.
% \end{itemize}
% \item $\Uof{\Delta}$ is defined as follows:
%   \begin{itemize} 
%   \item When $\Delta$ is of definite form, $\Uof{\Delta}$ is defined as above.
%   \item When $\Delta$ is of indefinite form, $\Uof{\Delta}$ is a uniquely corresponding metavariable ranging over unexpanded type formation contexts. For example, $\Uof{\Delta} = \uDelta$.
%   \end{itemize}
% \item $\Uof{\Gamma}$ is defined as follows:
%   \begin{itemize}
%   \item When $\Gamma$ is of definite form, $\Uof{\Gamma}$ produces the corresponding unexpanded typing context as follows:
% \begin{align*}
% \Uof{\emptyset} & = \uGG{\emptyset}{\emptyset}\\
% \Uof{\Gamma, \Ghyp{x}{\tau}} & = \Uof{\Gamma}, \uGhyp{\sigilof{x}}{x}{\tau}
% \end{align*}
%   \item When $\Gamma$ is of indefinite form, $\Uof{\Gamma}$ is a uniquely corresponding metavariable ranging over unexpanded typing contexts. For example, $\Uof{\Gamma} = \uGamma$.
% \end{itemize}
% \end{itemize}

% It is instructive to use this rule transformation to generate Rules (\ref{rules:expandsTU}) and Rules (\ref{rule:expandsU-var}) through (\ref{rule:expandsU-tap}) above. We omit the remaining rules, i.e. Rules (\ref*{rule:expandsU-fold}) through (\ref*{rule:expandsU-case}). By instead defining these rules solely by the rule transformation just described, we avoid having to write down a number of rules that are of limited marginal interest. Moreover, this demonstrates the general technique for generating typed expansion rules for unexpanded types and expressions of common form, so our exposition is somewhat ``robust'' to changes to the inner core. 
\vspace{-5px}\begin{grayparbox}
\vspace{8px}
\noindent\fcolorbox{black}{lightgray}{\strut$\ruleExpands{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$}~~$\urv$ has expansion $r$ taking values of type $\tau$ to values of type $\tau'$
\begin{equation}\label{rule:ruleExpands}
\graybox{\inferrule{
  \patExpands{\uAS{\uG'}{\pctx'}}{\uPhi}{\upv}{p}{\tau}\\
  \expandsUP{\uDelta}{\uGG{\uGcons{\uG}{\uG'}}{\Gcons{\Gamma}{\pctx'}}}{\uPsi}{\uPhi}{\ue}{e}{\tau'} 
}{
  \ruleExpands{\uDelta}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\aumatchrule{\upv}{\ue}}{\aematchrule{p}{e}}{\tau}{\tau'}
}}
\end{equation}

Rule (\ref{rule:ruleExpands}) is defined mutually with Rules (\ref{rules:expandsU}).

\subsubsection{Typed Pattern Expansion}
% \vspace{8px}
\noindent\fcolorbox{black}{lightgray}{\strut$\patExpands{\uGamma}{\uPhi}{\upv}{p}{\tau}$}~~$\upv$ has expansion $p$ matching against $\tau$ generating hypotheses $\uGamma$
\begin{subequations}\label{rules:patExpands}
\begin{equation}\label{rule:patExpands-var}
\graybox{\inferrule{ }{
  \patExpands{\uGG{\vExpands{\ux}{x}}{\Ghyp{x}{\tau}}}{\uPhi}{\ux}{x}{\tau}
}}
\end{equation}
\begin{equation}\label{rule:patExpands-wild}
\graybox{\inferrule{ }{
  \patExpands{\uGG{\emptyset}{\emptyset}}{\uPhi}{\wildp}{\aewildp}{\tau}
}}
\end{equation}
\begin{equation}\label{rule:patExpands-fold}
\graybox{\inferrule{ 
  \patExpands{\upctx}{\uPhi}{\upv}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \patExpands{\upctx}{\uPhi}{\foldp{\upv}}{\aefoldp{p}}{\arec{t}{\tau}}
}}
\end{equation}
\begin{equation}\label{rule:patExpands-tpl}
\graybox{
  \inferrule{
    \tau = \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
    \{\patExpands{{\upctx_i}}{\uPhi}{\upv_i}{p_i}{\tau_i}\}_{i \in \labelset}
  }{
    % \left(\shortstack{
    %   $\Delta \vdash_{\uPhi} \tplp{\mapschema{\upv}{i}{\labelset}}$\\
    %   $\leadsto$\\
    %   $\aetplp{\labelset}{\mapschema{p}{i}{\labelset}} : \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$\vspace{-1.2em}}\right)
    \patExpands{\GIconsi{i \in \labelset}{\upctx_i}}{\uPhi}{\tplp{\mapschema{\upv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\tau}
  }
}
% \graybox{\inferrule{
%   \{\patExpands{{\upctx_i}}{\uPhi}{\upv_i}{p_i}{\tau_i}\}_{i \in \labelset}\\
% }{
%   % \patExpands{\Gconsi{i \in \labelset}{\pctx_i}}{\Phi}{
%   %   \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}
%   % }{
%   %   \aetplp{\labelset}{\mapschema{p}{i}{\labelset}}
%   % }{
%   %   \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}
%   % } %{\autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema}{p}{i}{\labelset}}{...}
%   \left(\shortstack{$\Delta \vdash_{\uPhi} \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}$\\$\leadsto$\\$\aetplp{\labelset}{\mapschema{p}{i}{\labelset}} : \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}} \dashV \Gconsi{i \in \labelset}{\upctx_i}$\vspace{-1.2em}}\right)
% }}
\end{equation}
\begin{equation}\label{rule:patExpands-in}
\graybox{\inferrule{
  \patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}
}{
  \patExpands{\upctx}{\uPhi}{\injp{\ell}{\upv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}}
\end{equation}
\begin{equation}\label{rule:patExpands-apuptsm}
\graybox{\inferrule{
  \uPhi = \uPhi', \uPhyp{\tsmv}{a}{\tau}{\eparse}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}}\\
  \decodeCEPat{\ecand}{\cpv}\\\\
    \segOK{\segof{\cpv}}{b}\\
  \cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}
}{
  \patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}
}}
\end{equation}

\end{subequations}

In Rule (\ref{rule:patExpands-tpl}), $\upctx_i$ is shorthand for $\uGG{\uG_i}{\pctx_i}$ and $\GIconsi{i \in \labelset}{\upctx_i}$ is shorthand for \[\uGG{\GIconsi{i \in \labelset}{\uG_i}}{\Gconsi{i \in \labelset}{\pctx_i}}\] 
\end{grayparbox}


% \end{subequations}
% \clearpage
\section{Proto-Expansion Validation}\label{appendix:proto-expansions-SES}
\subsection{Syntax of Proto-Expansions}
$\arraycolsep=2pt\begin{array}{lllllll}
\textbf{Sort} & & & \textbf{Operational Form} & \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{PrTyp} & \ctau & ::= & t & t & \text{variable}\\
&&& \aceparr{\ctau}{\ctau} & \parr{\ctau}{\ctau} & \text{partial function}\\
&&& \aceall{t}{\ctau} & \forallt{t}{\ctau} & \text{polymorphic}\\
&&& \acerec{t}{\ctau} & \rect{t}{\ctau} & \text{recursive}\\
&&& \aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}} & \prodt{\mapschema{\ctau}{i}{\labelset}} & \text{labeled product}\\
&&& \acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}} & \sumt{\mapschema{\ctau}{i}{\labelset}} & \text{labeled sum}\\
% \LCC &&& \lightgray & \lightgray & \lightgray\\
&&& \acesplicedt{m}{n} & \splicedt{m}{n} & \text{spliced type ref.}\\%\ECC
\mathsf{PrExp} & \ce & ::= & x & x & \text{variable}\\
&&& \aceasc{\ctau}{\ce} & \asc{\ce}{\ctau} & \text{ascription}\\
&&& \aceletsyn{x}{\ce}{\ce} & \letsyn{x}{\ce}{\ce} & \text{value binding}\\
&&& \acelam{\ctau}{x}{\ce} & \lam{x}{\ctau}{\ce} & \text{abstraction}\\
&&& \aceap{\ce}{\ce} & \ap{\ce}{\ce} & \text{application}\\
&&& \acetlam{t}{\ce} & \Lam{t}{\ce} & \text{type abstraction}\\
&&& \acetap{\ce}{\ctau} & \App{\ce}{\ctau} & \text{type application}\\
&&& \acefold{\ce} & \fold{\ce} & \text{fold}\\
&&& \aceunfold{\ce} & \unfold{\ce} & \text{unfold}\\
&&& \acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}} & \tpl{\mapschema{\ce}{i}{\labelset}} & \text{labeled tuple}\\
&&& \acepr{\ell}{\ce} & \prj{\ce}{\ell} & \text{projection}\\
&&& \acein{\ell}{\ce} & \inj{\ell}{\ce} & \text{injection}\\
&&& \acecase{\labelset}{\ce}{\mapschemab{x}{\ce}{i}{\labelset}} & \caseof{\ce}{\mapschemab{x}{\ce}{i}{\labelset}} & \text{case analysis}\\
&&& \acesplicede{m}{n}{\ctau} & \splicede{m}{n}{\ctau} & \text{spliced expr. ref.}\\
\LCC \lightgray &\lightgray & \lightgray& \lightgray & \lightgray & \lightgray\\
&&& \acematchwith{n}{\ce}{\seqschemaX{\crv}} & \matchwith{\ce}{\seqschemaX{\crv}} & \text{match}\\
\mathsf{PrRule} & \crv & ::= & \acematchrule{p}{\ce} & \matchrule{p}{\ce} & \text{rule}\\
\mathsf{PrPat} & \cpv & ::= & \acewildp & \wildp & \text{wildcard pattern}\\
&&& \acefoldp{p} & \foldp{p} & \text{fold pattern}\\
&&& \acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}} & \tplp{\mapschema{\cpv}{i}{\labelset}} & \text{labeled tuple pattern}\\
&&& \aceinjp{\ell}{\cpv} & \injp{\ell}{\cpv} & \text{injection pattern}\\
% \LCC &&& \color{Yellow} & \color{Yellow} & \color{Yellow}\\
&&& \acesplicedp{m}{n}{\ctau} & \splicedp{m}{n}{\ctau} & \text{spliced pattern ref.}\ECC
\end{array}$

\subsubsection{Common Proto-Expansion Terms} Each expanded term\graytxtbox{, except variable patterns,} maps onto a proto-expansion term. We refer to these as the \emph{common proto-expansion terms}. In particular:
\begin{itemize}
  \item Each type, $\tau$, maps onto a proto-type, $\Cof{\tau}$, as follows:
  \[\arraycolsep=1pt\begin{array}{rl}
  \Cof{t} & = t\\
  \Cof{\aparr{\tau_1}{\tau_2}} & = \aceparr{\Cof{\tau_1}}{\Cof{\tau_2}}\\
  \Cof{\aall{t}{\tau}} & = \aceall{t}{\Cof{\tau}}\\
  \Cof{\arec{t}{\tau}} & = \acerec{t}{\Cof{\tau}}\\
  \Cof{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \aceprod{\labelset}{\mapschemax{\Cofv}{\tau}{i}{\labelset}}\\
  \Cof{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \acesum{\labelset}{\mapschemax{\Cofv}{\tau}{i}{\labelset}}
  \end{array}\]
  \item Each expanded expression, $e$, maps onto a proto-expression, $\Cof{e}$, as follows:
  \[\arraycolsep=1pt\begin{array}{rl}
  \Cof{x} & = x\\
  \Cof{\aelam{\tau}{x}{e}} & = \acelam{\Cof{\tau}}{x}{\Cof{e}}\\
  \Cof{\aeap{e_1}{e_2}} & = \aceap{\Cof{e_1}}{\Cof{e_2}}\\
  \Cof{\aetlam{t}{e}} & = \acetlam{t}{\Cof{e}}\\
  \Cof{\aetap{e}{\tau}} & = \acetap{\Cof{e}}{\Cof{\tau}}\\
  \Cof{\aefold{e}} & = \acefold{\Cof e}\\
  \Cof{\aeunfold{e}} & = \aceunfold{\Cof{e}}\\
  \Cof{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}} & = \acetpl{\labelset}{\mapschemax{\Cofv}{e}{i}{\labelset}}\\
  \Cof{\aein{\ell}{e}} &= \acein{\ell}{\Cof{e}}\\
  \LCC \lightgray & \lightgray \\
  \Cof{\aematchwith{n}{e}{\seqschemaX{r}}} & = \acematchwith{n}{\Cof{e}}{\seqschemaXx{\Cofv}{r}} \ECC
  \end{array}\]
  \end{itemize}
  \begin{grayparbox}
  \begin{itemize}
  \item Each expanded rule, $r$, maps onto the proto-rule, $\Cof{r}$, as follows:
  \begin{align*}
  \Cof{\aematchrule{p}{e}} & = \acematchrule{p}{\Cof{e}}
  \end{align*}
  Notice that proto-rules bind expanded patterns, not proto-patterns. This is because proto-rules appear in proto-expressions, which are generated by seTSMs. It would not be sensible for an seTSM to splice a pattern out of a literal body.
  \item Each expanded pattern, $p$, except for the variable patterns, maps onto a proto-pattern, $\Cof{p}$, as follows:
  \begin{align*}
  \Cof{\aewildp} & = \acewildp\\
  \Cof{\aefoldp{p}} & = \acefoldp{\Cof{p}}\\
  \Cof{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}} & = \acetplp{\labelset}{\mapschemax{\Cofv}{p}{i}{\labelset}}\\
  \Cof{\aeinjp{\ell}{p}} & = \aceinjp{\ell}{\Cof{p}}
  \end{align*}
\end{itemize}
\end{grayparbox}

\subsubsection{Proto-Expression Encoding and Decoding}
The type abbreviated $\tCEExp$ classifies encodings of \emph{proto-expressions}. The mapping from proto-expressions to values of type $\tCEExp$ is defined by the \emph{proto-expression encoding judgement}, $\encodeCondE{\ce}{e}$. An inverse mapping is defined by the \emph{proto-expression decoding judgement}, $\decodeCondE{e}{\ce}$.

\[\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\encodeCondE{\ce}{e} & \text{$\ce$ has encoding $e$}\\
\decodeCondE{e}{\ce} & \text{$e$ has decoding $\ce$}
\end{array}\]

Rather than picking a particular definition of $\tCEExp$ and defining the judgements above inductively against it, we only state the following condition, which establishes an isomorphism between values of type $\tCEExp$ and proto-expressions.

\begin{condition}[Proto-Expression Isomorphism]\label{condition:proto-expression-isomorphism} ~
\begin{enumerate}
\item For every $\ce$, we have $\encodeCondE{\ce}{\ecand}$ for some $\ecand$ such that $\hastypeUC{\ecand}{\tCEExp}$ and $\isvalU{\ecand}$.
\item If $\hastypeUC{\ecand}{\tCEExp}$ and $\isvalU{\ecand}$ then $\decodeCondE{\ecand}{\ce}$ for some $\ce$.
\item If $\encodeCondE{\ce}{\ecand}$ then $\decodeCondE{\ecand}{\ce}$.
\item If $\hastypeUC{\ecand}{\tCEExp}$ and $\isvalU{\ecand}$ and $\decodeCondE{\ecand}{\ce}$ then $\encodeCondE{\ce}{\ecand}$.
\item If $\encodeCondE{\ce}{\ecand}$ and $\encodeCondE{\ce}{\ecand'}$ then $\ecand=\ecand'$.
\item If $\hastypeUC{\ecand}{\tCEExp}$ and $\isvalU{\ecand}$ and $\decodeCondE{\ecand}{\ce}$ and $\decodeCondE{\ecand}{\ce'}$ then $\ce=\ce'$.
\end{enumerate}
\end{condition}\vspace{10px}

\begin{grayparbox}\vspace{-16px}
\subsubsection{Proto-Pattern Encoding and Decoding}
The type abbreviated $\tCEPat$ classifies encodings of \emph{proto-patterns}. The mapping from proto-patterns to values of type $\tCEPat$ is defined by the \emph{proto-pattern encoding judgement}, $\encodeCEPat{\cpv}{p}$. An inverse mapping is defined by the \emph{proto-expression decoding judgement}, $\decodeCEPat{p}{\cpv}$.

\[\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\encodeCEPat{\cpv}{p} & \text{$\cpv$ has encoding $p$}\\
\decodeCEPat{p}{\cpv} & \text{$p$ has decoding $\cpv$}
\end{array}\]

Again, rather than picking a particular definition of $\tCEPat$ and defining the judgements above inductively against it, we only state the following condition, which establishes an isomorphism between values of type $\tCEPat$ and proto-patterns.

\begin{condition}[Proto-Pattern Isomorphism]\label{condition:proto-pattern-isomorphism} ~
\begin{enumerate}
\item For every $\cpv$, we have $\encodeCEPat{\cpv}{\ecand}$ for some $\ecand$ such that $\hastypeUC{\ecand}{\tCEPat}$ and $\isvalU{\ecand}$.
\item If $\hastypeUC{\ecand}{\tCEPat}$ and $\isvalU{\ecand}$ then $\decodeCEPat{\ecand}{\cpv}$ for some $\cpv$.
\item If $\encodeCEPat{\cpv}{\ecand}$ then $\decodeCEPat{\ecand}{\cpv}$.
\item If $\hastypeUC{\ecand}{\tCEPat}$ and $\isvalU{\ecand}$ and $\decodeCEPat{\ecand}{\cpv}$ then $\encodeCEPat{\cpv}{\ecand}$.
\item If $\encodeCEPat{\cpv}{\ecand}$ and $\encodeCEPat{\cpv}{\ecand'}$ then $\ecand=\ecand'$.
\item If $\hastypeUC{\ecand}{\tCEPat}$ and $\isvalU{\ecand}$ and $\decodeCEPat{\ecand}{\cpv}$ and $\decodeCEPat{\ecand}{\cpv'}$ then $\cpv=\cpv'$.
\end{enumerate}
\end{condition}
\end{grayparbox}

\subsubsection{Splice Summaries}
The \emph{splice summary} of a proto-expression, $\summaryOf{\ce}$, \graytxtbox{or proto-pattern, $\summaryOf{\cpv}$,} is the finite set of references to spliced types, expressions \graytxtbox{and patterns} that it mentions.

\subsubsection{Segmentations}
A \emph{segment set}, $\psi$, is a finite set of pairs of natural numbers indicating the locations of spliced terms. The \emph{segmentation} of a proto-expression, $\segof{\ce}$, or proto-pattern, $\segof{\cpv}$, is the segment set implied by its splice summary.


% Segments consist of two natural numbers and a sort, i.e. segments are of the form $\segExp{m}{n}$ or $\segTyp{m}{n}$\graytxtbox{ or $\segPat{m}{n}$}.

% The metafunction $\segof{\ce}$ determines the segmentation of $\ce$ by generating one segment for each reference to a spliced expression or type, respectively. More specifically:
% \begin{itemize}
% \item We define $\segof{\ctau}$ as follows:
% \[\arraycolsep=1pt\begin{array}{rl}
%   \segof{t} & = \emptyset\\
%   \segof{\aceparr{\ctau_1}{\ctau_2}} & = \segof{\ctau_1} \cup \segof{\ctau_2}\\
%   \segof{\aceall{t}{\ctau}} &= \segof{\ctau}\\
%   \segof{\acerec{t}{\ctau}} & = \segof{\ctau}\\
%   \segof{\aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\ctau_i}\\
%   \segof{\acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\ctau_i}\\
%   \segof{\acesplicedt{m}{n}} & = \{ \segTyp{m}{n} \}
%   \end{array}\]
% \item We define $\segof{\ce}$ as follows:
% \[\arraycolsep=1pt\begin{array}{rl} 

% \segof{x} & = \emptyset\\
% \segof{\acelam{\ctau}{x}{\ce}} & = \segof{\ctau} \cup \segof{\ce} \\
% \segof{\acetlam{t}{\ce}} & = \segof{\ce}\\
% \segof{\acetap{\ce}{\ctau}} & = \segof{\ctau} \cup \segof{\ce}\\
% \segof{\acefold{\ce}} & = \segof{\ce}\\
% \segof{\aceunfold{\ce}} & = \segof{\ce}\\
% \segof{\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\ce_i}\\
% \segof{\acepr{\ell}{\ce}} & = \segof{\ce}\\
% \segof{\acein{\ell}{\ce}} & = \segof{\ce}\\
% \segof{\acecase{\labelset}{\ce}{\mapschemab{x}{\ce}{i}{\labelset}}} & = \segof{\ce} \cup_{i \in \labelset} \segof{\ce_i}\\
% \segof{\acesplicede{m}{n}{\ctau}} & = \{ \segExp{m}{n} \} \cup \segof{\ctau}\\
% \LCC \lightgray & \lightgray\\
% \segof{\acematchwith{n}{\ce}{\seqschemaX{\crv}}} & = \segof{\ce} \cup_{1 \leq i \leq n} \segof{\crv_i}\ECC 
% \end{array}\]
% \end{itemize}
% \begin{grayparbox}
% \begin{itemize}
% \item We define $\segof{\crv}$ as follows:
% \[\arraycolsep=1pt\begin{array}{rl} 

% \segof{\acematchrule{p}{\ce}} & = \segof{\ce}
% \end{array}\]
% \end{itemize}

% The metafunction $\segof{\cpv}$ determines the segmentation of $\cpv$ by generating one segment for each reference to a spliced type or pattern:
% \[
% \arraycolsep=1pt\begin{array}{rl}

% \segof{\acewildp} & = \emptyset\\
% \segof{\acefoldp{\cpv}} & = \segof{\cpv}\\
% \segof{\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\cpv_i}\\
% \segof{\aceinjp{\ell}{\cpv}} & = \segof{\cpv}\\
% \segof{\acesplicedp{m}{n}{\ctau}} & = \{ \segPat{m}{n} \} \cup \segof{\ctau}
% \end{array}
% \]

% \end{grayparbox}

The predicate $\segOK{\psi}{b}$ checks that each segment in $\psi$, has non-negative length and is within bounds of $b$, and that the segments in $\psi$ do not overlap.


\subsection{Proto-Type Validation}\label{appendix:proto-type-validation-SES}
%Each of these rules is defined based on the corresponding type formation rule, i.e. Rules (\ref{rule:istypeU-var}) through (\ref{rule:istypeU-sum}), respectively. For example, the following candidate expansion type validation rules are based on type formation rules (\ref{rule:istypeU-var}), (\ref{rule:istypeU-parr}) and (\ref{rule:istypeU-all}), respectively: 
\emph{Type splicing scenes}, $\tscenev$, are of the form $\tsceneUP{\uDelta}{b}$.

\vspace{10px}\noindent\fbox{\strut$\cvalidT{\Delta}{\tscenev}{\ctau}{\tau}$}~~$\ctau$ has well-formed expansion $\tau$
\begin{subequations}\label{rules:cvalidT-U}
\begin{equation}\label{rule:cvalidT-U-tvar}
\inferrule{ }{
  \cvalidT{\Delta, \Dhyp{t}}{\tscenev}{t}{t}
}
\end{equation}
\begin{equation}\label{rule:cvalidT-U-parr}
  \inferrule{
    \cvalidT{\Delta}{\tscenev}{\ctau_1}{\tau_1}\\
    \cvalidT{\Delta}{\tscenev}{\ctau_2}{\tau_2}
  }{
    \cvalidT{\Delta}{\tscenev}{\aceparr{\ctau_1}{\ctau_2}}{\aparr{\tau_1}{\tau_2}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidT-U-all}
  \inferrule {
    \cvalidT{\Delta, \Dhyp{t}}{\tscenev}{\ctau}{\tau}
  }{
    \cvalidT{\Delta}{\tscenev}{\aceall{t}{\ctau}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidT-U-rec}
  \inferrule{
    \cvalidT{\Delta, \Dhyp{t}}{\tscenev}{\ctau}{\tau}
  }{
    \cvalidT{\Delta}{\tscenev}{\acerec{t}{\ctau}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidT-U-prod}
  \inferrule{
    \{\cvalidT{\Delta}{\tscenev}{\ctau_i}{\tau_i}\}_{i \in \labelset}
  }{
    \cvalidT{\Delta}{\tscenev}{\aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidT-U-sum}
  \inferrule{
    \{\cvalidT{\Delta}{\tscenev}{\ctau_i}{\tau_i}\}_{i \in \labelset}
  }{
    \cvalidT{\Delta}{\tscenev}{\acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidT-U-splicedt}
  \inferrule{
    \parseUTyp{\bsubseq{b}{m}{n}}{\utau}\\
    \expandsTU{\uDD{\uD}{\Delta_\text{app}}}{\utau}{\tau}\\
    \Delta \cap \Delta_\text{app} = \emptyset
  }{
    \cvalidT{\Delta}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\acesplicedt{m}{n}}{\tau}
  }
\end{equation}
\end{subequations}


%Rule (\ref*{rule:cvalidT-U-splicedt}) governs this form:
%\chapter{Dependent Labeled Product Kinds}
% \begin{landscape}
% \begin{equation}\label{rule:iskind-dlprod}
% \inferrule{
% 	\{\iskind{\Omega}{\Delta \cup \{u_{i, j} :: \kappa_j\}_{1 \leq j < i}}{\Gamma}{\kappa_i}\}_{1 \leq i \leq n}
% }{
% 	\iskindX{\akdprodstd}
% }
% \end{equation}

% \begin{equation}\label{rule:kequal-dlprod}
% \inferrule{
% 	\{\kequal{\Omega}{\Delta \cup \{u_{i, j} :: \kappa_j\}_{1 \leq j < i}}{\Gamma}{\kappa_i}{\kappa'_i}\}_{1 \leq i \leq n}
% }{
% 	\kequalX{\akdprodstd}{\akdprod{n}{\seqschemaX{\ell}}{\seqschemaijb{u}{\kappa'}{i}{1}{n}{j}{1}{i}}}
% }
% \end{equation}
% \begin{equation}\label{rule:ksub-dlprod}
% \inferrule{
% 	\{\ksub{\Omega}{\Delta \cup \{u_{i,j} :: \kappa_j\}_{1 \leq j < i}}{\Gamma}{\kappa_i}{\kappa'_i}\}_{1 \leq i \leq n}
% }{
% 	\ksubX{\akdprodstd}{\akdprod{n}{\seqschemaX{\ell}}{\seqschemaijb{u}{\kappa'}{i}{1}{n}{j}{1}{i}}}
% }
% \end{equation}
% \begin{equation}\label{rule:haskind-dtpl}
% \inferrule{
% 	\{\haskind{\Omega}{\Delta \cup \{u_{i, j} :: \aksing{c_j}\}_{1 \leq j < i}}{\Gamma}{c_i}{\kappa_i}\}_{1 \leq i \leq n}
% }{
% 	\haskindX{\adtplX}{\akdprodstd}
% }
% \end{equation}
% \begin{equation}\label{rule:haskind-prj}
% \inferrule{
% 	\haskindX{c}{
% 		\akdprod{
% 			n' + 1 + n''
% 		}{
% 			\seqschema{\ell'}{i}{1}{n'}, \ell, \seqschema{\ell''}{i}{1}{n''}
% 		}{
% 			\seqschemaijb{u'}{\kappa'}{i}{1}{n'}{j}{1}{i};
% 			\{u_{j}\}_{1 \leq j \leq n'}.\kappa;
% 			\seqschemaijb{u''}{\kappa''}{i}{1}{n''}{j}{1}{i}
% 		}
% 	}
% }{
% 	\haskindX{\adprj{\ell}{c}}{[\{\adprj{\ell'_j}{c}/u_{j}\}_{1 \leq j \leq n'}]\kappa}
% }
% \end{equation}
% \begin{equation}\label{rule:cequal-dtpl}
% \inferrule{
% 	c=\adtplX\\
% 	c'=\adtpl{n}{\seqschemaX{\ell}}{\seqschemaijb{u}{c'}{i}{1}{n}{j}{1}{i}}\\\\
% 	\{\cequal{\Omega}{\Delta \cup \{u_{i, j} :: \aksing{\kappa_j}\}_{1 \leq j < i}}{\Gamma}{c_i}{c'_i}{\kappa_i}\}_{1 \leq i \leq n}
% }{
% 	\cequalX{c}{c'}{\akdprodstd}
% }
% \end{equation}
% \begin{equation}\label{rule:cequal-prj-1}
% \inferrule{
%   \cequalX{c}{c'}{
% 		\akdprod{
% 			n' + 1 + n''
% 		}{
% 			\seqschema{\ell'}{i}{1}{n'}, \ell, \seqschema{\ell''}{i}{1}{n''}
% 		}{
% 			\seqschemaijb{u'}{\kappa'}{i}{1}{n'}{j}{1}{i};
% 			\{u_{j}\}_{1 \leq j \leq n'}.\kappa;
% 			\seqschemaijb{u''}{\kappa''}{i}{1}{n''}{j}{1}{i}
% 		}
% 	}	
% }{
% 	\cequalX{\adprj{\ell}{c}}{\adprj{\ell}{c'}}{\kappa}
% }
% \end{equation}
% \begin{equation}\label{rule:cequal-prj-2}
% \inferrule{
% 	c = \adtpl{
% 				n' + 1 + n''
% 			}{
% 				\seqschema{\ell'}{i}{1}{n'}, \ell, \seqschema{\ell''}{i}{1}{n''}
% 			}{
% 				\seqschemaijb{u'}{c'}{i}{1}{n'}{j}{1}{i};
% 				\{u_j\}_{1 \leq j \leq n}.c_\ell; 
% 				\seqschemaijb{u''}{c''}{i}{1}{n''}{j}{1}{i}
% 			}\\
% 	\haskindX{c}{
% 		\akdprod{
% 			n' + 1 + n''
% 		}{
% 			\seqschema{\ell'}{i}{1}{n'}, \ell, \seqschema{\ell''}{i}{1}{n''}
% 		}{
% 			\seqschemaijb{u'}{\kappa'}{i}{1}{n'}{j}{1}{i};
% 			\{u_{j}\}_{1 \leq j \leq n'}.\kappa;
% 			\seqschemaijb{u''}{\kappa''}{i}{1}{n''}{j}{1}{i}
% 		}
% 	}
% }{
% 	\cequalX{
% 		\adprj{\ell}{
% 			c
% 		}
% 	}{[\{\adprj{\ell'_j}{c}/u_j\}_{1 \leq j \leq n'}]c_\ell}{[\{\adprj{\ell'_j}{c}/u_j\}_{1 \leq j \leq n'}]\kappa}
% }
% \end{equation}

% \end{landscape}

\subsection{Proto-Expression Validation}

\emph{Expression splicing scenes}, $\escenev$, are of the form $\esceneSGB{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}$. We write $\tsfrom{\escenev}$ for the type splicing scene constructed by dropping unnecessary contexts from $\escenev$:
\[\tsfrom{\esceneSGB{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}} = \tsceneUP{\uDelta}{b}\]

\vspace{10px}\noindent\fbox{\strut$\cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\tau}$}~~$\ce$ has expansion $e$ of type $\tau$
\begin{subequations}\label{rules:cvalidE-U}
\begin{equation}\label{rule:cvalidE-U-var}
\inferrule{ }{
  \cvalidE{\Delta}{\Gamma, \Ghyp{x}{\tau}}{\escenev}{x}{x}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidE-U-asc}
\inferrule{
  \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau}{\tau}\\
  \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\tau}
}{
  \cvalidE{\Delta}{\Gamma}{\escenev}{\aceasc{\ctau}{\ce}}{e}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidE-U-letsyn}
  \inferrule{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce_1}{e_1}{\tau_1}\\
    \cvalidE{\Delta}{\Gamma, x : \tau_1}{\ce_2}{e_2}{\tau_2}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\aceletsyn{x}{\ce_1}{\ce_2}}{
      \aeap{\aelam{\tau_1}{x}{e_2}}{e_1}
    }{\tau_2}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-lam}
\inferrule{
  \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau}{\tau}\\
  \cvalidE{\Delta}{\Gamma, \Ghyp{x}{\tau}}{\escenev}{\ce}{e}{\tau'}
}{
  \cvalidE{\Delta}{\Gamma}{\escenev}{\acelam{\ctau}{x}{\ce}}{\aelam{\tau}{x}{e}}{\aparr{\tau}{\tau'}}
}
\end{equation}
\begin{equation}\label{rule:cvalidE-U-ap}
  \inferrule{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce_1}{e_1}{\aparr{\tau}{\tau'}}\\
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce_2}{e_2}{\tau}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\aceap{\ce_1}{\ce_2}}{\aeap{e_1}{e_2}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-tlam}
  \inferrule{
    \cvalidE{\Delta, \Dhyp{t}}{\Gamma}{\escenev}{\ce}{e}{\tau}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\acetlam{t}{\ce}}{\aetlam{t}{e}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-tap}
  \inferrule{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\aall{t}{\tau}}\\
    \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau'}{\tau'}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\acetap{\ce}{\ctau'}}{\aetap{e}{\tau'}}{[\tau'/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-fold}
  \inferrule{\
    % \cvalidT{\Delta, \Dhyp{t}}{\tsfrom{\escenev}}{\ctau}{\tau}\\
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\acefold{\ce}}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-unfold}
  \inferrule{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\arec{t}{\tau}}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\aceunfold{\ce}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-tpl}
  \inferrule{
    \tau = \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
    \{\cvalidE{\Delta}{\Gamma}{\escenev}{\ce_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
  % \left(\shortstack{$\Delta~\Gamma \vdash^{\escenev} \acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}$\\$\leadsto$\\$\aetpl{\labelset}{\mapschema{e}{i}{\labelset}} : \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$\vspace{-1.2em}}\right)
    \cvalidE{\Delta}{\Gamma}{\escenev}{\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-pr}
  \inferrule{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\acepr{\ell}{\ce}}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-in}
  \inferrule{
    % \{\cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau_i}{\tau_i}\}_{i \in \labelset}\\
    % \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau}{\tau}\\
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\tau'}
  }{
    % \left(\shortstack{
    %   $\Delta~\Gamma \vdash^{\escenev} \acein{\ell}{\ce}$\\
    %   $\leadsto$\\
    %   $\aein{\ell}{e} : \asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}$\vspace{-1.2em}
    % }\right)
    \cvalidE{\Delta}{\Gamma}{\escenev}{\acein{\ell}{\ce}}{\aein{\ell}{e}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau'}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-case}
  \inferrule{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}\\
    % \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau}{\tau}\\
    \{\cvalidE{\Delta}{\Gamma, x_i : \tau_i}{\escenev}{\ce_i}{e_i}{\tau}\}_{i \in \labelset}
  }{
    \cvalidE{\Delta}{\Gamma}{\escenev}{\acecase{\labelset}{\ce}{\mapschemab{x}{\ce}{i}{\labelset}}}{\aecase{\labelset}{e}{\mapschemab{x}{e}{i}{\labelset}}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-U-splicede}
\inferrule{
  \cvalidT{\emptyset}{\tsfrom{\escenev}}{\ctau}{\tau}\\
  \escenev=\esceneSGB{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}\\
  \parseUExp{\bsubseq{b}{m}{n}}{\ue}\\
  \expandsSG{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{\ue}{e}{\tau}\\\\
  \Delta \cap \Delta_\text{app} = \emptyset\\
  \domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset
}{
  \cvalidE{\Delta}{\Gamma}{\escenev}{\acesplicede{m}{n}{\ctau}}{e}{\tau}
}
\end{equation}
\begin{grayparbox}
\begin{equation}\label{rule:cvalidE-U-match}
\graybox{\inferrule{
  % \escenev = \esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGamma}{\uPsi}{\uPhi}{b}\\\\
  % \istypeU{\Delta \cup \Delta_\text{app}}{\tau'}\\
  \cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\tau}\\
  % \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau'}{\tau'}\\\\
  \{\cvalidR{\Delta}{\Gamma}{\escenev}{\crv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}\\
}{\cvalidE{\Delta}{\Gamma}{\escenev}{\acematchwith{n}{\ce}{\seqschemaX{\crv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}}}
\end{equation}
\end{grayparbox}
\end{subequations}
% \clearpage
\vspace{-5px}
\begin{grayparbox}
\vspace{15px}
\noindent\fbox{\strut$\cvalidR{\Delta}{\Gamma}{\escenev}{\crv}{r}{\tau}{\tau'}$}~~$\crv$ has expansion $r$ taking values of type $\tau$ to values of type $\tau'$
\begin{equation}\label{rule:cvalidR-UP}
\inferrule{
  % \escenev = \esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGamma}{\uPsi}{\uPhi}{b}\\\\
  \patTypeD{\Delta \cup \Delta_\text{app}}{\pctx'}{p}{\tau}\\
  \cvalidE{\Delta}{\Gcons{\Gamma}{\pctx'}}{\escenev}{\ce}{e}{\tau'}
}{
  \cvalidR{\Delta}{\Gamma}{\escenev}{\acematchrule{p}{\ce}}{\aematchrule{p}{e}}{\tau}{\tau'}
}
\end{equation}
\end{grayparbox}
\vspace{-5px}\begin{grayparbox}
\subsection{Proto-Pattern Validation}\label{appendix:proto-pattern-validation-P}
\emph{Pattern splicing scenes}, $\pscenev$, are of the form $\pscene{\uDelta}{\uPhi}{b}$.

\vspace{10px}\noindent\fbox{\strut$\cvalidP{\upctx}{\pscenev}{\cpv}{p}{\tau}$}~~$\cpv$ has expansion $p$ matching against $\tau$ generating hypotheses $\upctx$
% \begin{grayparbox}
\begin{subequations}\label{rules:cvalidP-UP}
\begin{equation}\label{rule:cvalidP-UP-wild}
\inferrule{ }{
  \cvalidP{\uGG{\emptyset}{\emptyset}}{\pscenev}{\acewildp}{\aewildp}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-UP-fold}
\inferrule{
  \cvalidP{\upctx}{\pscenev}{\cpv}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \cvalidP{\upctx}{\pscenev}{\acefoldp{\cpv}}{\aefoldp{p}}{\arec{t}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-UP-tpl}
\inferrule{
  \tau = \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
  \{\cvalidP{\upctx_i}{\pscenev}{\cpv_i}{p_i}{\tau_i}\}_{i \in \labelset}
}{
% \left(\shortstack{$\vdash^{\pscenev} \acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}$\\$\leadsto$\\$\aetplp{\labelset}{\mapschema{p}{i}{\labelset}} : \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}~\dashVx^{\,\Gconsi{i \in \labelset}{\upctx_i}}$\vspace{-1.2em}}\right)
  \cvalidP{\GIconsi{i \in \labelset}{\upctx_i}}{\pscenev}{\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-UP-in}
\inferrule{
  \cvalidP{\upctx}{\pscenev}{\cpv}{p}{\tau}
}{
  \cvalidP{\upctx}{\pscenev}{\aceinjp{\ell}{\cpv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-UP-spliced}
\inferrule{
  \cvalidT{\emptyset}{\tsceneUP{\uDelta}{b}}{\ctau}{\tau}\\
  \parseUPat{\bsubseq{b}{m}{n}}{\upv}\\
  \patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}
}{
  \cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\acesplicedp{m}{n}{\ctau}}{p}{\tau}
}
\end{equation}
\end{subequations}
\end{grayparbox}
% Observe that, in each of these rules, the proto-expression form and the expanded expression form in the conclusion correspond, and the premises correspond to those of the corresponding typing rule, i.e. Rules (\ref{rule:hastypeU-var}) through (\ref{rule:hastypeU-ap}), respectively. The expression splicing scene, $\escenev$, passes opaquely through these rules.


% We can express this scheme more precisely with the following rule transformation. For each rule in Rules (\ref{rules:hastypeU}),
% \begin{mathpar}\refstepcounter{equation}
% \label{rule:cvalidE-U-tlam}
% \refstepcounter{equation}
% \label{rule:cvalidE-U-tap}
% \refstepcounter{equation}
% \label{rule:cvalidE-U-fold}
% \refstepcounter{equation}
% \label{rule:cvalidE-U-unfold}
% \refstepcounter{equation}
% \label{rule:cvalidE-U-tpl}
% \refstepcounter{equation}
% \label{rule:cvalidE-U-pr}
% \refstepcounter{equation}
% \label{rule:cvalidE-U-in}
% \refstepcounter{equation}
% \label{rule:cvalidE-U-case}
%   \inferrule{
%     J_1\\
%     \cdots\\
%     J_k
%   }{
%     J
%   }
% \end{mathpar}
% the corresponding proto-expression validation rule is 
% \begin{mathpar}
%   \inferrule{
%     \Cof{J_1}\\
%     \cdots\\
%     \Cof{J_k}
%   }{
%     \Cof{J}
%   }
% \end{mathpar}
% where 
% \[\begin{split}
%   \Cof{\istypeU{\Delta}{\tau}} & = \cvalidT{\Delta}{\tsfrom{\escenev}}{\Cof{\tau}}{\tau}\\
%   \Cof{\hastypeU{\Delta}{\Gamma}{e}{\tau}} & = \cvalidE{\Delta}{\Gamma}{\escenev}{\Cof{e}}{e}{\tau}\\
%   \Cof{\{J_i\}_{i \in \labelset}} & = \{\Cof{J_i}\}_{i \in \labelset}
% \end{split}\]
% and where:
% \begin{itemize}
% \item $\Cof{\tau}$ is defined as follows:
%   \begin{itemize}
%   \item When $\tau$ is of definite form, $\Cof{\tau}$ is defined as in Sec. \ref{sec:ce-syntax-U}.
%   \item When $\tau$ is of indefinite form, $\Cof{\tau}$ is a uniquely corresponding metavariable of sort $\mathsf{CETyp}$ also of indefinite form. For example, $\Cof{\tau_1}=\ctau_1$ and $\Cof{\tau_2}=\ctau_2$.
%   \end{itemize}
% \item $\Cof{e}$ is defined as follows
%   \begin{itemize}
%   \item When $e$ is of definite form, $\Cof{e}$ is defined as in Sec. \ref{sec:ce-syntax-U}. 
%   \item When $e$ is of indefinite form, $\Cof{e}$ is a uniquely corresponding metavariable of sort $\mathsf{CEExp}$ also of indefinite form. For example, $\Cof{e_1}=\ce_1$ and $\Cof{e_2}=\ce_2$.
%   \end{itemize}
% \end{itemize}

% It is instructive to use this rule transformation to generate Rules (\ref{rule:cvalidE-U-var}) through (\ref{rule:cvalidE-U-ap}) above. We omit the remaining rules for common forms, i.e. Rules (\ref*{rule:cvalidE-U-tlam}) through (\ref*{rule:cvalidE-U-case}).

\section{Metatheory}\label{appendix:metatheory-SES}
\subsection{Type Expansion}
% The Type Expansion Lemma establishes that the expansion of an unexpanded type is a well-formed type.

\begin{lemma}[Type Expansion]\label{lemma:type-expansion-U} If $\expandsTU{\uDD{\uD}{\Delta}}{\utau}{\tau}$ then $\istypeU{\Delta}{\tau}$.\end{lemma}
\begin{proof} By rule induction over Rules (\ref{rules:expandsTU}). In each case, we apply the IH to or over each premise, then apply the corresponding type formation rule in Rules (\ref{rules:istypeU}). \end{proof}

\begin{lemma}[Proto-Type Validation]\label{lemma:candidate-expansion-type-validation}
If $\cvalidT{\Delta}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\ctau}{\tau}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ then $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau}$.
\end{lemma}
\begin{proof} By rule induction over Rules (\ref{rules:cvalidT-U}).
\begin{byCases}
\item[\text{(\ref{rule:cvalidT-U-tvar})}] ~
\begin{pfsteps*}
   \item $\Delta=\Delta', \Dhyp{t}$ \BY{assumption}
   \item $\ctau=t$ \BY{assumption}
   \item $\tau=t$ \BY{assumption}
   \item $\istypeU{\Delta', \Dhyp{t}}{t}$ \BY{Rule (\ref{rule:istypeU-var})} \pflabel{istype}
   \item $\istypeU{\Dcons{\Delta', \Dhyp{t}}{\Delta_\text{app}}}{t}$ \BY{Lemma \ref{lemma:weakening-U} over $\Delta_\text{app}$ to \pfref{istype}}
 \end{pfsteps*} 
\resetpfcounter

\item[\text{(\ref{rule:cvalidT-U-parr})}] ~
\begin{pfsteps*}
  \item $\ctau=\aceparr{\ctau_1}{\ctau_2}$ \BY{assumption}
  \item $\tau=\aparr{\tau_1}{\tau_2}$ \BY{assumption}
  \item $\cvalidT{\Delta}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\ctau_1}{\tau_1}$ \BY{assumption} \pflabel{cvalid-ctau1}
  \item $\cvalidT{\Delta}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\ctau_2}{\tau_2}$ \BY{assumption} \pflabel{cvalid-ctau2}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau_1}$ \BY{IH on \pfref{cvalid-ctau1}} \pflabel{istype1}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau_2}$ \BY{IH on \pfref{cvalid-ctau2}} \pflabel{istype2}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\aparr{\tau_1}{\tau_2}}$ \BY{Rule (\ref{rule:istypeU-parr}) on \pfref{istype1} and \pfref{istype2}}
\end{pfsteps*}
\resetpfcounter

\item[\text{(\ref{rule:cvalidT-U-all})}] ~
\begin{pfsteps*}
  \item $\ctau=\aceall{t}{\ctau'}$ \BY{assumption}
  \item $\tau=\aall{t}{\tau'}$ \BY{assumption}
  \item $\cvalidT{\Delta, \Dhyp{t}}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\ctau'}{\tau'}$ \BY{assumption} \label{cvalidT}
  \item $\istypeU{\Dcons{\Delta, \Dhyp{t}}{\Delta_\text{app}}}{\tau'}$ \BY{IH on \pfref{cvalidT}} \pflabel{istypeU1}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}, \Dhyp{t}}{\tau'}$ \BY{exchange over $\Delta_\text{app}$ on \pfref{istypeU1}} \pflabel{istypeU2}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\aall{t}{\tau'}}$ \BY{Rule (\ref{rule:istypeU-all}) on \pfref{istypeU2}}
\end{pfsteps*}
\resetpfcounter

% \item[{\text{(\ref{rule:cvalidT-U-rec})}}~\textbf{through}~{\text{(\ref{rule:cvalidT-U-sum})}}] These cases follow analagously, i.e. we apply the IH to or over all proto-type validation premises, apply exchange as needed, and then apply the corresponding type formation rule.
% \\
\item[\text{(\ref{rule:cvalidT-U-rec})}] ~
\begin{pfsteps*}
  \item $\ctau=\acerec{t}{\ctau'}$ \BY{assumption}
  \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
  \item $\cvalidT{\Delta, \Dhyp{t}}{\tsceneU{\Delta_\text{app}}{b}}{\ctau'}{\tau'}$ \BY{assumption} \label{cvalidT}
  \item $\istypeU{\Dcons{\Delta, \Dhyp{t}}{\Delta_\text{app}}}{\tau'}$ \BY{IH on \pfref{cvalidT}} \pflabel{istypeU1}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}, \Dhyp{t}}{\tau'}$ \BY{exchange over $\Delta_\text{app}$ on \pfref{istypeU1}} \pflabel{istypeU2}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:istypeU-rec}) on \pfref{istypeU2}}
\end{pfsteps*}
\resetpfcounter

\item[\text{(\ref{rule:cvalidT-U-prod})}] ~
\begin{pfsteps*}
\item $\ctau=\aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}}$ \BY{assumption}  
\item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
\item $\{\cvalidT{\Delta}{\tsceneU{\Delta_\text{app}}{b}}{\ctau_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{cvalidT-ass}
\item $\{\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau_i}\}_{i \in \labelset}$ \BY{IH over \pfref{cvalidT-ass}} \pflabel{istype}
\item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:istypeU-prod}) on \pfref{istype}}
\end{pfsteps*}
\resetpfcounter 

\item[\text{(\ref{rule:cvalidT-U-sum})}] ~
\begin{pfsteps*}
\item $\ctau=\acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}}$ \BY{assumption}  
\item $\tau=\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
\item $\{\cvalidT{\Delta}{\tsceneU{\Delta_\text{app}}{b}}{\ctau_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{cvalidT-ass}
\item $\{\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau_i}\}_{i \in \labelset}$ \BY{IH over \pfref{cvalidT-ass}} \pflabel{istype}
\item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:istypeU-sum}) on \pfref{istype}}
\end{pfsteps*}
\resetpfcounter

\item[\text{(\ref{rule:cvalidT-U-splicedt})}] ~
\begin{pfsteps*}
\item $\ctau=\acesplicedt{m}{n}$ \BY{assumption}
\item $\parseUTyp{\bsubseq{b}{m}{n}}{\utau}$ \BY{assumption}
\item $\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{\utau}{\tau}$ \BY{assumption} \label{expandsTU}
\item $\Delta \cap \Delta_\text{app} = \emptyset$ \BY{assumption}
\item $\istypeU{\Delta_\text{app}}{\tau}$ \BY{Lemma \ref{lemma:type-expansion-U} on \pfref{expandsTU}}\pflabel{istype}
\item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau}$ \BY{Lemma \ref{lemma:weakening-U} over $\Delta$ on \pfref{istype} and exchange over $\Delta$}
\end{pfsteps*}
\resetpfcounter
\end{byCases}
\end{proof}

\vspace{15px}
\begin{grayparbox}\vspace{-15px}
\subsection{Typed Pattern Expansion}\label{appendix:SES-typed-pattern-expansion}
\begin{theorem}[Typed Pattern Expansion]\label{thm:typed-pattern-expansion} ~
\begin{enumerate}
  \item If $\pExpandsSP{\uDD{\uD}{\Delta}}{\uAS{\uA}{\Phi}}{\upv}{p}{\tau}{\uGG{\uG}{\pctx}}$ then $\patType{\pctx}{p}{\tau}$.
  \item If $\cvalidP{\uGG{\uG}{\pctx}}{\pscene{\uDD{\uD}{\Delta}}{\uAP{\uA}{\Phi}}{b}}{\cpv}{p}{\tau}$ then $\patType{\pctx}{p}{\tau}$.
\end{enumerate}
\end{theorem}
\begin{proof}
  By mutual rule induction over Rules (\ref{rules:patExpands}) and Rules (\ref{rules:cvalidP-UP}).
  \begin{enumerate}
  \item We induct on the premise. In the following, let $\uDelta=\uDD{\uD}{\Delta}$ and $\upctx=\uGG{\uG}{\pctx}$ and $\uPhi=\uAP{\uA}{\Phi}$.
  \begin{byCases}
    \item[\text{(\ref{rule:patExpands-var})}] ~
      \begin{pfsteps*}
        \item $\upv=\ux$ \BY{assumption}
        \item $p=x$ \BY{assumption}
        \item $\pctx=\Ghyp{x}{\tau}$ \BY{assumption}
        \item $\patType{\Ghyp{x}{\tau}}{x}{\tau}$ \BY{Rule (\ref{rule:patType-var})}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:patExpands-wild})}] ~
      \begin{pfsteps*}
        \item $p=\aewildp$ \BY{assumption}
        \item $\pctx = \emptyset$ \BY{assumption}
        \item $\patType{\emptyset}{\aewildp}{\tau}$ \BY{Rule (\ref{rule:patType-wild})}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:patExpands-fold})}] ~
      \begin{pfsteps*}
        \item $\upv=\foldp{\upv'}$ \BY{assumption}
        \item $p=\aefoldp{p'}$ \BY{assumption}
        \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
        %\item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
        \item $\patExpands{\upctx}{\uPhi}{\upv'}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption} \pflabel{patExpands}
        \item $\patType{\pctx}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{IH, part 1 on \pfref{patExpands}} \pflabel{patType}
        \item $\patType{\pctx}{\aefoldp{p'}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:patType-fold}) on \pfref{patType}}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:patExpands-tpl})}] ~
      \begin{pfsteps*}
        \item $\upv=\tplp{\mapschema{\upv}{i}{\labelset}}$ \BY{assumption}
        \item $p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}$ \BY{assumption}
        \item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
        \item $\{\patExpands{\uGG{\uG_i}{\pctx_i}}{\uPhi}{\upv_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{patExpands}
        \item $\pctx = \Gconsi{i \in \labelset}{\pctx_i}$ \BY{assumption}
        %\item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
        \item $\{\patType{\pctx_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{IH, part 1 over \pfref{patExpands}}\pflabel{patType}
        \item $\patType{\Gconsi{i \in \labelset}{\pctx_i}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:patType-tpl}) on \pfref{patType}}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:patExpands-in})}] ~
      \begin{pfsteps*}
        \item $\upv=\injp{\ell}{\upv'}$ \BY{assumption}
        \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
        \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
        \item $\patExpands{\upctx}{\uPhi}{\upv'}{p'}{\tau'}$ \BY{assumption} \pflabel{patExpands}
%        \item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
        \item $\patType{\pctx}{p'}{\tau'}$ \BY{IH, part 1 on \pfref{patExpands}} \pflabel{patType}
        \item $\patType{\pctx}{\aeinjp{\ell}{p'}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}$ \BY{Rule (\ref{rule:patType-inj}) on \pfref{patType}}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:patExpands-apuptsm})}] ~
      \begin{pfsteps*}
        \item $\upv=\utsmap{\tsmv}{b}$ \BY{assumption}
        \item $\uA=\uA', \vExpands{\tsmv}{a}$ \BY{assumption}
        \item $\Phi=\Phi', \xuptsmbnd{a}{\tau}{\eparse}$ \BY{assumption}
        \item $\encodeBody{b}{\ebody}$ \BY{assumption}
        \item $\evalU{\eparse(\ebody)}{{\lbltxt{SuccessP}}\cdot{\ecand}}$ \BY{assumption}
        \item $\decodeCEPat{\ecand}{\cpv}$ \BY{assumption}
        \item $\cvalidP{\uGG{\uG}{\pctx}}{\pscene{\uDelta}{\uAP{\uA}{\Phi}}{b}}{\cpv}{p}{\tau}$ \BY{assumption} \pflabel{cvalidP}
%        \item $\uptsmenv{\Delta}{\Phi', \xuptsmbnd{a}{\tau}{\eparse}}$ \BY{assumption} \pflabel{env}
        \item $\patType{\pctx}{p}{\tau}$ \BY{IH, part 2 on \pfref{cvalidP}}
      \end{pfsteps*}
      \resetpfcounter
  \end{byCases}

  \item We induct on the premise. In the following, let $\upctx=\uGG{\uG}{\pctx}$ and $\uDelta = \uDD{\uD}{\Delta}$ and $\uPhi=\uAP{\uA}{\Phi}$.
  \begin{byCases}
    \item[\text{(\ref{rule:cvalidP-UP-wild})}] ~
      \begin{pfsteps*}
        \item $p=\aewildp$ \BY{assumption}
        \item $\pctx=\emptyset$ \BY{assumption}
        \item $\patType{\emptyset}{\aewildp}{\tau}$ \BY{Rule (\ref{rule:patType-wild})}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:cvalidP-UP-fold})}] ~
      \begin{pfsteps*}
        \item $\cpv=\acefoldp{\cpv'}$ \BY{assumption}
        \item $p=\aefoldp{p'}$ \BY{assumption}
        \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
        % \item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
        \item $\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv'}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption} \pflabel{cvalidP}
        \item $\patType{\pctx}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{IH, part 2 on \pfref{cvalidP}} \pflabel{patType}
        \item $\patType{\pctx}{\aefoldp{p'}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:patType-fold}) on \pfref{patType}}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:cvalidP-UP-tpl})}] ~
      \begin{pfsteps*}
        \item $\cpv=\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}$ \BY{assumption}
        \item $p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}$ \BY{assumption}
        \item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
        \item $\{\cvalidP{\uGG{\uG_i}{\pctx_i}}{\pscene{\uDelta}{\uPhi}{b}}{\cpv_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{cvalidP}
        \item $\pctx = \Gconsi{i \in \labelset}{\pctx_i}$ \BY{assumption}
        %\item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
        \item $\{\patType{\pctx_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{IH, part 2 over \pfref{cvalidP}}\pflabel{patType}
        \item $\patType{\Gconsi{i \in \labelset}{\pctx_i}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:patType-tpl}) on \pfref{patType}}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:cvalidP-UP-in})}] ~
      \begin{pfsteps*}
        \item $\cpv=\aceinjp{\ell}{\cpv'}$ \BY{assumption}
        \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
        \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
        \item $\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv'}{p'}{\tau'}$ \BY{assumption} \pflabel{cvalidP}
%        \item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
        \item $\patType{\pctx}{p'}{\tau'}$ \BY{IH, part 2 on \pfref{cvalidP}} \pflabel{patType}
        \item $\patType{\pctx}{\aeinjp{\ell}{p'}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}$ \BY{Rule (\ref{rule:patType-inj}) on \pfref{patType}}
      \end{pfsteps*}
      \resetpfcounter
    \item[\text{(\ref{rule:cvalidP-UP-spliced})}] ~
      \begin{pfsteps*}
        \item $\cpv=\acesplicedp{m}{n}{\ctau}$ \BY{assumption}
        \item $\cvalidT{\emptyset}{\tsceneUP{\uDelta}{b}}{\ctau}{\tau}$ \BY{assumption}
        \item $\parseUExp{\bsubseq{b}{m}{n}}{\upv}$ \BY{assumption}
        \item $\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}$ \BY{assumption} \pflabel{patExpands}
        \item $\patType{\pctx}{p}{\tau}$ \BY{IH, part 1 on \pfref{patExpands}}
      \end{pfsteps*}
      \resetpfcounter
  \end{byCases}
  \end{enumerate}
The mutual induction can be shown to be well-founded by showing that the following numeric metric on the judgements that we induct on is decreasing:
\begin{align*}
\sizeof{\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}} & = \sizeof{\upv}\\
\sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}}} & = \sizeof{b}
\end{align*}
where $\sizeof{b}$ is the length of $b$ and $\sizeof{\upv}$ is the sum of the lengths of the literal bodies in $\upv$, as defined in Sec. \ref{appendix:SES-syntax}.

The only case in the proof of part 1 that invokes part 2 is Case (\ref{rule:patExpands-apuptsm}). There, we have that the metric remains stable: \begin{align*}
 & \sizeof{\patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}}\\
=& \sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}}}\\
=&\sizeof{b}\end{align*}

The only case in the proof of part 2 that invokes part 1 is Case (\ref{rule:cvalidP-UP-spliced}). There, we have that $\parseUPat{\bsubseq{b}{m}{n}}{\upv}$ and the IH is applied to the judgement $\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}$. Because the metric is stable when passing from part 1 to part 2, we must have that it is strictly decreasing in the other direction:
\[\sizeof{\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}} < \sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\acesplicedp{m}{n}{\ctau}}{p}{\tau}}}\]
i.e. by the definitions above, 
\[\sizeof{\upv} < \sizeof{b}\]

This is established by appeal to Condition \ref{condition:body-subsequences}, which states that subsequences of $b$ are no longer than $b$, and the Condition \ref{condition:pattern-parsing}, which states that an unexpanded pattern constructed by parsing a textual sequence $b$ is strictly smaller, as measured by the metric defined above, than the length of $b$, because some characters must necessarily be used to apply the pattern TSM and delimit each literal body. Combining Conditions \ref{condition:body-subsequences} and \ref{condition:pattern-parsing}, we have that $\sizeof{\upv} < \sizeof{b}$ as needed.
\end{proof}

\end{grayparbox}
\subsection{Typed Expression Expansion}\label{appendix:SES-typed-expression-expansion-metatheory}
\begin{theorem}[Typed Expansion (Full)]\label{thm:typed-expansion-full-U} ~
\begin{enumerate}
  \item \begin{enumerate}
    \item If $\expandsSG{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ then $\hastypeU{\Delta}{\Gamma}{e}{\tau}$.
    \item \graytxtbox{If $\ruleExpands{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$  then $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$.}
  \end{enumerate}
  \item \begin{enumerate}
    \item If $\cvalidE{\Delta}{\Gamma}{\esceneSG{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ then $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$. 
    \item \begin{grayparbox}If $\cvalidR{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\crv}{r}{\tau}{\tau'}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ then $\ruleType{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{r}{\tau}{\tau'}$.\end{grayparbox}
  \end{enumerate}
\end{enumerate}
\end{theorem}
\begin{proof}
By mutual rule induction over Rules (\ref{rules:expandsU}), \graytxtbox{Rule (\ref{rule:ruleExpands}),} Rules (\ref{rules:cvalidE-U}) \graytxtbox{and Rule (\ref{rule:cvalidR-UP})}.

\begin{enumerate}
\item In the following, let $\uDelta=\uDD{\uD}{\Delta}$ and $\uGamma=\uGG{\uG}{\Gamma}$.
  \begin{enumerate}
  \item 
  \begin{byCases} \item[\text{(\ref{rule:expandsU-var})}] ~
\begin{pfsteps}
  \item \ue=\ux \BY{assumption}
  \item e=x \BY{assumption}
  \item \Gamma=\Gamma', \Ghyp{x}{\tau} \BY{assumption}
  \item \hastypeU{\Delta}{\Gamma', \Ghyp{x}{\tau}}{x}{\tau} \BY{Rule (\ref{rule:hastypeU-var})}
\end{pfsteps}
\resetpfcounter

\item[\text{(\ref{rule:expandsU-asc})}] ~
\begin{pfsteps}
  \item \ue=\asc{\ue'}{\utau} \BY{assumption}
  \item \expandsTU{\uDelta}{\utau}{\tau} \BY{assumption} \pflabel{expandsTU}
  \item \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue'}{e}{\tau} \BY{assumption} \pflabel{expandsSG}
  \item \hastypeU{\Delta}{\Gamma}{e}{\tau} \BY{IH, part 1(a) on \pfref{expandsSG}}
\end{pfsteps}
\resetpfcounter

\item[\text{(\ref{rule:expandsU-letsyn})}] ~
\begin{pfsteps}
  \item \ue=\letsyn{\ux}{\ue_1}{\ue_2} \BY{assumption}
  \item e =   \aeap{\aelam{\tau_1}{x}{e_2}}{e_1} \BY{assumption}
  \item     \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue_1}{e_1}{\tau_1} \BY{assumption} \pflabel{expandsSG1}
  \item     \expandsSG{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue_2}{e_2}{\tau} \BY{assumption} \pflabel{expandsSG2}
  \item \hastypeU{\Delta}{\Gamma}{e_1}{\tau_1} \BY{IH, part 1(a) on \pfref{expandsSG1}} \pflabel{hastype1}
  \item \hastypeU{\Delta}{\Gamma, x : \tau}{e_2}{\tau} \BY{IH, part 1(a) on \pfref{expandsSG2}} \pflabel{hastype2}
  \item \hastypeU{\Delta}{\Gamma}{\aelam{\tau_1}{x}{e_2}}{\aparr{\tau_1}{\tau}} \BY{Rule (\ref{rule:hastypeU-lam}) on \pfref{hastype2}} \pflabel{hastype3}
  \item \hastypeU{\Delta}{\Gamma}{\aeap{\aelam{\tau_1}{x}{e_2}}{e_1}}{\tau} \BY{Rule (\ref{rule:hastypeU-ap}) on \pfref{hastype3} and \pfref{hastype1}}
\end{pfsteps}
\resetpfcounter

\item[\text{(\ref{rule:expandsU-lam})}] ~
\begin{pfsteps}
  \item \ue=\lam{\ux}{\utau_1}{\ue'} \BY{assumption}
  \item e=\aelam{\tau_1}{x}{e'} \BY{assumption}
  \item \tau=\aparr{\tau_1}{\tau_2} \BY{assumption}
  \item \expandsTU{\uDelta}{\utau_1}{\tau_1} \BY{assumption} \pflabel{istype}
  \item \expandsSG{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue'}{e'}{\tau_2} \BY{assumption} \pflabel{expandsU}
%  \item \uetsmenv{\Delta}{\Psi} \BY{assumption} \pflabel{uetsmenv}
  \item \istypeU{\Delta}{\tau_1} \BY{Lemma \ref{lemma:type-expansion-U} on \pfref{istype}} \pflabel{istype2}
  \item \hastypeU{\Delta}{\Gamma, \Ghyp{x}{\tau_1}}{e'}{\tau_2} \BY{IH, part 1(a) on \pfref{expandsU}} \pflabel{hastypeU}
  \item \hastypeU{\Delta}{\Gamma}{\aelam{\tau_1}{x}{e'}}{\aparr{\tau_1}{\tau_2}} \BY{Rule (\ref{rule:hastypeU-lam}) on \pfref{istype2} and \pfref{hastypeU}}
\end{pfsteps}
\resetpfcounter

\item[\text{(\ref{rule:expandsU-ap})}] ~
\begin{pfsteps}
  \item \ue=\ap{\ue_1}{\ue_2} \BY{assumption}
  \item e=\aeap{e_1}{e_2} \BY{assumption}
  \item \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue_1}{e_1}{\aparr{\tau_2}{\tau}} \BY{assumption}\pflabel{expandsU1}
  \item \expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue_2}{e_2}{\tau_2} \BY{assumption}\pflabel{expandsU2}
%  \item \uetsmenv{\Delta}{\Psi} \BY{assumption} \pflabel{uetsmenv}
  \item \hastypeU{\Delta}{\Gamma}{e_1}{\aparr{\tau_2}{\tau}} \BY{IH, part 1(a) on \pfref{expandsU1}}\pflabel{hastypeU1}
  \item \hastypeU{\Delta}{\Gamma}{e_2}{\tau_2} \BY{IH, part 1(a) on \pfref{expandsU2}}\pflabel{hastypeU2}
  \item \hastypeU{\Delta}{\Gamma}{\aeap{e_1}{e_2}}{\tau} \BY{Rule (\ref{rule:hastypeU-ap}) on \pfref{hastypeU1} and \pfref{hastypeU2}}
\end{pfsteps}
\resetpfcounter

\item[\text{(\ref{rule:expandsU-tlam})}~\textbf{through}~\text{(\ref{rule:expandsU-case})}] These cases follow analagously, i.e. we apply Lemma \ref{lemma:type-expansion-U} to or over the type expansion premises and the IH part 1(a) to or over the typed expression expansion premises and then apply the corresponding typing rule in Rules (\ref{rule:hastypeU-tlam}) through (\ref{rule:hastypeU-case}).
\\
\item[\text{(\ref{rule:expandsU-syntax})}] ~ 
\begin{pfsteps}
  \item \ue=\uesyntax{\tsmv}{\utau'}{\eparse}{\ue'} \BY{assumption}
  \item \expandsTU{\uDelta}{\utau'}{\tau'} \BY{assumption} \pflabel{expandsTU}
 \item \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}} \BY{assumption}\pflabel{eparse}
  \item \expandsSG{\uDelta}{\uGamma}{\uPsi, \uShyp{\tsmv}{a}{\tau'}{\eparse}}{\uPhi}{\ue'}{e}{\tau} \BY{assumption}\pflabel{expandsU}
%  \item \uetsmenv{\Delta}{\Psi} \BY{assumption}\pflabel{uetsmenv1}
 \item \istypeU{\Delta}{\tau'} \BY{Lemma \ref{lemma:type-expansion-U} to \pfref{expandsTU}} \pflabel{istype}
%  \item \uetsmenv{\Delta}{\Psi, \xuetsmbnd{\tsmv}{\tau'}{\eparse}} \BY{Definition \ref{def:seTSM-def-ctx-formation} on \pfref{uetsmenv1}, \pfref{istype} and \pfref{eparse}}\pflabel{uetsmenv3}
  \item \hastypeU{\Delta}{\Gamma}{e}{\tau} \BY{IH, part 1(a) on \pfref{expandsU}}
\end{pfsteps}
\resetpfcounter 

\item[\text{(\ref{rule:expandsU-tsmap})}] ~ 
\begin{pfsteps}
  \item \ue=\utsmap{\tsmv}{b} \BY{assumption}
  \item \uA = \uA', \vExpands{\tsmv}{a} \BY{assumption}
  \item \Psi=\Psi', \xuetsmbnd{a}{\tau}{\eparse} \BY{assumption}
  \item \encodeBody{b}{\ebody} \BY{assumption}
  \item \evalU{\eparse(\ebody)}{{\lbltxt{SuccessE}}\cdot{\ecand}} \BY{assumption}
  \item \decodeCondE{\ecand}{\ce} \BY{assumption}
  \item \cvalidE{\emptyset}{\emptyset}{\esceneSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau} \BY{assumption}\pflabel{cvalidE}
%  \item \uetsmenv{\Delta}{\Psi} \BY{assumption} \pflabel{uetsmenv}
  \item \emptyset \cap \Delta = \emptyset \BY{finite set intersection} \pflabel{delta-cap}
  \item {\emptyset} \cap \domof{\Gamma} = \emptyset \BY{finite set intersection} \pflabel{gamma-cap}
  \item \hastypeU{\emptyset \cup \Delta}{\emptyset \cup \Gamma}{e}{\tau} \BY{IH, part 2(a) on \pfref{cvalidE}, \pfref{delta-cap}, and \pfref{gamma-cap}} \pflabel{penultimate}
  \item \hastypeU{\Delta}{\Gamma}{e}{\tau} \BY{finite set and finite function identity over \pfref{penultimate}}
\end{pfsteps}
\resetpfcounter
\end{byCases}
\end{enumerate}
\begin{grayparbox}
\begin{enumerate}
\item[\hphantom{(a)}] \begin{byCases}
    \item[\text{(\ref{rule:expandsU-match})}] ~
      \begin{pfsteps*}
        \item $\ue=\matchwith{\ue'}{\seqschemaX{\urv}}$ \BY{assumption}
        \item $e=\aematchwith{n}{e'}{\seqschemaX{r}}$ \BY{assumption}
        \item $\expandsUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue'}{e'}{\tau'}$ \BY{assumption} \pflabel{expandsUP}
        % \item $\istypeU{\Delta}{\tau}$ \BY{assumption}\pflabel{istype}
        % \item $\expandsTU{\uDelta}{\utau}{\tau}$ \BY{assumption} \pflabel{expandsTU}
        \item $\{\ruleExpands{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\urv_i}{r_i}{\tau'}{\tau}\}_{1 \leq i \leq n}$ \BY{assumption}\pflabel{ruleExpands}
        \item $\hastypeU{\Delta}{\Gamma}{e'}{\tau'}$ \BY{IH, part 1(a) on \pfref{expandsUP}}\pflabel{hasType}
        \item $\{\ruleType{\Delta}{\Gamma}{r_i}{\tau'}{\tau}\}_{1 \leq i \leq n}$ \BY{IH, part 1(b) over \pfref{ruleExpands}}\pflabel{ruleType}
        \item $\hastypeU{\Delta}{\Gamma}{\aematchwith{n}{e'}{\seqschemaX{r}}}{\tau}$ \BY{Rule (\ref{rule:hastypeUP-match}) on \pfref{hasType} and \pfref{ruleType}}
      \end{pfsteps*}
      \resetpfcounter

    \item[\text{(\ref{rule:expandsU-defuptsm})}] ~
      \begin{pfsteps}
          \item \ue=\usyntaxup{\tsmv}{\utau'}{\eparse}{\ue'} \BY{assumption}
          \item \expandsTU{\uDelta}{\utau'}{\tau'} \BY{assumption} \pflabel{expandsTU}
         \item \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}} \BY{assumption}\pflabel{eparse}
          \item \expandsUP{\uDelta}{\uGamma}{\uPsi}{\uPhi, \uPhyp{\tsmv}{a}{\tau'}{\eparse}}{\ue'}{e}{\tau} \BY{assumption}\pflabel{expandsU}
        %  \item \uetsmenv{\Delta}{\Psi} \BY{assumption}\pflabel{uetsmenv1}
         \item \istypeU{\Delta}{\tau'} \BY{Lemma \ref{lemma:type-expansion-U} to \pfref{expandsTU}} \pflabel{istype}
        %  \item \uetsmenv{\Delta}{\Psi, \xuetsmbnd{\tsmv}{\tau'}{\eparse}} \BY{Definition \ref{def:seTSM-def-ctx-formation} on \pfref{uetsmenv1}, \pfref{istype} and \pfref{eparse}}\pflabel{uetsmenv3}
          \item \hastypeU{\Delta}{\Gamma}{e}{\tau} \BY{IH, part 1(a) on \pfref{expandsU}}
        \end{pfsteps}
        \resetpfcounter 
  \end{byCases}
  \end{enumerate}
  \end{grayparbox}
  \vspace{-4px}\begin{grayparbox}\vspace{4px}
  \begin{enumerate}
  \item[(b)] \begin{byCases}
    \item[\text{(\ref{rule:ruleExpands})}] ~
      \begin{pfsteps*}
        \item $\urv=\matchrule{\upv}{\ue}$ \BY{assumption}
        \item $r=\aematchrule{p}{e}$ \BY{assumption}
        \item $\patExpands{\uGG{\uA'}{\pctx}}{\uPhi}{\upv}{p}{\tau}$ \BY{assumption} \pflabel{patExpands}
        \item $\expandsUP{\uDelta}{\uGG{{\uA}\uplus{\uA'}}{\Gcons{\Gamma}{\pctx}}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}$ \BY{assumption} \pflabel{expandsUP}
        \item $\patType{\pctx}{p}{\tau}$ \BY{Theorem \ref{thm:typed-pattern-expansion}, part 1 on \pfref{patExpands}}\pflabel{patType}
        \item $\hastypeU{\Delta}{\Gcons{\Gamma}{\pctx}}{e}{\tau'}$ \BY{IH, part 1(a) on \pfref{expandsUP}} \pflabel{hasType}
        \item $\ruleType{\Delta}{\Gamma}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleType}) on \pfref{patType} and \pfref{hasType}}
      \end{pfsteps*}
      \resetpfcounter
  \end{byCases}
  \end{enumerate}
  \end{grayparbox}

\item In the following, let $\uDelta=\uDD{\uD}{\Delta_\text{app}}$ and $\uGamma=\uGG{\uG}{\Gamma_\text{app}}$. \begin{enumerate}
  \item 
  \begin{byCases}
    \item[\text{(\ref{rule:cvalidE-U-var})}] ~
\begin{pfsteps*}
  \item $\ce=x$ \BY{assumption}
  \item $e=x$ \BY{assumption}
  \item $\Gamma=\Gamma', \Ghyp{x}{\tau}$ \BY{assumption}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gamma', \Ghyp{x}{\tau}}{x}{\tau}$ \BY{Rule (\ref{rule:hastypeU-var})} \pflabel{hastypeU}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma', \Ghyp{x}{\tau}}{\Gamma_\text{app}}}{x}{\tau}$ \BY{Lemma \ref{lemma:weakening-U} over $\Gamma_\text{app}$ to \pfref{hastypeU}}
\end{pfsteps*}
\resetpfcounter

\item[\text{(\ref{rule:cvalidE-U-lam})}] ~
\begin{pfsteps*}
  \item $\ce=\acelam{\ctau_1}{x}{\ce'}$ \BY{assumption}
  \item $e=\aelam{\tau_1}{x}{e'}$ \BY{assumption}
  \item $\tau=\aparr{\tau_1}{\tau_2}$ \BY{assumption}
  \item $\cvalidT{\Delta}{\tsceneU{\uDelta_\text{app}}{b}}{\ctau_1}{\tau_1}$ \BY{assumption} \pflabel{cvalidT}
  \item $\cvalidE{\Delta}{\Gamma, \Ghyp{x}{\tau_1}}{\esceneSG{\uDelta_\text{app}}{\uGamma_\text{app}}{\uPsi}{\uPhi}{b}}{\ce'}{e'}{\tau_2}$ \BY{assumption} \pflabel{cvalidE}
%  \item $\uetsmenv{\Delta_\text{app}}{\Psi}$ \BY{assumption} \pflabel{uetsmenv}
  \item $\Delta \cap \Delta_\text{app}=\emptyset$ \BY{assumption} \pflabel{delta-disjoint}
  \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ \BY{assumption} \pflabel{gamma-disjoint}
  \item $x \notin \domof{\Gamma_\text{app}}$ \BY{identification convention} \pflabel{x-fresh}
  \item $\domof{\Gamma, x : \tau_1} \cap \domof{\Gamma_\text{app}}=\emptyset$ \BY{\pfref{gamma-disjoint} and \pfref{x-fresh}} \pflabel{gamma-disjoint2}
  \item $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau_1}$ \BY{Lemma \ref{lemma:candidate-expansion-type-validation} on \pfref{cvalidT} and \pfref{delta-disjoint}} \pflabel{istype}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma, \Ghyp{x}{\tau_1}}{\Gamma_\text{app}}}{e'}{\tau_2}$ \BY{IH, part 2(a) on \pfref{cvalidE}, \pfref{delta-disjoint} and \pfref{gamma-disjoint2}} \pflabel{hastype1}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}, \Ghyp{x}{\tau_1}}{e'}{\tau_2}$ \BY{exchange over $\Gamma_\text{app}$ on \pfref{hastype1}} \pflabel{hastype2}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{\aelam{\tau_1}{x}{e'}}{\aparr{\tau_1}{\tau_2}}$ \BY{Rule (\ref{rule:hastypeU-lam}) on \pfref{istype} and \pfref{hastype2}}
\end{pfsteps*}
\resetpfcounter

\item[\text{(\ref{rule:cvalidE-U-ap})}] ~
\begin{pfsteps*}
  \item $\ce=\aceap{\ce_1}{\ce_2}$ \BY{assumption}
  \item $e=\aeap{e_1}{e_2}$ \BY{assumption}
  \item $\cvalidE{\Delta}{\Gamma}{\esceneSG{\uDelta_\text{app}}{\uGamma_\text{app}}{\uPsi}{\uPhi}{b}}{\ce_1}{e_1}{\aparr{\tau_2}{\tau}}$ \BY{assumption} \pflabel{cvalidE1}
  \item $\cvalidE{\Delta}{\Gamma}{\esceneSG{\uDelta_\text{app}}{\uGamma_\text{app}}{\uPsi}{\uPhi}{b}}{\ce_2}{e_2}{\tau_2}$ \BY{assumption} \pflabel{cvalidE2}
%  \item $\uetsmenv{\Delta_\text{app}}{\Psi}$ \BY{assumption} \pflabel{uetsmenv}
  \item $\Delta \cap \Delta_\text{app}=\emptyset$ \BY{assumption} \pflabel{delta-disjoint}
  \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ \BY{assumption} \pflabel{gamma-disjoint}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e_1}{\aparr{\tau_2}{\tau}}$ \BY{IH, part 2(a) on \pfref{cvalidE1}, \pfref{delta-disjoint} and \pfref{gamma-disjoint}} \pflabel{hastypeU1}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e_2}{\tau_2}$ \BY{IH, part 2(a) on \pfref{cvalidE2}, \pfref{delta-disjoint} and \pfref{gamma-disjoint}} \pflabel{hastypeU2}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{\aeap{e_1}{e_2}}{\tau}$ \BY{Rule (\ref{rule:hastypeU-ap}) on \pfref{hastypeU1} and \pfref{hastypeU2}}
\end{pfsteps*}
\resetpfcounter

\item[\text{(\ref{rule:cvalidE-U-tlam})}] ~
\begin{pfsteps}
  \item \ce=\acetlam{t}{\ce'} \BY{assumption}
  \item e = \aetlam{t}{e'} \BY{assumption}
  \item \tau = \aall{t}{\tau'}\BY{assumption}
  \item \cvalidE{\Delta, \Dhyp{t}}{\Gamma}{\esceneSG{\uDelta_\text{app}}{\uGamma_\text{app}}{\uPsi}{\uPhi}{b}}{\ce'}{e'}{\tau'} \BY{assumption} \pflabel{cvalidE}
%  \item \uetsmenv{\Delta_\text{app}}{\Psi} \BY{assumption} \pflabel{uetsmenv}
  \item \Delta \cap \Delta_\text{app}=\emptyset \BY{assumption} \pflabel{delta-disjoint}
  \item \domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset \BY{assumption} \pflabel{gamma-disjoint}
  \item \Dhyp{t} \notin \Delta_\text{app} \BY{identification convention}\pflabel{t-fresh}
  \item \Delta, \Dhyp{t} \cap \Delta_\text{app} = \emptyset \BY{\pfref{delta-disjoint} and \pfref{t-fresh}}\pflabel{delta-disjoint2}
  \item \hastypeU{\Dcons{\Delta, \Dhyp{t}}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e'}{\tau'} \BY{IH, part 2(a) on \pfref{cvalidE}, \pfref{delta-disjoint2} and \pfref{gamma-disjoint}}\pflabel{hastype1}
  \item \hastypeU{\Dcons{\Delta}{\Delta_\text{app}, \Dhyp{t}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e'}{\tau'} \BY{exchange over $\Delta_\text{app}$ on \pfref{hastype1}}\pflabel{hastype2}
  \item \hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{\aetlam{t}{e'}}{\aall{t}{\tau'}} \BY{Rule (\ref{rule:hastypeU-tlam}) on \pfref{hastype2}}
\end{pfsteps}
\resetpfcounter

\item[{\text{(\ref{rule:cvalidE-U-tap})}}~\textbf{through}~{\text{(\ref{rule:cvalidE-U-case})}}] These cases follow analagously, i.e. we apply the IH, part 2(a) to all proto-expression validation judgements, Lemma \ref{lemma:candidate-expansion-type-validation} to all proto-type validation judgements, the identification convention to ensure that extended contexts remain disjoint, weakening and exchange as needed, and the corresponding typing rule in Rules (\ref{rule:hastypeU-tap}) through (\ref{rule:hastypeU-case}).
\\

\item[\text{(\ref{rule:cvalidE-U-splicede})}] ~
\begin{pfsteps*}
  \item $\ce=\acesplicede{m}{n}{\ctau}$ \BY{assumption}
  \item $\escenev=\esceneU{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{b}$ \BY{assumption}
  \item   $\cvalidT{\emptyset}{\tsfrom{\escenev}}{\ctau}{\tau}$ \BY{assumption}
  \item $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$ \BY{assumption}
  \item $\expandsU{\uDelta_\text{app}}{\uGamma_\text{app}}{\uPsi}{\ue}{e}{\tau}$ \BY{assumption} \pflabel{expands}
%  \item $\uetsmenv{\Delta_\text{app}}{\Psi}$ \BY{assumption} \pflabel{uetsmenv}
  \item $\Delta \cap \Delta_\text{app}=\emptyset$ \BY{assumption} \pflabel{delta-disjoint}
  \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ \BY{assumption} \pflabel{gamma-disjoint}
  \item $\hastypeU{\Delta_\text{app}}{\Gamma_\text{app}}{e}{\tau}$ \BY{IH, part 1 on \pfref{expands}} \pflabel{hastype}
  \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$ \BY{Lemma \ref{lemma:weakening-U} over $\Delta$ and $\Gamma$ and exchange on \pfref{hastype}}
\end{pfsteps*}
\resetpfcounter
\end{byCases}
\end{enumerate}
\begin{grayparbox}
\begin{enumerate}
\item[\hphantom{(a)}] \begin{byCases}
    \item[\text{(\ref{rule:cvalidE-U-match})}] ~
      \begin{pfsteps*}
        \item $\ce=\acematchwith{n}{\ce'}{\seqschemaX{\crv}}$ \BY{assumption}
        \item $e=\aematchwith{n}{e'}{\seqschemaX{r}}$ \BY{assumption}
        \item $\cvalidE{\Delta}{\Gamma}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce'}{e'}{\tau'}$ \BY{assumption} \pflabel{cvalidE}        
        % \item $\istypeU{\Delta \cup \Delta_\text{app}}{\tau}$ \BY{assumption} \pflabel{istype}
        % \item $\cvalidT{\Delta}{\tsceneUP{\uDelta}{b}}{\ctau}{\tau}$ \BY{assumption} \pflabel{cvalidT}
        \item $\{\cvalidR{\Delta}{\Gamma}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\crv_i}{r_i}{\tau'}{\tau}\}_{1 \leq i \leq n}$ \BY{assumption} \pflabel{cvalidR}
        \item $\Delta \cap \Delta_\text{app} = \emptyset$ \BY{assumption} \pflabel{delta-disjoint}
        \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset$ \BY{assumption} \pflabel{gamma-disjoint}
        \item $\hastypeU{\Delta \cup \Delta_\text{app}}{\Gamma \cup \Gamma_\text{app}}{e'}{\tau'}$ \BY{IH, part 2(a) on \pfref{cvalidE}, \pfref{delta-disjoint} and \pfref{gamma-disjoint}} \pflabel{hastype}
        \item $\ruleType{\Delta \cup \Delta_\text{app}}{\Gamma \cup \Gamma_\text{app}}{r}{\tau'}{\tau}$ \BY{IH, part 2(b) on \pfref{cvalidR}, \pfref{delta-disjoint} and \pfref{gamma-disjoint}} \pflabel{ruleType}
        \item $\hastypeU{\Delta \cup \Delta_\text{app}}{\Gamma \cup \Gamma_\text{app}}{\aematchwith{n}{e'}{\seqschemaX{r}}}{\tau}$ \BY{Rule (\ref{rule:hastypeUP-match}) on \pfref{hastype} and \pfref{ruleType}}
      \end{pfsteps*}
      \resetpfcounter
  \end{byCases}
    \end{enumerate}
  \end{grayparbox}\vspace{-3px}
  \begin{grayparbox}\vspace{3px}
  \begin{enumerate}
  \item[(b)] There is only one case. 
    \begin{byCases}
     \item[\text{(\ref{rule:cvalidR-UP})}] ~
      \begin{pfsteps*}
        \item $\crv=\acematchrule{p}{\ce}$ \BY{assumption}
        \item $r=\aematchrule{p}{e}$ \BY{assumption}
        \item $\patType{\pctx'}{p}{\tau}$ \BY{assumption} \pflabel{patType}
        \item $\cvalidE{\Delta}{\Gcons{\Gamma}{\pctx'}}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau'}$ \BY{assumption} \pflabel{cvalidE}
        \item $\Delta \cap \Delta_\text{app} = \emptyset$ \BY{assumption}\pflabel{delta-disjoint}
        \item $\domof{\Gamma} \cap \domof{\pctx'} = \emptyset$ \BY{identification convention}\pflabel{gamma-disjoint1}
        \item $\domof{\Gamma_\text{app}} \cap \domof{\pctx'} = \emptyset$ \BY{identification convention}\pflabel{gamma-disjoint2}
        \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset$ \BY{assumption}\pflabel{gamma-disjoint3}
        \item $\domof{\Gcons{\Gamma}{\pctx'}} \cap \domof{\Gamma_\text{app}} = \emptyset$ \BY{standard finite set definitions and identities on \pfref{gamma-disjoint1}, \pfref{gamma-disjoint2} and \pfref{gamma-disjoint3}}\pflabel{gamma-disjoint4}
        \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gcons{\Gamma}{\pctx'}}{\Gamma_\text{app}}}{e}{\tau'}$ \BY{IH, part 2(a) on \pfref{cvalidE}, \pfref{delta-disjoint} and \pfref{gamma-disjoint4}}\pflabel{hastype}
        \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gcons{\Gamma}{\Gamma_\text{app}}}{\pctx'}}{e}{\tau'}$ \BY{exchange of $\pctx'$ and $\Gamma_\text{app}$ on \pfref{hastype}}\pflabel{hastype2}
        \item $\ruleType{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleType}) on \pfref{patType} and \pfref{hastype2}}
      \end{pfsteps*}
      \resetpfcounter
   \end{byCases} 
\end{enumerate}
\end{grayparbox}
\end{enumerate}
\vspace{10px}

The mutual induction can be shown to be well-founded by showing that the following numeric metric on the judgements that we induct on is decreasing:
\begin{align*}
\sizeof{\expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}} & = \sizeof{\ue}\\
\sizeof{\cvalidE{\Delta}{\Gamma}{\esceneSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}} & = \sizeof{b}
\end{align*}
where $\sizeof{b}$ is the length of $b$ and $\sizeof{\ue}$ is the sum of the lengths of the seTSM literal bodies in $\ue$, as defined in Sec. \ref{appendix:SES-syntax}.

The only case in the proof of part 1 that invokes part 2 is Case (\ref{rule:expandsU-tsmap}). There, we have that the metric remains stable: \begin{align*}
 & \sizeof{\expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\utsmap{\tsmv}{b}}{e}{\tau}}\\
=& \sizeof{\cvalidE{\emptyset}{\emptyset}{\esceneSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}}\\
=&\sizeof{b}\end{align*}

The only case in the proof of part 2 that invokes part 1 is Case (\ref{rule:cvalidE-U-splicede}). There, we have that $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$ and the IH is applied to the judgement $\expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$. Because the metric is stable when passing from part 1 to part 2, we must have that it is strictly decreasing in the other direction:
\[\sizeof{\expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}} < \sizeof{\cvalidE{\Delta}{\Gamma}{\esceneSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\acesplicede{m}{n}{\ctau}}{e}{\tau}}\]
i.e. by the definitions above, 
\[\sizeof{\ue} < \sizeof{b}\]

This is established by appeal to Condition \ref{condition:body-subsequences}, which states that subsequences of $b$ are no longer than $b$, and Condition \ref{condition:body-parsing}, which states that an unexpanded expression constructed by parsing a textual sequence $b$ is strictly smaller, as measured by the metric defined above, than the length of $b$, because some characters must necessarily be used to apply a TSM and delimit each literal body. 
Combining these conditions, we have that $\sizeof{\ue} < \sizeof{b}$ as needed.
\end{proof}

\begin{theorem}[Typed Expression Expansion]\label{thm:typed-expansion-short-U} If $\expandsSG{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}\hspace{-3px}}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ then $\hastypeU{\Delta}{\Gamma}{e}{\tau}$.
\end{theorem}
\begin{proof} This theorem follows immediately from Theorem \ref{thm:typed-expansion-full-U}, part 1(a). \end{proof}

% % \subsection{Expressibility}
% The following lemma establishes that each type can be expressed as a well-formed proto-type, under the same type formation context and any type splicing scene.
% \begin{lemma}[Proto-Expansion Type Expressibility]\label{lemma:proto-type-expressibility-U} If $\istypeU{\Delta}{\tau}$ then $\cvalidT{\Delta}{\tscenev}{\Cof{\tau}}{\tau}$. \end{lemma}
% \begin{proof}
% By rule induction over Rules (\ref{rules:istypeU}). In each case, we apply the IH on or over each premise, then apply the corresponding proto-type validation rule in Rules (\ref{rules:cvalidT-U}).
% \end{proof}

% The Type Expressibility Lemma establishes that every well-formed type, $\tau$, can be expressed as a well-formed unexpanded type, $\Uof{\tau}$. This requires defining the metafunction $\Uof{\Delta}$ which maps $\Delta$ onto an unexpanded type formation context as follows:
% \begin{align*}
% \Uof{\emptyset} &= \uDD{\emptyset}{\emptyset}\\
% \Uof{\Delta, \Dhyp{t}} &= \Uof{\Delta}, \uDhyp{\sigilof{t}}{t}
% \end{align*}
% \begin{lemma}[Type Expressibility]\label{lemma:type-expressibility} If $\istypeU{\Delta}{\tau}$ then $\expandsTU{\Uof{\Delta}}{\Uof{\tau}}{\tau}$.\end{lemma}
% \begin{proof} By rule induction over Rules (\ref{rules:istypeU}) using the definitions of $\Uof{\tau}$ and $\Uof{\Delta}$ above. In each case, we apply the IH to or over each premise, then apply the corresponding type expansion rule in Rules (\ref{rules:expandsTU}).\end{proof}


% The following lemma establishes that each well-typed expanded expression, $e$, can be expressed as a valid proto-expression, $\Cof{e}$, that is assigned the same type under any expression splicing scene.
% \begin{theorem}[Proto-Expansion Expression Expressibility]\label{theorem:proto-expressions-expressibility-U} If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\cvalidE{\Delta}{\Gamma}{\escenev}{\Cof{e}}{e}{\tau}$.\end{theorem}
% \begin{proof} By rule induction over Rules (\ref{rules:hastypeU}). The rule transformation above guarantees that this lemma holds by construction. In particular, in each case, we apply Lemma \ref{lemma:proto-type-expressibility-U} to or over each type formation premise, the IH to or over each typing premise, then apply the corresponding proto-expression validation rule in Rules (\ref{rule:cvalidE-U-var}) through (\ref{rule:cvalidE-U-case}).
% \end{proof}

% The following lemma establishes that each well-typed expanded expression, $e$, can be expressed as a valid ce-expression, $\Cof{e}$, that is assigned the same type under any expression splicing scene.
% \begin{theorem}[Candidate Expansion Expression Expressibility]\label{lemma:ce-expressions-expressibility-UP} Both of the following hold:
% \begin{enumerate}
% \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\cvalidE{\Delta}{\Gamma}{\escenev}{\Cof{e}}{e}{\tau}$.
% \item If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ then $\cvalidR{\Delta}{\Gamma}{\escenev}{\Cof{r}}{r}{\tau}{\tau'}$.
% \end{enumerate}
% \end{theorem}
% \begin{proof} By mutual rule induction over Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}). 

% For part 1, we induct on the assumption. 
% \begin{byCases}
% \item[\text{(\ref{rule:hastypeUP-var}) through (\ref{rule:hastypeUP-in})}] In each of these cases, we apply Lemma \ref{lemma:ce-type-expressibility-U} to or over each type formation premise, the IH (part 1) to or over each typing premise, then apply the corresponding ce-expression validation rule in Rules (\ref{rule:cvalidE-UP-var}) through (\ref{rule:cvalidE-UP-in}).
% \item[\text{(\ref{rule:hastypeUP-match})}] ~
%   \begin{pfsteps}
%   \item e = \aematchwith{n}{e'}{\seqschemaX{r}} \BY{assumption}
%   \item \Cof{e} = \acematchwith{n}{\Cof{\tau}}{\Cof{e'}}{\seqschemaXx{\Cofv}{r}} \BY{definition of $\Cof{e}$}
%   \item \hastypeU{\Delta}{\Gamma}{e'}{\tau'} \BY{assumption} \pflabel{hasType}
%   \item \istypeU{\Delta}{\tau} \BY{assumption} \pflabel{isType}
%   \item \{\ruleType{\Delta}{\Gamma}{r_i}{\tau'}{\tau}\}_{1 \leq i \leq n} \BY{assumption} \pflabel{ruleType}
%   \item \cvalidE{\Delta}{\Gamma}{\escenev}{\Cof{e'}}{e'}{\tau'} \BY{IH, part 1 on \pfref{hasType}} \pflabel{cvalidE}
%   \item \cvalidT{\Delta}{\tsfrom{\escenev}}{\Cof{\tau}}{\tau} \BY{Lemma \ref{lemma:candidate-expansion-type-validation} on \pfref{isType}} \pflabel{cvalidT}
%   \item \{\cvalidR{\Delta}{\Gamma}{\escenev}{\Cof{r_i}}{r_i}{\tau'}{\tau}\}_{1 \leq i \leq n} \BY{IH, part 2 over \pfref{ruleType}} \pflabel{cvalidR}
%   \item \cvalidE{\Delta}{\Gamma}{\escenev}{\acematchwith{n}{\Cof{\tau}}{\Cof{e'}}{\seqschemaXx{\Cofv}{r}}}{\aematchwith{n}{e'}{\seqschemaX{r}}}{\tau} \BY{Rule (\ref{rule:cvalidE-UP-match}) on \pfref{cvalidE}, \pfref{cvalidT} and \pfref{cvalidR}}
%   \end{pfsteps}
% \end{byCases}
% \resetpfcounter

% For part 2, we induct on the assumption. There is only one case.
% \begin{byCases}
% \item[\text{(\ref{rule:ruleType})}] ~
%   \begin{pfsteps}
%     \item r = \aematchrule{p}{e} \BY{assumption}
%     \item \Cof{r} = \acematchrule{p}{\Cof{e}} \BY{definition of $\Cof{r}$}
%     \item \patType{\pctx}{p}{\tau} \BY{assumption} \pflabel{patType}
%     \item \hastypeU{\Delta}{\Gcons{\Gamma}{\pctx}}{e}{\tau'} \BY{assumption} \pflabel{hasType}
%     \item \cvalidE{\Delta}{\Gcons{\Gamma}{\pctx}}{\escenev}{\Cof{e}}{e}{\tau'} \BY{IH, part 1 on \pfref{hasType}} \pflabel{cvalidE}
%     \item \cvalidR{\Delta}{\Gamma}{\escenev}{\acematchrule{p}{\Cof{e}}}{\aematchrule{p}{e}}{\tau}{\tau'} \BY{Rule (\ref{rule:cvalidR-UP}) on \pfref{patType} and \pfref{cvalidE}}
%   \end{pfsteps}
%   \resetpfcounter
% \end{byCases}
% \end{proof}

% The following lemma establishes that every well-typed expanded pattern that generates no hypotheses can be expressed as a ce-pattern.
% \begin{lemma}[Candidate Expansion Pattern Expressibility]\label{lemma:ce-pattern-expressibility-U} If $\patType{\emptyset}{p}{\tau}$ then $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p}}{p}{\tau}$.\end{lemma}
% \begin{proof} By rule induction over Rules (\ref{rules:patType}).
% \begin{byCases}
% \item[\text{(\ref{rule:patType-var})}] This case does not apply.
% \item[\text{(\ref{rule:patType-wild})}] ~
%   \begin{pfsteps*}
%     \item $p=\aewildp$ \BY{assumption}
%     \item $\Cof{p}=\acewildp$ \BY{definition of $\Cof{p}$}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\acewildp}{\aewildp}{\tau}$ \BY{Rule (\ref{rule:cvalidP-UP-wild})}
%   \end{pfsteps*}
%   \resetpfcounter
% \item[\text{(\ref{rule:patType-fold})}] ~
%   \begin{pfsteps*}
%     \item $p=\aefoldp{p'}$ \BY{assumption}
%     \item $\Cof{p}=\acefoldp{\Cof{p'}}$ \BY{definition of $\Cof{p}$}
%     \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
%     \item $\patType{\emptyset}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption} \pflabel{patType}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p'}}{p}{[\arec{t}{\tau'}/t]\tau'}$ \BY{IH on \pfref{patType}} \pflabel{cvalidP}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\acefoldp{\Cof{p'}}}{\aefoldp{p'}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:cvalidP-UP-fold}) on \pfref{cvalidP}}
%   \end{pfsteps*}
%   \resetpfcounter
% \item[\text{(\ref{rule:patType-tpl})}] ~
%   \begin{pfsteps*}
%     \item $p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}$ \BY{assumption}
%     \item $\Cof{p}=\acetpl{\labelset}{\mapschemax{\Cofv}{p}{i}{\labelset}}$ \BY{definition of $\Cof{p}$}
%     \item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
%     \item $\{\patType{\emptyset}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{patType}
%     \item $\{\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p_i}}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{IH over \pfref{patType}} \pflabel{cvalidP}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\acetpl{\labelset}{\mapschemax{\Cofv}{p}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:cvalidP-UP-tpl}) on \pfref{cvalidP}}
%   \end{pfsteps*}
%   \resetpfcounter
% \item[\text{(\ref{rule:patType-inj})}] ~
%   \begin{pfsteps*}
%     \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
%     \item $\Cof{p}=\aceinjp{\ell}{\Cof{p'}}$ \BY{definition of $\Cof{p}$}
%     \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
%     \item $\patType{\emptyset}{p'}{\tau'}$ \BY{assumption}\pflabel{patType}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p'}}{p'}{\tau'}$ \BY{IH on \pfref{patType}}\pflabel{cvalidP}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\aceinjp{\ell}{\Cof{p'}}}{\aeinjp{\ell}{p'}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}$ \BY{Rule (\ref{rule:cvalidP-UP-in}) on \pfref{cvalidP}}
%   \end{pfsteps*}
%   \resetpfcounter
% \end{byCases}
% \end{proof}

% \subsubsection{Expressibility}
% The following lemma establishes that each well-typed expanded pattern can be expressed as an unexpanded pattern matching values of the same type and generating the same hypotheses and corresponding identifier updates. The metafunction $\Uof{\pctx}$ maps $\pctx$ to an unexpanded typing context as follows:
% \begin{align*}
% \Uof{\emptyset} & = \uGG{\emptyset}{\emptyset}\\
% \Uof{\pctx, x : \tau} & = \Uof{\pctx}, \uGhyp{\sigilof{x}}{x}{\tau}\\
% \Uof{\Gconsi{i \in \labelset}{\pctx_i}} & = \Gconsi{i \in \labelset}{\Uof{\pctx_i}}
% \end{align*}
% \begin{lemma}[Pattern Expressibility]\label{lemma:pattern-expressibility} If $\patType{\pctx}{p}{\tau}$ then $\patExpands{\Uof{\pctx}}{\uPhi}{\Uof{p}}{p}{\tau}$.\end{lemma}
% \begin{proof} By rule induction over Rules (\ref{rules:patType}), using the definitions of $\Uof{\pctx}$ and $\Uof{p}$ given above. In each case, we can apply the IH to or over each premise, then apply the corresponding rule in Rules (\ref{rules:patExpands}).\end{proof}

% We can now establish the Expressibility Theorem -- that each well-typed expanded expression, $e$, can be expressed as an unexpanded expression, $\ue$, and assigned the same type under the corresponding contexts.

% \begin{theorem}[Expressibility] Both of the following hold:
% \begin{enumerate}
% \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\expandsUP{\Uof{\Delta}}{\Uof{\Gamma}}{\uPsi}{\uPhi}{\Uof{e}}{e}{\tau}$.
% \item If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ then $\ruleExpands{\Uof{\Delta}}{\Uof{\Gamma}}{\uPsi}{\uPhi}{\Uof{r}}{r}{\tau}{\tau'}$.
% \end{enumerate}
% \end{theorem}
% \begin{proof} By mutual rule induction over Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}). 

% For part 1, we induct on the assumption. The rule transformation defined above guarantees that this part holds by its construction. In particular, in each case, we can apply Lemma \ref{lemma:type-expressibility} to or over each type formation premise, the IH (part 1) to or over each typing premise, the IH (part 2) over each rule typing premise, then apply the corresponding rule in Rules (\ref{rules:expandsUP}).

% For part 2, we induct on the assumption. There is only one case:
% \begin{byCases}
% \item[(\ref{rule:ruleType})] ~
% \begin{pfsteps*}
% \item $r = \aematchrule{p}{e}$ \BY{assumption}
% \item $\patType{\pctx}{p}{\tau}$ \BY{assumption} \pflabel{patType}
% \item $\hastypeU{\Delta}{\Gamma \cup \pctx}{e}{\tau'}$ \BY{assumption} \pflabel{hasType}
% \item $\Uof{\Gamma}=\uGG{\uG}{\Gamma}$, for some $\uG$ \BY{definition of $\Uof{\Gamma}$}
% \item $\Uof{\pctx} =\uGG{\uG'}{\pctx}$, for some $\uG'$ \BY{definition of $\Uof{\pctx}$}
% \item $\Uof{\Gamma \cup \pctx} = \uGG{\uG \uplus \uG'}{\Gamma \cup \pctx}$ \BY{definition of $\Uof{\pctx}$}
% \item $\Uof{r} = \aumatchrule{\Uof{p}}{\Uof{e}}$ \BY{definition of $\Uof{r}$}
% \item $\patExpands{\uGG{\uG'}{\pctx}}{\uPhi}{\Uof{p}}{p}{\tau}$ \BY{Lemma \ref{lemma:pattern-expressibility} on \pfref{patType}} \pflabel{patExpands}
% \item $\expandsUP{\uDelta}{\uGG{\uGcons{\uG}{\uG'}}{\Gcons{\Gamma}{\pctx}}}{\uPsi}{\uPhi}{\Uof{e}}{e}{\tau'}$ \BY{IH, part 1 on \pfref{hasType}} \pflabel{expandsUP}
% \item $\ruleExpands{\Uof{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\aumatchrule{\Uof{p}}{\Uof{e}}}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleExpands}) on \pfref{patExpands} and \pfref{expandsUP}}
% \end{pfsteps*}
% \resetpfcounter
% \end{byCases}
% \end{proof}

\subsection{Reasoning Principles}\label{appendix:SES-reasoning-principles}
\begin{lemma}[Proto-Type Expansion Decomposition] 
\label{thm:proto-type-expansion-decomposition-SES}
If $\cvalidT{\Delta}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\ctau}{\tau}$ and $\summaryOf{\ctau} = \sseq{\acesplicedt{m_i}{n_i}}{n}$ then all of the following hold:
\begin{enumerate}
\item $\sseq{\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{
  \parseUTypF{\bsubseq{b}{m_i}{n_i}}
}{\tau_i}}{n}$
% \item $\sseq{\istypeU{\Delta_\text{app}}{\tau_i}}{n}$
\item $\tau = [\sseq{\tau_i/t_i}{n}]\tau'$ for some $\sseq{t_i}{n}$ and $\tau'$
\item $\istypeU{\Delta \cup \sseq{\Dhyp{t_i}}{n}}{\tau'}$
\end{enumerate}
\end{lemma}
\begin{proof}
By rule induction over Rules (\ref{rules:cvalidT-U}). In the following, let $\uDelta = \uDD{\uD}{\Delta_\text{app}}$ and $\tscenev=\tsceneU{\uDelta}{b}$.
\begin{byCases}
  \item[\text{(\ref{rule:cvalidT-U-tvar})}] 
    \begin{pfsteps}
    \item \ctau = t \BY{assumption}
    \item \tau = t \BY{assumption}
    \item \Delta = \Delta', \Dhyp{t} \BY{assumption}
    \item \summaryOf{\ctau} = \{ \} \BY{definition}
    \end{pfsteps}
    \resetpfcounter
    The conclusions hold as follows:
    \begin{enumerate}
    \item This conclusion holds trivially because $n=0$.
    % \item This conclusion holds trivially because $n=0$.
    \item Choose the empty set and $\tau'=t$.
    \item $\istypeU{\Delta', \Dhyp{t}}{t}$ by Rule (\ref{rule:istypeU-var})
    \end{enumerate}
  \item[\text{(\ref{rule:cvalidT-U-parr})}] 
    \begin{pfsteps}
    \item \ctau = \aceparr{\ctau_1}{\ctau_2} \BY{assumption}
    \item \tau = \aparr{\tau'_1}{\tau'_2} \BY{assumption}
    \item \cvalidT{\Delta}{\tscenev}{\ctau_1}{\tau_1} \BY{assumption} \pflabel{cvalidT1}
    \item \cvalidT{\Delta}{\tscenev}{\ctau_2}{\tau_2} \BY{assumption} \pflabel{cvalidT2}
    \item \summaryOf{\ctau} = \summaryOf{\ctau_1} \cup \summaryOf{\ctau_2} \BY{definition} \pflabel{summaryOf}
    \item \summaryOf{\ctau_1} = \sseqS{\acesplicedt{m_{i}}{n_{i}}}{0}{n'} \BY{definition} \pflabel{summaryOf1}
    \item \summaryOf{\ctau_2} = \sseqS{\acesplicedt{m_{i}}{n_{i}}}{n'}{n} \BY{definition} \pflabel{summaryOf2}
    \item \sseq{\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{
  \parseUTypF{\bsubseq{b}{m_i}{n_i}}
}{\tau_i}}{n'} 
    \BY{IH on \pfref{cvalidT1} and \pfref{summaryOf1}}
    \pflabel{expands1}
    % \item \sseq{\istypeU{\Delta_\text{app}}{\tau_i}}{n}
    \item \tau'_1 = [\sseq{\tau_i/t_i}{n'}]\tau''_1 \text{~for some $\sseq{t_i}{n'}$ and $\tau''_1$}
        \BY{IH on \pfref{cvalidT1} and \pfref{summaryOf1}}
        \pflabel{decompose1}
    \item \istypeU{\Delta \cup \sseq{\Dhyp{t_i}}{n'}}{\tau''_1}
        \BY{IH on \pfref{cvalidT1} and \pfref{summaryOf1}}
        \pflabel{istype1}
    \item \sseqS{\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{
  \parseUTypF{\bsubseq{b}{m_i}{n_i}}
}{\tau_i}}{n'}{n} 
    \BY{IH on \pfref{cvalidT2} and \pfref{summaryOf2}}
    \pflabel{expands2}
    % \item \sseq{\istypeU{\Delta_\text{app}}{\tau_i}}{n}
    \item \tau'_2 = [\sseqS{\tau_i/t_i}{n'}{n}]\tau''_2 \text{~for some $\sseqS{t_i}{n'}{n}$ and $\tau''_2$}
        \BY{IH on \pfref{cvalidT2} and \pfref{summaryOf2}}
        \pflabel{decompose2}
    \item \istypeU{\Delta \cup \sseqS{\Dhyp{t_i}}{n'}{n}}{\tau''_2}
        \BY{IH on \pfref{cvalidT2} and \pfref{summaryOf2}}
        \pflabel{istype2}
    \item \tau_1' = [\sseq{\tau_i/t_i}{n}]\tau_1'' \BY{substitution properties and \pfref{decompose1}} \pflabel{fdecompose1}
    \item \tau_2' = [\sseq{\tau_i/t_i}{n}]\tau_2'' \BY{substitution properties and \pfref{decompose2}} \pflabel{fdecompose2}
    \item \aparr{\tau_1'}{\tau_2'} = [\sseq{\tau_i/t_i}{n}]\aparr{\tau_1''}{\tau_2''} \BY{substitution and \pfref{fdecompose1} and \pfref{fdecompose2}}
    \pflabel{finaldecompose}
    \item \istypeU{\Delta \cup \sseq{\Dhyp{t_i}}{n}}{\tau''_1} \BY{Weakening and \pfref{istype1}} \pflabel{istype3}
    \item \istypeU{\Delta \cup \sseq{\Dhyp{t_i}}{n}}{\tau''_2} \BY{Weakening and \pfref{istype2}} \pflabel{istype4}
    \item \istypeU{\Delta \cup \sseq{\Dhyp{t_i}}{n}}{\aparr{\tau''_1}{\tau''_2}} \BY{Rule (\ref{rule:istypeU-parr}) on \pfref{istype3} and \pfref{istype4}}
    \pflabel{finalistype}
    \end{pfsteps}
    The conclusions hold as follows:
    \begin{enumerate}
      \item \pfref{expands1} $\cup$ \pfref{expands2}
      \item Choosing $\sseq{t_i}{n}$ and $\aparr{\tau''_1}{\tau''_2}$, by \pfref{finaldecompose}.
      \item \pfref{finalistype}
    \end{enumerate}
    \resetpfcounter
  \item[\text{(\ref{rule:cvalidT-U-all}) \textbf{through} (\ref{rule:cvalidT-U-sum})}] These cases follow by analagous inductive argument.
  \item[\text{(\ref{rule:cvalidT-U-splicedt})}] ~
  \begin{pfsteps}
  \item \ctau = \acesplicedt{m}{n} \BY{assumption}
  \item \summaryOf{\acesplicedt{m}{n}} = \{ \acesplicedt{m}{n} \} \BY{definition}
  \item \parseUTyp{\bsubseq{b}{m}{n}}{\utau} \BY{assumption} \pflabel{parseUTyp}
  \item \expandsTU{\uDD{\uD}{\Delta_\text{app}}}{\utau}{\tau} \BY{assumption} \pflabel{expandsTU}
  \item \istypeU{\Delta, \Dhyp{t}}{t} \BY{Rule (\ref{rule:istypeU-var})} \pflabel{istype}
  \end{pfsteps}
  The conclusions hold as follows:
  \begin{enumerate}
    \item \pfref{parseUTyp} and \pfref{expandsTU}
    \item Choose $\{t\}$ and $t$. Then $\tau = [\tau/t]t$ by definition.
    \item \pfref{istype}
  \end{enumerate}
  \resetpfcounter
\end{byCases}
\end{proof}

\begin{lemma}[Proto-Expression \graytxtbox{and Proto-Rule} Expansion Decomposition] 
\label{thm:proto-expression-expansion-decomposition} ~
\begin{enumerate}
\item If $\cvalidE
  {\Delta}{\Gamma}
  {\esceneSG
    {\uDD{\uD}{\Delta_\text{app}}}
    {\uGG{\uG}{\Gamma_\text{app}}}
    {\uPsi}{\uPhi}{b}
  }{\ce}{e}{\tau}$ and \[\summaryOf{\ce} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicede{m_i}{n_i}{\ctau_i}}{\nexp}\] then all of the following hold:
  \begin{enumerate}
    \item $\sseq{
          \expandsTU{\uDD{\uD}{\Delta_\text{app}}}
          {
            \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
          }{\tau'_i}
        }{\nty}$
    \item $\sseq{
      \cvalidT{\emptyset}{
        \tsceneUP
          {\uDD
            {\uD}{\Delta_\text{app}}
          }{b}
      }{
        \ctau_i
      }{\tau_i}
    }{\nexp}$
    \item $\sseq{
      \expandsSG
        {\uDD{\uD}{\Delta_\text{app}}}
        {\uGG{\uG}{\Gamma_\text{app}}}
        {\uPsi}
        {\uPhi}
        {\parseUExpF{\bsubseq{b}{m_i}{n_i}}}
        {e_i}
        {\tau_i}
    }{\nexp}$
    \item $e = [\sseq{\tau'_i/t_i}{\nty}][\sseq{e_i/x_i}{\nexp}]e'$ for some $\sseq{t_i}{\nty}$ and $\sseq{x_i}{\nexp}$ and $e'$
    \item $\hastypeU
      {\Delta \cup \sseq{\Dhyp{t_i}}{\nty}}
      {\Gamma \cup \sseq{x_i : \tau_i}{\nexp}}
      {e'}{\tau}$
  \end{enumerate}
\end{enumerate}
\begin{grayparbox}
\begin{enumerate}
\item[2.] If $\cvalidR{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\crv}{r}{\tau}{\tau'}$ and \[\summaryOf{\crv} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicede{m_i}{n_i}{\ctau_i}}{\nexp}\] then all of the following hold:
  \begin{enumerate}
    \item $\sseq{
          \expandsTU{\uDD{\uD}{\Delta_\text{app}}}
          {
            \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
          }{\tau'_i}
        }{\nty}$
    \item $\sseq{
      \cvalidT{\emptyset}{
        \tsceneUP
          {\uDD
            {\uD}{\Delta_\text{app}}
          }{b}
      }{
        \ctau_i
      }{\tau_i}
    }{\nexp}$
    \item $\sseq{
      \expandsSG
        {\uDD{\uD}{\Delta_\text{app}}}
        {\uGG{\uG}{\Gamma_\text{app}}}
        {\uPsi}
        {\uPhi}
        {\parseUExpF{\bsubseq{b}{m_i}{n_i}}}
        {e_i}
        {\tau_i}
    }{\nexp}$
    \item $r = [\sseq{\tau'_i/t_i}{\nty}][\sseq{e_i/x_i}{\nexp}]r'$ for some $\sseq{t_i}{\nty}$ and $\sseq{x_i}{\nexp}$ and $e'$
    \item $\ruleType
      {\Delta \cup \sseq{\Dhyp{t_i}}{\nty}}
      {\Gamma \cup \sseq{x_i : \tau_i}{\nexp}}
      {r'}{\tau}{\tau'}$
  \end{enumerate}
\end{enumerate}
\end{grayparbox}
\end{lemma}
\begin{proof} By rule induction over Rules (\ref{rules:cvalidE-U}) and Rule (\ref{rule:cvalidR-UP}). In the following, let $\uDelta=\uDD{\uD}{\Delta_\text{app}}$ and $\uGamma=\uGG{\uG}{\Gamma_\text{app}}$ and $\escenev=\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}$.
\begin{enumerate}
\item \begin{byCases}
  \item[\text{(\ref{rule:cvalidE-U-var})}] \begin{pfsteps}
    \item \ce=x \BY{assumption}
    \item e=x \BY{assumption}
    \item \Gamma = \Gamma', x : \tau \BY{assumption}
    \item \summaryOf{x}=\{ \} \BY{definition}
  \end{pfsteps}
  The conclusions hold as follows:
  \begin{enumerate}
    \item This conclusion holds trivially because $\nty=0$.
    \item This conclusion holds trivially because $\nexp=0$.
    \item This conclusion holds trivially because $\nexp=0$.
    \item Choose the empty set, the empty set and $x$. 
    \item $\hastypeU{\Delta}{\Gamma', x : \tau}{x}{\tau}$ by Rule (\ref{rule:hastypeU-var})
  \end{enumerate}
  \resetpfcounter
  \item[\text{(\ref{rule:cvalidE-U-asc}) \textbf{through} (\ref{rule:cvalidE-U-case})}] These cases follow by straightforward inductive argument.
  \item[\text{(\ref{rule:cvalidE-U-splicede})}] \begin{pfsteps}
    \item \ce=\acesplicede{m}{n}{\ctau} \BY{assumption}
    \item \summaryOf{\acesplicede{m}{n}{\ctau}} = \summaryOf{\ctau} \cup \{ \acesplicede{m}{n}{\ctau} \} \BY{definition}
    \item \summaryOf{\ctau} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \BY{definition} \pflabel{ctau}
    \item \cvalidT{\emptyset}{\tsfrom{\escenev}}{\ctau}{\tau} \BY{assumption} \pflabel{cvalidT}
    \item \parseUExp{\bsubseq{b}{m}{n}}{\ue} \BY{assumption} \pflabel{parseUExp}
    \item \expandsSG{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{\ue}{e}{\tau}
    \BY{assumption} \pflabel{expandsSG}
    \item \sseq{\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{
  \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
}{\tau'_i}}{\nty}
% \item $\sseq{\istypeU{\Delta_\text{app}}{\tau_i}}{n}$
   \BY{Lemma \ref{thm:proto-type-expansion-decomposition-SES} on \pfref{cvalidT} and \pfref{ctau}} \pflabel{parseUTyp}
   \item \hastypeU{\Delta \cup \sseq{\Dhyp{t_i}}{n_ty}}{\Gamma, x : \tau}{x}{\tau} \BY{Rule (\ref{rule:hastypeU-var})} \pflabel{hastypeU}
  \end{pfsteps}
  The conclusions hold as follows:
  \begin{enumerate}
    \item \pfref{parseUTyp}
    \item \pfref{cvalidT}
    \item \pfref{parseUExp} and \pfref{expandsSG}
    \item Choosing $\sseq{t_i}{\nty}$, $\{x\}$ and $x$, we have $e = [\sseq{\tau'_i/t_i}{\nty}][e/x]x$ by definition.
    \item \pfref{hastypeU}
  \end{enumerate}
  \resetpfcounter
\end{byCases}
\begin{grayparbox}
\begin{byCases}
  \item[\text{(\ref{rule:cvalidE-U-match})}] \begin{pfsteps*}
    \item $\ce = \acematchwith{\nrules}{\ce'}{\seqschemaX{\crv}}$ \BY{assumption}
    \item $e = \aematchwith{\nrules}{\tau}{e'}{\seqschemaX{r}}$ \BY{assumption}
    % \item $\istypeU{\Delta \cup \Delta_\text{app}}{\tau'}$ \BY{assumption} \pflabel{istype}
    \item $\cvalidE{\Delta}{\Gamma}{\escenev}{\ce}{e}{\tau'}$ \BY{assumption} \pflabel{cvalidE}
    \item $\{\cvalidR{\Delta}{\Gamma}{\escenev}{\crv_j}{r_j}{\tau'}{\tau}\}_{1 \leq j \leq \nrules}$
    \BY{assumption} \pflabel{cvalidR}
    \item $\summaryOf{\acematchwith{\nrules}{\ce'}{\seqschemaX{\crv}}} = \summaryOf{\ce} \cup \bigcup_{0 \leq i < \nrules} \summaryOf{\crv_i}$ \BY{definition} 
    \item $\summaryOf{\ce'} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty'} \cup \sseq{\acesplicede{m_i}{n_i}{\ctau_i}}{\nexp'}$ \BY{definition} \pflabel{summaryOfscrut}
    \item $\{\summaryOf{\crv_j} = \sseq{\acesplicedt{m'_{i,j}}{n'_{i,j}}}{\ntyj} \cup \sseq{\acesplicede{m_{i,j}}{n_{i,j}}{\ctau_{i,j}}}{\nexpj}\}_{0 \leq j < \nrules}$ \BY{definition} \pflabel{summaryOfr}
    \item $\sseq{
              \expandsTU{\uDD{\uD}{\Delta_\text{app}}}
              {
                \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
              }{\tau'_i}
            }{\nty'}$
        \BY{IH, part 1 on \pfref{cvalidE} and \pfref{summaryOfscrut}} \pflabel{c1scrut}
    \item $\sseq{
          \cvalidT{\emptyset}{
            \tsceneUP
              {\uDD
                {\uD}{\Delta_\text{app}}
              }{b}
          }{
            \ctau_i
          }{\tau_i}
        }{\nexp'}$
            \BY{IH, part 1 on \pfref{cvalidE} and \pfref{summaryOfscrut}} \pflabel{c2scrut}
    \item $\sseq{
          \expandsSG
            {\uDD{\uD}{\Delta_\text{app}}}
            {\uGG{\uG}{\Gamma_\text{app}}}
            {\uPsi}
            {\uPhi}
            {\parseUExpF{\bsubseq{b}{m_i}{n_i}}}
            {e_i}
            {\tau_i}
        }{\nexp'}$
            \BY{IH, part 1 on \pfref{cvalidE} and \pfref{summaryOfscrut}} \pflabel{c3scrut}
    \item $e' = [\sseq{\tau'_i/t_i}{\nty'}][\sseq{e_i/x_i}{\nexp'}]e''$ for some $\sseq{t_i}{\nty'}$ and $\sseq{x_i}{\nexp'}$ and $e''$
        \BY{IH, part 1 on \pfref{cvalidE} and \pfref{summaryOfscrut}} \pflabel{c4scrut}
    \item $\hastypeU
          {\Delta \cup \sseq{\Dhyp{t_i}}{\nty'}}
          {\Gamma \cup \sseq{x_i : \tau_i}{\nexp'}}
          {e''}{\tau'}$
              \BY{IH, part 1 on \pfref{cvalidE} and \pfref{summaryOfscrut}} \pflabel{c5scrut}
    \item $\{\sseq{
              \expandsTU{\uDD{\uD}{\Delta_\text{app}}}
              {
                \parseUTypF{\bsubseq{b}{m'_{i,j}}{n'_{i,j}}}
              }{\tau'_{i,j}}
            }{\ntyj}\}_{0 \leq j < \nrules}$
        \BY{IH, part 2 over \pfref{cvalidR} and \pfref{summaryOfr}} \pflabel{c1r}
    \item $\{\sseq{
          \cvalidT{\emptyset}{
            \tsceneUP
              {\uDD
                {\uD}{\Delta_\text{app}}
              }{b}
          }{
            \ctau_{i,j}
          }{\tau_{i,j}}
        }{\nexpj}\}_{0 \leq j < \nrules}$
            \BY{IH, part 2 over \pfref{cvalidR} and \pfref{summaryOfr}} \pflabel{c2r}
    \item $\{\sseq{
          \expandsSG
            {\uDD{\uD}{\Delta_\text{app}}}
            {\uGG{\uG}{\Gamma_\text{app}}}
            {\uPsi}
            {\uPhi}
            {\parseUExpF{\bsubseq{b}{m_{i,j}}{n_{i,j}}}}
            {e_{i,j}}
            {\tau_{i,j}}
        }{\nexpj}\}_{0 \leq j < \nrules}$
            \BY{IH, part 2 over \pfref{cvalidR} and \pfref{summaryOfr}} \pflabel{c3r}
    \item $\{r_j = [\sseq{\tau'_{i,j}/t_{i,j}}{\ntyj}][\sseq{e_{i,j}/x_{i,j}}{\nexpj}]r_j'\}_{0 \leq j < \nrules}$ for some $\{\sseq{t_{i,j}}{\ntyj}\}_{0 \leq j < \nrules}$ and $\{\sseq{x_{i,j}}{\nexpj}\}_{0 \leq j < \nrules}$  and $\{r_j'\}_{0 \leq j < \nrules}$ 
        \BY{IH, part 2 over \pfref{cvalidR} and \pfref{summaryOfr}} \pflabel{c4r}
    \item $\{\ruleType
          {\Delta \cup \sseq{\Dhyp{t_{i,j}}}{\ntyj}}
          {\Gamma \cup \sseq{x_{i,j} : \tau_{i,j}}{\nexpj}}
          {r_j'}{\tau'}{\tau}\}_{0 \leq j < \nrules}$
              \BY{IH, part 2 over \pfref{cvalidR} and \pfref{summaryOfr}} \pflabel{c5r}
    \item $e' = [\sseq{\tau'_i/t_i}{\nty'} \cup \{ \sseq{\tau_{i,j}/t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}][\sseq{e_i/x_i}{\nexp} \cup \{ \sseq{\tau_{i,j}/t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}]e''$ \BY{substitution properties and \pfref{c4scrut}} \pflabel{c4fscrut}
    \item $\{r_j = [\sseq{\tau'_i/t_i}{\nty'} \cup \sseq{\tau'_{i,j}/t_{i,j}}{\ntyj}][\sseq{e_i/x_i}{\nexp} \cup \sseq{e_{i,j}/x_{i,j}}{\nexpj}]r_j'\}_{0 \leq j < \nrules}$ \BY{substitution properties and \pfref{c4r}} \pflabel{c4fr}
    \item $e = [\sseq{\tau'_i/t_i}{\nty'} \cup \{ \sseq{\tau_{i,j}/t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}][\sseq{e_i/x_i}{\nexp'} \cup \{ \sseq{e_{i,j}/x_{i,j}}{\nexpj} \}_{0 \leq j < \nrules}]\aematchwith{\nrules}{e''}{\seqschemaX{r'}}$ \BY{\pfref{c4fscrut} and \pfref{c4fr} and definition of substitution} \pflabel{c4e}
    \item $\hastypeU
          {\Delta \cup \sseq{\Dhyp{t_i}}{\nty'} \cup \{ \sseq{t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}}
          {\Gamma \cup \sseq{x_i : \tau_i}{\nexp'} \cup \{ \sseq{x_{i,j}}{\nexpj} \}_{0 \leq j < \nrules}}
          {e''}{\tau'}$ \BY{Weakening on \pfref{c5scrut}} \pflabel{c5scrutf}
    \item $\{\ruleType
          {\Delta \cup \sseq{\Dhyp{t_i}}{\nty'} \cup \{ \sseq{t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}}
          {\Gamma \cup \sseq{x_{i,j} : \tau_{i,j}}{\nexpj} \cup \{ \sseq{x_{i,j}}{\nexpj} \}_{0 \leq j < \nrules}}
          {r_j'}{\tau'}{\tau}\}_{0 \leq j < \nrules}$ \BY{Weakening over \pfref{c5r}} \pflabel{c5rf}
    \item $\hastypeU
              {\Delta \cup \sseq{\Dhyp{t_i}}{\nty'} \cup \{ \sseq{t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}}
              {\Gamma \cup \sseq{x_i : \tau_i}{\nexp'} \cup \{ \sseq{x_{i,j}}{\nexpj} \}_{0 \leq j < \nrules}}
              {\aematchwith{\nrules}{e''}{\seqschemaX{r'}}}{\tau}$ \BY{Rule (\ref{rule:hastypeUP-match}) on \pfref{c5scrutf} and \pfref{c5rf}} \pflabel{c5ff}
  \end{pfsteps*} 

  The conclusions hold as follows:
  \begin{enumerate}
    \item $\text{\pfref{c1scrut}} \cup \bigcup_{0 \leq j < \nrules} \text{\pfref{c1r}}_j$
    \item $\text{\pfref{c2scrut}} \cup \bigcup_{0 \leq j < \nrules} \text{\pfref{c2r}}_j$
    \item $\text{\pfref{c3scrut}} \cup \bigcup_{0 \leq j < \nrules} \text{\pfref{c3r}}_j$
    \item Choose:
      \begin{enumerate}
      \item $\sseq{t_i}{\nty'} \cup \{ \sseq{t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}$; and
      \item $\sseq{x_i}{\nexp'} \cup \{ \sseq{x_{i,j}}{\nexpj} \}_{0 \leq j < \nrules}$; and 
      \item $\aematchwith{\nrules}{e''}{\seqschemaX{r'}}$
      \end{enumerate}
      We have $e = [\sseq{\tau'_i/t_i}{\nty'} \cup \{ \sseq{\tau_{i,j}/t_{i,j}}{\ntyj} \}_{0 \leq j < \nrules}][\sseq{e_i/x_i}{\nexp'} \cup \{ \sseq{e_{i,j}/x_{i,j}}{\nexpj} \}_{0 \leq j < \nrules}]\aematchwith{\nrules}{e''}{\seqschemaX{r'}}$ by \pfref{c4e}.
    \item \pfref{c5ff}
  \end{enumerate}
  \resetpfcounter
\end{byCases}
\end{grayparbox}
\end{enumerate}
\vspace{-2px}\begin{grayparbox}\vspace{2px}
\begin{enumerate}
\item[2.] By rule induction over the rule typing assumption. There is only one case. In the following, let $\uDelta=\uDD{\uD}{\Delta_\text{app}}$ and $\uGamma=\uGG{\uG}{\Gamma_\text{app}}$ and $\escenev=\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}$.
  \begin{byCases}
    \item[\text{(\ref{rule:cvalidR-UP})}] ~
    \begin{pfsteps*}
      \item $\crv = \acematchrule{p}{\ce}$ \BY{assumption}
      \item $r=\aematchrule{p}{e}$ \BY{assumption}
      \item $\patType{\pctx'}{p}{\tau}$ \BY{assumption} \pflabel{patType}
      \item $\cvalidE{\Delta}{\Gcons{\Gamma}{\pctx'}}{\escenev}{\ce}{e}{\tau'}$ \BY{assumption} \pflabel{cvalid}
      \item $\summaryOf{\crv} = \summaryOf{\ce}$ \BY{definition}
      \item $\summaryOf{\ce} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicede{m_i}{n_i}{\ctau_i}}{\nexp}$ \BY{definition} \pflabel{summaryOfce}
      \item $\sseq{
            \expandsTU{\uDD{\uD}{\Delta_\text{app}}}
            {
              \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
            }{\tau'_i}
          }{\nty}$
          \BY{IH, part 1 on \pfref{cvalid} and \pfref{summaryOfce}}
          \pflabel{c1e}
      \item $\sseq{
        \cvalidT{\emptyset}{
          \tsceneUP
            {\uDD
              {\uD}{\Delta_\text{app}}
            }{b}
        }{
          \ctau_i
        }{\tau_i}
      }{\nexp}$
                \BY{IH, part 1 on \pfref{cvalid} and \pfref{summaryOfce}}
          \pflabel{c2e}
      \item $\sseq{
        \expandsSG
          {\uDD{\uD}{\Delta_\text{app}}}
          {\uGG{\uG}{\Gamma_\text{app}}}
          {\uPsi}
          {\uPhi}
          {\parseUExpF{\bsubseq{b}{m_i}{n_i}}}
          {e_i}
          {\tau_i}
      }{\nexp}$
          \BY{IH, part 1 on \pfref{cvalid} and \pfref{summaryOfce}}
          \pflabel{c3e}      
      \item $e = [\sseq{\tau'_i/t_i}{\nty}][\sseq{e_i/x_i}{\nexp}]e'$ for some $\sseq{t_i}{\nty}$ and $\sseq{x_i}{\nexp}$ and $e'$
          \BY{IH, part 1 on \pfref{cvalid} and \pfref{summaryOfce}}
          \pflabel{c4e}
      \item $\hastypeU
        {\Delta \cup \sseq{\Dhyp{t_i}}{\nty}}
        {\Gamma \cup \pctx' \cup \sseq{x_i : \tau_i}{\nexp}}
        {e'}{\tau}$
          \BY{IH, part 1 on \pfref{cvalid} and \pfref{summaryOfce}}
          \pflabel{c5e}
      \item $r=[\sseq{\tau'_i/t_i}{\nty}][\sseq{e_i/x_i}{\nexp}]\aematchrule{p}{e'}$ \BY{substitution properties and \pfref{c4e}} \pflabel{c4r}
      \item $\ruleType
              {\Delta \cup \sseq{\Dhyp{t_i}}{\nty}}
              {\Gamma \cup \sseq{x_i : \tau_i}{\nexp}}
              {\aematchrule{p}{e'}}
              {\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleType}) on \pfref{patType} and \pfref{c5e}} \pflabel{c5r}
    \end{pfsteps*}
    The conclusions hold as follows:
    \begin{enumerate}
      \item \pfref{c1e}
      \item \pfref{c2e}
      \item \pfref{c3e}
      \item Choosing $\sseq{t_i}{\nty}$ and $\sseq{x_i}{\nexp}$ and $\aematchrule{p}{e'}$, by \pfref{c4r}
      \item \pfref{c5r}
    \end{enumerate}
    \resetpfcounter
  \end{byCases}
\end{enumerate}
\end{grayparbox}
\end{proof}
% \begin{equation}\label{rule:cvalidR-UP}
% \inferrule{
%   \patType{\pctx}{p}{\tau}\\
%   \cvalidE{\Delta}{\Gcons{\Gamma}{\pctx}}{\escenev}{\ce}{e}{\tau'}
% }{
%   \cvalidR{\Delta}{\Gamma}{\escenev}{\acematchrule{p}{\ce}}{\aematchrule{p}{e}}{\tau}{\tau'}
% }
% \end{equation}

\begin{theorem}[seTSM Abstract Reasoning Principles]
\label{thm:tsc-SES}
If $\expandsSG{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\utsmap{\tsmv}{b}}{e}{\tau}$ then:
\begin{enumerate}
\item (\textbf{Typing 1}) $\uPsi = \uPsi', \uShyp{\tsmv}{a}{\tau}{\eparse}$ and $\hastypeU{\Delta}{\Gamma}{e}{\tau}$
\item $\encodeBody{b}{\ebody}$
\item $\evalU{\ap{\eparse}{\ebody}}{\lbltxt{SuccessE}\cdot\ecand}$
\item $\decodeCondE{\ecand}{\ce}$
\item (\textbf{Segmentation}) $\segOK{\segof{\ce}}{b}$
\item $\summaryOf{\ce} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicede{m_i}{n_i}{\ctau_i}}{\nexp}$
\item \textbf{(Typing 2)} $\sseq{
      \expandsTU{\uDD{\uD}{\Delta}}
      {
        \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
      }{\tau'_i}
    }{\nty}$ and $\sseq{\istypeU{\Delta}{\tau'_i}}{\nty}$
\item \textbf{(Typing 3)} $\sseq{
  \cvalidT{\emptyset}{
    \tsceneUP
      {\uDD
        {\uD}{\Delta}
      }{b}
  }{
    \ctau_i
  }{\tau_i}
}{\nexp}$ and $\sseq{\istypeU{\Delta}{\tau_i}}{\nexp}$
\item \textbf{(Typing 4)} $\sseq{
  \expandsSG
    {\uDD{\uD}{\Delta}}
    {\uGG{\uG}{\Gamma}}
    {\uPsi}
    {\uPhi}
    {\parseUExpF{\bsubseq{b}{m_i}{n_i}}}
    {e_i}
    {\tau_i}
}{\nexp}$ and $\sseq{\hastypeU{\Delta}{\Gamma}{e_i}{\tau_i}}{\nexp}$
\item (\textbf{Capture Avoidance}) $e = [\sseq{\tau'_i/t_i}{\nty}][\sseq{e_i/x_i}{\nexp}]e'$ for some $\sseq{t_i}{\nty}$ and $\sseq{x_i}{\nexp}$ and $e'$
\item (\textbf{Context Independence}) $\hastypeU
  {\sseq{\Dhyp{t_i}}{\nty}}
  {\sseq{x_i : \tau_i}{\nexp}}
  {e'}{\tau}$
\end{enumerate}
\end{theorem}
\begin{proof} By rule induction over Rules (\ref{rules:expandsU}). There is only one rule that applies. In the following, let $\uDelta = \uDD{\uD}{\Delta}$ and $\uGamma = \uGG{\uG}{\Gamma}$.
\begin{byCases}
\item[\text{(\ref{rule:expandsU-tsmap})}] ~
\begin{pfsteps*}
  \item $\uPsi = \uPsi', \uShyp{\tsmv}{a}{\tau}{\eparse}$ \BY{assumption} \pflabel{uPsidef}
  \item $\expandsSG{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\utsmap{\tsmv}{b}}{e}{\tau}$ \BY{assumption} \pflabel{expandsSG}
  \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{Theorem \ref{thm:typed-expansion-short-U} on \pfref{expandsSG}} \pflabel{hastype}
  \item $\encodeBody{b}{\ebody}$ \BY{assumption} \pflabel{encodeBody}
  \item $\evalU{\eparse(\ebody)}{{\lbltxt{SuccessE}}\cdot{\ecand}}$ \BY{assumption} \pflabel{evalU}
  \item $\decodeCondE{\ecand}{\ce}$ \BY{assumption} \pflabel{decodeCondE}
  \item $\segOK{\segof{\ce}}{b}$ \BY{assumption} \pflabel{segOK}
  \item $\cvalidE{\emptyset}{\emptyset}{\esceneSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ \BY{assumption}\pflabel{cvalidE}
  \item $\summaryOf{\ce} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicede{m_i}{n_i}{\ctau_i}}{\nexp}$ \BY{definition} \pflabel{summaryOf}
  \item $\sseq{
      \expandsTU{\uDD{\uD}{\Delta}}
      {
        \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
      }{\tau'_i}
    }{\nty}$ \BY{Lemma \ref{thm:proto-expression-expansion-decomposition} on \pfref{cvalidE} and \pfref{summaryOf}} \pflabel{c1}
\item $\sseq{\istypeU{\Delta}{\tau'_i}}{\nty}$ \BY{Lemma \ref{lemma:type-expansion-U}, part 1 over \pfref{c1}} \pflabel{t1}
\item $\sseq{
  \cvalidT{\emptyset}{
    \tsceneUP
      {\uDD
        {\uD}{\Delta}
      }{b}
  }{
    \ctau_i
  }{\tau_i}
}{\nexp}$ \BY{Lemma \ref{thm:proto-expression-expansion-decomposition} on \pfref{cvalidE} and \pfref{summaryOf}} \pflabel{c2}
\item $\emptyset \cap \Delta = \emptyset$ \BY{definition} \pflabel{emptyintersect}
\item $\sseq{\istypeU{\Delta}{\tau_i}}{\nexp}$ \BY{Lemma \ref{lemma:type-expansion-U}, part 2 over \pfref{c2} and \pfref{emptyintersect}} \pflabel{t2}
\item $\sseq{
  \expandsSG
    {\uDD{\uD}{\Delta}}
    {\uGG{\uG}{\Gamma}}
    {\uPsi}
    {\uPhi}
    {\parseUExpF{\bsubseq{b}{m_i}{n_i}}}
    {e_i}
    {\tau_i}
}{\nexp}$ \BY{Lemma \ref{thm:proto-expression-expansion-decomposition} on \pfref{cvalidE} and \pfref{summaryOf}} \pflabel{c3}
\item $\sseq{\hastypeU{\Delta}{\Gamma}{e_i}{\tau_i}}{\nexp}$ \BY{Theorem \ref{thm:typed-expansion-short-U} over \pfref{c3}} \pflabel{t3}
\item $e = [\sseq{\tau'_i/t_i}{\nty}][\sseq{e_i/x_i}{\nexp}]e'$ for some $\sseq{t_i}{\nty}$ and $\sseq{x_i}{\nexp}$ and $e'$ \BY{Lemma \ref{thm:proto-expression-expansion-decomposition} on \pfref{cvalidE} and \pfref{summaryOf}} \pflabel{c4}
\item $\hastypeU
  {\sseq{\Dhyp{t_i}}{\nty}}
  {\sseq{x_i : \tau_i}{\nexp}}
  {e'}{\tau}$ \BY{Lemma \ref{thm:proto-expression-expansion-decomposition} on \pfref{cvalidE} and \pfref{summaryOf}} \pflabel{c5}
\end{pfsteps*}
The conclusions hold as follows:
\begin{enumerate}
  \item \pfref{uPsidef} and \pfref{hastype}
  \item \pfref{encodeBody}
  \item \pfref{evalU}
  \item \pfref{decodeCondE}
  \item \pfref{segOK}
  \item \pfref{summaryOf}
  \item \pfref{c1} and \pfref{t1}
  \item \pfref{c2} and \pfref{t2}
  \item \pfref{c3} and \pfref{t3}
  \item \pfref{c4}
  \item \pfref{c5}
\end{enumerate}
\resetpfcounter
\end{byCases}
\end{proof}

% The following theorem establishes a prohibition on \textbf{Shadowing} as discussed in Sec. \ref{sec:uetsms-validation}.

% \begin{theorem}[Shadowing Prohibition]
% \label{thm:shadowing-prohibition-SES} ~
% \begin{enumerate}
% \item If $\cvalidT{\Delta}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\acesplicedt{m}{n}}{\tau}$ then:\begin{enumerate}
% \item $\parseUTyp{\bsubseq{b}{m}{n}}{\utau}$
% \item $\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{\utau}{\tau}$
% \item $\Delta \cap \Delta_\text{app} = \emptyset$
% \end{enumerate}
% \item If $\cvalidE{\Delta}{\Gamma}{\escenev}{\acesplicede{m}{n}{\ctau}}{e}{\tau}$ then:
% \begin{enumerate}
% \item $\cvalidT{\emptyset}{\tsfrom{\escenev}}{\ctau}{\tau}$
% \item $  \escenev=\esceneU{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{b}$
% \item $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$
% \item $\expandsU{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\ue}{e}{\tau}$
% \item $\Delta \cap \Delta_\text{app} = \emptyset$
% \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset$
% \end{enumerate}
% \end{enumerate}
% \end{theorem}
% \begin{proof} ~
% \begin{enumerate}
% \item By rule induction over Rules (\ref{rules:cvalidT-U}). The only rule that applies is Rule (\ref{rule:cvalidT-U-splicedt}). The conclusions are the premises of this rule.
% \item By rule induction over Rules (\ref{rules:cvalidE-U}). The only rule that applies is Rule (\ref{rule:cvalidE-U-splicede}). The conclusions are the premises of this rule.
% \end{enumerate}
% \end{proof}

\begin{grayparbox}
\begin{lemma}[Proto-Pattern Expansion Decomposition]
\label{lemma:proto-pattern-expansion-decomposition-S}
If $\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}$ and 
\[ 
\summaryOf{\cpv} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicedp{m_i}{n_i}{\ctau_i}}{\npat}
\]
then all of the following hold:
\begin{enumerate}
    \item $\sseq{
          \expandsTU{\uDelta}
          {
            \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
          }{\tau'_i}
        }{\nty}$
    \item $\sseq{
      \cvalidT{\emptyset}{
        \tsceneUP
          {\uDelta}{b}
      }{
        \ctau_i
      }{\tau_i}
    }{\npat}$
    \item $\sseq{
      \patExpands
        {\upctx_i}
        {\uPhi}
        {\parseUPatF{\bsubseq{b}{m_i}{n_i}}}
        {p_i}
        {\tau_i}
    }{\npat}$
  \item $\upctx = \biguplus_{0 \leq i < \npat} \upctx_i$
\end{enumerate}
\end{lemma}
\begin{proof} By rule induction over Rules (\ref{rules:cvalidP-UP}). In the following, let $\pscenev=\pscene{\uDelta}{\uPhi}{b}$.
\begin{byCases}
  \item[\text{(\ref{rule:cvalidP-UP-wild})}] ~
    \begin{pfsteps*}
      \item $\cpv=\acewildp$ \BY{assumption}
      \item $e = \aewildp$ \BY{assumption}
      \item $\upctx = \uGG{\emptyset}{\emptyset}$ \BY{assumption}
      \item $\summaryOf{\acewildp} = \emptyset$ \BY{definition}
    \end{pfsteps*}
    The conclusions hold as follows:
    \begin{enumerate}
      \item This conclusion holds trivially because $\nty=0$.
      \item This conclusion holds trivially because $\npat=0$.
      \item This conclusion holds trivially because $\npat=0$.
      \item This conclusion holds trivially because $\upctx=\emptyset$ and $\npat=0$.
    \end{enumerate}
    \resetpfcounter
  \item[\text{(\ref{rule:cvalidP-UP-fold})}] ~
    \begin{pfsteps*}
      \item $\cpv=\acefoldp{\cpv'}$ \BY{assumption}
      \item $p=\aefoldp{p'}$ \BY{assumption}
      \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
      \item $\cvalidP{\upctx}{\pscenev}{\cpv}{p}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption} \pflabel{cvalidP}
      \item $\summaryOf{\acefoldp{\cpv'}} = \summaryOf{\cpv'}$ \BY{definition} \pflabel{summaryOf}
      \item $\summaryOf{\cpv'} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicedp{m_i}{n_i}{\ctau_i}}{\npat}$ \BY{definition} \pflabel{summaryOf2}
      \item $\sseq{
            \expandsTU{\uDelta}
            {
              \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
            }{\tau'_i}
          }{\nty}$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c1}
      \item $\sseq{
        \cvalidT{\emptyset}{
          \tsceneUP
            {\uDelta}{b}
        }{
          \ctau_i
        }{\tau_i}
      }{\npat}$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c2}
      \item $\sseq{
        \patExpands
          {\upctx_i}
          {\uPhi}
          {\parseUPatF{\bsubseq{b}{m_i}{n_i}}}
          {p_i}
          {\tau_i}
      }{\npat}$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c3}
    \item $\upctx = \biguplus_{0 \leq i < \npat} \upctx_i$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}}\pflabel{c4}\end{pfsteps*}
    The conclusions hold as follows:
    \begin{enumerate}
    \item \pfref{c1}
    \item \pfref{c2}
    \item \pfref{c3}
    \item \pfref{c4}
    \end{enumerate}
    \resetpfcounter
  \item[\text{(\ref{rule:cvalidP-UP-tpl})}] ~
    \begin{pfsteps*}
      \item $\cpv=\acetplp{\labelset}{\mapschema{\cpv}{j}{\labelset}}$ \BY{assumption}
      \item $p=\aetplp{\labelset}{\mapschema{p}{j}{\labelset}}$ \BY{assumption}
      \item $\tau = \aprod{\labelset}{\mapschema{\tau}{j}{\labelset}}$ \BY{assumption}
      \item $\upctx=\GIconsi{j \in \labelset}{\upctx_j}$ \BY{assumption} \pflabel{Gconsi}
      \item $\{\cvalidP{\upctx_j}{\pscenev}{\cpv_j}{p_j}{\tau_j}\}_{j \in \labelset}$ \BY{assumption} \pflabel{cvalidP}
      \item $\summaryOf{\acetplp{\labelset}{\mapschema{\cpv}{j}{\labelset}}} = \bigcup_{j \in \labelset} \summaryOf{\cpv_j}$ \BY{definition}
      \item $\{ \summaryOf{\cpv_j} = \sseq{\acesplicedt{m'_{i,j}}{n'_{i,j}}}{\ntyj} \cup \sseq{\acesplicedp{m_{i,j}}{n_{i,j}}{\ctau_{i,j}}}{\npatj} \}_{j \in \labelset}$ \BY{definition}\pflabel{summaryOf2}
      \item $\npat = \Sigma_{j \in \labelset} \npatj$ \BY{definition}
      \item $\{\sseq{
            \expandsTU{\uDelta}
            {
              \parseUTypF{\bsubseq{b}{m'_{i,j}}{n'_{i,j}}}
            }{\tau'_{i,j}}
          }{\ntyj}\}_{j \in \labelset}$ \BY{IH over \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c1}
      \item $\{\sseq{
        \cvalidT{\emptyset}{
          \tsceneUP
            {\uDelta}{b}
        }{
          \ctau_{i,j}
        }{\tau_{i,j}}
      }{\npatj}\}_{j \in \labelset}$ \BY{IH over \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c2}
      \item $\{\sseq{
        \patExpands
          {\upctx_{i,j}}
          {\uPhi}
          {\parseUPatF{\bsubseq{b}{m_{i,j}}{n_{i,j}}}}
          {p_{i,j}}
          {\tau_{i,j}}
      }{\npatj}\}_{j \in \labelset}$ \BY{IH over \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c3}
    \item $\{\upctx_j = \biguplus_{0 \leq i < \npatj} \upctx_{i,j}\}_{j \in \labelset}$ \BY{IH over \pfref{cvalidP} and \pfref{summaryOf2}}\pflabel{c4}
    \item $\biguplus{j \in \labelset} \upctx_{j} = \biguplus_{j \in \labelset} \biguplus{i \in \npatj} \upctx_{i,j}$ \BY{definition and \pfref{c4}}\pflabel{c4x}
    \end{pfsteps*}
    The conclusions hold as follows:
    \begin{enumerate}
      \item $\bigcup_{j \in \labelset} \bigcup_{i \in \ntyj} \text{\pfref{c1}}_{i,j}$
      \item $\bigcup_{j \in \labelset} \bigcup_{i \in \npatj} \text{\pfref{c2}}_{i,j}$
      \item $\bigcup_{j \in \labelset} \bigcup_{i \in \npatj} \text{\pfref{c3}}_{i,j}$
      \item \pfref{c4x}
    \end{enumerate}
    \resetpfcounter
  \item[\text{(\ref{rule:cvalidP-UP-in})}]
    \begin{pfsteps*}
      \item $\cpv=\aceinjp{\ell}{\cpv'}$ \BY{assumption}
      \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
      \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
      \item $\cvalidP{\upctx}{\pscenev}{\cpv}{p}{\tau'}$ \BY{assumption} \pflabel{cvalidP}
      \item $\summaryOf{\aceinjp{\ell}{\cpv'}} = \summaryOf{\cpv'}$ \BY{definition} \pflabel{summaryOf}
      \item $\summaryOf{\cpv'} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicedp{m_i}{n_i}{\ctau_i}}{\npat}$ \BY{definition} \pflabel{summaryOf2}
      \item $\sseq{
            \expandsTU{\uDelta}
            {
              \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
            }{\tau'_i}
          }{\nty}$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c1}
      \item $\sseq{
        \cvalidT{\emptyset}{
          \tsceneUP
            {\uDelta}{b}
        }{
          \ctau_i
        }{\tau_i}
      }{\npat}$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c2}
      \item $\sseq{
        \patExpands
          {\upctx_i}
          {\uPhi}
          {\parseUPatF{\bsubseq{b}{m_i}{n_i}}}
          {p_i}
          {\tau_i}
      }{\npat}$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}} \pflabel{c3}
    \item $\upctx = \biguplus_{0 \leq i < \npat} \upctx_i$ \BY{IH on \pfref{cvalidP} and \pfref{summaryOf2}}\pflabel{c4}\end{pfsteps*}
    The conclusions hold as follows:
    \begin{enumerate}
    \item \pfref{c1}
    \item \pfref{c2}
    \item \pfref{c3}
    \item \pfref{c4}
    \end{enumerate}
    \resetpfcounter
  \item[\text{(\ref{rule:cvalidP-UP-spliced})}] ~
    \begin{pfsteps*}
      \item $\cpv=\acesplicedp{m}{n}{\ctau}$ \BY{assumption}
      \item $\cvalidT{\emptyset}{\tsceneUP{\uDelta}{b}}{\ctau}{\tau}$ \BY{assumption} \pflabel{cvalidT}
      \item $\parseUPat{\bsubseq{b}{m}{n}}{\upv}$ \BY{assumption} \pflabel{parseUPat}
      \item $\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}$ \BY{assumption} \pflabel{patExpands}
      \item $\summaryOf{\acesplicedp{m}{n}{\ctau}} = \summaryOf{\ctau} \cup \{ \acesplicedp{m}{n}{\ctau} \}$ \BY{definition} \pflabel{summaryOf}
      \item $\summaryOf{\ctau} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty}$ \BY{definition} \pflabel{summaryOf2}
      \item $\sseq{\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{
  \parseUTypF{\bsubseq{b}{m_i}{n_i}}
}{\tau_i}}{n}$ \BY{Lemma \ref{thm:proto-type-expansion-decomposition-SES} on \pfref{cvalidT} and \pfref{summaryOf2}} \pflabel{expandsTU}
% \item $\sseq{\istypeU{\Delta_\text{app}}{\tau_i}}{n}$
    \end{pfsteps*}
    The conclusions hold as follows:
    \begin{enumerate}
      \item \pfref{expandsTU}
      \item \pfref{cvalidT}
      \item \pfref{parseUPat} and \pfref{patExpands}
      \item This conclusion holds by \pfref{patExpands} because $\npat=1$.
    \end{enumerate}
    \resetpfcounter
\end{byCases}
\end{proof}

\begin{theorem}[spTSM Abstract Reasoning Principles]
\label{thm:spTSM-Typing-Segmentation}
If $\patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}$ where $\uDelta=\uDD{\uD}{\Delta}$ and $\uGamma=\uGG{\uG}{\Gamma}$ then all of the following hold:
\begin{enumerate}
        \item (\textbf{Typing 1}) $\uPhi=\uPhi', \uPhyp{\tsmv}{a}{\tau}{\eparse}$ and $\patType{\pctx}{p}{\tau}$
        \item $\encodeBody{b}{\ebody}$
        \item $\evalU{\eparse(\ebody)}{{\lbltxt{SuccessP}}\cdot{\ecand}}$
        \item $\decodeCEPat{\ecand}{\cpv}$
        \item (\textbf{Segmentation}) $\segOK{\segof{\cpv}}{b}$
        \item $\summaryOf{\cpv} = \sseq{\acesplicedt{n'_i}{m'_i}}{\nty} \cup \sseq{\acesplicedp{m_i}{n_i}{\ctau_i}}{\npat}$
        \item (\textbf{Typing 2}) $\sseq{
              \expandsTU{\uDelta}
              {
                \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
              }{\tau'_i}
            }{\nty}$ and $\sseq{\istypeU{\Delta}{\tau'_i}}{\nty}$
        \item (\textbf{Typing 3}) $\sseq{
          \cvalidT{\emptyset}{
            \tsceneUP
              {\uDelta}{b}
          }{
            \ctau_i
          }{\tau_i}
        }{\npat}$ and $\sseq{\istypeU{\Delta}{\tau_i}}{\npat}$
        \item (\textbf{Typing 4}) $\sseq{
          \patExpands
            {\upctx_i}
            {\uPhi}
            {\parseUPatF{\bsubseq{b}{m_i}{n_i}}}
            {p_i}
            {\tau_i}
        }{\npat}$ and $\sseq{\patType{\upctx_i}{p_i}{\tau_i}}{\npat}$
      \item (\textbf{No Hidden Bindings}) $\upctx = \biguplus_{0 \leq i < \npat} \upctx_i$
\end{enumerate}
\end{theorem}
\begin{proof} By rule induction over Rules (\ref{rules:patExpands}). There is only one rule that applies.
\begin{byCases}
  \item[\text{(\ref{rule:patExpands-apuptsm})}] 
    \begin{pfsteps*}
      \item $\patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}$ \BY{assumption} \pflabel{patExpands}
      \item $\uPhi = \uPhi', \uPhyp{\tsmv}{a}{\tau}{\eparse}$ \BY{assumption} \pflabel{uPhidef}
      \item $\patType{\pctx}{p}{\tau}$ \BY{Theorem \ref{thm:typed-pattern-expansion} on \pfref{patExpands}} \pflabel{patType}
      \item $\encodeBody{b}{\ebody}$ \BY{assumption} \pflabel{encodeBody}
      \item $\evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}}$ \BY{assumption} \pflabel{evalU}
      \item $\decodeCEPat{\ecand}{\cpv}$ \BY{assumption} \pflabel{decodeCEPat}
      \item $\segOK{\segof{\cpv}}{b}$ \BY{assumption} \pflabel{segOK}
      \item $\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}$ \BY{assumption} \pflabel{cvalidP}
      \item $\summaryOf{\cpv} = \sseq{\acesplicedt{m'_i}{n'_i}}{\nty} \cup \sseq{\acesplicedp{m_i}{n_i}}{\npat}$ \BY{definition}\pflabel{summaryOf}
      \item $\sseq{
            \expandsTU{\uDelta}
            {
              \parseUTypF{\bsubseq{b}{m'_i}{n'_i}}
            }{\tau'_i}
          }{\nty}$ \BY{Lemma \ref{lemma:proto-pattern-expansion-decomposition-S} on \pfref{cvalidP} and \pfref{summaryOf}}\pflabel{c1}
      \item $\sseq{\istypeU{\Delta}{\tau'_i}}{\nty}$ \BY{Lemma \ref{lemma:type-expansion-U}, part 1 over \pfref{c1}}\pflabel{t1}
      \item $\sseq{
        \cvalidT{\emptyset}{
          \tsceneUP
            {\uDelta}{b}
        }{
          \ctau_i
        }{\tau_i}
      }{\npat}$  \BY{Lemma \ref{lemma:proto-pattern-expansion-decomposition-S} on \pfref{cvalidP} and \pfref{summaryOf}}\pflabel{c2}
      \item $\sseq{\istypeU{\Delta}{\tau_i}}{\npat}$ \BY{Lemma \ref{lemma:type-expansion-U}, part 2 over \pfref{c2}}\pflabel{t2}
      \item $\sseq{
        \patExpands
          {\upctx_i}
          {\uPhi}
          {\parseUPatF{\bsubseq{b}{m_i}{n_i}}}
          {p_i}
          {\tau_i}
      }{\npat}$ \BY{Lemma \ref{lemma:proto-pattern-expansion-decomposition-S} on \pfref{cvalidP} and \pfref{summaryOf}}\pflabel{c3}
    \item $\sseq{\patType{\upctx_i}{p_i}{\tau_i}}{\npat}$ \BY{Theorem \ref{thm:typed-pattern-expansion} over \pfref{c3}}\pflabel{t3}
    \item $\upctx = \biguplus_{0 \leq i < \npat} \upctx_i$ \pflabel{c4}
    \end{pfsteps*}
    The conclusions hold as follows:
    \begin{enumerate}
      \item \pfref{uPhidef} and \pfref{patType}
      \item \pfref{encodeBody}
      \item \pfref{evalU}
      \item \pfref{decodeCEPat}
      \item \pfref{segOK}
      \item \pfref{summaryOf}
      \item \pfref{c1} and \pfref{t1}
      \item \pfref{c2} and \pfref{t2}
      \item \pfref{c3} and \pfref{t3}
      \item \pfref{c4}
    \end{enumerate}
    \resetpfcounter
\end{byCases}
\end{proof}
\end{grayparbox}

% \inferrule{
%   \uPhi = \uPhi', \uPhyp{\tsmv}{a}{\tau}{\eparse}\\\\
%   \encodeBody{b}{\ebody}\\
%   \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}}\\
%   \decodeCEPat{\ecand}{\cpv}\\\\
%     \segOK{\segof{\cpv}}{b}\\
%   \cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}
% }{
%   \patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}
% }}

\chapter{$\miniVerseParam$}\label{appendix:miniVerseParam}

\clearpage
\section{Expanded Language (XL)}
\subsection{Syntax}
\subsubsection{Signatures and Module Expressions}
\[\begin{array}{lllllll}
\textbf{Sort} & & & \textbf{Operational Form} 
%& \textbf{Stylized Form} 
& \textbf{Description}\\
\mathsf{Sig} & \sigma & ::= & \asignature{\kappa}{u}{\tau} 
%& \signature{u}{\kappa}{\tau} 
& \text{signature}\\
\mathsf{Mod} & M & ::= & X 
%& X 
& \text{module variable}\\
&&& \astruct{c}{e} 
%& \struct{c}{e} 
& \text{structure}\\
&&& \aseal{\sigma}{M} 
%& \seal{M}{\sigma} 
& \text{seal}\\
&&& \amlet{\sigma}{M}{X}{M} %& \mlet{X}{M}{M}{\sigma} 
& \text{definition}
\end{array}\]

\subsubsection{Kinds and Constructors}
\[\begin{array}{lrlllll}
\textbf{Sort} & & & \textbf{Operational Form} 
%& \textbf{Stylized Form} 
& \textbf{Description}\\
\mathsf{Kind} & \kappa & ::= & \akdarr{\kappa}{u}{\kappa} 
%& \kdarr{u}{\kappa}{\kappa} 
& \text{dependent function}\\
&&& \akunit 
%& \kunit 
& \text{nullary product}\\
&&& \akdbprod{\kappa}{u}{\kappa} 
%& \kdbprod{u}{\kappa}{\kappa} 
& \text{dependent product}\\
%&&& \akdprodstd & \kdprodstd & \text{labeled dependent product}\\
&&& \akty 
%& \kty
& \text{types}\\
&&& \aksing{\tau} 
%& \ksing{\tau} 
& \text{singleton}\\
\mathsf{Con} & c, \tau & ::= & u 
%& u 
& \text{constructor variable}\\
&&& t 
%& t 
& \text{type variable}
\\
&&& \acabs{u}{c} 
%& \cabs{u}{c} 
& \text{abstraction}\\
&&& \acapp{c}{c} 
%& \capp{c}{c} 
& \text{application}\\
&&& \actriv 
%& \ctriv 
& \text{trivial}\\
&&& \acpair{c}{c}
% & \cpair{c}{c} 
& \text{pair}\\
&&& \acprl{c} 
%& \cprl{c} 
& \text{left projection}\\
&&& \acprr{c} 
%& \cprr{c} 
& \text{right projection}\\
%&&& \adtplX & \dtplX & \text{labeled dependent tuple}\\
%&&& \adprj{\ell}{c} & \prj{c}{\ell} & \text{projection}\\
&&& \aparr{\tau}{\tau} 
%& \parr{\tau}{\tau} 
& \text{partial function}\\
&&& \aallu{\kappa}{u}{\tau} 
%& \forallu{u}{\kappa}{\tau} 
& \text{polymorphic}\\
&&& \arec{t}{\tau} 
%& \rect{t}{\tau} 
& \text{recursive}\\
&&& \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}} 
%& \prodt{\mapschema{\tau}{i}{\labelset}} 
& \text{labeled product}\\
&&& \asum{\labelset}{\mapschema{\tau}{i}{\labelset}} 
%& \sumt{\mapschema{\tau}{i}{\labelset}} 
& \text{labeled sum}\\
&&& \amcon{M} 
%& \mcon{M} 
& \text{constructor component}
\end{array}\]
\clearpage

\subsubsection{Expressions, Rules and Patterns}
\[\begin{array}{lllllll}
\textbf{Sort} & & & \textbf{Operational Form} 
%& \textbf{Stylized Form} 
& \textbf{Description}\\
\mathsf{Exp} & e & ::= & x 
%& x 
& \text{variable}\\
&&& \aelam{\tau}{x}{e} 
%& \lam{x}{\tau}{e} 
& \text{abstraction}\\
&&& \aeap{e}{e} 
%& \ap{e}{e} 
& \text{application}\\
&&& \aeclam{\kappa}{u}{e} %& \clam{u}{\kappa}{e} 
& \text{constructor abstraction}\\
&&& \aecap{e}{\kappa} %& \cAp{e}{\kappa} 
& \text{constructor application}\\
&&& \aefold{e} %& \fold{e} 
& \text{fold}\\
&&& \aeunfold{e} %& \unfold{e} 
& \text{unfold}\\
&&& \aetpl{\labelset}{\mapschema{e}{i}{\labelset}} 
%& \tpl{\mapschema{e}{i}{\labelset}} 
& \text{labeled tuple}\\
&&& \aepr{\ell}{e} 
%& \prj{e}{\ell} 
& \text{projection}\\
&&& \aein{\ell}{e} 
%& \inj{\ell}{e} 
& \text{injection}\\
&&& \aematchwith{n}{e}{\seqschemaX{r}} 
%& \matchwith{e}{\seqschemaX{r}} 
& \text{match}\\
&&& \amval{M} 
%& \mval{M} 
& \text{value component}\\
\mathsf{Rule} & r & ::= & \aematchrule{p}{e} 
%& \matchrule{p}{e} 
& \text{rule}\\
\mathsf{Pat} & p & ::= & x 
%& x 
& \text{variable pattern}\\
&&& \aewildp 
%& \wildp 
& \text{wildcard pattern}\\
&&& \aefoldp{p} 
%& \foldp{p} 
& \text{fold pattern}\\
&&& \aetplp{\labelset}{\mapschema{p}{i}{\labelset}} 
%& \tplp{\mapschema{p}{i}{\labelset}} 
& \text{labeled tuple pattern}\\
&&& \aeinjp{\ell}{p} 
%& \injp{\ell}{p} 
& \text{injection pattern}
\end{array}\]

\subsection{Statics}\label{appendix:P-statics}
\subsubsection{Unified Contexts}
A \emph{unified context}, $\Omega$, is an ordered finite function. 
We write
\begin{itemize}
\item $\Omega, X : \sigma$ when $X \notin \domof{\Omega}$ and $\issigX{\sigma}$ for the extension of $\Omega$ with a mapping from $X$ to the hypothesis $X : \sigma$.
\item $\Omega, x : \tau$ when $x \notin \domof{\Omega}$ and $\haskindX{\tau}{\akty}$ for the extension of $\Omega$ with a mapping from $x$ to the hypothesis $x : \tau$
\item $\Omega, u :: \kappa$ when $u \notin \domof{\Omega}$ and $\iskindX{\kappa}$ for the extension of $\Omega$ with a mapping from $u$ to the hypothesis $u :: \kappa$
\end{itemize}
A well-formed unified context is one that can be constructed by some sequence of such extensions, starting from the empty context, $\emptyset$. We identify unified contexts up to exchange and contraction in the usual manner.

% \begin{definition}[Unified Context Formation] $\isctxU{\Omega}$ iff:
% \begin{enumerate}
% \item $\Omega = \emptyset$; or
% \item $\Omega = \Omega', X : \sigma$ and $\issig{\Omega'}{\sigma}$; or 
% \item $\Omega = \Omega', u :: \kappa$ and $\iskind{\Omega'}{\kappa}$; or 
% \item $\Omega = \Omega', x : \tau$ and $\isTypeP{\Omega'}{\tau}$.
% \end{enumerate}
% \end{definition}

\subsubsection{Signatures and Structures}
\noindent\fbox{$\strut\issigX{\sigma}$}~~$\sigma$ is a signature
\begin{equation}\label{rule:issig}
\inferrule{
  \iskindX{\kappa}\\
  \haskind{\Omega, u :: \kappa}{\tau}{\akty}
}{
  \issigX{\asignature{\kappa}{u}{\tau}}
}
\end{equation}

\noindent\fbox{$\strut\sigequalX{\sigma}{\sigma'}$}~~$\sigma$ and $\sigma'$ are definitionally equal
\begin{equation}\label{rule:sigequal}
\inferrule{
  \kequalX{\kappa}{\kappa'}\\
  \cequal{\Omega, u :: \kappa}{\tau}{\tau'}{\akty}
}{
  \sigequalX{\asignature{\kappa}{u}{\tau}}{\asignature{\kappa'}{u}{\tau'}}
}
\end{equation}

\noindent\fbox{$\strut\sigsubX{\sigma}{\sigma'}$}~~$\sigma$ is a subsignature of $\sigma'$
\begin{equation}\label{rule:sigsub}
\inferrule{
  \ksubX{\kappa}{\kappa'}\\
  \issubtypeP{\Omega, u :: \kappa}{\tau}{\tau'}
}{
  \sigsubX{\asignature{\kappa}{u}{\tau}}{\asignature{\kappa'}{u}{\tau'}}
}
\end{equation}

\noindent\fbox{$\strut\hassigX{M}{\sigma}$}~~$M$ matches $\sigma$
\begin{subequations}\label{rules:hassig}
\begin{equation}\label{rule:hassig-subsume}
\inferrule{
  \hassigX{M}{\sigma}\\
  \sigsubX{\sigma}{\sigma'}
}{
  \hassigX{M}{\sigma'}
}
\end{equation}
\begin{equation}\label{rule:hassig-var}
\inferrule{ }{
  \hassig{\Omega, X : \sigma}{X}{\sigma}
}
\end{equation}
\begin{equation}\label{rule:hassig-struct}
\inferrule{
  \haskindX{c}{\kappa}\\
  \hastypeP{\Omega}{e}{[c/u]\tau}
}{
  \hassigX{\astruct{c}{e}}{\asignature{\kappa}{u}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:hassig-seal}
\inferrule{
  \issigX{\sigma}\\
  \hassigX{M}{\sigma}
}{
  \hassigX{\aseal{\sigma}{M}}{\sigma}
}
\end{equation}
\begin{equation}\label{rule:hassig-let}
\inferrule{
  \hassigX{M}{\sigma}\\
  \issigX{\sigma'}\\
  \hassig{\Omega, X : \sigma}{M'}{\sigma'}  
}{
  \hassigX{\amlet{\sigma'}{M}{X}{M'}}{\sigma'}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\ismvalX{M}$}~~$M$ is, or stands for, a module value
\begin{subequations}\label{rules:ismval}
\begin{equation}\label{rule:ismval-struct}
\inferrule{ }{
  \ismvalX{\astruct{c}{e}}
}
\end{equation}
\begin{equation}\label{rule:ismval-var}
\inferrule{ }{
  \ismval{\Omega, X : \sigma}{X}
}
\end{equation}
\end{subequations}

\subsubsection{Kinds and Constructors}
\noindent\fbox{$\strut\iskindX{\kappa}$}~~$\kappa$ is a kind
\begin{subequations}\label{rules:iskind}
\begin{equation}\label{rule:iskind-darr}
\inferrule{
  \iskindX{\kappa_1}\\
  \iskind{\Omega, u :: \kappa_1}{\kappa_2}
}{
  \iskindX{\akdarr{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:iskind-unit}
\inferrule{ }{
  \iskindX{\akunit}
}
\end{equation}
\begin{equation}\label{rule:iskind-dprod}
\inferrule{
  \iskindX{\kappa_1}\\
  \iskind{\Omega, u :: \kappa_1}{\kappa_2}
}{
  \iskindX{\akdbprod{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:iskind-ty}
\inferrule{ }{
  \iskindX{\akty}
}
\end{equation}
\begin{equation}\label{rule:iskind-sing}
\inferrule{
  \haskindX{\tau}{\akty}
}{
  \iskindX{\aksing{\tau}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\kequalX{\kappa}{\kappa'}$}~~$\kappa$ and $\kappa'$ are definitionally equal
\begin{subequations}\label{rules:kequal}
\begin{equation}\label{rule:kequal-refl}
\inferrule{
  \iskindX{\kappa}
}{
  \kequalX{\kappa}{\kappa}
}
\end{equation}
\begin{equation}\label{rule:kequal-sym}
\inferrule{
  \kequalX{\kappa}{\kappa'}
}{
  \kequalX{\kappa'}{\kappa}
}
\end{equation}
\begin{equation}\label{rule:kequal-trans}
\inferrule{
  \kequalX{\kappa}{\kappa'}\\
  \kequalX{\kappa'}{\kappa''}
}{
  \kequalX{\kappa}{\kappa''}
}
\end{equation}
\begin{equation}\label{rule:kequal-darr}
\inferrule{
  \kequalX{\kappa_1}{\kappa_1'}\\
  \kequal{\Omega, u :: \kappa_1}{\kappa_2}{\kappa_2'}
}{
  \kequalX{\akdarr{\kappa_1}{u}{\kappa_2}}{\akdarr{\kappa_1'}{u}{\kappa_2'}}
}
\end{equation}
\begin{equation}\label{rule:kequal-dprod}
\inferrule{
  \kequalX{\kappa_1}{\kappa'_1}\\
  \kequal{\Omega, u :: \kappa_1}{\kappa_2}{\kappa'_2}
}{
  \kequalX{\akdbprod{\kappa_1}{u}{\kappa_2}}{\akdbprod{\kappa'_1}{u}{\kappa'_2}}  
}
\end{equation}
\begin{equation}\label{rule:kequal-sing}
\inferrule{
  \cequalX{c}{c'}{\akty}
}{
  \kequalX{\aksing{c}}{\aksing{c'}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\ksubX{\kappa}{\kappa'}$}~~$\kappa$ is a subkind of $\kappa'$
\begin{subequations}\label{rules:ksub}
\begin{equation}\label{rule:ksub-equal}
\inferrule{
  \kequalX{\kappa}{\kappa'}
}{
  \ksubX{\kappa}{\kappa'}
}
\end{equation}
\begin{equation}\label{rule:ksub-trans}
\inferrule{
  \ksubX{\kappa}{\kappa'}\\
  \ksubX{\kappa'}{\kappa''}
}{
  \ksubX{\kappa}{\kappa''}
}
\end{equation}
\begin{equation}\label{rule:ksub-darr}
\inferrule{
  \ksubX{\kappa'_1}{\kappa_1}\\
  \ksub{\Omega, u :: \kappa'_1}{\kappa_2}{\kappa'_2}  
}{
  \ksubX{\akdarr{\kappa_1}{u}{\kappa_2}}{\akdarr{\kappa'_1}{u}{\kappa'_2}}
}
\end{equation}
\begin{equation}\label{rule:ksub-dprod}
\inferrule{
  \ksubX{\kappa_1}{\kappa'_1}\\
  \ksub{\Omega, u :: \kappa_1}{\kappa_2}{\kappa'_2}
}{
  \ksubX{\akdbprod{\kappa_1}{u}{\kappa_2}}{\akdbprod{\kappa'_1}{u}{\kappa'_2}}
}
\end{equation}
\begin{equation}\label{rule:ksub-sing}
\inferrule{
  \haskindX{\tau}{\akty}
}{
  \ksubX{\aksing{\tau}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:ksub-sing-2}
\inferrule{
  \issubtypePX{\tau}{\tau'}
}{
  \ksubX{\aksing{\tau}}{\aksing{\tau'}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\haskindX{c}{\kappa}$}~~$c$ has kind $\kappa$
\begin{subequations}\label{rules:haskind}
\begin{equation}\label{rule:haskind-subsume}
\inferrule{
  \haskindX{c}{\kappa_1}\\
  \ksubX{\kappa_1}{\kappa_2}
}{
  \haskindX{c}{\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:haskind-var}
\inferrule{ }{\haskind{\Omega, u :: \kappa}{u}{\kappa}}
\end{equation}
\begin{equation}\label{rule:haskind-abs}
\inferrule{
  \haskind{\Omega, u :: \kappa_1}{c_2}{\kappa_2}
}{
  \haskindX{\acabs{u}{c_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:haskind-app}
\inferrule{
  \haskindX{c_1}{\akdarr{\kappa_2}{u}{\kappa}}\\
  \haskindX{c_2}{\kappa_2}
}{
  \haskindX{\acapp{c_1}{c_2}}{[c_1/u]\kappa}
}
\end{equation}
\begin{equation}\label{rule:haskind-unit}
\inferrule{ }{
  \haskindX{\actriv}{\akunit}
}
\end{equation}
\begin{equation}\label{rule:haskind-pair}
\inferrule{
  \haskindX{c_1}{\kappa_1}\\
  \haskindX{c_2}{[c_1/u]\kappa_2}
}{
  \haskindX{\acpair{c_1}{c_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:haskind-prl}
\inferrule{
  \haskindX{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \haskindX{\acprl{c}}{\kappa_1}
}
\end{equation}
\begin{equation}\label{rule:haskind-prr}
\inferrule{
  \haskindX{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \haskindX{\acprr{c}}{[\acprl{c}/u]\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:haskind-parr}
\inferrule{
  \haskindX{\tau_1}{\akty}\\
  \haskindX{\tau_2}{\akty}
}{
  \haskindX{\aparr{\tau_1}{\tau_2}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:haskind-all}
\inferrule{
  \iskindX{\kappa}\\
  \haskind{\Omega, u :: \kappa}{\tau}{\akty}
}{
  \haskindX{\aallu{\kappa}{u}{\tau}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:haskind-rec}
\inferrule{
  \haskind{\Omega, t :: \akty}{\tau}{\akty}
}{
  \haskindX{\arec{t}{\tau}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:haskind-prod}
\inferrule{
  \{\haskindX{\tau_i}{\akty}\}_{1 \leq i \leq n}
}{
  \haskindX{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:haskind-sum}
\inferrule{
  \{\haskindX{\tau_i}{\akty}\}_{1 \leq i \leq n}
}{
  \haskindX{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:haskind-sing}
\inferrule{
  \haskindX{c}{\akty}
}{
  \haskindX{c}{\aksing{c}}
}
\end{equation}
\begin{equation}\label{rule:haskind-stat}
\inferrule{
  \ismvalX{M}\\
  \hassigX{M}{\asignature{\kappa}{u}{\tau}}
}{
  \haskindX{\amcon{M}}{\kappa}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\cequalX{c}{c'}{\kappa}$}~~$c$ and $c'$ are definitionally equal as constructors of kind $\kappa$
\begin{subequations}\label{rules:cequal}
\begin{equation}\label{rule:cequal-refl}
\inferrule{
  \haskindX{c}{\kappa}
}{
  \cequalX{c}{c}{\kappa}
}
\end{equation}
\begin{equation}\label{rule:cequal-sym}
\inferrule{
  \cequalX{c}{c'}{\kappa}
}{
  \cequalX{c'}{c}{\kappa}
}
\end{equation}
\begin{equation}\label{rule:cequal-trans}
\inferrule{
  \cequalX{c}{c'}{\kappa}\\
  \cequalX{c'}{c''}{\kappa}
}{
  \cequalX{c}{c''}{\kappa}
}
\end{equation}
\begin{equation}\label{rule:cequal-lam}
\inferrule{
  \cequal{\Omega, u :: \kappa_1}{c}{c'}{\kappa_2}
}{
  \cequalX{\acabs{u}{c}}{\acabs{u}{c'}}{\akdarr{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cequal-app-1}
\inferrule{
  \cequalX{c_1}{c_1'}{\akdarr{\kappa_2}{u}{\kappa}}\\
  \cequalX{c_2}{c_2'}{\kappa_2}
}{
  \cequalX{\acapp{c_1}{c_2}}{\acapp{c'_1}{c'_2}}{\kappa}
}
\end{equation}
\begin{equation}\label{rule:cequal-app-2}
\inferrule{
  \haskindX{\acabs{u}{c}}{\akdarr{\kappa_2}{u}{\kappa}}\\
  \haskindX{c_2}{\kappa_2}
}{
  \cequalX{\acapp{\acabs{u}{c}}{c_2}}{[c_2/u]c}{[c_2/u]\kappa}
}
\end{equation}
\begin{equation}\label{rule:cequal-pair}
\inferrule{
  \cequalX{c_1}{c'_1}{\kappa_1}\\
  \cequalX{c_2}{c'_2}{[c_1/u]\kappa_2}
}{
  \cequalX{\acpair{c_1}{c_2}}{\acpair{c'_1}{c'_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cequal-prl-1}
\inferrule{
  \cequalX{c}{c'}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \cequalX{\acprl{c}}{\acprl{c'}}{\kappa_1}
}
\end{equation}
\begin{equation}\label{rule:cequal-prl-2}
\inferrule{
  \haskindX{c_1}{\kappa_1}\\
  \haskindX{c_2}{\kappa_2}
}{
  \cequalX{\acprl{\acpair{c_1}{c_2}}}{c_1}{\kappa_1}
}
\end{equation}
\begin{equation}\label{rule:cequal-prr-1}
\inferrule{
  \cequalX{c}{c'}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \cequalX{\acprr{c}}{\acprr{c'}}{[\acprl{c}/u]\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:cequal-prr-2}
\inferrule{
  \haskindX{c_1}{\kappa_1}\\
  \haskindX{c_2}{\kappa_2}
}{
  \cequalX{\acprr{\acpair{c_1}{c_2}}}{c_2}{\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:cequal-parr}
\inferrule{
  \cequalX{\tau_1}{\tau'_1}{\akty}\\
  \cequalX{\tau_2}{\tau'_2}{\akty}
}{
  \cequalX{\aparr{\tau_1}{\tau_2}}{\aparr{\tau'_1}{\tau'_2}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cequal-all}
\inferrule{
  \kequalX{\kappa}{\kappa'}\\
  \cequal{\Omega, u :: \kappa}{\tau}{\tau'}{\akty}
}{
  \cequalX{\aallu{\kappa}{u}{\tau}}{\aallu{\kappa'}{u}{\tau'}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cequal-rec}
\inferrule{
  \cequal{\Omega, t :: \akty}{\tau}{\tau'}{\akty}
}{
  \cequalX{\arec{t}{\tau}}{\arec{t}{\tau'}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cequal-prod}
\inferrule{
  \{\cequalX{\tau_i}{\tau'_i}{\akty}\}_{1 \leq i \leq n}
}{
  \cequalX{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau'}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cequal-sum}
\inferrule{
  \{\cequalX{\tau_i}{\tau'_i}{\akty}\}_{1 \leq i \leq n}
}{
  \cequalX{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau'}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cequal-sing}
\inferrule{
  \haskindX{c}{\aksing{c'}}
}{
  \cequalX{c}{c'}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cequal-stat}
\inferrule{
  % \ismvalX{\astruct{c}{e}}\\
  \hassigX{\astruct{c}{e}}{\asignature{\kappa}{u}{\tau}}
}{
  \cequalX{\amcon{\astruct{c}{e}}}{c}{\kappa}
}
\end{equation}
\end{subequations}
\subsubsection{Expressions, Rules and Patterns}
% \noindent\fbox{$\strut\istypeP{\Omega}{\tau}$}~~$\tau$ is a type

% \vspace{6px}\noindent Types, $\tau$, classify expressions. The constructors of kind $\akty$ coincide with the types of $\miniVerseParam$.
% \begin{equation}\label{rule:istypeP}
% \inferrule{
%   \haskindX{\tau}{\akty}
% }{
%   \istypeP{\Omega}{\tau}
% }
% \end{equation}

% \noindent\fbox{$\strut\tequalPX{\tau}{\tau'}$}~~$\tau$ and $\tau'$ are definitionally equal types

% \vspace{6px}\noindent Type equality then coincides with constructor equality at kind $\akty$.
% \begin{equation}\label{rule:tequalP}
% \inferrule{
%   \cequalX{\tau}{\tau}{\akty}
% }{
%   \tequalPX{\tau}{\tau'}
% }
% \end{equation}


\noindent\fbox{$\strut\issubtypePX{\tau}{\tau'}$}~~$\tau$ is a subtype of $\tau'$

\begin{subequations}\label{rules:issubtypeP}  
\begin{equation}\label{rule:issubtypeP-equal}
\inferrule{
  \cequalX{\tau_1}{\tau_2}{\akty}
}{
  \issubtypePX{\tau_1}{\tau_2}
}
\end{equation}
\begin{equation}\label{rule:issubtypeP-trans}
\inferrule{
  \issubtypePX{\tau}{\tau'}\\
  \issubtypePX{\tau'}{\tau''}
}{
  \issubtypePX{\tau}{\tau''}
}
\end{equation}
\begin{equation}\label{rule:issubtypeP-parr}
\inferrule{
  \issubtypePX{\tau_1'}{\tau_1}\\
  \issubtypePX{\tau_2}{\tau_2'}
}{
  \issubtypePX{\aparr{\tau_1}{\tau_2}}{\aparr{\tau_1'}{\tau_2'}}
}
\end{equation}
\begin{equation}\label{rule:issubtypeP-all}
\inferrule{
  \ksubX{\kappa'}{\kappa}\\
  \issubtypeP{\Omega, u :: \kappa'}{\tau}{\tau'}
}{
  \issubtypePX{\aallu{\kappa}{u}{\tau}}{\aallu{\kappa'}{u}{\tau'}}
}
\end{equation}
\begin{equation}\label{rule:issubtypeP-prod}
\inferrule{
  \{\issubtypePX{\tau_i}{\tau'_i}\}_{i \in \labelset}
}{
  \issubtypePX{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau'}{i}{\labelset}}}
}
\end{equation}
\begin{equation}\label{rule:issubtypeP-sum}
\inferrule{
  \{\issubtypePX{\tau_i}{\tau'_i}\}_{i \in \labelset}
}{
  \issubtypePX{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau'}{i}{\labelset}}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\hastypeP{\Omega}{e}{\tau}$}~~$e$ has type $\tau$
\begin{subequations}\label{rules:hastypeP}
\begin{equation}\label{rule:hastypeP-subsume}
\inferrule{
  \hastypeP{\Omega}{e}{\tau}\\
  \issubtypePX{\tau}{\tau'}
}{
  \hastypeP{\Omega}{e}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:hastypeP-var}
  \inferrule{ }{
    \hastypeP{\Omega, \Ghyp{x}{\tau}}{x}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-lam}
  \inferrule{
    \haskind{\Omega}{\tau}{\akty}\\
    \hastypeP{\Omega, \Ghyp{x}{\tau}}{e}{\tau'}
  }{
    \hastypeP{\Omega}{\aelam{\tau}{x}{e}}{\aparr{\tau}{\tau'}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-ap}
  \inferrule{
    \hastypeP{\Omega}{e_1}{\aparr{\tau}{\tau'}}\\
    \hastypeP{\Omega}{e_2}{\tau}
  }{
    \hastypeP{\Omega}{\aeap{e_1}{e_2}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-clam}
  \inferrule{
    \iskindX{\kappa}\\
    \hastypeP{\Omega, u :: \kappa}{e}{\tau}
  }{
    \hastypeP{\Omega}{\aeclam{\kappa}{u}{e}}{\aallu{\kappa}{u}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-cap}
  \inferrule{
    \hastypeP{\Omega}{e}{\aallu{\kappa}{u}{\tau}}\\
    \haskindX{c}{\kappa}
  }{
    \hastypeP{\Omega}{\aecap{e}{c}}{[c/u]\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-fold}
  \inferrule{\
    % \haskind{\Omega, t :: \akty}{\tau}{\akty}\\
    \hastypeP{\Omega}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \hastypeP{\Omega}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-unfold}
  \inferrule{
    \hastypeP{\Omega}{e}{\arec{t}{\tau}}
  }{
    \hastypeP{\Omega}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-tpl}
  \inferrule{
    \{\hastypeP{\Omega}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \hastypeP{\Omega}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-pr}
  \inferrule{
    \hastypeP{\Omega}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}}
  }{
    \hastypeP{\Omega}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-in}
  \inferrule{
    % \{\haskind{\Omega}{\tau_i}{\akty}\}_{i \in \labelset}\\
    % \haskind{\Omega}{\tau}{\akty}\\
    \hastypeP{\Omega}{e}{\tau}
  }{
    \hastypeP{\Omega}{\aein{\ell}{e}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \ell \hookrightarrow \tau}}
  }
\end{equation}
\begin{equation}\label{rule:hastypeP-match}
\inferrule{
  \hastypeP{\Omega}{e}{\tau}\\
  % \haskind{\Omega}{\tau'}{\akty}\\
  \{\ruleTypeP{\Omega}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}\\
}{\hastypeP{\Omega}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}}
\end{equation}
\begin{equation}\label{rule:hastypeP-dyn}
\inferrule{
  \ismvalX{M}\\
  \hassigX{M}{\asignature{\kappa}{u}{\tau}}
}{
  \hastypeP{\Omega}{\amval{M}}{[\amcon{M}/u]\tau}
}
\end{equation}
\end{subequations}
\noindent\fbox{$\strut\ruleTypeP{\Omega}{r}{\tau}{\tau'}$}~~$r$ takes values of type $\tau$ to values of type $\tau'$
\begin{equation}\label{rule:ruleTypeP}
\inferrule{
  \patTypeP{\Omega'}{p}{\tau}\\
  \hastypeP{\Gcons{\Omega}{\Omega'}}{e}{\tau'}
}{
  \ruleTypeP{\Omega}{\aematchrule{p}{e}}{\tau}{\tau'}
}
\end{equation}

\noindent\fbox{$\strut\patTypeP{\Omega'}{p}{\tau}$}~~$p$ matches values of type $\tau$ generating hypotheses $\Omega'$

\begin{subequations}\label{rules:patTypeP}
\begin{equation}\label{rule:patTypeP-subsume}
\inferrule{
  \patTypeP{\Omega'}{p}{\tau}\\
  \issubtypePX{\tau}{\tau'}
}{
  \patTypeP{\Omega'}{p}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:patTypeP-var}
\inferrule{ }{\patTypeP{\Ghyp{x}{\tau}}{x}{\tau}}
\end{equation}
\begin{equation}\label{rule:patTypeP-wild}
\inferrule{ }{\patTypeP{\emptyset}{\aewildp}{\tau}}
\end{equation}
\begin{equation}\label{rule:patTypeP-fold}
\inferrule{
  \patTypeP{\Omega'}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \patTypeP{\Omega'}{\aefoldp{p}}{\arec{t}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:patTypeP-tpl}
\inferrule{
  \{\patTypeP{\Omega_i}{p_i}{\tau_i}\}_{i \in \labelset}
}{
  \patTypeP{\Gconsi{i \in \labelset}{\Omega_i}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
}
\end{equation}
\begin{equation}\label{rule:patTypeP-inj}
\inferrule{
  \patTypeP{\Omega'}{p}{\tau}
}{
  \patTypeP{\Omega'}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}
\end{equation}
\end{subequations}

\subsubsection{Metatheory}
The rules above are syntax-directed, so we assume an inversion lemma for each rule as needed without stating it separately or proving it explicitly. The following standard lemmas also hold, for all basic judgements $J$ above.

\begin{lemma}[Weakening]\label{lemma:weakening-P}  If $\Omega \vdash J$ then $\Omega \cup \Omega' \vdash J$.
% \begin{enumerate}
% \item \begin{enumerate}
%   \item If $\issigX{\sigma}$ then $\issig{\Omega \cup \Omega'}{\sigma}$.
%   \item If $\sigequal{\Omega}{\sigma}{\sigma'}$ then $\sigequal{\Omega \cup \Omega'}{\sigma}{\sigma'}$.
%   \item If $\sigsub{\Omega}{\sigma}{\sigma'}$ then $\sigsub{\Omega \cup \Omega'}{\sigma}{\sigma'}$.
%   \item If $\hassigX{M}{\sigma}$ then $\hassig{\Omega \cup \Omega'}{M}{\sigma}$.
%   \item If $\ismvalX{M}$ then $\ismval{\Omega \cup \Omega'}{M}$.
%   \end{enumerate}
% \item \begin{enumerate}
% \item If $\iskindX{\kappa}$ then $\iskind{\Omega \cup \Omega'}{\kappa}$.
% \item If $\kequalX{\kappa}{\kappa'}$ then $\kequal{\Omega \cup \Omega'}{\kappa}{\kappa'}$.
% \item If $\ksubX{\kappa}{\kappa'}$ then $\ksub{\Omega \cup \Omega'}{\kappa}{\kappa'}$.
% \item If $\haskindX{c}{\kappa}$ then $\haskind{\Omega \cup \Omega'}{c}{\kappa}$.
% \item If $\cequalX{c}{c'}{\kappa}$ then $\cequal{\Omega \cup \Omega'}{c}{c'}{\kappa}$.
% \end{enumerate}
% \item \begin{enumerate}
% \item If $\istypeP{\Omega}{\tau}$ then $\istypeP{\Omega \cup \Omega'}{\tau}$.
% \item If $\tequalPX{\tau}{\tau'}$ then $\tequalP{\Omega \cup \Omega'}{\tau}{\tau'}$.
% \item If $\issubtypePX{\tau}{\tau'}$ then $\issubtypeP{\Omega \cup \Omega'}{\tau}{\tau'}$.
% \item If $\hastypeP{\Omega}{e}{\tau}$ then $\hastypeP{\Omega \cup \Omega'}{e}{\tau}$.
% \item If $\ruleTypeP{\Omega}{r}{\tau}{\tau'}$ then $\ruleTypeP{\Omega \cup \Omega'}{r}{\tau}{\tau'}$.
% \item If $\patTypePC{\Omega}{\Omega''}{p}{\tau}$ then $\patTypePC{\Omega \cup \Omega'}{\Omega''}{p}{\tau}$.
% \end{enumerate}
% \end{enumerate}
\end{lemma}
\begin{proof-sketch} By straightforward mutual rule induction.
\end{proof-sketch}

A \emph{substitution}, $\omega$, is a finite function that maps:
\begin{itemize}
\item each $X \in \domof{\omega}$ to a module expression subtitution, $M/X$; 
\item each $u \in \domof{\omega}$ to a constructor substitution, $c/u$; and 
\item each $x \in \domof{\omega}$ to an expression substitution, $e/x$.
\end{itemize}

We write $\hastypeP{\Omega}{\omega}{\Omega'}$ iff $\domof{\omega}=\domof{\Omega'}$ and:
\begin{itemize}
\item for each $M/X \in \omega$, we have $X : \sigma \in \Omega'$ and $\hassigX{M}{\sigma}$ and $\ismvalX{M}$; and
\item for each $c/u \in \omega$, we have $u :: \kappa \in \Omega'$ and $\haskindX{c}{\kappa}$; and 
\item for each $e/x \in \omega$, we have $x : \tau \in \Omega'$ and $\hastypeP{\Omega}{e}{\tau}$.
\end{itemize}

We simultaneously apply a substitution by placing it in prefix position. For example, $[\omega]e$ applies the substitutions $\omega$ simultaneously to $e$.

\begin{lemma}[Substitution]\label{lemma:substitution-P} If $\Omega \cup \Omega' \cup \Omega'' \vdash J$ and $\hastypeP{\Omega}{\omega}{\Omega'}$ then $\Omega \cup [\omega]\Omega'' \vdash [\omega]J$.
\end{lemma}
\begin{proof-sketch} By straightforward rule induction. 
\end{proof-sketch}

\begin{lemma}[Decomposition]\label{lemma:decomposition-P} 
If $\Omega \cup [\omega]\Omega'' \vdash [\omega]J$ and $\hastypeP{\Omega}{\omega}{\Omega'}$ then $\Omega \cup \Omega' \cup \Omega'' \vdash J$.
\end{lemma}
\begin{proof-sketch} By straightforward rule induction.
\end{proof-sketch}

% \begin{lemma}[Regularity]\label{lemma:regularity-P} ~
% \begin{enumerate}
% \item ...
% \end{enumerate}
% \end{lemma}

\subsection{Structural Dynamics}
The structural dynamics of modules is defined as a transition system, and is organized around judgements of the following form:

\vspace{10px}
$\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\stepsU{M}{M'} & \text{$M$ transitions to $M'$}\\
\isvalP{M} & \text{$M$ is a module value}\\
\matchfail{M} & \text{$M$ raises match failure}
\end{array}$
\vspace{10px}

The structural dynamics of expressions is also defined as a transition system, and is organized around judgements of the following form:

\vspace{10px}
$\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\stepsU{e}{e'} & \text{$e$ transitions to $e'$}\\
\isvalP{e} & \text{$e$ is a value}\\
\matchfail{e} & \text{$e$ raises match failure}
\end{array}$
\vspace{10px}

We also define auxiliary judgements for \emph{iterated transition}, $\multistepU{e}{e'}$, and \emph{evaluation}, $\evalU{e}{e'}$ of expressions.

\begin{definition}[Iterated Transition]\label{defn:iterated-transition-P} Iterated transition, $\multistepU{e}{e'}$, is the reflexive, transitive closure of the transition judgement, $\stepsU{e}{e'}$.\end{definition}

\begin{definition}[Evaluation]\label{defn:evaluation-P} $\evalU{e}{e'}$ iff $\multistepU{e}{e'}$ and $\isvalU{e'}$. \end{definition}

Similarly, we lift these definitions to the level of module expressions as well.

\begin{definition}[Iterated Module Transition]\label{defn:iterated-transition-modules-P} Iterated transition, $\multistepU{M}{M'}$, is the reflexive, transitive closure of the transition judgement, $\stepsU{M}{M'}$.\end{definition}

\begin{definition}[Module Evaluation]\label{defn:evaluation-modules-P} $\evalU{M}{M'}$ iff $\multistepU{M}{M'}$ and $\isvalU{M'}$. \end{definition}



As in $\miniVersePat$, our subsequent developments do not make mention of particular rules in the dynamics, nor do they make mention of other judgements, not listed above, that are used only for defining the dynamics of the match operator, so we do not produce these details here. Instead, it suffices to state the following conditions.

The Preservation condition ensures that evaluation preserves typing.
\begin{condition}[Preservation]\label{condition:preservation-P} ~
\begin{enumerate}
\item If $\hassig{}{M}{\sigma}$ and $\stepsU{M}{M'}$ then $\hassig{}{M}{\sigma}$.
\item If $\hastypeUC{e}{\tau}$ and $\stepsU{e}{e'}$ then $\hastypeUC{e'}{\tau}$.
\end{enumerate}
\end{condition}

The Progress condition ensures that evaluation of a well-typed expanded expression cannot ``get stuck''. We must consider the possibility of match failure in this condition.
\begin{condition}[Progress]\label{condition:progress-P} ~
\begin{enumerate}
\item If $\hassig{}{M}{\sigma}$ then either $\isvalU{M}$ or $\matchfail{M}$ or there exists an $M'$ such that $\stepsU{M}{M'}$.
\item If $\hastypeUC{e}{\tau}$ then either $\isvalU{e}$ or $\matchfail{e}$ or there exists an $e'$ such that $\stepsU{e}{e'}$.
\end{enumerate}
\end{condition}

\section{Unexpanded Language (UL)}
\subsection{Syntax}
\subsubsection{Stylized Syntax -- Unexpanded Signatures and Modules}
\[\begin{array}{lllllll}
\textbf{Sort} & & 
%& \textbf{Operational Form} 
& \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{USig} & \usigma & ::= 
%& \ausignature{\ukappa}{\uu}{\utau} 
& \signature{\uu}{\ukappa}{\utau} & \text{signature}\\
\mathsf{UMod} & \uM & ::= 
%& \uX 
& \uX & \text{module identifier}\\
&&
%& \austruct{\uc}{\ue} 
& \struct{\uc}{\ue} & \text{structure}\\
&&
%& \auseal{\usigma}{\uM} 
& \seal{\uM}{\usigma} & \text{seal}\\
&&
%& \aumlet{\usigma}{\uM}{\uX}{\uM} 
& \mlet{\uX}{\uM}{\uM}{\usigma} & \text{definition}\\
% \LCC &&
%& \lightgray 
% & \color{Yellow} & \color{Yellow}\\
&&
%& \aumdefpetsm{\urho}{e}{\tsmv}{\uM} 
& \defpetsm{\tsmv}{\urho}{e}{\uM} & \text{peTSM definition}\\
%&&&                                    & \texttt{expressions}~\{e\}~\texttt{in}~\uM\\
&&
%& \aumletpetsm{\uepsilon}{\tsmv}{\uM} 
& \uletpetsm{\tsmv}{\uepsilon}{\uM} & \text{peTSM binding}\\
% &&&                                  & \texttt{expressions}~\texttt{in}~\uM\\
% &&& ... & ... & \text{peTSM designation}\\
&&
%& \audefpptsm{\urho}{e}{\tsmv}{\uM} 
& \defpptsm{\tsmv}{\urho}{e}{\uM} & \text{ppTSM definition}\\
% &&&                                    & \texttt{patterns}~\{e\}~\texttt{in}~\uM\\
&&
%& \auletpptsm{\uepsilon}{\tsmv}{\uM} 
& \uletpptsm{\tsmv}{\uepsilon}{\uM} & \text{ppTSM binding}%\ECC%
% &&& & \texttt{patterns}~\texttt{in}~\uM\\
% &&& ... & ... & \text{ppTSM designation}\ECC
\end{array}\]%\vspace{-15px}
% \caption[Syntax of unexpanded module expressions and signatures in $\miniVerseParam$]{Syntax of unexpanded module expressions and signatures in $\miniVerseParam$.}\vspace{-5px}
% \label{fig:P-unexpanded-modules-signatures}
% \end{figure}
% \begin{figure}[p] \vspace{-10px}

\subsubsection{Stylized Syntax -- Unexpanded Kinds and Constructors}
\[\begin{array}{lrlllll}
\textbf{Sort} & & 
%& \textbf{Operational Form} 
& \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{UKind} & \ukappa & ::= 
%& \aukdarr{\ukappa}{\uu}{\ukappa} 
& \kdarr{\uu}{\ukappa}{\ukappa} & \text{dependent function}\\
&&
%& \aukunit 
& \kunit & \text{nullary product}\\
&&
%& \aukdbprod{\ukappa}{\uu}{\ukappa} 
& \kdbprod{\uu}{\ukappa}{\ukappa} & \text{dependent product}\\
%&&& \akdprodstd & \kdprodstd & \text{labeled dependent product}\\
&&
%& \aukty 
& \kty & \text{types}\\
&&
%& \auksing{\utau} 
& \ksing{\utau} & \text{singleton}\\
\mathsf{UCon} & \uc, \utau & ::= 
%& \uu 
& \uu & \text{constructor identifier}\\
&&
%& \ut 
& \ut & \\
&&
%& \aucasc{\ukappa}{\uc} 
& \casc{\uc}{\ukappa} & \text{ascription}\\
&&
%& \aucabs{\uu}{\uc} 
& \cabs{\uu}{\uc} & \text{abstraction}\\
&&
%& \aucapp{c}{c} 
& \capp{c}{c} & \text{application}\\
&&
%& \auctriv 
& \ctriv & \text{trivial}\\
&&
%& \aucpair{\uc}{\uc} 
& \cpair{\uc}{\uc} & \text{pair}\\
&&
%& \aucprl{\uc} 
& \cprl{\uc} & \text{left projection}\\
&&
%& \aucprr{\uc} 
& \cprr{\uc} & \text{right projection}\\
%&&& \adtplX & \dtplX & \text{labeled dependent tuple}\\
%&&& \adprj{\ell}{c} & \prj{c}{\ell} & \text{projection}\\
&&
%& \auparr{\utau}{\utau} 
& \parr{\utau}{\utau} & \text{partial function}\\
&&
%& \auallu{\ukappa}{\uu}{\utau} 
& \forallu{\uu}{\ukappa}{\utau} & \text{polymorphic}\\
&&
%& \aurec{\ut}{\utau} 
& \rect{\ut}{\utau} & \text{recursive}\\
&&
%& \auprod{\labelset}{\mapschema{\utau}{i}{\labelset}} 
& \prodt{\mapschema{\utau}{i}{\labelset}} & \text{labeled product}\\
&&
%& \ausum{\labelset}{\mapschema{\utau}{i}{\labelset}} 
& \sumt{\mapschema{\utau}{i}{\labelset}} & \text{labeled sum}\\
&&
%& \aumcon{\uX} 
& \mcon{\uX} & \text{constructor component}
\end{array}\]%\vspace{-15px}
% \caption[Syntax of unexpanded kinds and constructors in $\miniVerseParam$]{Syntax of unexpanded kinds and constructors in $\miniVerseParam$.}\vspace{-10px}
% \label{fig:P-unexpanded-kinds-constructors}
% \end{figure}
\clearpage

\subsubsection{Stylized Syntax -- Unexpanded Expressions, Rules and Patterns}
% \clearpage
% \begin{figure}[p]
\[\begin{array}{lllllll}
\textbf{Sort} & & 
%& \textbf{Operational Form} 
& \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{UExp} & \ue & ::= 
%& \ux 
& \ux & \text{identifier}\\
&&
% & \auasc{\utau}{\ue} 
& \asc{\ue}{\utau} & \text{ascription}\\
&&
% & \auletsyn{\ux}{\ue}{\ue} 
& \letsyn{\ux}{\ue}{\ue} & \text{value binding}\\
% &&
%& \auanalam{\ux}{\ue} 
% & \analam{\ux}{\ue} & \text{abstraction (unannotated)}\\
&&
%& \aulam{\utau}{\ux}{\ue} 
& \lam{\ux}{\utau}{\ue} & \text{abstraction}\\
&&
%& \auap{\ue}{\ue} 
& \ap{\ue}{\ue} & \text{application}\\
&&
%& \auclam{\ukappa}{\uu}{\ue} 
& \clam{\uu}{\ukappa}{\ue} & \text{constructor abstraction}\\
&&
%& \aucap{\ue}{\uc} 
& \cAp{\ue}{\uc} & \text{constructor application}\\
&&
%& \auanafold{\ue} 
& \fold{\ue} & \text{fold}\\
&&
%& \auunfold{\ue} 
& \unfold{\ue} & \text{unfold}\\
&&
%& \autpl{\labelset}{\mapschema{\ue}{i}{\labelset}} 
& \tpl{\mapschema{\ue}{i}{\labelset}} & \text{labeled tuple}\\
&&
%& \aupr{\ell}{\ue} 
& \prj{\ue}{\ell} & \text{projection}\\
&&
%& \auanain{\ell}{\ue} 
& \inj{\ell}{\ue} & \text{injection}\\
&&
%& \aumatchwithb{n}{\ue}{\seqschemaX{\urv}} 
& \matchwith{\ue}{\seqschemaX{\urv}} & \text{match}\\
&&
%& \aumval{\uX} 
& \mval{\uX} & \text{value component}\\
% \LCC &&
% %& \color{Yellow} 
% & \color{Yellow} & \color{Yellow} \\
% &&& \audefpetsm{\urho}{e}{\tsmv}{\ue} & \texttt{syntax}~\tsmv~\texttt{at}~\urho~\texttt{for} & \text{peTSM definition}\\
% &&&                                    & \texttt{expressions}~\{e\}~\texttt{in}~\ue\\
% &&& \auletpetsm{\uepsilon}{\tsmv}{\ue} & \texttt{let}~\texttt{syntax}~\tsmv=\uepsilon~\texttt{for} & \text{peTSM binding}\\
% &&&                                  & \texttt{expressions}~\texttt{in}~\ue\\
% &&& ... & ... & \text{peTSM designation}\\
&&
%& \auappetsm{b}{\uepsilon} 
& \utsmap{\uepsilon}{b} & \text{peTSM application}\\%\ECC\\%\ECC
% &&& \auelit{b} & {\lit{b}}  & \text{peTSM unadorned literal}\\
% &&& \audefpptsm{\urho}{e}{\tsmv}{\ue} & \texttt{syntax}~\tsmv~\texttt{at}~\urho~\texttt{for} & \text{ppTSM definition}\\
% &&&                                    & \texttt{patterns}~\{e\}~\texttt{in}~\ue\\
% &&& \auletpptsm{\uepsilon}{\tsmv}{\ue} & \texttt{let}~\texttt{syntax}~\tsmv=\uepsilon~\texttt{for} & \text{ppTSM binding}\\
% &&& & \texttt{patterns}~\texttt{in}~\ue\\
% &&& ... & ... & \text{ppTSM designation}\\\ECC
\mathsf{URule} & \urv & ::= 
%& \aumatchrule{\upv}{\ue} 
& \matchrule{\upv}{\ue} & \text{match rule}\\
\mathsf{UPat} & \upv & ::= 
%& \ux 
& \ux & \text{identifier pattern}\\
&&
%& \auwildp 
& \wildp & \text{wildcard pattern}\\
&&
%& \aufoldp{\upv} 
& \foldp{\upv} & \text{fold pattern}\\
&&
%& \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}} 
& \tplp{\mapschema{\upv}{i}{\labelset}} & \text{labeled tuple pattern}\\
&&
%& \auinjp{\ell}{\upv} 
& \injp{\ell}{\upv} 
& \text{injection pattern}\\
% \LCC &&
%& \lightgray 
% & \color{Yellow} & \color{Yellow}\\
&&
%& \auappptsm{b}{\uepsilon} 
& \utsmap{\uepsilon}{b} & \text{ppTSM application}%\ECC
% &&& \auplit{b} & \lit{b} & \text{ppTSM unadorned literal}\ECC
\end{array}\]
% \caption[Syntax of unexpanded expressions, rules and patterns in $\miniVerseParam$]{Syntax of unexpanded expressions, rules and patterns in $\miniVerseParam$.}
% \label{fig:P-unexpanded-terms}
% \end{figure}

\subsubsection{Stylized Syntax -- Unexpanded TSM Types and Expressions}
% \begin{figure}[p]
\[\begin{array}{lllllll}
\textbf{Sort} & & 
%& \textbf{Operational Form} 
& \textbf{Stylized Form} 
& \textbf{Description}\\
% \LCC \color{Yellow}&\color{Yellow}& \color{Yellow}
%& \lightgray 
% & \color{Yellow} & \color{Yellow}\\
\mathsf{UMType} & \urho & ::= 
%& \autype{\utau} 
& \utau & \text{type annotation}\\
&&
%& \aualltypes{\ut}{\urho} 
& \alltypes{\ut}{\urho} & \text{type parameterization}\\
&&
%& \auallmods{\usigma}{\uX}{\urho} 
& \allmods{\uX}{\usigma}{\urho} & \text{module parameterization}\\
\mathsf{UMExp} & \uepsilon & ::= 
%& \abindref{\tsmv} 
& \tsmv & \text{TSM binding reference}\\
&&
%& \auabstype{\ut}{\uepsilon} 
& \abstype{\ut}{\uepsilon} & \text{type abstraction}\\
&&
%& \auabsmod{\usigma}{\uX}{\uepsilon} 
& \absmod{\uX}{\usigma}{\uepsilon} & \text{module abstraction}\\
&&
%& \auaptype{\utau}{\uepsilon} 
& \aptype{\uepsilon}{\utau} & \text{type application}\\
&&
%& \auapmod{\uM}{\uepsilon} 
& \apmod{\uepsilon}{\uX} & \text{module application}%\ECC
\end{array}
\]
% \caption{Syntax of unexpanded TSM types and expressions.}
% \label{fig:P-macro-expressions-types-u}
% \end{figure}

\subsubsection{Stylized Syntax -- TSM Types and Expressions}

% \clearpage
% \begin{figure}[p]
\[\begin{array}{lllllll}
\textbf{Sort} & & & \textbf{Operational Form} 
%& \textbf{Stylized Form} 
& \textbf{Description}\\
% \LCC \color{Yellow}&\color{Yellow}& \color{Yellow}
%& \lightgray 
% & \color{Yellow} & \color{Yellow}\\
\mathsf{MType} & \rho & ::= & \aetype{\tau} 
%& \tau 
& \text{type annotation}\\
&&& \aealltypes{t}{\rho} 
%& \alltypes{t}{\rho} 
& \text{type parameterization}\\
&&& \aeallmods{\sigma}{X}{\rho} 
%& \allmods{X}{\sigma}{\rho} 
& \text{module parameterization}\\
\mathsf{MExp} & \epsilon & ::= & \adefref{a} 
%& a 
& \text{TSM definition reference}\\
&&& \aeabstype{t}{\epsilon} 
%& \abstype{t}{\epsilon} 
& \text{type abstraction}\\
&&& \aeabsmod{\sigma}{X}{\epsilon} 
%& \absmod{X}{\sigma}{\epsilon} 
& \text{module abstraction}\\
&&& \aeaptype{\tau}{\epsilon} 
%& \aptype{\epsilon}{\tau} 
& \text{type application}\\
&&& \aeapmod{M}{\epsilon} 
%& \aptype{\epsilon}{M} 
& \text{module application}%\ECC
\end{array}\]
% \caption[Syntax of TSM types and expressions in $\miniVerseParam$]{Syntax of TSM types and expressions.}
% \label{fig:P-macro-expressions-types}
% \end{figure}

\subsubsection{Body Lengths}
We write $\sizeof{b}$ for the length of $b$. 
The metafunction $\sizeof{\uM}$ computes the sum of the lengths of expression literal bodies in $\uM$:
\[
\begin{array}{ll}
\sizeof{\uX} & = 0\\
\sizeof{\struct{\uc}{\ue}} & = \sizeof{\ue}\\
\sizeof{\seal{\uM}{\usigma}} & = \sizeof{\uM}\\
\sizeof{\mlet{\uX}{\uM}{\uM'}{\usigma}} & = \sizeof{\uM} + \sizeof{\uM'}\\
\sizeof{\defpetsm{\tsmv}{\urho}{e}{\uM}} & = \sizeof{\uM}\\
\sizeof{\uletpetsm{\tsmv}{\uepsilon}{\uM}} & = \sizeof{\uM}\\
\sizeof{\defpptsm{\tsmv}{\urho}{e}{\uM}} & = \sizeof{\uM}\\
\sizeof{\uletpptsm{\tsmv}{\uepsilon}{\uM}} & = \sizeof{\uM}
\end{array}
\]
and $\sizeof{\ue}$ computes the sum of the lengths of expression literal bodies in $\ue$:
\[
\begin{array}{ll}
\sizeof{\ux} & = 0\\
\sizeof{\lam{\ux}{\utau}{\ue}} &= \sizeof{\ue}\\
\sizeof{\ap{\ue_1}{\ue_2}} & = \sizeof{\ue_1} + \sizeof{\ue_2}\\
\sizeof{\clam{\uu}{\ukappa}{\ue}} & = \sizeof{\ue}\\
\sizeof{\cAp{\ue}{\uc}} & = \sizeof{\ue}\\
\sizeof{\fold{\ue}} & = \sizeof{\ue}\\
\sizeof{\unfold{\ue}} & = \sizeof{\ue}\\
%\end{align*}
%\begin{align*}
\sizeof{\tpl{\mapschema{\ue}{i}{\labelset}}} & = \sum_{i \in \labelset} \sizeof{\ue_i}\\
\sizeof{\prj{\ell}{\ue}} & = \sizeof{\ue}\\
\sizeof{\inj{\ell}{\ue}} & = \sizeof{\ue}\\
\sizeof{\matchwith{\ue}{\seqschemaX{\urv}}} & = \sizeof{\ue} + \sum_{1 \leq i \leq n} \sizeof{r_i}\\
\sizeof{\mval{\uX}} & = 0\\
% \sizeof{\caseof{\ue}{\mapschemab{\ux}{\ue}{i}{\labelset}}} & = \sizeof{\ue} + \sum_{i \in \labelset} \sizeof{\ue_i}\\
% \sizeof{\uesyntax{\tsmv}{\utau}{\eparse}{\ue}} & = \sizeof{\ue}\\
\sizeof{\utsmap{\uepsilon}{b}} & = \sizeof{b}
\end{array}
\]
and $\sizeof{\urv}$ computes the sum of the lengths of expression literal bodies in $\urv$:
\begin{align*}
\sizeof{\matchrule{\upv}{\ue}} & = \sizeof{\ue}
\end{align*}
% and $\sizeof{\uepsilon}$ computes the sum of the lengths of expression literal bodies in $\uepsilon$:
% \begin{align*}
% \sizeof{\tsmv} & = 0\\
% \sizeof{\abstype{\ut}{\uepsilon}} & = \sizeof{\uepsilon}\\
% \sizeof{\absmod{\uX}{\usigma}{\uepsilon}} & = \sizeof{\uepsilon}\\
% \sizeof{\aptype{\uepsilon}{\utau}} & = 0\\
% \sizeof{\apmod{\uepsilon}{\uM}} & = \sizeof{\uM}
% \end{align*}

Similarly, the metafunction $\sizeof{\upv}$ computes the sum of the lengths of the pattern literal bodies in $\upv$:
\begin{align*}
\sizeof{\ux} & = 0\\
\sizeof{\foldp{\upv}} & = \sizeof{\upv}\\
\sizeof{\tplp{\mapschema{\upv}{i}{\labelset}}} & = \sum_{i \in \labelset} \sizeof{\upv_i}\\
\sizeof{\injp{\ell}{\upv}} & = \sizeof{\upv}\\
\sizeof{\utsmap{\uepsilon}{b}} & = \sizeof{b}
\end{align*}

\subsubsection{Common Unexpanded Forms}\label{appendix:P-shared-forms}
Each expanded form, with a few minor exceptions noted below, maps onto an unexpanded form. We refer to these as the \emph{common forms}. In particular:
\begin{itemize}
\item Each module variable, $X$, maps onto a unique module identifier, written $\sigilof{X}$.
\item Each signature, $\sigma$, maps onto an unexpanded signature, $\Uof{\sigma}$, as follows:
\begin{align*}
\Uof{\asignature{\kappa}{u}{c}} & = \signature{\sigilof{u}}{\Uof{\kappa}}{\Uof{c}}
\end{align*}
\item Each module expression, $M$, maps onto an unexpanded module expression, $\uM$, as follows:
\begin{align*}
\Uof{X} & = \sigilof{X}\\
\Uof{\astruct{\uc}{\ue}} & = \struct{\Uof{\uc}}{\Uof{\ue}}\\
\Uof{\aseal{\sigma}{M}} & = \seal{\Uof{M}}{\Uof{\sigma}}\\
\Uof{\amlet{\sigma}{M}{X}{M'}} & = \mlet{\sigilof{X}}{\Uof{M}}{\Uof{M'}}{\Uof{\sigma}}
\end{align*}
\item Each constructor variable, $u$, maps onto a unique {type identifier}, written $\sigilof{u}$.
\item Each kind, $\kappa$, maps onto an unexpanded kind, $\Uof{\kappa}$, as follows:
\begin{align*}
\Uof{\akdarr{\kappa}{u}{\kappa'}} & = \kdarr{\sigilof{u}}{\Uof{\kappa}}{\Uof{\kappa'}}\\
\Uof{\akunit} & = \kunit\\
\Uof{\akdbprod{\kappa}{u}{\kappa'}} & = \kdbprod{\sigilof{u}}{\Uof{\kappa}}{\Uof{\kappa'}}\\
\Uof{\akty} & = \kty\\
\Uof{\aksing{\tau}} & = \ksing{\Uof{\tau}}
\end{align*}
\item Each constructor, $c$, except for constructors of the form $\amcon{M}$ where $M$ is not a module variable, maps onto an unexpanded type, $\Uof{c}$, as follows: 
  \begin{align*}
  \Uof{u} &= \sigilof{u}\\
  \Uof{\acabs{u}{c}} & = \cabs{\sigilof{u}}{\Uof{c}}\\
  \Uof{\acapp{c}{c'}} & = \capp{\Uof{c}}{\Uof{c'}}\\
  \Uof{\actriv} & = \ctriv\\
  \Uof{\acpair{c}{c'}} & = \cpair{\Uof{c}}{\Uof{c'}}\\
  \Uof{\acprl{c}} & = \cprl{\Uof{c}}\\
  \Uof{\acprr{c}} & = \cprr{\Uof{c}}\\
  \Uof{\aparr{\tau_1}{\tau_2}} & = \parr{\Uof{\tau_1}}{\Uof{\tau_2}}\\
  \Uof{\aallu{\kappa}{u}{\tau}} & = \forallu{\sigilof{u}}{\Uof{\kappa}}{\Uof{\tau}}\\
  \Uof{\arec{t}{\tau}} & = \rect{\sigilof{t}}{\Uof{\tau}}\\
  \Uof{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \prodt{\mapschemax{\Uofv}{\tau}{i}{\labelset}}\\
  \Uof{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \sumt{\mapschemax{\Uofv}{\tau}{i}{\labelset}}\\
  \Uof{\amcon{X}} & = \mcon{\sigilof{X}}
  \end{align*}
\item Each expression variable, $x$, maps onto a unique expression identifier, written $\sigilof{x}$.
\item Each expanded expression, $e$, except expressions of the form $\amval{M}$ where $M$ is not a module variable, maps onto an unexpanded expression, $\Uof{e}$, as follows:
\begin{align*}
\Uof{x} & = \sigilof{x}\\
\Uof{\aelam{\tau}{x}{e}} & = \lam{\sigilof{x}}{\Uof{\tau}}{\Uof{e}}\\
\Uof{\aeap{e_1}{e_2}} & = \ap{\Uof{e_1}}{\Uof{e_2}}\\
\Uof{\aeclam{\kappa}{u}{e}} & = \clam{\sigilof{u}}{\Uof{\kappa}}{\Uof{e}}\\
\Uof{\aecap{e}{c}} & = \cAp{\Uof{e}}{\Uof{c}}\\
\Uof{\aefold{e}} & = \fold{\Uof e}\\
\Uof{\aeunfold{e}} & = \unfold{\Uof{e}}\\
\Uof{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}} & = \tpl{\mapschemax{\Uofv}{e}{i}{\labelset}}\\
\Uof{\aepr{\ell}{e}} & = \prj{\Uof{e}}{\ell}\\
\Uof{\aein{\ell}{e}} &= \inj{\ell}{\Uof{e}}\\
\Uof{\aematchwith{n}{e}{\seqschemaX{r}}} & = \matchwith{\Uof{e}}{\seqschemaXx{\Uofv}{r}}\\
\Uof{\amval{X}} & = \mval{\sigilof{X}}
\end{align*}
\end{itemize}
\begin{itemize}
\item Each expanded rule, $r$, maps onto an unexpanded rule, $\Uof{r}$, as follows:
\begin{align*}
\Uof{\aematchrule{p}{e}} & = \aumatchrule{\Uof{p}}{\Uof{e}}
\end{align*}
\item Each expanded pattern, $p$, maps onto an unexpanded pattern, $\Uof{p}$, as follows:
\begin{align*}
\Uof{x} & = \sigilof{x}\\
\Uof{\aewildp} &= \auwildp\\
\Uof{\aefoldp{p}} &= \aufoldp{\Uof{p}}\\
\Uof{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}} & = \autplp{\labelset}{\mapschemax{\Uofv}{p}{i}{\labelset}}\\
\Uof{\aeinjp{\ell}{p}} & = \auinjp{\ell}{\Uof{p}}
\end{align*}
\end{itemize}

\subsubsection{Textual Syntax}
There is also a context-free textual syntax for the UL. We need only posit the existence of partial metafunctions that satisfy the following condition. 
\begin{condition}[Textual Representability]\label{condition:textual-representability-P} ~
\begin{enumerate}
% \item For each $\usigma$, there exists $b$ such that $\parseUSig{b}{\usigma}$.
% \item For each $\uM$, there exists $b$ such that $\parseUMod{b}{\uM}$.
\item For each $\ukappa$, there exists $b$ such that $\parseUKind{b}{\ukappa}$.
\item For each $\uc$, there exists $b$ such that $\parseUCon{b}{\uc}$.
\item For each $\ue$, there exists $b$ such that $\parseUExp{b}{\ue}$.
\item For each $\upv$, there exists $b$ such that $\parseUPat{b}{\upv}$.
\end{enumerate}
\end{condition}

\begin{condition}[Expression Parsing Monotonicity]\label{condition:body-parsing-P} If $\parseUExp{b}{\ue}$ then $\sizeof{\ue} < \sizeof{b}$.\end{condition}

\begin{condition}[Pattern Parsing Monotonicity]\label{condition:pattern-parsing-P} If $\parseUPat{b}{\upv}$ then $\sizeof{\upv} < \sizeof{b}$.\end{condition}

\subsection{Typed Expansion}\label{appendix:typed-expansion-P}
\subsubsection{Unexpanded Unified Contexts}\label{appendix:u-unified-ctxs}
A \emph{unexpanded unified context}, $\uOmega$, takes the form $\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}$, where $\uMctx$ is a \emph{module identifier expansion context}, $\uD$ is a \emph{constructor identifier expansion context}, $\uG$ is an \emph{expression identifier expansion context}, and $\Omega$ is a unified context.

% \subsubsection{Identifier Expansion Contexts}
A module identifier expansion context, $\uMctx$, is a finite function that maps each module identifier $\uX \in \domof{\uMctx}$ to the module identifier expansion $\vExpands{\uX}{X}$. We write $\uOmega, \uMhyp{\uX}{X}{\sigma}$ when $\uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}$ as an abbreviation of \[\uOmegaEx{\uD}{\uG}{\uMctx \uplus \vExpands{\uX}{X}}{\Omega, X : \sigma}\]

A constructor identifier expansion context, $\uD$, is a finite function that maps each constructor identifier $\uu \in \domof{\uD}$ to the constructor identifier expansion $\vExpands{\uu}{u}$. We write $\uOmega, \uKhyp{\uu}{u}{\kappa}$ when $\uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}$ as an abbreviation of \[\uOmegaEx{\uD \uplus \vExpands{\uu}{u}}{\uG}{\uMctx}{\Omega, u :: \kappa}\]

An expression identifier expansion context, $\uG$, is a finite function that maps each expression identifier $\ux \in \domof{\uG}$ to the expression identifier expansion $\vExpands{\ux}{x}$. We write $\uOmega, \uGhyp{\ux}{x}{\tau}$ when $\uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}$ as an abbreviation of \[\uOmegaEx{\uD}{\uG \uplus \vExpands{\ux}{x}}{\uMctx}{\Omega, x : \tau}\]

\subsubsection{Body Encoding and Decoding}
An assumed type abbreviated $\tBody$ classifies encodings of literal bodies, $b$. The mapping from literal bodies to values of type $\tBody$ is defined by the \emph{body encoding judgement} $\encodeBody{b}{\ebody}$. An inverse mapping is defined   by the \emph{body decoding judgement} $\decodeBody{\ebody}{b}$.
\[\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\encodeBody{b}{e} & \text{$b$ has encoding $e$}\\
\decodeBody{e}{b} & \text{$e$ has decoding $b$}
\end{array}\]
The following condition establishes an isomorphism between literal bodies and values of type $\tBody$ mediated by the judgements above.
\begin{condition}[Body Isomorphism]\label{condition:body-isomorphism-P} ~
\begin{enumerate}
\item For every literal body $b$, we have that $\encodeBody{b}{\ebody}$ for some $\ebody$ such that $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$.
\item If $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$ then $\decodeBody{\ebody}{b}$ for some $b$.
\item If $\encodeBody{b}{\ebody}$ then $\decodeBody{\ebody}{b}$.
\item If $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$ and $\decodeBody{\ebody}{b}$ then $\encodeBody{b}{\ebody}$. 
\item If $\encodeBody{b}{\ebody}$ and $\encodeBody{b}{\ebody'}$ then $\ebody = \ebody'$.
\item If $\hastypeUC{\ebody}{\tBody}$ and $\isvalU{\ebody}$ and $\decodeBody{\ebody}{b}$ and $\decodeBody{\ebody}{b'}$ then $b=b'$.
\end{enumerate}
\end{condition}
We also assume a partial metafunction, $\bsubseq{b}{m}{n}$, which extracts a subsequence of $b$ starting at position $m$ and ending at position $n$, inclusive, where $m$ and $n$ are natural numbers. The following condition is technically necessary.
\begin{condition}[Body Subsequencing]\label{condition:body-subsequences-P} If $\bsubseq{b}{m}{n}=b'$ then $\sizeof{b'} \leq \sizeof{b}$. \end{condition}

\subsubsection{Parse Results}
 The type function abbreviated $\tParseResultF$, and auxiliary abbreviations used below, is defined as follows:
\begin{align*}
L_\mathtt{P} & \defeq \lbltxt{ParseError}, \lbltxt{Success}\\
\tParseResultF & \defeq \acabs{t}{\asum{L_\mathtt{P}}{
  \mapitem{\lbltxt{ParseError}}{\prodt{}}, 
  \mapitem{\lbltxt{Success}}{t}
}}\\
\tParseResult{\tau} & \defeq \acapp{\tParseResultF}{\tau}\\
\lbltxt{SuccessE}\cdot e & \defeq \aein{L_\mathtt{P}}{\mathtt{Success}}{\mapitem{\mathtt{ParseError}}{\tpl{}}, \mapitem{\mathtt{Success}}{\tPProtoExpr}}{e}\\
\lbltxt{SuccessP}\cdot e & \defeq \aein{L_\mathtt{P}}{\mathtt{Success}}{\mapitem{\mathtt{ParseError}}{\tpl{}}, \mapitem{\mathtt{Success}}{\tCEPat}}{e}
\end{align*} %[\mapitem{\lbltxt{ParseError}}{\prodt{}}, \mapitem{\lbltxt{SuccessE}}{\tCEExp}]

\subsubsection{TSM Contexts}
\emph{peTSM contexts}, $\uPsi$, are of the form $\uAS{\uA}{\Psi}$, where $\uA$ is a \emph{TSM identifier expansion context} and $\Psi$ is a \emph{peTSM definition context}.

\emph{ppTSM contexts}, $\uPhi$, are of the form $\uAS{\uA}{\Phi}$, where $\uA$ is a TSM identifier expansion context and $\Phi$ is a \emph{ppTSM definition context}.

A \emph{TSM identifier expansion context}, $\uA$, is a finite function mapping each TSM identifier $\tsmv \in \domof{\uA}$ to the \emph{TSM identifier expansion}, $\vExpands{\tsmv}{\epsilon}$, for some \emph{TSM expression}, $\epsilon$. We write $\ctxUpdate{\uA}{\tsmv}{\epsilon}$ for the TSM identifier expansion context that maps $\tsmv$ to $\vExpands{\tsmv}{\epsilon}$, and defers to $\uA$ for all other TSM identifiers (i.e. the previous mapping is \emph{updated}.)

A \emph{peTSM definition context}, $\Psi$, is a finite function mapping each TSM name $a \in \domof{\Psi}$ to an \emph{expanded peTSM definition}, $\petsmdefn{a}{\rho}{\eparse}$, where $\rho$ is the peTSM's type annotation, and $\eparse$ is its parse function. We write $\Psi, \petsmdefn{a}{\rho}{\eparse}$ when $a \notin \domof{\Psi}$ for the extension of $\Psi$ that maps $a$ to $\petsmdefn{a}{\rho}{\eparse}$. We write $\petsmenv{\Omega}{\Psi}$  when all the TSM type annotations in $\Psi$ are well-formed assuming $\Omega$, and the parse functions in $\Psi$ are closed and of the appropriate type.


\begin{definition}[peTSM Definition Context Formation]\label{def:peTSM-def-ctx-formation} $\petsmenv{\Omega}{\Psi}$ iff for each ${\petsmdefn{a}{\rho}{\eparse}} \in \Psi$, we have $\istsmty{\Omega}{\rho}$ and \[\hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\]\end{definition}

\begin{definition}[peTSM Context Formation] $\petsmctx{\Omega}{\uAS{\uA}{\Psi}}$ iff $\petsmenv{\Omega}{\Psi}$ and for each $\vExpands{\tsmv}{\epsilon} \in \uA$ we have $\hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}$ for some $\rho$.
\end{definition}

A \emph{ppTSM definition context}, $\Phi$, is a finite function mapping each TSM name $a \in \domof{\Phi}$ to an \emph{expanded ppTSM definition}, $\pptsmdefn{a}{\rho}{\eparse}$, where $\rho$ is the ppTSM's type annotation, and $\eparse$ is its parse function. We write $\Phi, \pptsmdefn{a}{\rho}{\eparse}$ when $a \notin \domof{\Phi}$ for the extension of $\Phi$ that maps $a$ to $\pptsmdefn{a}{\rho}{\eparse}$. We write $\pptsmenv{\Omega}{\Phi}$  when all the type annotations in $\Phi$ are well-formed assuming $\Omega$, and the parse functions in $\Phi$ are closed and of the appropriate type.

\begin{definition}[ppTSM Definition Context Formation]\label{def:ppTSM-def-ctx-formation} $\pptsmenv{\Omega}{\Phi}$ iff for each $\pptsmdefn{\tsmv}{\rho}{\eparse} \in \Phi$, we have $\istsmty{\Omega}{\rho}$ and \[\hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat}}\]\end{definition}

\begin{definition}[ppTSM Context Formation] $\pptsmctx{\Omega}{\uAS{\uA}{\Phi}}$ iff $\pptsmenv{\Omega}{\Phi}$ and for each $\vExpands{\tsmv}{\epsilon} \in \uA$ we have $\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}$ for some $\rho$.
\end{definition}

\subsubsection{Signature and Module Expansion}
\noindent\fbox{$\strut\sigExpandsPX{\usigma}{\sigma}$}~~$\usigma$ has well-formed expansion $\sigma$
\begin{equation}\label{rule:sigExpandsP}
\inferrule{
  \kExpandsX{\ukappa}{\kappa}\\
  \cExpands{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\utau}{\tau}{\akty}
}{
  \sigExpandsPX{\signature{\uu}{\ukappa}{\utau}}{\asignature{\kappa}{u}{\tau}}
}
\end{equation}

\noindent\fbox{$\strut\mExpandsPX{\uM}{M}{\sigma}$}~~$\uM$ has expansion $M$ matching $\sigma$
\begin{subequations}\label{rules:mExpandsP}
\begin{equation}\label{rule:mExpandsP-subsumes}
\inferrule{
  \mExpandsPX{\uM}{M}{\sigma}\\
  \sigsub{\uOmega}{\sigma}{\sigma'}
}{
  \mExpandsPX{\uM}{M}{\sigma'}
}
\end{equation}
\begin{equation}\label{rule:mExpands-var}
\inferrule{ }{
  \mExpandsP{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPsi}{\uPhi}{\uX}{X}{\sigma}
}
\end{equation}
\begin{equation}\label{rule:mExpandsP-struct}
\inferrule{
  \kanaX{\uc}{c}{\kappa}\\
  \eanaPX{\ue}{e}{[c/u]\tau}
}{
  \mExpandsPX{\struct{\uc}{\ue}}{\astruct{c}{e}}{\asignature{\kappa}{u}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:mExpandsP-seal}
\inferrule{
  \sigExpandsPX{\usigma}{\sigma}\\
  \mExpandsPX{\uM}{M}{\sigma}
}{
  \mExpandsPX{\seal{\uM}{\usigma}}{\aseal{\sigma}{M}}{\sigma} 
}
\end{equation}
\begin{equation}\label{rule:mExpandsP-mlet}
\inferrule{
  \mExpandsPX{\uM}{M}{\sigma}\\
  \sigExpandsPX{\usigma'}{\sigma'}\\\\
  \mExpandsP{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPsi}{\uPhi}{\uM'}{M'}{\sigma'}
}{
  \mExpandsPX{\mlet{\uX}{\uM}{\uM'}{\usigma'}}{\amlet{\sigma'}{M}{X}{M'}}{\sigma'}
}
\end{equation}
\begin{equation}\label{rule:mExpandsP-syntaxpe}
\inferrule{
  \tsmtyExpands{\uOmega}{\urho}{\rho}\\
  \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\\\\
  \evalU{\eparse}{\eparse'}\\
  \mExpandsP{\uOmega}{\uAS{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Psi, \petsmdefn{a}{\rho}{\eparse'}}}{\uPhi}{\uM}{M}{\sigma}
}{
  \mExpandsP{\uOmega}{\uAS{\uA}{\Psi}}{\uPhi}{\defpetsm{\tsmv}{\urho}{\eparse}{\uM}}{M}{\sigma}
}
\end{equation}
\begin{equation}\label{rule:mExpandsP-letpetsm}
\inferrule{
  % \uOmega = \uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}\\
  \tsmexpExpandsExp{\uOmega}{\uAS{\uA}{\Psi}}{\uepsilon}{\epsilon}{\rho}\\
  % \tsmexpEvalsExp{\Omega}{\Psi}{\epsilon}{\epsilon_\text{normal}}\\\\
  \mExpandsP{\uOmega}{\uAS{\uA\uplus\mapitem{\tsmv}{\epsilon_\text{normal}}}{\Psi}}{\uPhi}{\uM}{M}{\sigma}
}{
  \mExpandsP{\uOmega}{\uAS{\uA}{\Psi}}{\uPhi}{\uletpetsm{\tsmv}{\uepsilon}{\uM}}{M}{\sigma}
}
\end{equation}
\begin{equation}\label{rule:mExpandsP-syntaxpp}
\inferrule{ 
  \tsmtyExpands{\uOmega}{\urho}{\rho}\\
  \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat }}\\\\
  \evalU{\eparse}{\eparse'}\\
  \mExpandsP{\uOmega}{\uPsi}{\uAS{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Phi, \pptsmdefn{a}{\rho}{\eparse'}}}{\uM}{M}{\sigma}
}{
  \mExpandsP{\uOmega}{\uPsi}{\uAS{\uA}{\Phi}}{\defpptsm{\tsmv}{\urho}{\eparse}{\uM}}{M}{\sigma}
}
\end{equation}
\begin{equation}\label{rule:mExpandsP-letpptsm}
\inferrule{
  \tsmexpExpandsPat{\uOmega}{\uAS{\uA}{\Phi}}{\uepsilon}{\epsilon}{\rho}\\
  \mExpandsP{\uOmega}{\uPsi}{\uAS{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Phi}}{\uM}{M}{\sigma}
}{
  \mExpandsP{\uOmega}{\uPsi}{\uAS{\uA}{\Phi}}{\uletpptsm{\tsmv}{\uepsilon}{\uM}}{M}{\sigma}
}
\end{equation}
\end{subequations}

\subsubsection{Kind and Constructor Expansion}
\noindent\fbox{$\strut\kExpandsX{\ukappa}{\kappa}$}~~$\ukappa$ has well-formed expansion $\kappa$
\begin{subequations}\label{rules:kExpands-B}
\begin{equation}\label{rule:kExpands-B-darr}
\inferrule{
  \kExpandsX{\ukappa_1}{\kappa_1}\\
  \kExpands{\uOmega, \uKhyp{\uu}{u}{\kappa_1}}{\ukappa_2}{\kappa_2}
}{
  \kExpandsX{\kdarr{\uu}{\ukappa_1}{\ukappa_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:kExpands-B-unit}
\inferrule{ }{
  \kExpandsX{\kunit}{\akunit}
}
\end{equation}
\begin{equation}\label{rule:kExpands-B-dprod}
\inferrule{
  \kExpandsX{\ukappa_1}{\kappa_1}\\
  \kExpands{\uOmega, \uKhyp{\uu}{u}{\kappa_1}}{\ukappa_2}{\kappa_2}
}{
  \kExpandsX{\kdbprod{\uu}{\ukappa_1}{\ukappa_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:kExpands-B-ty}
\inferrule{ }{
  \kExpandsX{\kty}{\akty}
}
\end{equation}
\begin{equation}\label{rule:kExpands-B-sing}
\inferrule{
  \cExpandsX{\utau}{\tau}{\akty}
}{
  \kExpandsX{\ksing{\utau}}{\aksing{\tau}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\cExpandsX{\uc}{c}{\kappa}$}~~$\uc$ has expansion $c$ of kind $\kappa$
\begin{subequations}\label{rules:cExpands}
\begin{equation}\label{rule:cExpands-subsume}
\inferrule{
  \cExpandsX{\uc}{c}{\kappa_1}\\
  \ksubX{\kappa_1}{\kappa_2}
}{
  \cExpandsX{\uc}{c}{\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:cExpands-var}
\inferrule{ }{\cExpands{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\uu}{u}{\kappa}}
\end{equation}
\begin{equation}\label{rule:cExpands-abs}
\inferrule{
  \cExpands{\uOmega, \uKhyp{\uu}{u}{\kappa_1}}{\uc_2}{c_2}{\kappa_2}
}{
  \cExpandsX{\cabs{\uu}{\uc_2}}{\acabs{u}{c_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cExpands-app}
\inferrule{
  \cExpandsX{\uc_1}{c_1}{\akdarr{\kappa_2}{u}{\kappa}}\\
  \cExpandsX{\uc_2}{c_2}{\kappa_2}
}{
  \cExpandsX{\capp{\uc_1}{\uc_2}}{\acapp{c_1}{c_2}}{[c_1/u]\kappa}
}
\end{equation}
\begin{equation}\label{rule:cExpands-unit}
\inferrule{ }{
  \cExpandsX{\ctriv}{\actriv}{\akunit}
}
\end{equation}
\begin{equation}\label{rule:cExpands-pair}
\inferrule{
  \cExpandsX{\uc_1}{c_1}{\kappa_1}\\
  \cExpandsX{\uc_2}{c_2}{[c_1/u]\kappa_2}
}{
  \cExpandsX{\cpair{\uc_1}{\uc_2}}{\acpair{c_1}{c_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cExpands-prl}
\inferrule{
  \cExpandsX{\uc}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \cExpandsX{\cprl{\uc}}{\acprl{c}}{\kappa_1}
}
\end{equation}
\begin{equation}\label{rule:cExpands-prr}
\inferrule{
  \cExpandsX{\uc}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \cExpandsX{\cprr{\uc}}{\acprr{c}}{[\acprl{c}/u]\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:cExpands-parr}
\inferrule{
  \cExpandsX{\utau_1}{\tau_1}{\akty}\\
  \cExpandsX{\utau_2}{\tau_2}{\akty}
}{
  \cExpandsX{\parr{\utau_1}{\utau_2}}{\aparr{\tau_1}{\tau_2}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cExpands-all}
\inferrule{
  \kExpandsX{\ukappa}{\kappa}\\
  \cExpands{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\utau}{\tau}{\akty}
}{
  \cExpandsX{\forallu{\uu}{\ukappa}{\utau}}{\aallu{\kappa}{u}{\tau}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cExpands-rec}
\inferrule{
  \cExpands{\uOmega, \uKhyp{\ut}{t}{\akty}}{\utau}{\tau}{\akty}
}{
  \cExpandsX{\rect{\ut}{\utau}}{\arec{t}{\tau}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cExpands-prod}
\inferrule{
  \{\cExpandsX{\utau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
}{
  \cExpandsX{\prodt{\mapschema{\utau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cExpands-sum}
\inferrule{
  \{\cExpandsX{\utau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
}{
  \cExpandsX{\sumt{\mapschema{\utau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cExpands-sing}
\inferrule{
  \cExpandsX{\uc}{c}{\akty}
}{
  \cExpandsX{\uc}{c}{\aksing{c}}
}
\end{equation}
\begin{equation}\label{rule:cExpands-stat}
\inferrule{ }{
  \cExpands{\uOmega, \uMhyp{\uX}{X}{\asignature{\kappa}{u}{\tau}}}{\mcon{\uX}}{\amcon{X}}{\kappa}
}
\end{equation}
\end{subequations}

\subsubsection{Type, Expression, Rule and Pattern Expansion}
% \noindent\fbox{$\strut\tExpandsPX{\utau}{\tau}$}~~$\utau$ has well-formed expansion $\tau$
% \begin{equation}\label{rule:tExpandsP}
% \inferrule{
%   \cExpandsX{\utau}{\tau}{\akty}
% }{
%   \tExpandsPX{\utau}{\tau}
% }
% \end{equation}

\noindent\fbox{$\strut\expandsPX{\ue}{e}{\tau}$}~~$\ue$ has expansion $e$ of type $\tau$
\begin{subequations}\label{rules:expandsP}
\begin{equation}\label{rule:expandsP-subsume}
  \inferrule{
    \expandsPX{\ue}{e}{\tau}\\
    \issubtypePX{\tau}{\tau'}
  }{
    \expandsPX{\ue}{e}{\tau'}
  }
\end{equation}

\begin{equation}\label{rule:expandsP-var}
  \inferrule{ }{ 
    \expandsP{\uOmega, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ux}{x}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsP-asc}
  \inferrule{
    \cExpands{\uOmega}{\utau}{\tau}{\akty}\\
    \expandsP{\uOmega}{\uPsi}{\uPhi}{\ue}{e}{\tau}
  }{
    \expandsP{\uOmega}{\uPsi}{\uPhi}{\asc{\ue}{\utau}}{e}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:expandsP-letsyn}
  \inferrule{
    \expandsP{\uOmega}{\uPsi}{\uPhi}{\ue_1}{e_1}{\tau_1}\\
    \expandsP{\uOmega, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue_2}{e_2}{\tau_2}
  }{
    \expandsP{\uOmega}{\uPsi}{\uPhi}{\letsyn{\ux}{\ue_1}{\ue_2}}{
      \aeap{\aelam{\tau_1}{x}{e_2}}{e_1}
    }{\tau_2}
  }
\end{equation}
%Functions with an argument type annotation can appear in synthetic position.
\begin{equation}\label{rule:expandsP-lam}
  \inferrule{
    \cExpands{\uOmega}{\utau_1}{\tau_1}{\akty}\\
    \expandsP{\uOmega, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue}{e}{\tau_2}
  }{
    \expandsPX{\lam{\ux}{\utau_1}{\ue}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
  }
\end{equation}

%Function applications can appear in synthetic position. The argument is analyzed against the argument type synthesized by the function.
\begin{equation}\label{rule:expandsP-ap}
  \inferrule{
    \expandsPX{\ue_1}{e_1}{\aparr{\tau_2}{\tau}}\\
    \expandsPX{\ue_2}{e_2}{\tau_2}
  }{
    \expandsPX{\ap{\ue_1}{\ue_2}}{\aeap{e_1}{e_2}}{\tau}
  }
\end{equation}

%Type lambdas and type applications can appear in synthetic position.
\begin{equation}\label{rule:expandsP-tlam}
  \inferrule{
    \kExpandsX{\ukappa}{\kappa}\\
    \expandsP{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\uPsi}{\uPhi}{\ue}{e}{\tau}
  }{
    \expandsPX{\clam{\uu}{\ukappa}{\ue}}{\aeclam{\kappa}{u}{e}}{\aallu{\kappa}{u}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:expandsP-tap}
  \inferrule{
    \expandsPX{\ue}{e}{\aallu{\kappa}{u}{\tau}}\\
    \ksynX{\uc}{c}{\kappa}
  }{
    \expandsPX{\cAp{\ue}{\uc}}{\aecap{e}{c}}{[c/t]\tau}
  }
\end{equation}
% Values of recursive types can be introduced only in analytic position.
\begin{equation}\label{rule:expandsP-fold}
  \inferrule{
    \expandsPX{\ue}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \expandsPX{\fold{\ue}}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}

%Unfoldings can appear in synthetic position.
\begin{equation}\label{rule:expandsP-unfold}
  \inferrule{
    \expandsPX{\ue}{e}{\arec{t}{\tau}}
  }{
    \expandsPX{\unfold{\ue}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}

%Labeled tuples can appear in synthetic position. Each of the field values are then in synthetic position. 
\begin{equation}\label{rule:expandsP-tpl}
  \inferrule{
    \{\expandsPX{\ue_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \expandsPX{\tpl{\mapschema{\ue}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}

%Fields can be projected out of a labeled tuple in synthetic position.
\begin{equation}\label{rule:expandsP-pr}
  \inferrule{
    \expandsPX{\ue}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
  }{
    \expandsPX{\prj{\ue}{\ell}}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}

% Values of labeled sum type can appear only in analytic position.
\begin{equation}\label{rule:expandsP-in}
  \inferrule{
    \expandsPX{\ue'}{e'}{\tau'}
  }{
    \expandsPX{\inj{\ell}{\ue}}{\aein{\ell}{e'}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}
    % \uOmega \vdash_{\uPsi; \uPhi} \left(\shortstack{$\ue \leadsto $\\$\Leftarrow$\vspace{-1.2em}}\right)
    %\expandsPX{\auanain{\ell}{\ue}}{\aein{\ell}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
  }
\end{equation}

%Match expressions can appear in synthetic position.
\begin{equation}\label{rule:expandsP-match}
  \inferrule{
    % \uOmega = \uOmegaEx{\uD}{\uG}{\uM}{\Omega}\\\\
    \expandsPX{\ue}{e}{\tau}\\
    % \haskind{\Omega}{\tau'}{\akty}\\
    \{\rsynPX{\urv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
  }{
    \expandsPX{\matchwith{\ue}{\seqschemaX{\urv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
  }
\end{equation}

\begin{equation}\label{rule:expandsP-mval}
  \inferrule{ }{
    \expandsP{\uOmega, \uMhyp{\uX}{X}{\asignature{\kappa}{u}{\tau}}}{\uPsi}{\uPhi}{\mval{\uX}}{\amval{X}}{[\amcon{X}/u]\tau}
  }
\end{equation}

% ueTSMs can be defined and applied in synthetic position.
% \begin{equation}\label{rule:expandsP-defpetsm}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\\\\
%   \expandsP{\uOmega}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\uI}}{\uPhi}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\usyntaxueP{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% }
% \end{equation}

% \begin{equation}\label{rule:expandsP-letpetsm}
% \inferrule{
%   \tsmexpExpandsExp{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \expandsP{\uOmega}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Psi}{\uI}}{\uPhi}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\uletpetsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% }
% \end{equation}

\begin{equation}\label{rule:expandsP-apuetsm}
\inferrule{
  \uOmega = \uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
  \uPsi=\uAS{\uA}{\Psi}\\\\
  \tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\aetype{\tau_\text{final}}}\\
  \tsmexpEvalsExp{\Omega_\text{app}}{\Psi}{\epsilon}{\epsilon_\text{normal}}\\\\
  \tsmdefof{\epsilon_\text{normal}}=a\\
  \Psi = \Psi', \petsmdefn{a}{\rho}{\eparse}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessE}}\cdot{e_\text{pproto}}}\\
  \decodePCEExp{e_\text{pproto}}{\pce}\\\\
  \prepce{\Omega_\text{app}}{\Psi}{\pce}{\ce}{\epsilon_\text{normal}}{\aetype{\tau_\text{proto}}}{\omega}{\Omega_\text{params}}\\\\
  \segOK{\segof{\ce}}{b}\\
  \cvalidEP{\Omega_\text{params}}{\esceneP{\OParams}{\uOmega}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau_\text{proto}}
}{
  \expandsP{\uOmega}{\uPsi}{\uPhi}{\utsmap{\uepsilon}{b}}{[\omega]e}{[\omega]\tau_\text{proto}}
}
\end{equation}

% These rules are nearly identical to Rules (\ref{rule:expandsUP-syntax}) and (\ref{rule:expandsUP-tsmap}), differing only in that the typed expansion premises have been replaced by corresponding synthetic typed expansion premises. The premises of these rules can be understood as described in Sections \ref{sec:U-uetsm-definition} and \ref{sec:U-uetsm-application}. The body encoding judgement and candidate expansion expression decoding judgements were characterized in Sec. \ref{sec:typed-expansion-UP}. We discuss candidate expansion validation in Sec. \ref{sec:ce-validation-B} below.

% To support ueTSM implicits, ueTSM contexts, $\uPsi$, are redefined to take the form $\uASI{\uA}{\Psi}{\uI}$. TSM naming contexts, $\uA$, and ueTSM definition contexts, $\Psi$, were defined in Sec. \ref{sec:typed-expansion-UP}. We write $\uPsi, \uShyp{\tsmv}{a}{\tau}{\eparse}$ when $\uPsi=\uASI{\uA}{\Psi}{\uI}$ as shorthand for \[\uASI{\ctxUpdate{\uA}{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}\]

% \emph{TSM designation contexts}, $\uI$, are finite functions that map each type $\tau \in \domof{\uI}$ to the \emph{TSM designation} $\designate{\tau}{a}$, for some symbol $a$. We write $\uI \uplus \designate{\tau}{a}$ for the TSM designation context that maps $\tau$ to $\designate{\tau}{a}$ and defers to $\uI$ for all other types (i.e. the previous designation, if any, is updated). 

% The TSM designation context in the ueTSM context is updated by expressions of ueTSM designation form. Such expressions can appear in synthetic position, where they are governed by the following rule:% We write $\uIOK{\Delta}{\uI}$ when each type in $\uI$ is well-formed assuming $\Delta$.
%\begin{definition}[TSM Designation Context Well-Formedness] $\uIOK{\Delta}{{\uI}$ iff for each $\designate{\tau}{a}$ we have $\istypeU{\Delta}{\tau}$.\end{definition}

% \todo{peTSM implicit designation}
% \begin{equation}\label{rule:expandsP-implicite}
%   \inferrule{
%     \esyn{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\ue}{e}{\tau'}
%   }{
%     \esyn{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\uPhi}{\implicite{\tsmv}{\ue}}{e}{\tau'}
%   }
% \end{equation}

% % Like ueTSMs, upTSMs can be defined in synthetic position.
% \begin{equation}\label{rule:expandsP-syntaxup}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat}}\\\\
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\uI}}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\usyntaxup{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% }
% \end{equation}


% \begin{equation}\label{rule:expandsP-letpptsm}
% \inferrule{
%   \tsmexpExpandsPat{\uOmega}{\uASI{\uA}{\Phi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Phi}{\uI}}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\uletpptsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% }
% \end{equation}

% % This rule is nearly identical to Rule (\ref{rule:expandsUP-defuptsm}), differing only in that the typed expansion premise has been replaced by the corresponding synthetic typed expansion premise. The premises can be understood as described in Section \ref{sec:uptsm-definition}.

% % To support upTSM implicits, upTSM contexts, $\uPhi$, are redefined to take the form $\uASI{\uA}{\Phi}{\uI}$. upTSM definition contexts, $\Phi$, were defined in Sec. \ref{sec:uptsm-definition}. We write $\uPhi, \uPhyp{\tsmv}{a}{\tau}{\eparse}$ when $\uPhi=\uASI{\uA}{\Phi}{\uI}$ as shorthand for \[\uASI{\ctxUpdate{\uA}{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI}\]

% % The TSM designation context in the upTSM context is updated by expressions of upTSM designation form. Such expressions can appear in synthetic position, where they are governed by the following rule:% We write $\uIOK{\Delta}{\uI}$ when each type in $\uI$ is well-formed assuming $\Delta$.
% %\begin{definition}[TSM Designation Context Well-Formedness] $\uIOK{\Delta}{{\uI}$ iff for each $\designate{\tau}{a}$ we have $\istypeU{\Delta}{\tau}$.\end{definition}
% \todo{ppTSM implicit designation}
% \begin{equation}\label{rule:expandsP-implicitp}
%   \inferrule{
%     \esyn{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau'}
%   }{
%     \esyn{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\implicitp{\tsmv}{\ue}}{e}{\tau'}
%   }
% \end{equation}
\end{subequations}

% \begin{subequations}\label{rules:expandsP}
% Type analysis subsumes type synthesis, in that when a type can be synthesized for an unexpanded expression, that unexpanded expression can also be analyzed against that type, producing the same expansion. This is expressed by the following \emph{subsumption rule} for unexpanded expressions.

% Additional rules are needed for certain forms in order to propagate types for analysis into subexpressions, and for forms that can appear only in analytic position.



% Rule (\ref{rule:esyn-tpl}) governed labeled tuples in synthetic position. The following rule governs labeled tuples in analytic position.


% Rule (\ref{rule:esyn-match}) governed match expressions in synthetic position. The following rule governs match expressions in analytic position.

% Rule (\ref{rule:esyn-defuetsm}) governed ueTSM definitions in synthetic position. The following rule governs ueTSM definitions in analytic position.
% \begin{equation}\label{rule:expandsP-defpetsm}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\\\\
%   \expandsP{\uOmega}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\uI}}{\uPhi}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\usyntaxueP{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% }
% \end{equation}

% \begin{equation}\label{rule:expandsP-letpetsm}
% \inferrule{
%   \tsmexpExpandsExp{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \expandsP{\uOmega}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Psi}{\uI}}{\uPhi}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\uletpetsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% }
% \end{equation}

% \todo{peTSM implicit designation}
% Rule (\ref{rule:esyn-implicite}) governed ueTSM designations in synthetic position. The following rule governs ueTSM designations in analytic position.
% \begin{equation}\label{rule:expandsP-implicite}
%   \inferrule{
%     \eana{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\ue}{e}{\tau'}
%   }{
%     \eana{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\uPhi}{\implicite{\tsmv}{\ue}}{e}{\tau'}
%   }
% \end{equation}

% \todo{peTSM implicit application}
% % An expression of unadorned literal form can appear only in analytic position. The following rule extracts the TSM designated at the type that the expression is being analyzed against from the TSM designation context in the ueTSM context and applies it implicitly, i.e. the premises correspond to those of Rule (\ref{rule:esyn-apuetsm}).


% Rule (\ref{rule:esyn-defuptsm}) governed upTSM definitions in synthetic position. The following rule governs upTSM definitions in analytic position.
% \begin{equation}\label{rule:expandsP-syntaxup}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat}}\\\\
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\uI}}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\usyntaxup{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% }
% \end{equation}


% \begin{equation}\label{rule:expandsP-letpptsm}
% \inferrule{
%   \tsmexpExpandsPat{\uOmega}{\uASI{\uA}{\Phi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Phi}{\uI}}{\ue}{e}{\tau}
% }{
%   \expandsP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\uletpptsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% }
% \end{equation}


% \todo{ppTSM implicit designation}
% % Rule (\ref{rule:esyn-implicitp}) governed upTSM designations in synthetic position. The following rule governs upTSM designations in analytic position.
% \begin{equation}\label{rule:expandsP-implicitp}
%   \inferrule{
%     \eana{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau'}
%   }{
%     \eana{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\implicitp{\tsmv}{\ue}}{e}{\tau'}
%   }
% \end{equation}

% \end{subequations}

\noindent\fbox{$\strut\rExpandsSP{\uOmega}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$}~~$\urv$ has expansion $r$ taking values of type $\tau$ to values of type $\tau'$
\begin{equation}\label{rule:rExpandsP}
  \inferrule{
    \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}\\
    \patExpandsP{\uOmegaEx{\emptyset}{\uG'}{\emptyset}{\Omega'}}{\uPhi}{\upv}{p}{\tau}\\
    \expandsP{\uOmegaEx{\uD}{\uG \uplus \uG'}{\uMctx}{\Omega \cup \Omega'}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}
  }{
    \rExpandsSP{\uOmega}{\uPsi}{\uPhi}{\matchrule{\upv}{\ue}}{\aematchrule{p}{e}}{\tau}{\tau'}
  }
\end{equation}


\noindent\fbox{$\strut\patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau}$}~~$\upv$ has expansion $p$ matching against $\tau$ generating hypotheses $\uOmega'$
% The typed pattern expansion judgement is inductively defined by Rules (\ref{rules:patExpandsP}) as follows. %As in $\miniVersePat$, \emph{unexpanded pattern typing contexts}, $\upctx$, are defined identically to unexpanded typing contexts (i.e. we only use a distinct metavariable to emphasize their distinct roles in the judgements above). 

% The following rules are written identically to the typed pattern expansion rules for shared pattern forms in $\miniVersePat$, i.e. Rules (\ref{rule:patExpands-var}) through (\ref{rule:patExpands-in}).
\begin{subequations}\label{rules:patExpandsP}
\begin{equation}\label{rule:patExpandsP-subsume}
\inferrule{
  \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}\\\\
  \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau}\\
  \issubtypeP{\Omega}{\tau}{\tau'}
}{
  \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:patExpandsP-var}
\inferrule{ }{
  \patExpandsP{\uOmegaEx{\emptyset}{\vExpands{\ux}{x}}{\emptyset}{\Ghyp{x}{\tau}}}{\uPhi}{\ux}{x}{\tau}
}
\end{equation}
\begin{equation}\label{rule:patExpandsP-wild}
\inferrule{ }{
  \patExpandsP{\uOmegaEx{\emptyset}{\emptyset}{\emptyset}{\emptyset}}{\uPhi}{\wildp}{\aewildp}{\tau}
}
\end{equation}
\begin{equation}\label{rule:patExpandsP-fold}
\inferrule{ 
  \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \patExpandsP{\uOmega'}{\uPhi}{\foldp{\upv}}{\aefoldp{p}}{\arec{t}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:patExpandsP-tpl}
\inferrule{
  \tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
  \{\patExpandsP{{\uOmega_i}}{\uPhi}{\upv_i}{p_i}{\tau_i}\}_{i \in \labelset}
}{
  %\patExpandsP{\Gconsi{i \in \labelset}{\upctx_i}}{A}{B}{C}
  \patExpandsP{\Gconsi{i \in \labelset}{\uOmega_i}}{\uPhi}{\tplp{\mapschema{\upv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\tau}
  % \patExpands{\Gconsi{i \in \labelset}{\pctx_i}}{\Phi}{
  %   \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}
  % }{
  %   \aetplp{\labelset}{\mapschema{p}{i}{\labelset}}
  % }{
  %   \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}
  % } %{\autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema}{p}{i}{\labelset}}{...}
  %\left(\shortstack{$\Delta \vdash_{\uPhi} \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}$\\$\leadsto$\\$\aetplp{\labelset}{\mapschema{p}{i}{\labelset}} : \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}} \dashV \Gconsi{i \in \labelset}{\upctx_i}$\vspace{-1.2em}}\right)
}
\end{equation}
\begin{equation}\label{rule:patExpandsP-in}
\inferrule{
  \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau}
}{
  \patExpandsP{\uOmega'}{\uPhi}{\injp{\ell}{\upv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}
\end{equation}

\begin{equation}\label{rule:patExpandsP-apuptsm}
\inferrule{
  \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
  \uPhi=\uAS{\uA}{\Phi}\\\\
  \tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aetype{\tau_\text{final}}}\\
  \tsmexpEvalsPat{\Omega_\text{app}}{\Phi}{\epsilon}{\epsilon_\text{normal}}\\\\
  \tsmdefof{\epsilon_\text{normal}}=a\\
  \Phi = \Phi', \pptsmdefn{a}{\rho}{\eparse}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{e_\text{pproto}}}\\
  \decodePCEPat{e_\text{pproto}}{\pcp}\\\\
  \prepcp{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon_\text{normal}}{\aetype{\tau_\text{proto}}}{\omega}{\Omega_\text{params}}\\\\
      \segOK{\segof{\cpv}}{b}\\
  \cvalidPP{\uOmega'}{\psceneP{\uOmega}{\uPhi}{b}}{\cpv}{p}{\tau_\text{proto}}
}{
  \patExpandsP{\uOmega'}{\uPhi}{\utsmap{\uepsilon}{b}}{p}{[\omega]\tau_\text{proto}}
}
\end{equation}
\end{subequations}

\subsubsection{TSM Types and Expressions}
\noindent\fbox{$\strut\istsmty{\Omega}{\rho}$}~~$\rho$ is a TSM type
\begin{subequations}\label{rules:istsmty}
\begin{equation}\label{rule:istsmty-type}
\inferrule{
  \haskindX{\tau}{\akty}
}{
  \istsmty{\Omega}{\aetype{\tau}}
}
\end{equation}
\begin{equation}\label{rule:istsmty-alltypes}
\inferrule{
  \istsmty{\Omega, t :: \akty}{\rho}
}{
  \istsmty{\Omega}{\aealltypes{t}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:istsmty-allmods}
\inferrule{
  \issig{\Omega}{\sigma}\\
  \istsmty{\Omega, X : \sigma}{\rho}
}{
  \istsmty{\Omega}{\aeallmods{\sigma}{X}{\rho}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\tsmtyExpands{\uOmega}{\urho}{\rho}$}~~$\urho$ has well-formed expansion $\rho$
\begin{subequations}\label{rules:tsmtyExpands}
\begin{equation}\label{rule:tsmtyExpands-type}
\inferrule{
  \cExpandsX{\utau}{\tau}{\akty}
}{
  \tsmtyExpands{\uOmega}{{\utau}}{\aetype{\tau}}
}
\end{equation}
\begin{equation}\label{rule:tsmtyExpands-alltypes}
\inferrule{
  \tsmtyExpands{\uOmega, \uKhyp{\ut}{t}{\akty}}{\urho}{\rho}
}{
  \tsmtyExpands{\uOmega}{\alltypes{\ut}{\urho}}{\aealltypes{t}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:tsmtyExpands-allmods}
\inferrule{
  \sigExpandsPX{\usigma}{\sigma}\\
  \tsmtyExpands{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\urho}{\rho}
}{
  \tsmtyExpands{\uOmega}{\allmods{\uX}{\usigma}{\urho}}{\aeallmods{\sigma}{X}{\rho}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}$}~~$\epsilon$ is a peTSM expression at $\rho$
\begin{subequations}\label{rules:hastsmtypeExp}
\begin{equation}\label{rule:hastsmtypeExp-defref}
\inferrule{ }{
  \hastsmtypeExp{\Omega}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\adefref{a}}{\rho}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypeExp-abstype}
\inferrule{
  \hastsmtypeExp{\Omega, t :: \akty}{\Psi}{\epsilon}{\rho}
}{
  \hastsmtypeExp{\Omega}{\Psi}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypeExp-absmod}
\inferrule{
  \issigX{\sigma}\\
  \hastsmtypeExp{\Omega, X : \sigma}{\Psi}{\epsilon}{\rho}
}{
  \hastsmtypeExp{\Omega}{\Psi}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypeExp-aptype}
\inferrule{
  \hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\aealltypes{t}{\rho}}\\
  \haskindX{\tau}{\akty}
}{
  \hastsmtypeExp{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypeExp-apmod}
\inferrule{
  \hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
  \hassig{\Omega}{X}{\sigma}
}{
  \hastsmtypeExp{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}$}~~$\epsilon$ is a ppTSM expression at $\rho$
\begin{subequations}\label{rules:hastsmtypePat}
\begin{equation}\label{rule:hastsmtypePat-defref}
\inferrule{ }{
  \hastsmtypePat{\Omega}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\adefref{a}}{\rho}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypePat-abstype}
\inferrule{
  \hastsmtypePat{\Omega, t :: \akty}{\Phi}{\epsilon}{\rho}
}{
  \hastsmtypePat{\Omega}{\Phi}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypePat-absmod}
\inferrule{
  \issigX{\sigma}\\
  \hastsmtypePat{\Omega, X : \sigma}{\Phi}{\epsilon}{\rho}
}{
  \hastsmtypePat{\Omega}{\Phi}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypePat-aptype}
\inferrule{
  \hastsmtypePat{\Omega}{\Phi}{\epsilon}{\aealltypes{t}{\rho}}\\
  \haskindX{\tau}{\akty}
}{
  \hastsmtypePat{\Omega}{\Phi}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho}
}
\end{equation}
\begin{equation}\label{rule:hastsmtypePat-apmod}
\inferrule{
  \hastsmtypePat{\Omega}{\Phi}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
  \hassig{\Omega}{X}{\sigma}
}{
  \hastsmtypePat{\Omega}{\Phi}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
}
\end{equation}

\end{subequations}

\noindent\fbox{$\strut\tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\rho}$}~~$\uepsilon$ has peTSM expression expansion $\epsilon$ at $\rho$
\begin{subequations}\label{rules:tsmexpExpandsExp}
\begin{equation}\label{rule:tsmexpExpandsExp-bindref}
\inferrule{
  \hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}  
}{
  \tsmexpExpandsExp{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uAS{\uA, \mapitem{\tsmv}{\epsilon}}{\Psi}}{{\tsmv}}{\epsilon}{\rho}
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsExp-abstype}
\inferrule{
  \tsmexpExpandsExp{\uOmega, \uKhyp{\ut}{t}{\akty}}{\uPsi}{\uepsilon}{\epsilon}{\rho}
}{
  \tsmexpExpandsExp{\uOmega}{\uPsi}{\abstype{\ut}{\uepsilon}}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsExp-absmod}
\inferrule{
  \sigExpandsPX{\usigma}{\sigma}\\
  \tsmexpExpandsExp{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPsi}{\uepsilon}{\epsilon}{\rho}
}{
  \tsmexpExpandsExp{\uOmega}{\uPsi}{\absmod{\uX}{\usigma}{\uepsilon}}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsExp-aptype}
\inferrule{
  \tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\aealltypes{t}{\rho}}\\
  \cExpandsX{\utau}{\tau}{\akty}
}{
  \tsmexpExpandsExp{\uOmega}{\uPsi}{\aptype{\uepsilon}{\utau}}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho} 
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsExp-apmod}
\inferrule{
  \tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
  \mExpandsPX{\uX}{X}{\sigma}
}{
  \tsmexpExpandsExp{\uOmega}{\uPsi}{\apmod{\uepsilon}{\uX}}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\tsmexpExpandsPat{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\rho}$}~~$\uepsilon$ has ppTSM expression expansion $\epsilon$ at $\rho$
\begin{subequations}\label{rules:tsmexpExpandsPat}
\begin{equation}\label{rule:tsmexpExpandsPat-bindref}
\inferrule{
  \hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}  
}{
  \tsmexpExpandsPat{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uAS{\uA, \mapitem{\tsmv}{\epsilon}}{\Phi}}{{\tsmv}}{\epsilon}{\rho}
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsPat-abstype}
\inferrule{
  \tsmexpExpandsPat{\uOmega, \uKhyp{\ut}{t}{\akty}}{\uPhi}{\uepsilon}{\epsilon}{\rho}
}{
  \tsmexpExpandsPat{\uOmega}{\uPhi}{\abstype{\ut}{\uepsilon}}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsPat-absmod}
\inferrule{
  \sigExpandsPX{\usigma}{\sigma}\\
  \tsmexpExpandsPat{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPhi}{\uepsilon}{\epsilon}{\rho}
}{
  \tsmexpExpandsPat{\uOmega}{\uPhi}{\absmod{\uX}{\usigma}{\uepsilon}}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsPat-aptype}
\inferrule{
  \tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aealltypes{t}{\rho}}\\
  \cExpandsX{\utau}{\tau}{\akty}
}{
  \tsmexpExpandsPat{\uOmega}{\uPhi}{\aptype{\uepsilon}{\utau}}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho} 
}
\end{equation}
\begin{equation}\label{rule:tsmexpExpandsPat-apmod}
\inferrule{
  \tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
  \mExpandsPX{\uX}{X}{\sigma}
}{
  \tsmexpExpandsPat{\uOmega}{\uPhi}{\apmod{\uepsilon}{\uX}}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\tsmexpNormalExp{\Omega}{\Psi}{\epsilon}$}~~$\epsilon$ is a normal peTSM expression
\begin{subequations}\label{rules:tsmexpNormalExp}
\begin{equation}\label{rule:tsmexpNormalExp-defref}
\inferrule{ }{
  \tsmexpNormalExp{\Omega}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\adefref{a}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalExp-abstype}
\inferrule{ }{
  \tsmexpNormalExp{\Omega}{\Psi}{\aeabstype{t}{\epsilon}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalExp-absmod}
\inferrule{ }{
  \tsmexpNormalExp{\Omega}{\Psi}{\aeabsmod{\sigma}{X}{\epsilon}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalExp-aptype}
\inferrule{
  \epsilon \neq \aeabstype{t}{\epsilon'}\\
  \tsmexpNormalExp{\Omega}{\Psi}{\epsilon}
}{
  \tsmexpNormalExp{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalExp-apmod}
\inferrule{
  \epsilon \neq \aeabsmod{\sigma}{X'}{\epsilon'}\\
  \tsmexpNormalExp{\Omega}{\Psi}{\epsilon}
}{
  \tsmexpNormalExp{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\tsmexpNormalPat{\Omega}{\Psi}{\epsilon}$}~~$\epsilon$ is a normal ppTSM expression
\begin{subequations}\label{rules:tsmexpNormalPat}
\begin{equation}\label{rule:tsmexpNormalPat-defref}
\inferrule{ }{
  \tsmexpNormalPat{\Omega}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\adefref{a}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalPat-abstype}
\inferrule{ }{
  \tsmexpNormalPat{\Omega}{\Psi}{\aeabstype{t}{\epsilon}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalPat-absmod}
\inferrule{ }{
  \tsmexpNormalPat{\Omega}{\Psi}{\aeabsmod{\sigma}{X}{\epsilon}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalPat-aptype}
\inferrule{
  \epsilon \neq \aeabstype{t}{\epsilon'}\\
  \tsmexpNormalPat{\Omega}{\Psi}{\epsilon}
}{
  \tsmexpNormalPat{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpNormalPat-apmod}
\inferrule{
  \epsilon \neq \aeabsmod{\sigma}{X'}{\epsilon'}\\
  \tsmexpNormalPat{\Omega}{\Psi}{\epsilon}
}{
  \tsmexpNormalPat{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}$}~~peTSM expression $\epsilon$ transitions to $\epsilon'$
\begin{subequations}\label{rules:tsmexpStepsExp}
\begin{equation}\label{rule:tsmexpStepsExp-aptype-1}
\inferrule{
  \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
}{
  \tsmexpStepsExp{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}{\aeaptype{\tau}{\epsilon'}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpStepsExp-aptype-2}
\inferrule{ }{
  \tsmexpStepsExp{\Omega}{\Psi}{\aeaptype{\tau}{\aeabstype{t}{\epsilon}}}{[\tau/t]\epsilon}
}
\end{equation}
\begin{equation}\label{rule:tsmexpStepsExp-apmod-1}
\inferrule{
  \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
}{
  \tsmexpStepsExp{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}{\aeapmod{X}{\epsilon'}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpStepsExp-apmod-2}
\inferrule{ }{
  \tsmexpStepsExp{\Omega}{\Psi}{\aeapmod{X}{\aeabsmod{\sigma}{X'}{\epsilon}}}{[X/X']\epsilon}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\tsmexpStepsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}$}~~peTSM expression $\epsilon$ transitions to $\epsilon'$
\begin{subequations}\label{rules:tsmexpStepsPat}
\begin{equation}\label{rule:tsmexpStepsPat-aptype-1}
\inferrule{
  \tsmexpStepsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}
}{
  \tsmexpStepsPat{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}{\aeaptype{\tau}{\epsilon'}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpStepsPat-aptype-2}
\inferrule{ }{
  \tsmexpStepsPat{\Omega}{\Psi}{\aeaptype{\tau}{\aeabstype{t}{\epsilon}}}{[\tau/t]\epsilon}
}
\end{equation}
\begin{equation}\label{rule:tsmexpStepsPat-apmod-1}
\inferrule{
  \tsmexpStepsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}
}{
  \tsmexpStepsPat{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}{\aeapmod{X}{\epsilon'}}
}
\end{equation}
\begin{equation}\label{rule:tsmexpStepsPat-apmod-2}
\inferrule{ }{
  \tsmexpStepsPat{\Omega}{\Psi}{\aeapmod{X}{\aeabsmod{\sigma}{X'}{\epsilon}}}{[X/X']\epsilon}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}$}~~peTSM expression $\epsilon$ transitions in multiple steps to $\epsilon'$
\begin{subequations}\label{rules:tsmexpMultistepsExp}
\begin{equation}\label{rule:tsmexpMultistepsExp-refl}
\inferrule{ }{
  \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon}
}
\end{equation}
\begin{equation}\label{rule:tsmexpMultistepsExp-steps}
\inferrule{
  \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
}{
  \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
}
\end{equation}
\begin{equation}\label{rule:tsmexpMultistepsExp-trans}
\inferrule{
  \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}\\
  \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon'}{\epsilon''}
}{
  \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon''}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\tsmexpMultistepsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}$}~~peTSM expression $\epsilon$ transitions in multiple steps to $\epsilon'$
\begin{subequations}\label{rules:tsmexpMultistepsPat}
\begin{equation}\label{rule:tsmexpMultistepsPat-refl}
\inferrule{ }{
  \tsmexpMultistepsPat{\Omega}{\Psi}{\epsilon}{\epsilon}
}
\end{equation}
\begin{equation}\label{rule:tsmexpMultistepsPat-steps}
\inferrule{
  \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
}{
  \tsmexpMultistepsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}
}
\end{equation}
\begin{equation}\label{rule:tsmexpMultistepsPat-trans}
\inferrule{
  \tsmexpMultistepsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}\\
  \tsmexpMultistepsPat{\Omega}{\Psi}{\epsilon'}{\epsilon''}
}{
  \tsmexpMultistepsPat{\Omega}{\Psi}{\epsilon}{\epsilon''}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\tsmexpEvalsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}$}~~peTSM expression $\epsilon$ normalizes to $\epsilon'$
\begin{equation}\label{rule:tsmexpEvalsExp}
\inferrule{
  \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}\\
  \tsmexpNormalExp{\Omega}{\Psi}{\epsilon'}
}{
  \tsmexpEvalsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
}
\end{equation}


\noindent\fbox{$\strut\tsmexpEvalsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}$}~~peTSM expression $\epsilon$ normalizes to $\epsilon'$
\begin{equation}\label{rule:tsmexpEvalsPat}
\inferrule{
  \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}\\
  \tsmexpNormalExp{\Omega}{\Psi}{\epsilon'}
}{
  \tsmexpEvalsPat{\Omega}{\Psi}{\epsilon}{\epsilon'}
}
\end{equation}

The following metafunction extracts the TSM name from a TSM expression.
\begin{subequations}
\begin{align}
\tsmdefof{\adefref{a}} & = a \label{eqn:tsmdefof-adefref}\\
\tsmdefof{\aeabstype{t}{\epsilon}} & = \tsmdefof{\epsilon} \label{eqn:tsmdefof-abstype}\\
\tsmdefof{\aeabsmod{\sigma}{X}{\epsilon}} & = \tsmdefof{\epsilon} \label{eqn:tsmdefof-absmod}\\
\tsmdefof{\aeaptype{\tau}{\epsilon}} & = \tsmdefof{\epsilon} \label{eqn:tsmdefof-aptype}\\
\tsmdefof{\aeapmod{X}{\epsilon}} & = \tsmdefof{\epsilon} \label{eqn:tsmdefof-apmod}
\end{align}
\end{subequations}
\section{Proto-Expansion Validation}\label{appendix:P-proto-expansion-validation}
\subsection{Syntax of Proto-Expansions}
\subsubsection{Syntax -- Parameterized Proto-Expressions}
\[\begin{array}{lllllll}
\textbf{Sort} & & & \textbf{Operational Form} & \textbf{Stylized Form} & \textbf{Description}\\
% \LCC \color{Yellow}&\color{Yellow}&\color{Yellow}& \color{Yellow} & \color{Yellow} & \color{Yellow}\\
\mathsf{PPrExpr} & \pce & ::= & \apceexp{\ce} & \pceexp{\ce} & \text{proto-expression}\\
&&& \apcebindtype{t}{\pce} & \pcebindtype{t}{\pce} & \text{type binding}\\
&&& \apcebindmod{X}{\pce} & \pcebindmod{X}{\pce} & \text{module binding}%\ECC
\end{array}\]

\subsubsection{Syntax -- Parameterized Proto-Patterns}
\[\begin{array}{lllllll}
\textbf{Sort} & & & \textbf{Operational Form} & \textbf{Stylized Form} & \textbf{Description}\\
% \LCC \color{Yellow}&\color{Yellow}&\color{Yellow}& \color{Yellow} & \color{Yellow} & \color{Yellow}\\
\mathsf{PPrPat} & \pcp & ::= & \apcepat{\cpv} & {\cpv} & \text{proto-pattern}\\
&&& \apcebindtype{t}{\pcp} & \pcebindtype{t}{\pcp} & \text{type binding}\\
&&& \apcebindmod{X}{\pcp} & \pcebindmod{X}{\pcp} & \text{module binding}%\ECC
\end{array}\]

\subsubsection{Syntax -- Proto-Kinds and Proto-Constructors}
\[\begin{array}{lrlllll}
\textbf{Sort} & & & \textbf{Operational Form} & \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{PrKind} & \cekappa & ::= & \acekdarr{\cekappa}{u}{\cekappa} & \kdarr{u}{\cekappa}{\cekappa} & \text{dependent function}\\
&&& \acekunit & \kunit & \text{nullary product}\\
&&& \acekdbprod{\cekappa}{u}{\cekappa} & \kdbprod{u}{\cekappa}{\cekappa} & \text{dependent product}\\
%&&& \akdprodstd & \kdprodstd & \text{labeled dependent product}\\
&&& \acekty & \kty & \text{types}\\
&&& \aceksing{\ctau} & \ksing{\ctau} & \text{singleton}\\
% \LCC &&& \color{Yellow} & \color{Yellow} & \color{Yellow}\\
&&& \acesplicedk{m}{n} & \splicedk{m}{n} & \text{spliced kind}\\%\ECC\\
\mathsf{PrCon} & \cec, \ctau & ::= & u & u & \text{constructor variable}\\
&&& t & t & \text{type variable}\\
% &&& \acecasc{\cekappa}{\cec} & \casc{\cec}{\cekappa} & \text{ascription}\\
&&& \acecabs{u}{\cec} & \cabs{u}{\cec} & \text{abstraction}\\
&&& \acecapp{\cec}{\cec} & \capp{\cec}{\cec} & \text{application}\\
&&& \acectriv & \ctriv & \text{trivial}\\
&&& \acecpair{\cec}{\cec} & \cpair{\cec}{\cec} & \text{pair}\\
&&& \acecprl{\cec} & \cprl{\cec} & \text{left projection}\\
&&& \acecprr{\cec} & \cprr{\cec} & \text{right projection}\\
%&&& \adtplX & \dtplX & \text{labeled dependent tuple}\\
%&&& \adprj{\ell}{c} & \prj{c}{\ell} & \text{projection}\\
&&& \aceparr{\ctau}{\ctau} & \parr{\ctau}{\ctau} & \text{partial function}\\
&&& \aceallu{\cekappa}{u}{\ctau} & \forallu{u}{\cekappa}{\ctau} & \text{polymorphic}\\
&&& \acerec{t}{\ctau} & \rect{t}{\ctau} & \text{recursive}\\
&&& \aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}} & \prodt{\mapschema{\ctau}{i}{\labelset}} & \text{labeled product}\\
&&& \acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}} & \sumt{\mapschema{\ctau}{i}{\labelset}} & \text{labeled sum}\\
&&& \acemcon{X} & \mcon{X} & \text{constructor component}\\
% \LCC &&& \color{Yellow} & \color{Yellow} & \color{Yellow}\\
&&& \acesplicedc{m}{n}{\cekappa} & \splicedc{m}{n}{\cekappa} & \text{spliced constructor}%\ECC
\end{array}\]

\subsubsection{Syntax -- Proto-Expressions and Proto-Rules}
\[\arraycolsep=4pt\begin{array}{lllllll}
\textbf{Sort} & & & \textbf{Operational Form} & \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{PrExp} & \ce & ::= & x & x & \text{variable}\\
&&& \aceasc{\ctau}{\ce} & \asc{\ce}{\ctau} & \text{ascription}\\
&&& \aceletsyn{x}{\ce}{\ce} & \letsyn{x}{\ce}{\ce} & \text{value binding}\\
% &&& \aceanalam{x}{\ce} & \analam{x}{\ce} & \text{abstraction (unannotated)}\\
&&& \acelam{\ctau}{x}{\ce} & \lam{x}{\ctau}{\ce} & \text{abstraction}\\
&&& \aceap{\ce}{\ce} & \ap{\ce}{\ce} & \text{application}\\
&&& \aceclam{\cekappa}{u}{\ce} & \clam{u}{\cekappa}{\ce} & \text{constructor abstraction}\\
&&& \acecap{\ce}{\cec} & \cAp{\ce}{\cec} & \text{constructor application}\\
&&& \acefold{\ce} & \fold{\ce} & \text{fold}\\
&&& \aceunfold{\ce} & \unfold{\ce} & \text{unfold}\\
&&& \acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}} & \tpl{\mapschema{\ce}{i}{\labelset}} & \text{labeled tuple}\\
&&& \acepr{\ell}{\ce} & \prj{\ce}{\ell} & \text{projection}\\
&&& \aceanain{\ell}{\ce} & \inj{\ell}{\ce} & \text{injection}\\
&&& \acematchwith{n}{\ce}{\seqschemaX{\crv}} & \matchwith{\ce}{\seqschemaX{\crv}} & \text{match}\\
&&& \acemval{X} & \mval{X} & \text{value component}\\
% \LCC &&& \color{Yellow} & \color{Yellow} & \color{Yellow}\\
&&& \acesplicede{m}{n}{\ctau} & \splicede{m}{n}{\ctau} & \text{spliced expression}\\%\ECC\\
\mathsf{PrRule} & \crv & ::= & \acematchrule{p}{\ce} & \matchrule{p}{\ce} & \text{rule}\end{array}\]

\subsubsection{Syntax -- Proto-Patterns}
\[\begin{array}{lllllll}
\mathsf{PrPat} & \cpv & ::= & \acewildp & \wildp & \text{wildcard pattern}\\
&&& \acefoldp{p} & \foldp{p} & \text{fold pattern}\\
&&& \acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}} & \tplp{\mapschema{\cpv}{i}{\labelset}} & \text{labeled tuple pattern}\\
&&& \aceinjp{\ell}{\cpv} & \injp{\ell}{\cpv} & \text{injection pattern}\\
% \LCC &&& \color{Yellow} & \color{Yellow} & \color{Yellow}\\
&&& \acesplicedp{m}{n}{\ctau} & \splicedp{m}{n}{\ctau} & \text{spliced pattern} %\ECC
\end{array}\]

\subsubsection{Common Proto-Expansion Terms}
Each expanded term, with a few exceptions noted below, maps onto a proto-expansion term. We refer to these as the \emph{common proto-expansion terms}. In particular:
\begin{itemize}
  \item Each kind, $\kappa$, maps onto a proto-kind, $\Cof{\kappa}$, as follows:
  \[\arraycolsep=1pt\begin{array}{rl}
  \Cof{\akdarr{\kappa_1}{u}{\kappa_2}} & = \acekdarr{\Cof{\kappa_1}}{u}{\Cof{\kappa_2}}\\
  \Cof{\akunit} & = \acekunit\\
  \Cof{\akdbprod{\kappa_1}{u}{\kappa_2}} & = \acekdbprod{\Cof{\kappa_1}}{u}{\Cof{\kappa_2}}\\
  \Cof{\akty} & = \acekty\\
  \Cof{\aksing{\tau}} & = \aceksing{\Cof{\tau}}
  \end{array}\]
  \item Each constructor, $c$, maps onto a proto-constructor, $\Cof{c}$, as follows:
  \[\arraycolsep=1pt\begin{array}{rl}
  \Cof{u} & = u\\
  \Cof{\acabs{u}{c}} & = \acecabs{u}{\Cof{c}}\\
  \Cof{\acapp{c_1}{c_2}} & = \acecapp{\Cof{c_1}}{\Cof{c_2}}\\
  \Cof{\actriv} & = \acectriv\\
  \Cof{\acpair{c_1}{c_2}} & = \acecpair{\Cof{c_1}}{\Cof{c_2}}\\
  \Cof{\acprl{c}} & = \acecprl{\Cof{c}}\\
  \Cof{\acprr{c}} & = \acecprr{\Cof{c}}\\
  \Cof{\aparr{\tau_1}{\tau_2}} & = \aceparr{\Cof{\tau_1}}{\Cof{\tau_2}}\\
  \Cof{\aall{t}{\tau}} & = \aceall{t}{\Cof{\tau}}\\
  \Cof{\arec{t}{\tau}} & = \acerec{t}{\Cof{\tau}}\\
  \Cof{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \aceprod{\labelset}{\mapschemax{\Cofv}{\tau}{i}{\labelset}}\\
  \Cof{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \acesum{\labelset}{\mapschemax{\Cofv}{\tau}{i}{\labelset}}\\
  \Cof{\amcon{X}} & = \acemcon{X}
  \end{array}\]
  \item Each expanded expression, $e$, except for the value projection of a module expression that is not of module variable form, maps onto a proto-expression, $\Cof{e}$, as follows:
  \[\arraycolsep=1pt\begin{array}{rl}
  \Cof{x} & = x\\
  \Cof{\aelam{\tau}{x}{e}} & = \acelam{\Cof{\tau}}{x}{\Cof{e}}\\
  \Cof{\aeap{e_1}{e_2}} & = \aceap{\Cof{e_1}}{\Cof{e_2}}\\
  \Cof{\aeclam{\kappa}{u}{e}} & = \aceclam{\Cof{\kappa}}{u}{\Cof{e}}\\
  \Cof{\aecap{e}{c}} & = \acecap{\Cof{e}}{\Cof{c}}\\
  \Cof{\aefold{e}} & = \acefold{\Cof e}\\
  \Cof{\aeunfold{e}} & = \aceunfold{\Cof{e}}\\
  \Cof{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}} & = \acetpl{\labelset}{\mapschemax{\Cofv}{e}{i}{\labelset}}\\
  \Cof{\aein{\ell}{e}} &= \acein{\ell}{\Cof{e}}\\
  \Cof{\aematchwith{n}{e}{\seqschemaX{r}}} & = \acematchwith{n}{\Cof{e}}{\seqschemaXx{\Cofv}{r}}\\
  \Cof{\amval{X}} & = \acemval{X}
  \end{array}\]
  \item Each expanded rule, $r$, maps onto the proto-rule, $\Cof{r}$, as follows:
  \begin{align*}
  \Cof{\aematchrule{p}{e}} & = \acematchrule{p}{\Cof{e}}
  \end{align*}
  Notice that proto-rules bind expanded patterns, not proto-patterns. This is because proto-rules appear in proto-expressions, which are generated by peTSMs. It would not be sensible for an peTSM to splice a pattern out of a literal body.
  \item Each expanded pattern, $p$, except for the variable patterns, maps onto a proto-pattern, $\Cof{p}$, as follows:
  \begin{align*}
  \Cof{\aewildp} & = \acewildp\\
  \Cof{\aefoldp{p}} & = \acefoldp{\Cof{p}}\\
  \Cof{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}} & = \acetplp{\labelset}{\mapschemax{\Cofv}{p}{i}{\labelset}}\\
  \Cof{\aeinjp{\ell}{p}} & = \aceinjp{\ell}{\Cof{p}}
  \end{align*}
\end{itemize}

\subsubsection{Parameterized Proto-Expression Encoding and Decoding}
The type abbreviated $\tPProtoExpr$ classifies encodings of \emph{parameterized proto-expressions}. The mapping from parameterized proto-expressions to values of type $\tPProtoExpr$ is defined by the \emph{parameterized proto-expression encoding judgement}, $\encodePCEExp{\pce}{e}$. An inverse mapping is defined by the \emph{parameterized proto-expression decoding judgement}, $\decodePCEExp{e}{\pce}$.

\[\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\encodePCEExp{\pce}{e} & \text{$\pce$ has encoding $e$}\\
\decodePCEExp{e}{\pce} & \text{$e$ has decoding $\pce$}
\end{array}\]

Rather than picking a particular definition of $\tPProtoExpr$ and defining the judgements above inductively against it, we only state the following condition, which establishes an isomorphism between values of type $\tPProtoExpr$ and parameterized proto-expressions.

\begin{condition}[Parameterized Proto-Expression Isomorphism]\label{condition:parameterized-proto-expression-isomorphism} ~
\begin{enumerate}
\item For every $\pce$, we have $\encodePCEExp{\pce}{\ecand}$ for some $\ecand$ such that $\hastypeUC{\ecand}{\tPProtoExpr}$ and $\isvalU{\ecand}$.
\item If $\hastypeUC{\ecand}{\tPProtoExpr}$ and $\isvalU{\ecand}$ then $\decodePCEExp{\ecand}{\pce}$ for some $\pce$.
\item If $\encodePCEExp{\pce}{\ecand}$ then $\decodePCEExp{\ecand}{\pce}$.
\item If $\hastypeUC{\ecand}{\tPProtoExpr}$ and $\isvalU{\ecand}$ and $\decodePCEExp{\ecand}{\pce}$ then $\encodePCEExp{\pce}{\ecand}$.
\item If $\encodePCEExp{\pce}{\ecand}$ and $\encodePCEExp{\pce}{\ecand'}$ then $\ecand=\ecand'$.
\item If $\hastypeUC{\ecand}{\tPProtoExpr}$ and $\isvalU{\ecand}$ and $\decodePCEExp{\ecand}{\pce}$ and $\decodePCEExp{\ecand}{\pce'}$ then $\pce=\pce'$.
\end{enumerate}
\end{condition}

\subsubsection{Parameterized Proto-Pattern Encoding and Decoding}
The type abbreviated $\tPCEPat$ classifies encodings of \emph{parameterized proto-patterns}. The mapping from parameterized proto-patterns to values of type $\tPCEPat$ is defined by the \emph{parameterized proto-pattern encoding judgement}, $\encodePCEPat{\pcp}{p}$. An inverse mapping is defined by the \emph{parameterized proto-expression decoding judgement}, $\decodePCEPat{p}{\pcp}$.

\[\begin{array}{ll}
\textbf{Judgement Form} & \textbf{Description}\\
\encodePCEPat{\pcp}{p} & \text{$\pcp$ has encoding $p$}\\
\decodePCEPat{p}{\pcp} & \text{$p$ has decoding $\pcp$}
\end{array}\]

Again, rather than picking a particular definition of $\tPCEPat$ and defining the judgements above inductively against it, we only state the following condition, which establishes an isomorphism between values of type $\tPCEPat$ and parameterized proto-patterns.

\begin{condition}[Parameterized Proto-Pattern Isomorphism]\label{condition:proto-pattern-isomorphism-P} ~
\begin{enumerate}
\item For every $\pcp$, we have $\encodePCEPat{\pcp}{\ecand}$ for some $\ecand$ such that $\hastypeUC{\ecand}{\tPCEPat}$ and $\isvalU{\ecand}$.
\item If $\hastypeUC{\ecand}{\tPCEPat}$ and $\isvalU{\ecand}$ then $\decodePCEPat{\ecand}{\pcp}$ for some $\pcp$.
\item If $\encodePCEPat{\pcp}{\ecand}$ then $\decodePCEPat{\ecand}{\pcp}$.
\item If $\hastypeUC{\ecand}{\tPCEPat}$ and $\isvalU{\ecand}$ and $\decodePCEPat{\ecand}{\pcp}$ then $\encodePCEPat{\pcp}{\ecand}$.
\item If $\encodePCEPat{\pcp}{\ecand}$ and $\encodePCEPat{\pcp}{\ecand'}$ then $\ecand=\ecand'$.
\item If $\hastypeUC{\ecand}{\tPCEPat}$ and $\isvalU{\ecand}$ and $\decodePCEPat{\ecand}{\pcp}$ and $\decodePCEPat{\ecand}{\pcp'}$ then $\pcp=\pcp'$.
\end{enumerate}
\end{condition}

\subsubsection{Splice Summaries}
The \emph{splice summary} of a proto-expression, $\summaryOf{\ce}$, or proto-pattern, $\summaryOf{\cpv}$, is the finite set of references to spliced kinds, constructors, expressions and patterns that it mentions.

\subsubsection{Segmentations}
A \emph{segment set}, $\psi$, is a finite set of pairs of natural numbers indicating the locations of spliced terms. The \emph{segmentation} of a proto-expression, $\segof{\ce}$, or proto-pattern, $\segof{\cpv}$, is the segment set implied by the splice summary.

The predicate $\segOK{\psi}{b}$ checks that each segment in $\psi$, has non-negative length and is within bounds of $b$, and that the segments in $\psi$ do not overlap.

% \subsubsection{Segmentations}
% A \emph{segmentation}, $\psi$, is a finite set of \emph{segments}. Segments consist of two natural numbers and a sort, i.e. segments are of the form $\segKind{m}{n}$ or $\segCon{m}{n}$ or $\segExp{m}{n}$ or $\segPat{m}{n}$.

% The metafunction $\segof{\ce}$ determines the segmentation of $\ce$ by generating one segment for each reference to a spliced term. More specifically:
% \begin{itemize}
% \item We define $\segof{\cekappa}$ as follows:
% \[\arraycolsep=1pt\begin{array}{rl}
%   \segof{\acekdarr{\cekappa_1}{u}{\cekappa_2}} & = \segof{\cekappa_1} \cup \segof{\cekappa_2}\\
%   \segof{\acekunit} & = \emptyset\\
%   \segof{\acekdbprod{\cekappa_1}{u}{\cekappa_2}} & = \segof{\cekappa_1} \cup \segof{\cekappa_2}\\
%   \segof{\acekty} & = \emptyset\\
%   \segof{\aceksing{\ctau}} & = \segof{\ctau}\\
%   \segof{\acesplicedk{m}{n}} & = \{ \segKind{m}{n} \}
% \end{array}\]
% \item We define $\segof{\cec}$ as follows:
% \[\arraycolsep=1pt\begin{array}{rl}
%   \segof{u} & = \emptyset\\
%   \segof{\acecabs{u}{\cec}} & = \segof{\cec}\\
%   \segof{\acecapp{\cec_1}{\cec_2}} & = \segof{\cec_1} \cup \segof{\cec_2}\\
%   \segof{\acectriv} & = \emptyset\\
%   \segof{\acecpair{\cec_1}{\cec_2}} & = \segof{\cec_1} \cup \segof{\cec_2}\\
%   \segof{\acecprl{\cec}} & = \segof{\cec}\\
%   \segof{\acecprr{\cec}} & = \segof{\cec}\\
%   \segof{\aceparr{\ctau_1}{\ctau_2}} & = \segof{\ctau_1} \cup \segof{\ctau_2}\\
%   \segof{\aceallu{u}{\cekappa}{\ctau}} &= \segof{\cekappa} \cup \segof{\ctau}\\
%   \segof{\acerec{t}{\ctau}} & = \segof{\ctau}\\
%   \segof{\aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\ctau_i}\\
%   \segof{\acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\ctau_i}\\
%   \segof{\acemcon{X}} & = \emptyset\\
%   \segof{\acesplicedc{m}{n}} & = \{ \segCon{m}{n} \}
%   \end{array}\]
% \item We define $\segof{\ce}$ as follows:
% \[\arraycolsep=1pt\begin{array}{rl} 

% \segof{x} & = \emptyset\\
% \segof{\acelam{\ctau}{x}{\ce}} & = \segof{\ctau} \cup \segof{\ce} \\
% \segof{\aceclam{\cekappa}{u}{\ce}} & = \segof{\cekappa} \cup \segof{\ce}\\
% \segof{\acecap{\ce}{\cec}} & = \segof{\cec} \cup \segof{\ce}\\
% \segof{\acefold{\ce}} & = \segof{\ce}\\
% \segof{\aceunfold{\ce}} & = \segof{\ce}\\
% \segof{\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\ce_i}\\
% \segof{\acepr{\ell}{\ce}} & = \segof{\ce}\\
% \segof{\acein{\ell}{\ce}} & = \segof{\ce}\\
% \segof{\acematchwith{n}{\ce}{\seqschemaX{\crv}}} & = \segof{\ce} \cup_{1 \leq i \leq n} \segof{\crv_i}\\
% \segof{\acemval{X}} & = \emptyset\\
% \segof{\acesplicede{m}{n}{\ctau}} & = \{ \segExp{m}{n} \} \cup \segof{\ctau}\\
% \end{array}\]
% \item We define $\segof{\crv}$ as follows:
% \[\arraycolsep=1pt\begin{array}{rl} 

% \segof{\acematchrule{p}{\ce}} & = \segof{\ce}
% \end{array}\]
% \end{itemize}

% The metafunction $\segof{\cpv}$ determines the segmentation of $\cpv$ by generating one segment for each reference to a spliced type or pattern:
% \[
% \arraycolsep=1pt\begin{array}{rl}

% \segof{\acewildp} & = \emptyset\\
% \segof{\acefoldp{\cpv}} & = \segof{\cpv}\\
% \segof{\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}} & = \cup_{i \in \labelset} \segof{\cpv_i}\\
% \segof{\aceinjp{\ell}{\cpv}} & = \segof{\cpv}\\
% \segof{\acesplicedp{m}{n}{\ctau}} & = \{ \segPat{m}{n} \} \cup \segof{\ctau}
% \end{array}
% \]

% The predicate $\segOK{\psi}{b}$ checks that each segment in $\psi$, has non-negative length and is within bounds of $b$, and that the segments in $\psi$ do not overlap.

\subsection{Deparameterization}
\begin{minipage}{0.42\textwidth}
\noindent\fbox{$\strut\prepce{\Omega_\text{app}}{\Psi}{\pce}{\ce}{\epsilon}{\rho}{\omega}{\Omega_\text{params}}$}\end{minipage}
\begin{minipage}{0.58\textwidth}
When applying peTSM $\epsilon$ at $\rho$, $\pce$ has deparameterization $\ce$ with parameter substitution $\omega$\end{minipage}
\begin{subequations}\label{rules:prepce}
\begin{equation}\label{rule:prepce-ceexp}
\inferrule{ }{
  \prepce{\Omega_\text{app}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\apceexp{\ce}}{\ce}{\adefref{a}}{\rho}{\emptyset}{\emptyset}
}
\end{equation}
\begin{equation}\label{rule:prepce-alltypes}
\inferrule{
  \prepce{\Omega_\text{app}}{\Psi}{\pce}{\ce}{\epsilon}{\aealltypes{t}{\rho}}{\omega}{\Omega}\\
  t \notin \domof{\Omega_\text{app}}
}{
  \prepce{\Omega_\text{app}}{\Psi}{\apcebindtype{t}{\pce}}{\ce}{\aeaptype{\tau}{\epsilon}}{\rho}{\omega, \tau/t}{\Omega, t :: \akty}
}
\end{equation}
\begin{equation}\label{rule:prepce-allmods}
\inferrule{
  \prepce{\Omega_\text{app}}{\Psi}{\pce}{\ce}{\epsilon}{\aeallmods{\sigma}{X}{\rho}}{\omega}{\Omega}\\
  X \notin \domof{\Omega_\text{app}}
}{
  \prepce{\Omega_\text{app}}{\Psi}{\apcebindmod{X}{\pce}}{\ce}{\aeapmod{X'}{\epsilon}}{\rho}{\omega, X'/X}{\Omega, X : \sigma}
}
\end{equation}
\end{subequations}

\noindent\begin{minipage}{0.42\textwidth}
\fbox{$\strut\prepcp{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon}{\rho}{\omega}{\Omega_\text{params}}$}\end{minipage}
\begin{minipage}{0.58\textwidth}
When applying ppTSM $\epsilon$ at $\rho$, $\pcp$ has deparameterization $\cpv$ with parameter substitution $\omega$\end{minipage}
\begin{subequations}\label{rules:prepcp}
\begin{equation}\label{rule:prepcp-cepat}
\inferrule{ }{
  \prepcp{\Omega_\text{app}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\apcepat{\cpv}}{\cpv}{\adefref{a}}{\rho}{\emptyset}{\emptyset}
}
\end{equation}
\begin{equation}\label{rule:prepcp-alltypes}
\inferrule{
  \prepcp{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon}{\aealltypes{t}{\rho}}{\omega}{\Omega}\\
  t \notin \domof{\Omega_\text{app}}
}{
  \prepcp{\Omega_\text{app}}{\Phi}{\apcebindtype{t}{\pcp}}{\cpv}{\aeaptype{\tau}{\epsilon}}{\rho}{\omega, \tau/t}{\Omega, t :: \akty}
}
\end{equation}
\begin{equation}\label{rule:prepcp-allmods}
\inferrule{
  \prepce{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon}{\aeallmods{\sigma}{X}{\rho}}{\omega}{\Omega}\\
  X \notin \domof{\Omega_\text{app}}
}{
  \prepcp{\Omega_\text{app}}{\Phi}{\apcebindmod{X}{\pcp}}{\cpv}{\aeapmod{X'}{\epsilon}}{\rho}{\omega, X'/X}{\Omega, X : \sigma}
}
\end{equation}
% \begin{equation}\label{rule:prepcp-ceexp}
% \inferrule{ }{
%   \prepcp{\Omega_\text{app}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\adefref{a}}{\rho}{\emptyset}{\emptyset}
% }
% \end{equation}
% \begin{equation}\label{rule:prepcp-alltypes}
% \inferrule{
%   \prepcp{\Omega_\text{app}}{\Phi}{\epsilon}{\aealltypes{t}{\rho}}{\omega}{\Omega}\\
%   t \notin \domof{\Omega_\text{app}}
% }{
%   \prepcp{\Omega_\text{app}}{\Phi}{\aeaptype{\tau}{\epsilon}}{\rho}{\omega, \tau/t}{\Omega, t :: \akty}
% }
% \end{equation}
% \begin{equation}\label{rule:prepcp-allmods}
% \inferrule{
%   \prepcp{\Omega_\text{app}}{\Phi}{\epsilon}{\aeallmods{\sigma}{X}{\rho}}{\omega}{\Omega}\\
%   X \notin \domof{\Omega_\text{app}}
% }{
%   \prepcp{\Omega_\text{app}}{\Phi}{\aeapmod{X'}{\epsilon}}{\rho}{\omega, X'/X}{\Omega, X : \sigma}
% }
% \end{equation}
\end{subequations}

\subsection{Proto-Expansion Validation}
\subsubsection{Splicing Scenes}
\emph{Expression splicing scenes}, $\escenev$, are of the form $\esceneP{\Omega}{\uOmega}{\uPsi}{\uPhi}{b}$, \emph{constructor splicing scenes}, $\cscenev$, are of the form $\csceneP{\Omega}{\uOmega}{b}$, and \emph{pattern splicing scenes}, $\pscenev$, are of the form $\psceneP{\uOmega}{\uPhi}{b}$. We write $\csfrom{\escenev}$ for the constructor splicing scene constructed by dropping the TSM contexts from $\escenev$:
\[\csfrom{\esceneP{\OParams}{\uOmega}{\uPsi}{\uPhi}{b}} = \csceneP{\OParams}{\uOmega}{b}\]

\subsubsection{Proto-Kind and Proto-Constructor Validation}
\noindent\fbox{$\strut\cvalidKX{\cekappa}{\kappa}$}~~$\cekappa$ has well-formed expansion $\kappa$
\begin{subequations}\label{rules:cvalidK}
\begin{equation}\label{rule:cvalidK-darr}
\inferrule{
  \cvalidKX{\cekappa_1}{\kappa_1}\\
  \cvalidK{\Omega, u :: \kappa_1}{\cscenev}{\cekappa_2}{\kappa_2}
}{
  \cvalidKX{\acekdarr{\cekappa_1}{u}{\cekappa_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cvalidK-unit}
\inferrule{ }{
  \cvalidKX{\acekunit}{\akunit}
}
\end{equation}
\begin{equation}\label{rule:cvalidK-dprod}
\inferrule{
  \cvalidKX{\cekappa_1}{\kappa_1}\\
  \cvalidK{\Omega, u :: \kappa_1}{\cscenev}{\cekappa_2}{\kappa_2}
}{
  \cvalidKX{\acekdbprod{\cekappa_1}{u}{\cekappa_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cvalidK-ty}
\inferrule{ }{
  \cvalidKX{\acekty}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cvalidK-sing}
\inferrule{
  \cvalidCX{\ctau}{\tau}{\akty}
}{
  \cvalidKX{\aceksing{\ctau}}{\aksing{\tau}}
}
\end{equation}
\begin{equation}\label{rule:cvalidK-spliced}
\inferrule{
  \parseUKind{\bsubseq{b}{m}{n}}{\ukappa}\\
  \kExpands{\uOmega}{\ukappa}{\kappa}\\\\
  \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
  \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
}{
  \cvalidK{\Omega}{\csceneP{\OParams}{\uOmega}{b}}{\acesplicedk{m}{n}}{\kappa}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\cvalidCX{\cec}{c}{\kappa}$}~~$\cec$ has expansion $c$ of kind $\kappa$
\begin{subequations}\label{rules:cvalidC}
\begin{equation}\label{rule:cvalidC-subsume}
\inferrule{
  \cvalidCX{\cec}{c}{\kappa_1}\\
  \ksubX{\kappa_1}{\kappa_2}
}{
  \cvalidCX{\cec}{c}{\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-var}
\inferrule{ }{\cvalidC{\Omega, {u} :: {\kappa}}{\cscenev}{u}{u}{\kappa}}
\end{equation}
\begin{equation}\label{rule:cvalidC-abs}
\inferrule{
  \cvalidC{\Omega, u :: \kappa_1}{\cscenev}{\cec_2}{c_2}{\kappa_2}
}{
  \cvalidCX{\acecabs{u}{\cec_2}}{\acabs{u}{c_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-app}
\inferrule{
  \cvalidCX{\cec_1}{c_1}{\akdarr{\kappa_2}{u}{\kappa}}\\
  \cvalidCX{\cec_2}{c_2}{\kappa_2}
}{
  \cvalidCX{\acecapp{\cec_1}{\cec_2}}{\acapp{c_1}{c_2}}{[c_1/u]\kappa}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-unit}
\inferrule{ }{
  \cvalidCX{\acectriv}{\actriv}{\akunit}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-pair}
\inferrule{
  \cvalidCX{\cec_1}{c_1}{\kappa_1}\\
  \cvalidCX{\cec_2}{c_2}{[c_1/u]\kappa_2}
}{
  \cvalidCX{\acecpair{\cec_1}{\cec_2}}{\acpair{c_1}{c_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-prl}
\inferrule{
  \cvalidCX{\cec}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \cvalidCX{\acecprl{\cec}}{\acprl{c}}{\kappa_1}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-prr}
\inferrule{
  \cvalidCX{\cec}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
}{
  \cvalidCX{\acecprr{\cec}}{\acprr{c}}{[\acprl{c}/u]\kappa_2}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-parr}
\inferrule{
  \cvalidCX{\ctau_1}{\tau_1}{\akty}\\
  \cvalidCX{\ctau_2}{\tau_2}{\akty}
}{
  \cvalidCX{\aceparr{\ctau_1}{\ctau_2}}{\aparr{\tau_1}{\tau_2}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-all}
\inferrule{
  \cvalidKX{\cekappa}{\kappa}\\
  \cvalidC{\Omega, u :: \kappa}{\cscenev}{\ctau}{\tau}{\akty}
}{
  \cvalidCX{\aceallu{\cekappa}{u}{\ctau}}{\aallu{\kappa}{u}{\tau}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-rec}
\inferrule{
  \cvalidC{\Omega, t :: \akty}{\cscenev}{\ctau}{\tau}{\akty}
}{
  \cvalidCX{\acerec{t}{\ctau}}{\arec{t}{\tau}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-prod}
\inferrule{
  \{\cvalidCX{\ctau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
}{
  \cvalidCX{\aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-sum}
\inferrule{
  \{\cvalidCX{\ctau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
}{
  \cvalidCX{\acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-sing}
\inferrule{
  \cvalidCX{\cec}{c}{\akty}
}{
  \cvalidCX{\cec}{c}{\aksing{c}}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-stat}
\inferrule{ }{
  \cvalidC{\Omega, X : {\asignature{\kappa}{u}{\tau}}}{\cscenev}{\acemcon{X}}{\amcon{X}}{\kappa}
}
\end{equation}
\begin{equation}\label{rule:cvalidC-spliced}
\inferrule{
  \cscenev=\csceneP{\OParams}{\uOmega}{b}\\
  \cvalidK{\OParams}{\cscenev}{\cekappa}{\kappa}\\
  \parseUCon{\bsubseq{b}{m}{n}}{\uc}\\
  \cExpands{\uOmega}{\uc}{c}{\kappa}\\\\
  \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
  \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
}{
  \cvalidC{\Omega}{\cscenev}{\acesplicedc{m}{n}{\cekappa}}{c}{\kappa}
}
\end{equation}
\end{subequations}
\subsubsection{Proto-Expression and Proto-Rule Validation}
% \begin{equation}
% \inferrule{
%   \ccanaX{\ctau}{\tau}{\akty}
% }{
%   \cvalidTP{\Omega}{\cscenev}{\ctau}{\tau}
% }
% \end{equation}
\noindent\fbox{$\strut\cvalidEPX{\ce}{e}{\tau}$}~~$\ce$ has expansion $e$ of type $\tau$
\begin{subequations}\label{rules:cvalidE-P}
\begin{equation}\label{rule:cvalidE-P-subsume}
  \inferrule{
    \cvalidEPX{\ce}{e}{\tau}\\
    \issubtypePX{\tau}{\tau'}
  }{
    \cvalidEPX{\ce}{e}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-var}
  \inferrule{ }{ 
    \cvalidEP{\Omega, \Ghyp{x}{\tau}}{\escenev}{x}{x}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-asc}
\inferrule{
  \cvalidC{\Omega}{\csfrom{\escenev}}{\ctau}{\tau}{\akty}\\
  \cvalidEP{\Omega}{\escenev}{\ce}{e}{\tau}
}{
  \cvalidEP{\Omega}{\escenev}{\aceasc{\ctau}{\ce}}{e}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidE-P-letsyn}
  \inferrule{
    \cvalidEP{\Omega}{\escenev}{\ce_1}{e_1}{\tau_1}\\
    \cvalidEP{\Omega, x : \tau_1}{\ce_2}{e_2}{\tau_2}
  }{
    \cvalidEP{\Omega}{\escenev}{\aceletsyn{x}{\ce_1}{\ce_2}}{
      \aeap{\aelam{\tau_1}{x}{e_2}}{e_1}
    }{\tau_2}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-lam}
  \inferrule{
    \cvalidC{\Omega}{\csfrom{\escenev}}{\ctau_1}{\tau_1}{\akty}\\
    \cvalidEP{\Omega, \Ghyp{x}{\tau_1}}{\escenev}{\ce}{e}{\tau_2}
  }{
    \cvalidEPX{\acelam{\ctau_1}{x}{\ce}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-ap}
  \inferrule{
    \cvalidEPX{\ce_1}{e_1}{\aparr{\tau_2}{\tau}}\\
    \cvalidEPX{\ce_2}{e_2}{\tau_2}
  }{
    \cvalidEPX{\aceap{\ce_1}{\ce_2}}{\aeap{e_1}{e_2}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-clam}
  \inferrule{
    \cvalidK{\Omega}{\csfrom{\escenev}}{\cekappa}{\kappa}\\
    \cvalidEP{\Omega, u :: \kappa}{\escenev}{\ce}{e}{\tau}
  }{
    \csynX{\aceclam{\cekappa}{u}{\ce}}{\aeclam{\kappa}{u}{e}}{\aallu{\kappa}{u}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-cap}
  \inferrule{
    \cvalidEPX{\ce}{e}{\aallu{\kappa}{u}{\tau}}\\
    \cvalidC{\Omega}{\csfrom{\escenev}}{\cec}{c}{\kappa}
  }{
    \cvalidEPX{\acecap{\ce}{\cec}}{\aecap{e}{c}}{[c/u]\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-fold}
  \inferrule{
    \cvalidEPX{\ce}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \cvalidEPX{\aceanafold{\ce}}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-unfold}
  \inferrule{
    \cvalidEPX{\ce}{e}{\arec{t}{\tau}}
  }{
    \cvalidEPX{\aceunfold{\ce}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-tpl}
  \inferrule{
    \tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\    
    \{\cvalidEPX{\ce_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \cvalidEPX{\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-pr}
  \inferrule{
    \cvalidEPX{\ce}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
  }{
    \cvalidEPX{\acepr{\ell}{\ce}}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-in}
  \inferrule{
    \asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}\\\\
    \cvalidEPX{\ce'}{e'}{\tau'}
  }{
    \cvalidEPX{\aceanain{\ell}{\ce'}}{\aein{\ell}{e'}}{\tau}
    %\left(\shortstack{$\Delta~\Gamma \vdash^{\escenev} $\\$\leadsto$\\$ \Leftarrow $\vspace{-1.2em}}\right)
    %\eanaX{\auanain{\ell}{\ue}}{\aein{\ell}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-match}
  \inferrule{
    % n > 0\\
    \cvalidEPX{\ce}{e}{\tau}\\
    \{\cvalidRP{\Omega}{\escenev}{\crv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
  }{
    \cvalidEPX{\acematchwithb{n}{\ce}{\seqschemaX{\crv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:cvalidE-P-mval}
\inferrule{ }{
  \cvalidEP{\Omega, X : \asignature{\kappa}{u}{\tau}}{\escenev}{\acemval{X}}{\amval{X}}{[\amcon{X}/u]\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidE-P-splicede}
\inferrule{
  \escenev = \esceneP{\OParams}{\uOmega}{\uPsi}{\uPhi}{b}\\
  \cvalidC{\OParams}{\csfrom{\escenev}}{\ctau}{\tau}{\akty}\\\\
  \parseUExp{\bsubseq{b}{m}{n}}{\ue}\\
  \expandsP{\uOmega}{\uPsi}{\uPhi}{\ue}{e}{\tau}\\\\
  \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
  \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
}{
  \cvalidEP{\Omega}{\escenev}{\acesplicede{m}{n}{\ctau}}{e}{\tau}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\cvalidRP{\Omega}{\escenev}{\crv}{r}{\tau}{\tau'}$}~~$\crv$ has expansion $r$ taking values of type $\tau$ to values of type $\tau'$
\begin{equation}\label{rule:cvalidR-P}
\inferrule{
  \patTypeP{\Omega'}{p}{\tau}\\
  \cvalidEP{\Gcons{\Omega}{\Omega'}}{\escenev}{\ce}{e}{\tau'}
}{
  \cvalidRP{\Omega}{\escenev}{\acematchrule{p}{\ce}}{\aematchrule{p}{e}}{\tau}{\tau'}
}
\end{equation}

\subsubsection{Proto-Pattern Validation}
\noindent\fbox{$\strut\cvalidPPE{\uOmega}{\pscenev}{\cpv}{p}{\tau}$}~~$\cpv$ has expansion $p$ matching against $\tau$ generating hypotheses $\uOmega$
\begin{subequations}\label{rules:cvalidPP}
\begin{equation}\label{rule:cvalidPP-wild}
\inferrule{ }{
  \cvalidPP{\uOmegaEx{\emptyset}{\emptyset}{\emptyset}{\emptyset}}{\pscenev}{\acewildp}{\aewildp}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidPP-fold}
\inferrule{
  \cvalidPP{\uOmega}{\pscenev}{\cpv}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \cvalidPP{\uOmega}{\pscenev}{\acefoldp{\cpv}}{\aefoldp{p}}{\arec{t}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:cvalidPP-tpl}
\inferrule{
  \cpv=\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}\\
  p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}\\\\
  \{\cvalidPP{\upctx_i}{\pscenev}{\cpv_i}{p_i}{\tau_i}\}_{i \in \labelset}
}{
  \cvalidPP{\GIconsi{i \in \labelset}{\uOmega_i}}{\pscenev}{\cpv}{p}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  %\cvalidPP{}{\cpv}{p}{}
%\left(\shortstack{$\vdash^{\pscenev} $\\$\leadsto$\\$ :~\dashVx^{\,\Gconsi{i \in \labelset}{\upctx_i}}$\vspace{-1.2em}}\right)
}
\end{equation}
\begin{equation}\label{rule:cvalidPP-in}
\inferrule{
  \cvalidPP{\uOmega}{\pscenev}{\cpv}{p}{\tau}
}{
  \cvalidPP{\uOmega}{\pscenev}{\aceinjp{\ell}{\cpv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}
\end{equation}
\begin{equation}\label{rule:cvalidPP-spliced}
\inferrule{
  \cvalidC{\OParams}{\csceneP{\OParams}{\uOmega}{b}}{\ctau}{\tau}{\akty}\\
  \parseUPat{\bsubseq{b}{m}{n}}{\upv}\\
  \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau}
}{
  \cvalidPP{\uOmega'}{\pscene{\uOmega}{\uPhi}{b}}{\acesplicedp{m}{n}{\ctau}}{p}{\tau}
}
\end{equation}
\end{subequations}


\section{Metatheory}\label{appendix:metatheory-P}
\subsection{TSM Expression Evaluation}
\begin{theorem}[peTSM Preservation]
\label{thm:peTSM-preservation}
If $\hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}$ and $\tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}$ then $\hastsmtypeExp{\Omega}{\Psi}{\epsilon'}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[peTSM Preservation (Multistep)]
\label{thm:peTSM-preservation-multistep}
If $\hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}$ and $\tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}$ then $\hastsmtypeExp{\Omega}{\Psi}{\epsilon'}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[peTSM Preservation (Evaluation)]
\label{thm:peTSM-preservation-evaluation}
If $\hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}$ and $\tsmexpEvalsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}$ then $\hastsmtypeExp{\Omega}{\Psi}{\epsilon'}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[ppTSM Preservation]
\label{thm:ppTSM-preservation}
If $\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}$ and $\tsmexpStepsPat{\Omega}{\Phi}{\epsilon}{\epsilon'}$ then $\hastsmtypePat{\Omega}{\Phi}{\epsilon'}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[ppTSM Preservation (Multistep)]
\label{thm:ppTSM-preservation-multistep}
If $\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}$ and $\tsmexpMultistepsPat{\Omega}{\Phi}{\epsilon}{\epsilon'}$ then $\hastsmtypePat{\Omega}{\Phi}{\epsilon'}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[ppTSM Preservation (Evaluation)]
\label{thm:ppTSM-preservation-evaluation}
If $\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}$ and $\tsmexpEvalsPat{\Omega}{\Phi}{\epsilon}{\epsilon'}$ then $\hastsmtypePat{\Omega}{\Phi}{\epsilon'}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[peTSM Progress]
\label{thm:peTSM-progress}
If $\hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}$ then either $\tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}$ for some $\epsilon'$ or $\tsmexpNormalExp{\Omega}{\Psi}{\epsilon}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[ppTSM Progress]
\label{thm:ppTSM-progress}
If $\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}$ then either $\tsmexpStepsPat{\Omega}{\Phi}{\epsilon}{\epsilon'}$ for some $\epsilon'$ or $\tsmexpNormalPat{\Omega}{\Phi}{\epsilon}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\subsection{Typed Expansion}
\subsubsection{Kinds and Constructors}
\begin{theorem}[Kind and Constructor Expansion]
\label{thm:kind-and-constructor-expansion-P}
~
\begin{enumerate}
\item If $\kExpands{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\ukappa}{\kappa}$ then $\iskind{\Omega}{\kappa}$.
\item If $\cExpands{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uc}{c}{\kappa}$ then $\haskind{\Omega}{c}{\kappa}$.
\end{enumerate}
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\subsubsection{TSM Types and Expressions}
\begin{theorem}[TSM Type Expansion]
\label{thm:tsm-type-expansion-P}
If $\tsmtyExpands{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\urho}{\rho}$ then $\istsmty{\Omega}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[peTSM Expression Expansion]
\label{thm:peTSM-expression-expansion}
If $\tsmexpExpandsExp{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uAS{\uA}{\Psi}}{\uepsilon}{\epsilon}{\rho}$ then $\hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\begin{theorem}[ppTSM Expression Expansion]
\label{thm:ppTSM-expression-expansion}
If $\tsmexpExpandsPat{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uAS{\uA}{\Phi}}{\uepsilon}{\epsilon}{\rho}$ then $\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}$.
\end{theorem}
\begin{proof}\todo{proof}\end{proof}

\subsubsection{Patterns}
\begin{lemma}[Pattern Deparameterization]
\label{lemma:pattern-deparameterization-P}
If $\prepcp{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon}{\rho}{\omega}{\Omega_\text{params}}$ and $\hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho'}$ then $\domof{\Omega_\text{app}} \cap \domof{\Omega_\text{params}} = \emptyset$ and $\hastypeP{\Omega_\text{app}}{\omega}{\Omega_\text{params}}$.
\end{lemma}
\begin{proof} By rule induction over Rules (\ref{rules:prepcp}).
\begin{byCases}
  \item[\text{(\ref{rule:prepcp-ceexp})}] We have:
    \begin{pfsteps*}
      \item $\omega=\emptyset$ \BY{assumption}
      \item $\Omega_\text{params}=\emptyset$ \BY{assumption}
      \item $\domof{\Omega_\text{app}} \cap \domof{\emptyset} = \emptyset$ \BY{definition}
      \item $\hastypeP{\Omega_\text{app}}{\emptyset}{\emptyset}$ \BY{definition}
    \end{pfsteps*}
    \resetpfcounter
  \item[\text{(\ref{rule:prepcp-alltypes})}] We have:
    \begin{pfsteps*}
      \item $\epsilon=\aeaptype{\tau}{\epsilon'}$ \BY{assumption}
      \item $\prepcp{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon'}{\aealltypes{t}{\rho}}{\omega'}{\Omega'}$ \BY{assumption} \pflabel{prepcp}
      \item $t \notin \domof{\Omega_\text{app}}$ \BY{assumption} \pflabel{notin}
      \item $\omega=\omega', \tau/t$ \BY{assumption}
      \item $\Omega_\text{params} = \Omega', t :: \akty$ \BY{assumption}
      \item $\domof{\Omega_\text{app}} \cap \domof{\Omega'} = \emptyset$ \BY{IH on \pfref{prepcp}} \pflabel{IH1}
      \item $\hastypeP{\Omega_\text{app}}{\omega'}{\Omega'}$ \BY{IH on \pfref{prepcp}} \pflabel{IH2}
      \item $\domof{\Omega_\text{app}} \cap \domof{\Omega', t :: \akty}$ \BY{\pfref{notin} and \pfref{IH2} and definition of finite set intersection}
      \item $\hastypeP{\Omega_\text{app}}{\omega', \tau/t}{\Omega', t :: \akty}$ \BY{\todo{definition of omega type} and \todo{assumption that epsilon is well-typed}}
    \end{pfsteps*}
  \item[\text{(\ref{rule:prepcp-allmods})}] \todo{this case is analagous}
\end{byCases}
\end{proof}

\begin{theorem}[Typed Pattern Expansion]\label{thm:typed-pattern-expansion-P} ~
\begin{enumerate}
  \item If $\pExpandsSP{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}}{\uPhi}{\upv}{p}{\tau}{\uOmegaEx{\uD'}{\uG'}{\uMctx'}{\Omega'}}$ then $\uMctx' = \emptyset$ and $\uD' = \emptyset$ and $\patTypePC{\Omega_\text{app}}{\Omega'}{p}{\tau}$.
  \item If $\cvalidPP{\uOmegaEx{\uD'}{\uG'}{\uMctx'}{\Omega'}}{\pscene{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}}{\uPhi}{b}}{\cpv}{p}{\tau}$ and $\domof{\Omega_\text{params}} \cap \domof{\Omega_\text{app}} = \emptyset$ then $\uMctx' = \emptyset$ and $\uD' = \emptyset$ and $\patTypePC{\Omega_\text{params} \cup \Omega_\text{app}}{\Omega'}{p}{\tau}$.
\end{enumerate}
\end{theorem}
\begin{proof} My mutual rule induction over Rules (\ref{rules:patExpandsP}) and Rules (\ref{rules:cvalidPP}).
\begin{enumerate}
\item In the following, let $\uOmega = \uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}$ and $\uOmega' = \uOmegaEx{\uD'}{\uG'}{\uMctx'}{\Omega'}$.
  \begin{byCases}
    \item[\text{(\ref{rule:patExpandsP-subsume}) \textbf{through} (\ref{rule:patExpandsP-in})}] These cases follow by applying the IH, part 1 and applying the corresponding pattern typing rule in Rules (\ref{rules:patTypeP}).

    \item[\text{(\ref{rule:patExpandsP-apuptsm})}] We have:
    \begin{pfsteps*}
    \item $\upv=\utsmap{\uepsilon}{b}$ \BY{assumption}
    \item $\uPhi=\uAS{\uA}{\Phi}$ \BY{assumption}
    \item $\tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aetype{\tau_\text{final}}}$ \BY{assumption}
    \item $\tsmexpEvalsPat{\Omega_\text{app}}{\Phi}{\epsilon}{\epsilon_\text{normal}}$ \BY{assumption}
    \item $\tsmdefof{\epsilon_\text{normal}}=a$ \BY{assumption}
    \item $\Phi = \Phi', \pptsmdefn{a}{\rho}{\eparse}$ \BY{assumption}
    \item $\encodeBody{b}{\ebody}$ \BY{assumption}
    \item $\evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}}$ \BY{assumption}
    \item $\decodeCEPat{\ecand}{\cpv}$ \BY{assumption}
    \item $\prepcp{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon}{\aetype{\tau_\text{proto}}}{\omega}{\Omega_\text{params}}$ \BY{assumption}
    \item $\cvalidPP{\uOmega'}{\psceneP{\uOmega}{\uPhi}{b}}{\cpv}{p}{\tau_\text{proto}}$ \BY{assumption}
    \item $\tau = [\omega]\tau_\text{proto}$ \BY{assumption}
    \item $\domof{\Omega_\text{params}} \cap \domof{\Omega_\text{app}} = \emptyset$ \BY{\todo{lemma}}
    \item $\hastypeP{\Omega_\text{app}}{\omega}{\Omega_\text{params}}$ \BY{\todo{lemma}}
    \item $\uMctx' = \emptyset$ \BY{\todo{IH part 2}}
    \item $\uD' = \emptyset$
    \item $\patTypePC{\Omega_\text{params} \cup \Omega_\text{app}}{\Omega'}{p}{\tau_\text{proto}}$
    \item $\patTypePC{\Omega_\text{app}}{\Omega'}{p}{[\omega]\tau_\text{proto}}$ \BY{\todo{substitution}}
    \end{pfsteps*}

    % \item[\text{(\ref{rule:patExpandsP-subsume})}] We have:
    %   \begin{pfsteps*}
    %   \item $\patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau'}$ \BY{assumption} \pflabel{patExpandsP}
    %   \item $\issubtypeP{\Omega}{\tau'}{\tau}$ \BY{assumption} \pflabel{issubtypeP}
    %   \item $\uMctx' = \emptyset$  \BY{IH, part 1 on \pfref{patExpandsP}}
    %   \item $\uD' = \emptyset$   \BY{IH, part 1 on \pfref{patExpandsP}}
    %   \item $\patTypeP{\Omega'}{p}{\tau'}$  \BY{IH, part 1 on \pfref{patExpandsP}}
    %   \item $\patTypeP{\Omega'}{p}{\tau}$ \BY{Rule (\ref{rule:patTypeP-subsume}) on \pfref{patExpandsP} and \pfref{issubtypeP}}
    %   \end{pfsteps*}
    %   \resetpfcounter
    % \item[\text{(\ref{rule:patExpandsP-var})}] We have:
    %   \begin{pfsteps*}
    %   \item $\upv=x$ \BY{assumption}
    %   \item $p=x$ \BY{assumption}
    %   \item $\uMctx' = \emptyset$ \BY{assumption}
    %   \item $\uD' = \emptyset$ \BY{assumption}
    %   \item $\Omega' = x : \tau$ \BY{assumption}
    %   \item $\patTypeP{\Omega'}{x}{\tau}$ \BY{Rule (\ref{rule:patTypeP-var})}
    %   \end{pfsteps*}
    %    \resetpfcounter
    % \item[\text{(\ref{rule:patExpandsP-wild})}] We have:
    %   \begin{pfsteps*}
    %   \item $\upv=\wildp$ \BY{assumption}
    %   \item $p = \aewildp$ \BY{assumption}
    %   \item $\uMctx' = \emptyset$ \BY{assumption}
    %   \item $\uD' = \emptyset$ \BY{assumption}
    %   \item $\Omega' = \emptyset$ \BY{assumption}
    %   \item $\patTypeP{\Omega'}{\aewildp}{\tau}$ \BY{Rule (\ref{rule:patTypeP-wild})}
    %   \end{pfsteps*}
    %   \resetpfcounter
    % \item[\text{(\ref{rule:patExpandsP-fold})}] We have:
    %   \begin{pfsteps*}
    %   \item $\upv = \foldp{\upv'}$ \BY{assumption}
    %   \item $p = \aefoldp{p'}$ \BY{assumption}
    %   \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
    %   \item $\patExpandsP{\uOmega'}{\uPhi}{\upv'}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption}\pflabel{patExpandsP}
    %   \item $\uMctx' = \emptyset$ \BY{IH, part 1 on \pfref{patExpandsP}}
    %   \item $\uD' = \emptyset$ \BY{IH, part 1 on \pfref{patExpandsP}}
    %   \item $\patTypeP{\Omega'}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{IH, part 1 on \pfref{patExpandsP}} \pflabel{patTypeP}
    %   \item $\patTypeP{\Omega'}{\aefoldp{p'}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:patTypeP-fold}) on \pfref{patTypeP}}
    %   \end{pfsteps*}
    %   \resetpfcounter
  \end{byCases}
\item We induct on the premise. In the following, let $\upctx=\uGG{\uG}{\pctx}$ and $\uPhi=\uASI{\uA}{\Phi}{\uI}$.
  \begin{byCases}
    \item[\text{(\ref{rule:cvalidP-B-wild}) through (\ref{rule:cvalidP-B-spliced})}] In each case, the proof is written identically to the proof of the corresponding case in the proof of Theorem \ref{thm:typed-pattern-expansion}.
  \end{byCases}
\end{enumerate}
The mutual induction can be shown to be well-founded by showing that the following numeric metric on the judgements that we induct on is decreasing:
\begin{align*}
\sizeof{\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}} & = \sizeof{\upv}\\
\sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}}} & = \sizeof{b}
\end{align*}
where $\sizeof{b}$ is the length of $b$ and $\sizeof{\upv}$ is the sum of the lengths of the literal bodies in $\upv$,
\begin{align*}
\sizeof{\ux} & = 0\\
\sizeof{\aufoldp{\upv}} & = \sizeof{\upv}\\
\sizeof{\autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}} & = \sum_{i \in \labelset} \sizeof{\upv_i}\\
\sizeof{\auinjp{\ell}{\upv}} & = \sizeof{\upv}\\
\sizeof{\auapuptsm{b}{\tsmv}} & = \sizeof{b}\\
\sizeof{\auplit{b}} & = \sizeof{b}
\end{align*}

The only case in the proof of part 1 that invokes part 2 are Case (\ref{rule:patExpands-B-apuptsm}) and (\ref{rule:patExpands-B-lit}). There, we have that the metric remains stable: \begin{align*}
 & \sizeof{\patExpands{\upctx}{\uPhi, \uShyp{\tsmv}{a}{\tau}{\eparse}}{\auapuptsm{b}{\tsmv}}{p}{\tau}}\\
=& \sizeof{\patExpands{\upctx}{\uASI{\uA}{\Phi', \xuptsmbnd{a}{\tau}{\eparse}}{\uI', \designate{\tau}{a}}}{\auplit{b}}{p}{\tau}}\\
=& \sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi, \uShyp{\tsmv}{a}{\tau}{\eparse}}{b}}{\cpv}{p}{\tau}}}\\
=&\sizeof{b}\end{align*}

The only case in the proof of part 2 that invokes part 1 is Case (\ref{rule:cvalidP-B-spliced}). There, we have that $\parseUPat{\bsubseq{b}{m}{n}}{\upv}$ and the IH is applied to the judgement $\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}$. Because the metric is stable when passing from part 1 to part 2, we must have that it is strictly decreasing in the other direction:
\[\sizeof{\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}} < \sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\acesplicedp{m}{n}{\ctau}}{p}{\tau}}}\]
i.e. by the definitions above, 
\[\sizeof{\upv} < \sizeof{b}\]

This is established by appeal to Condition \ref{condition:body-subsequences}, which states that subsequences of $b$ are no longer than $b$, and the following condition, which states that an unexpanded pattern constructed by parsing a textual sequence $b$ is strictly smaller, as measured by the metric defined above, than the length of $b$, because some characters must necessarily be used to delimit each literal body.
% \begin{condition}[Pattern Parsing Monotonicity]\label{condition:pattern-parsing-B} If $\parseUPat{b}{\upv}$ then $\sizeof{\upv} < \sizeof{b}$.\end{condition}

Combining Conditions \ref{condition:body-subsequences} and \ref{condition:pattern-parsing-B}, we have that $\sizeof{\ue} < \sizeof{b}$ as needed.
\end{proof}
\subsubsection{Expressions and Rules}
\begin{theorem}[Typed Expression and Rule Expansion]
\label{thm:typed-expression-expansion-P}
~
\begin{enumerate}
\item \begin{enumerate}
  \item If $\expandsP{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ then $\hastypeP{\Omega}{e}{\tau}$.
  \item If $\rExpandsSP{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$ then $\ruleTypeP{\Omega}{r}{\tau}{\tau'}$.
  \end{enumerate}
\item \begin{enumerate}
  \item If $\cvalidEP{\Omega_\text{params}}{\esceneP{\OParams}{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ and $\domof{\Omega_\text{params}} \cap \domof{\Omega_\text{app}} = \emptyset$ then $\hastypeP{\Omega_\text{params} \cup \Omega_\text{app}}{e}{\tau}$.
  \item If $\cvalidRP{\Omega_\text{params}}{\esceneP{\OParams}{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}}{\uPsi}{\uPhi}{b}}{\crv}{r}{\tau}{\tau'}$ and $\domof{\Omega_\text{params}} \cap \domof{\Omega_\text{app}} = \emptyset$ then $\ruleTypeP{\Omega_\text{params} \cup \Omega_\text{app}}{r}{\tau}{\tau'}$.
  \end{enumerate}
\end{enumerate}
\end{theorem}
\begin{proof} \todo{proof} \end{proof}

\subsubsection{Signatures and Modules}
\begin{theorem}[Signature Expansion]
\label{thm:signature-expansion-P}
If $\sigExpandsP{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\usigma}{\sigma}$ then $\issig{\Omega}{\sigma}$.
\end{theorem}
\begin{proof} \todo{proof} \end{proof}

\begin{theorem}[Module Expansion]
\label{thm:module-expansion-P}
If $\mExpandsP{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uPsi}{\uPhi}{\uM}{M}{\sigma}$ then $\hassig{\Omega}{M}{\sigma}$.
\end{theorem}
\begin{proof} \todo{proof} \end{proof}

\subsection{Reasoning Principles}

\begin{theorem}[peTSM Segmentation, Context Independence and Typing]
\label{thm:petsm-reasoning-principles}
If $\expandsP{\uOmega}{\uPsi}{\uPhi}{\utsmap{\uepsilon}{b}}{e}{\tau}$ then:
\begin{enumerate}
  \item $\uOmega = \uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}$
  \item $\uPsi=\uAS{\uA}{\Psi}$
  \item $\tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\aetype{\tau_\text{final}}}$
  \item $\tsmexpEvalsExp{\Omega_\text{app}}{\Psi}{\epsilon}{\epsilon_\text{normal}}$
  \item $\tsmdefof{\epsilon_\text{normal}}=a$
  \item $\Psi = \Psi', \petsmdefn{a}{\rho}{\eparse}$
  \item $\encodeBody{b}{\ebody}$
  \item $\evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessE}}\cdot{e_\text{pproto}}}$
  \item $\decodePCEExp{e_\text{pproto}}{\pce}$
  \item $\prepce{\Omega_\text{app}}{\Psi}{\pce}{\ce}{\epsilon_\text{normal}}{\aetype{\tau_\text{proto}}}{\omega}{\Omega_\text{params}}$
  \item (\textbf{Segmentation}) $\segOK{\segof{\ce}}{b}$
  \item $\cvalidEP{\Omega_\text{params}}{\esceneP{\OParams}{\uOmega}{\uPsi}{\uPhi}{b}}{\ce}{e'}{\tau_\text{proto}}$
  \item $e = [\omega]e'$
  \item $\tau = [\omega]\tau_\text{proto}$
  \item (\textbf{Context Independence}) $\domof{\Omega_\text{app}} \cap \domof{\Omega_\text{params}} = \emptyset$
  \item (\textbf{Typing}) $\tau_\text{final} = [\omega]\tau_\text{proto}$
\end{enumerate}
\end{theorem}
\begin{proof} \todo{proof} \end{proof}

Similarly, ppTSM application is guaranteed to produce a segmentation of the literal body and respect the type annotation on the ppTSM definition.
\begin{theorem}[ppTSM Segmentation and Typing]
\label{thm:pptsm-reasoning-principles}
If $\patExpandsP{\uOmega'}{\uPhi}{\utsmap{\uepsilon}{b}}{p}{\tau}$ then:
\begin{enumerate}
  \item $\uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}$
  \item $\uPhi=\uAS{\uA}{\Phi}$
  \item $\tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aetype{\tau_\text{final}}}$
  \item $\tsmexpEvalsPat{\Omega_\text{app}}{\Phi}{\epsilon}{\epsilon_\text{normal}}$
  \item $\tsmdefof{\epsilon_\text{normal}}=a$
  \item $\Phi = \Phi', \pptsmdefn{a}{\rho}{\eparse}$
  \item $\encodeBody{b}{\ebody}$
  \item $\evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}}$
  \item $\decodeCEPat{\ecand}{\cpv}$
  \item $\prepcp{\Omega_\text{app}}{\Phi}{\pcp}{\cpv}{\epsilon_\text{normal}}{\aetype{\tau_\text{proto}}}{\omega}{\Omega_\text{params}}$
  \item (\textbf{Segmentation}) $\segOK{\segof{\cpv}}{b}$
  \item $\cvalidPP{\uOmega'}{\psceneP{\uOmega}{\uPhi}{b}}{\cpv}{p}{\tau_\text{proto}}$
  \item $\tau = [\omega]\tau_\text{proto}$
  \item (\textbf{Typing}) $\tau_\text{final} = [\omega]\tau_\text{proto}$
\end{enumerate}
\end{theorem}
\begin{proof} \todo{proof} \end{proof}

Spliced terms have access only to the bindings at the application site.
\begingroup
\begin{theorem}[peTSM Shadowing Prohibition]
\label{thm:petsm-shadowing-prohibition}
~
\begin{enumerate}
\item If $\cvalidK{\Omega}{\csceneP{\OParams}{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}}{b}}{\acesplicedk{m}{n}}{\kappa}$ then:
  \begin{enumerate}
    \item $\parseUKind{\bsubseq{b}{m}{n}}{\ukappa}$
    \item $\kExpands{\uOmega}{\ukappa}{\kappa}$
    \item $\domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset$
  \end{enumerate}
\item If $\cvalidC{\Omega}{\csceneP{\OParams}{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}}{b}}{\acesplicedc{m}{n}{\cekappa}}{c}{\kappa}$ then:
  \begin{enumerate}
    \item $\parseUCon{\bsubseq{b}{m}{n}}{\uc}$
    \item $\cExpands{\uOmega}{\uc}{c}{\kappa}$
    \item $\domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset$
  \end{enumerate}
\item If $\cvalidEP{\Omega}{\esceneP{\OParams}{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}}{\uPsi}{\uPhi}{b}}{\acesplicede{m}{n}{\ctau}}{e}{\tau}$ then:\todo{revise this}
  \begin{enumerate}
    \item $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$
    \item $\expandsP{\uOmega}{\uPsi}{\uPhi}{\ue}{e}{\tau}$
    \item $\domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset$
  \end{enumerate}
\end{enumerate}
\end{theorem}
\begin{proof} \todo{proof} \end{proof}

\chapter{Bidirectional $\miniVersePat$}\label{appendix:simple-implicits}

\section{Expanded Language (XL)}
The Bidirectional $\miniVersePat$ expanded language (XL) is the same as the  $\miniVersePat$ XL, which was detailed in Appendix \ref{appendix:SES-XL}. %It consists of types, $\tau$, expanded expressions, $e$, expanded rules, $r$, and expanded patterns, $p$.

\section{Unexpanded Language (UL)}
\subsection{Syntax}
\subsubsection{Stylized Syntax}
The stylized syntax extends the stylized syntax of the $\miniVersePat$ UL given in Sec. \ref{appendix:SES-syntax}.

\[\begin{array}{lllllll}
\textbf{Sort} & & 
%& \textbf{Operational Form} 
& \textbf{Stylized Form} & \textbf{Description}\\
\mathsf{UTyp} & \utau & ::= 
%& \cdots 
& \cdots & \text{(as in $\miniVersePat$)}\\
\mathsf{UExp} & \ue & ::= 
%& \cdots 
& \cdots & \text{(as in $\miniVersePat$)}\\
% &&
%& \auasc{\utau}{\ue} 
% & \asc{\ue}{\utau} & \text{ascription}\\
% &&
%& \auletsyn{\ux}{\ue}{\ue} 
% & \letsyn{\ux}{\ue}{\ue} & \text{value binding}\\
&&& \implicite{\tsmv}{\ue} & \text{seTSM designation}\\
&&& \implicitp{\tsmv}{\ue} & \text{spTSM designation}\\
&&& \lit{b} & \text{seTSM unadorned literal}\\
% &&& \auanalam{\ux}{\ue} & \analam{\ux}{\ue} & \text{abstraction (unannotated)}\\
% &&& \aulam{\utau}{\ux}{\ue} & \lam{\ux}{\utau}{\ue} & \text{abstraction (annotated)}\\
% &&& \auap{\ue}{\ue} & \ap{\ue}{\ue} & \text{application}\\
% &&& \autlam{\ut}{\ue} & \Lam{\ut}{\ue} & \text{type abstraction}\\
% &&& \autap{\ue}{\utau} & \App{\ue}{\utau} & \text{type application}\\
% &&& \auanafold{\ue} & \fold{\ue} & \text{fold}\\
% &&& \auunfold{\ue} & \unfold{\ue} & \text{unfold}\\
% &&& \autpl{\labelset}{\mapschema{\ue}{i}{\labelset}} & \tpl{\mapschema{\ue}{i}{\labelset}} & \text{labeled tuple}\\
% &&& \aupr{\ell}{\ue} & \prj{\ue}{\ell} & \text{projection}\\
% &&& \auanain{\ell}{\ue} & \inj{\ell}{\ue} & \text{injection}\\
% &&& \aumatchwithb{n}{\ue}{\seqschemaX{\urv}} & \matchwith{\ue}{\seqschemaX{\urv}} & \text{match}\\
% &&& \audefuetsm{\utau}{e}{\tsmv}{\ue} & \texttt{syntax}~\tsmv~\texttt{at}~\utau~\texttt{for} & \text{ueTSM definition}\\
% &&&                                    & \texttt{expressions}~\{e\}~\texttt{in}~\ue\\
% \LCC &&& \lightgray & \lightgray & \lightgray \\
% &&& \auimplicite{\tsmv}{\ue} & \texttt{implicit\,syntax}~\tsmv~\texttt{for} & \text{ueTSM designation}\\
% &&&                          & \texttt{expressions\,in}~\ue\\ \ECC
% &&& \autsmap{b}{\tsmv} & \utsmap{\tsmv}{b} & \text{ueTSM application}\\%\ECC
% \LCC &&& \lightgray & \lightgray & \lightgray \\
% &&& \auelit{b} & {\lit{b}}  & \text{ueTSM unadorned literal}\\\ECC
% &&& \audefuptsm{\utau}{e}{\tsmv}{\ue} & \texttt{syntax}~\tsmv~\texttt{at}~\utau~\texttt{for} & \text{upTSM definition}\\
% &&&                                    & \texttt{patterns}~\{e\}~\texttt{in}~\ue\\
% \LCC &&& \lightgray & \lightgray & \lightgray \\
% &&& \auimplicitp{\tsmv}{\ue} & \texttt{implicit\,syntax}~\tsmv~\texttt{for} & \text{upTSM designation}\\
% &&&                          & \texttt{patterns\,in}~\ue\\ \ECC
\mathsf{URule} & \urv & ::= 
%& \aumatchrule{\upv}{\ue} 
& \cdots & \text{(as in $\miniVersePat$)}\\
\mathsf{UPat} & \upv & ::= 
%& \ux 
& \cdots & \text{(as in $\miniVersePat$)}\\
&&& \lit{b} & \text{spTSM unadorned literal}
% &&& \auwildp & \wildp & \text{wildcard pattern}\\
% &&& \aufoldp{\upv} & \foldp{\upv} & \text{fold pattern}\\
% &&& \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}} & \tplp{\mapschema{\upv}{i}{\labelset}} & \text{labeled tuple pattern}\\
% &&& \auinjp{\ell}{\upv} & \injp{\ell}{\upv} & \text{injection pattern}\\
% &&& \auapuptsm{b}{\tsmv} & \utsmap{\tsmv}{b} & \text{upTSM application}\\
% \LCC &&& \lightgray & \lightgray & \lightgray\\
% &&& \auplit{b} & \lit{b} & \text{upTSM unadorned literal}\ECC
\end{array}\]
\subsubsection{Body Lengths}
We write $\sizeof{b}$ for the length of $b$. The metafunction $\sizeof{\ue}$ computes the sum of the lengths of expression literal bodies in $\ue$. It is defined by extending the definition given in Sec. \ref{appendix:SES-syntax} with the following additional cases:
\[
\begin{array}{ll}
% \sizeof{\asc{\ue}{\utau}} & = \sizeof{\ue}\\
% \sizeof{\letsyn{\ux}{\ue_1}{\ue_2}} & = \sizeof{\ue_1} + \sizeof{\ue_2}\\
\sizeof{\implicite{\tsmv}{\ue}} & = \sizeof{\ue}\\
\sizeof{\implicitp{\tsmv}{\ue}} & = \sizeof{\ue}\\
\sizeof{\lit{b}} & = \sizeof{b}
\end{array}
\]

Similarly, the metafunction $\sizeof{\upv}$ computes the sum of the lengths of the pattern literal bodies in $\upv$. It is defined by extending the definition given in Sec. \ref{appendix:SES-syntax} with the following additional case:
\begin{align*}
\sizeof{\lit{b}} & = \sizeof{b}
\end{align*}

\subsubsection{Textual Syntax}
In addition to the stylized syntax, there is also a context-free textual syntax for the UL. We need only posit the existence of the following partial metafunctions.

\begin{condition}[Textual Representability]\label{condition:textual-representability-BS} ~
\begin{enumerate}
\item For each $\utau$, there exists $b$ such that $\parseUTyp{b}{\utau}$. 
\item For each $\ue$, there exists $b$ such that $\parseUExp{b}{\ue}$.
% \item For each $\urv$, there exists $b$ such that $\parseURule{b}{\urv}$.
\item {For each $\upv$, there exists $b$ such that $\parseUPat{b}{\upv}$.}
\end{enumerate}
\end{condition}

We also impose the following technical conditions.

\begin{condition}[Expression Parsing Monotonicity]\label{condition:body-parsing-BS} If $\parseUExp{b}{\ue}$ then $\sizeof{\ue} < \sizeof{b}$.\end{condition}

\begin{condition}[Pattern Parsing Monotonicity]\label{condition:pattern-parsing-BS} If $\parseUPat{b}{\upv}$ then $\sizeof{\upv} < \sizeof{b}$.\end{condition}

\subsection{Bidirectionally Typed Expansion}
\subsubsection{Contexts}
\emph{Unexpanded type formation contexts}, $\uDelta$, and \emph{unexpanded typing contexts}, $\uGamma$, were defined in Sec. \ref{appendix:typed-expression-expansion-S}.

\subsubsection{Body Encoding and Decoding}
The type $\tBody$ and the judgements $\encodeBody{b}{e}$ and $\decodeBody{e}{b}$ are characterized in Sec. \ref{appendix:typed-expression-expansion-S}.

\subsubsection{Parse Results}
The types $\tParseResultExp$ and $\tParseResultPat$ are defined as in Sec. \ref{appendix:typed-expression-expansion-S}.

\subsubsection{TSM Contexts}

\emph{seTSM contexts}, $\uPsi$, are of the form $\uASI{\uA}{\Psi}{\uI}$, where $\uA$ is a \emph{TSM identifier expansion context}, $\Psi$ is a \emph{seTSM definition context} and $\uI$ is a \emph{TSM implicit designation context}.

\emph{spTSM contexts}, $\uPhi$, are of the form $\uASI{\uA}{\Phi}{\uI}$, where $\uA$ is a {TSM identifier expansion context}, defined above, and $\Phi$ is a \emph{spTSM definition context}. 

A \emph{TSM identifier expansion context}, $\uA$, is a finite function mapping each TSM identifier $\tsmv \in \domof{\uA}$ to the \emph{TSM identifier expansion}, $\vExpands{\tsmv}{a}$, for some \emph{TSM name}, $a$. We write $\ctxUpdate{\uA}{\tsmv}{a}$ for the TSM identifier expansion context that maps $\tsmv$ to $\vExpands{\tsmv}{a}$, and defers to $\uA$ for all other TSM identifiers (i.e. the previous mapping is \emph{updated}.)

An \emph{seTSM definition context}, $\Psi$, is a finite function mapping each TSM name $a \in \domof{\Psi}$ to an \emph{expanded seTSM definition}, $\xuetsmbnd{a}{\tau}{\eparse}$, where $\tau$ is the seTSM's type annotation, and $\eparse$ is its parse function. We write $\Psi, \xuetsmbnd{a}{\tau}{\eparse}$ when $a \notin \domof{\Psi}$ for the extension of $\Psi$ that maps $a$ to $\xuetsmbnd{a}{\tau}{\eparse}$. We write $\uetsmenv{\Delta}{\Psi}$  when all the type annotations in $\Psi$ are well-formed assuming $\Delta$, and the parse functions in $\Psi$ are closed and of the appropriate type.

\begin{definition}[seTSM Definition Context Formation]\label{def:seTSM-def-ctx-formation} $\uetsmenv{\Delta}{\Psi}$ iff for each $\xuetsmbnd{a}{\tau}{\eparse} \in \Psi$, we have $\istypeU{\Delta}{\tau}$ and $\hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}}$.\end{definition}

An \emph{spTSM definition context}, $\Phi$, is a finite function mapping each TSM name $a \in \domof{\Phi}$ to an \emph{expanded seTSM definition}, $\xuptsmbnd{a}{\tau}{\eparse}$, where $\tau$ is the spTSM's type annotation, and $\eparse$ is its parse function. We write $\Phi, \xuptsmbnd{a}{\tau}{\eparse}$ when $a \notin \domof{\Phi}$ for the extension of $\Phi$ that maps $a$ to $\xuptsmbnd{a}{\tau}{\eparse}$. We write $\uptsmenv{\Delta}{\Phi}$  when all the type annotations in $\Phi$ are well-formed assuming $\Delta$, and the parse functions in $\Phi$ are closed and of the appropriate type.

\begin{definition}[spTSM Definition Context Formation]\label{def:spTSM-def-ctx-formation} $\uptsmenv{\Delta}{\Phi}$ iff for each $\xuptsmbnd{a}{\tau}{\eparse} \in \Phi$, we have $\istypeU{\Delta}{\tau}$ and $\hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPat}}$.\end{definition}

A \emph{TSM implicit designation context}, $\uI$, is a finite function that maps each type $\tau \in \domof{\uI}$ to the \emph{TSM designation} $\designate{\tau}{a}$, for some TSM name $a$. We write $\uI \uplus \designate{\tau}{a}$ for the TSM implicit designation context that maps $\tau$ to $\designate{\tau}{a}$ and defers to $\uI$ for all other types (i.e. the previous designation, if any, is updated.)

\begin{definition}[TSM Implicit Designation Context Formation]\label{def:implicit-designation-ctx-formation-S} $\uIOK{\Delta}{\uI}$ iff for each $\designate{\tau}{a} \in \uI$, we have $\istypeU{\Delta}{\tau}$.
\end{definition}

\begin{definition}[seTSM Context Formation] $\uetsmctx{\Delta}{\uASI{\uA}{\Psi}{\uI}}$ iff
\begin{enumerate}
\item $\uetsmenv{\Delta}{\Psi}$; and
\item for each $\vExpands{\tsmv}{a} \in \uA$ we have $a \in \domof{\Psi}$; and
\item $\uIOK{\Delta}{\uI}$; and
\item for each $\designate{\tau}{a} \in \uI$, we have $a \in \domof{\Psi}$.
\end{enumerate}
\end{definition}

\begin{definition}[spTSM Context Formation] $\uptsmctx{\Delta}{\uASI{\uA}{\Phi}{\uI}}$ iff 
\begin{enumerate}
\item $\uptsmenv{\Delta}{\Phi}$; and
\item for each $\vExpands{\tsmv}{a} \in \uA$ we have $a \in \domof{\Phi}$; and
\item $\uIOK{\Delta}{\uI}$; and
\item for each $\designate{\tau}{a} \in \uI$ we have $a \in \domof{\Phi}$.
\end{enumerate}
\end{definition}

We define $\uPsi, \uShyp{\tsmv}{a}{\tau}{\eparse}$, when $\uPsi=\uASI{\uA}{\Phi}{\uI}$, as an abbreviation of \[\uASI{\ctxUpdate{\uA}{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}\]
%\vspace{10px}

We define $\uPhi, \uPhyp{\tsmv}{a}{\tau}{\eparse}$, when $\uPhi=\uASI{\uA}{\Phi}{\uI}$, as an abbreviation of \[\uASI{\ctxUpdate{\uA}{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI}\]

\subsubsection{Type Expansion}
The \emph{type expansion judgement}, $\expandsTU{\uDelta}{\utau}{\tau}$, is inductively defined as in $\miniVersePat$ by Rules (\ref{rules:expandsTU}).

\subsubsection{Bidirectionally Typed Expression and Rule Expansion}
\noindent\fbox{$\esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$}~~$\ue$ has expansion $e$ synthesizing type $\tau$

\begin{subequations}\label{rules:esyn-S}
\begin{equation}\label{rule:esyn-S-var}
  \inferrule{ }{ 
    \esyn{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ux}{x}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-asc}
  \inferrule{
    \expandsTU{\uDelta}{\utau}{\tau}\\
    \eanaX{\ue}{e}{\tau}
  }{
    \esynX{\asc{\ue}{\utau}}{e}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-let}
  \inferrule{
    \esynX{\ue}{e}{\tau}\\
    \esyn{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ue'}{e'}{\tau'}
  }{
    \esynX{\letsyn{\ux}{\ue}{\ue'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-lam}
  \inferrule{
    \expandsTU{\uDelta}{\utau_1}{\tau_1}\\
    \esyn{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue}{e}{\tau_2}
  }{
    \esynX{\lam{\ux}{\utau_1}{\ue}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-ap}
  \inferrule{
    \esynX{\ue_1}{e_1}{\aparr{\tau_2}{\tau}}\\
    \eanaX{\ue_2}{e_2}{\tau_2}
  }{
    \esynX{\ap{\ue_1}{\ue_2}}{\aeap{e_1}{e_2}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-tlam}
  \inferrule{
    \esyn{\uDelta, \uDhyp{\ut}{t}}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}
  }{
    \esynX{\Lam{\ut}{\ue}}{\aetlam{t}{e}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-tap}
  \inferrule{
    \esynX{\ue}{e}{\aall{t}{\tau}}\\
    \expandsTU{\uDelta}{\utau'}{\tau'}
  }{
    \esynX{\App{\ue}{\utau'}}{\aetap{e}{\tau'}}{[\tau'/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-unfold}
  \inferrule{
    \esynX{\ue}{e}{\arec{t}{\tau}}
  }{
    \esynX{\unfold{\ue}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-tpl}
  \inferrule{
    \{\esynX{\ue_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \esynX{\tpl{\mapschema{\ue}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-pr}
  \inferrule{
    \esynX{\ue}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
  }{
    \esynX{\prj{\ue}{\ell}}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:esyn-defuetsm}
\inferrule{
  \expandsTU{\uDelta}{\utau}{\tau}\\
  \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}}\\\\
  \evalU{\eparse}{\eparse'}\\
  \esyn{\uDelta}{\uGamma}{\uPsi, \uShyp{\tsmv}{a}{\tau}{\eparse'}}{\uPhi}{\ue}{e}{\tau'}
}{
  \esynX{\usyntaxueP{\tsmv}{\utau}{\eparse}{\ue}}{e}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:esyn-S-apuetsm}
\inferrule{
  \uPsi = \uPsi', \uShyp{\tsmv}{a}{\tau}{\eparse}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{\lbltxt{SuccessE}\cdot\ecand}\\
  \decodeCondE{\ecand}{\ce}\\\\
    \segOK{\segof{\ce}}{b}\\
  \cana{\emptyset}{\emptyset}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}
}{
  \esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\utsmap{\tsmv}{b}}{e}{\tau}
}
\end{equation}
\begin{equation}\label{rule:esyn-S-implicite}
  \inferrule{
    \uPsi = \uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}\\\\
    \esyn{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\ue}{e}{\tau'}
  }{
    \esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\implicite{\tsmv}{\ue}}{e}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:esyn-S-defuptsm}
\inferrule{
  \expandsTU{\uDelta}{\utau}{\tau}\\
  \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPat}}\\\\
  \evalU{\eparse}{\eparse'}\\
  \esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi, \uPhyp{\tsmv}{a}{\tau}{\eparse'}}{\ue}{e}{\tau'}
}{
  \esynX{\usyntaxup{\tsmv}{\utau}{\eparse}{\ue}}{e}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:esyn-S-implicitp}
  \inferrule{
    \uPhi = \uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI}\\\\
    \esyn{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau'}
  }{
    \esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\implicitp{\tsmv}{\ue}}{e}{\tau'}
  }
\end{equation}
\end{subequations}

\noindent\fbox{$\eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$}~~$\ue$ has expansion $e$ when analyzed against type $\tau$

\begin{subequations}\label{rules:eana-S}
\begin{equation}\label{rule:eana-S-subsume}
  \inferrule{
    \esynX{\ue}{e}{\tau}
  }{
    \eanaX{\ue}{e}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-let}
  \inferrule{
    \esynX{\ue}{e}{\tau}\\
    \eana{\uDelta}{\uGamma, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ue'}{e'}{\tau'}
  }{
    \eanaX{\letsyn{\ux}{\ue}{\ue'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-tlam}
  \inferrule{
    \eana{\uDelta, \uDhyp{\ut}{t}}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}
  }{
    \eanaX{\Lam{\ut}{\ue}}{\aetlam{t}{e}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-fold}
  \inferrule{
    \eanaX{\ue}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \eanaX{\fold{\ue}}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-tpl}
  \inferrule{
    \{\eanaX{\ue_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \eanaX{\tpl{\mapschema{\ue}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-in}
  \inferrule{
    \eanaX{\ue}{e}{\tau'}
  }{
    \eanaX{\inj{\ell}{\ue}}{\aein{\ell}{e}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-match}
  \inferrule{
    \esynX{\ue}{e}{\tau}\\
    \{\ranaX{\urv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
  }{
    \eanaX{\matchwith{\ue}{\seqschemaX{\urv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-defuetsm}
\inferrule{
  \expandsTU{\uDelta}{\utau}{\tau}\\
  \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}}\\\\
  \evalU{\eparse}{\eparse'}\\
  \eana{\uDelta}{\uGamma}{\uPsi, \uShyp{\tsmv}{a}{\tau}{\eparse'}}{\uPhi}{\ue}{e}{\tau'}
}{
  \eanaX{\usyntaxueP{\tsmv}{\utau}{\eparse}{\ue}}{e}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:eana-S-implicite}
  \inferrule{
    \uPsi = \uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}\\\\
    \eana{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\ue}{e}{\tau'}
  }{
    \eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\implicite{\tsmv}{\ue}}{e}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-lit}
  \inferrule{
    \uPsi = \uASI{\uA}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{\lbltxt{SuccessE}\cdot\ecand}\\
  \decodeCondE{\ecand}{\ce}\\\\
    \segOK{\segof{\ce}}{b}\\
  \cana{\emptyset}{\emptyset}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}
  }{
    \eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\lit{b}}{e}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:eana-S-defuptsm}
\inferrule{
  \expandsTU{\uDelta}{\utau}{\tau}\\
  \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPat}}\\\\
  \evalU{\eparse}{\eparse'}\\
  \eana{\uDelta}{\uGamma}{\uPsi}{\uPhi, \uPhyp{\tsmv}{a}{\tau}{\eparse'}}{\ue}{e}{\tau'}
}{
  \eanaX{\usyntaxup{\tsmv}{\utau}{\eparse}{\ue}}{e}{\tau'}
}
\end{equation}
\begin{equation}\label{rule:eana-S-implicitp}
  \inferrule{
    \uPhi = \uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI}\\\\
    \eana{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau'}
  }{
    \eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\implicitp{\tsmv}{\ue}}{e}{\tau'}
  }
\end{equation}
\end{subequations}

\noindent\fbox{$\rana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$}~~$\urv$ has expansion $r$ taking values of type $\tau$ to values of type $\tau'$

\begin{equation}\label{rule:rana-S}
  \inferrule{
    \patExpands{\uGG{\uG'}{\Gamma'}}{\uPhi}{\upv}{p}{\tau}\\
    \eana{\uDD{\uD}{\Delta}}{\uGG{\uG \uplus \uG'}{\Gamma \cup \Gamma'}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}
  }{
    \rana{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\matchrule{\upv}{\ue}}{\aematchrule{p}{e}}{\tau}{\tau'}
  }
\end{equation}

\subsubsection{Pattern Expansion}
\noindent\fbox{$\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}$}~~$\upv$ has expansion $p$ matching against $\tau$ generating hypotheses $\upctx$

\begin{subequations}\label{rules:patExpands-B}
\begin{equation}\label{rule:patExpands-B-var}
\inferrule{ }{
  \patExpands{\uGG{\vExpands{\ux}{x}}{\Ghyp{x}{\tau}}}{\uPhi}{\ux}{x}{\tau}
}
\end{equation}
\begin{equation}\label{rule:patExpands-B-wild}
\inferrule{ }{
  \patExpands{\uGG{\emptyset}{\emptyset}}{\uPhi}{\wildp}{\aewildp}{\tau}
}
\end{equation}
\begin{equation}\label{rule:patExpands-B-fold}
\inferrule{ 
  \patExpands{\upctx}{\uPhi}{\upv}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \patExpands{\upctx}{\uPhi}{\foldp{\upv}}{\aefoldp{p}}{\arec{t}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:patExpands-B-tpl}
\inferrule{
    \tau = \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
  \{\patExpands{{\upctx_i}}{\uPhi}{\upv_i}{p_i}{\tau_i}\}_{i \in \labelset}\\
}{
    \patExpands{\GIconsi{i \in \labelset}{\upctx_i}}{\uPhi}{\tplp{\mapschema{\upv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\tau}
}
\end{equation}
\begin{equation}\label{rule:patExpands-B-in}
\inferrule{
  \patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}
}{
  \patExpands{\upctx}{\uPhi}{\injp{\ell}{\upv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}
\end{equation}
\begin{equation}\label{rule:patExpands-B-apuptsm}
\inferrule{
  \uPhi = \uPhi', \uPhyp{\tsmv}{a}{\tau}{\eparse}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}}\\
  \decodeCEPat{\ecand}{\cpv}\\\\
    \segOK{\segof{\cpv}}{b}\\
  \cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}
}{
  \patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}
}
\end{equation}
\begin{equation}\label{rule:patExpands-B-lit}
\inferrule{
  \uPhi = \uASI{\uA}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI, \designate{\tau}{a}}\\\\
  \encodeBody{b}{\ebody}\\
  \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}}\\
  \decodeCEPat{\ecand}{\cpv}\\\\
    \segOK{\segof{\cpv}}{b}\\
  \cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}
}{
  \patExpands{\upctx}{\uPhi}{\lit{b}}{p}{\tau}
}
\end{equation}
\end{subequations}

\section{Proto-Expansion Validation}
\subsection{Syntax of Proto-Expansions}
The syntax of proto-expansions was defined in Sec. \ref{appendix:proto-expansions-SES}.

% \[\begin{array}{lllllll}
% \textbf{Sort} & & & \textbf{Operational Form} & \textbf{Stylized Form} & \textbf{Description}\\
% \mathsf{PrTyp} & \ctau & ::= & \cdots & \cdots & \text{(as in $\miniVersePat$)}\\
% % &&& \aceparr{\ctau}{\ctau} & \parr{\ctau}{\ctau} & \text{partial function}\\
% % &&& \aceall{t}{\ctau} & \forallt{t}{\ctau} & \text{polymorphic}\\
% % &&& \acerec{t}{\ctau} & \rect{t}{\ctau} & \text{recursive}\\
% % &&& \aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}} & \prodt{\mapschema{\ctau}{i}{\labelset}} & \text{labeled product}\\
% % &&& \acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}} & \sumt{\mapschema{\ctau}{i}{\labelset}} & \text{labeled sum}\\
% %\LCC &&& \gray & \gray & \gray\\
% % &&& \acesplicedt{m}{n} & \splicedt{m}{n} & \text{spliced}\\%\ECC
% \mathsf{PrExp} & \ce & ::= & \cdots & \cdots & \text{(as in $\miniVersePat$)}\\
% &&& \aceasc{\ctau}{\ce} & \asc{\ce}{\ctau} & \text{ascription}\\
% &&& \aceletsyn{x}{\ce}{\ce} & \letsyn{x}{\ce}{\ce} & \text{value binding}\\
% % &&& \aceanalam{x}{\ce} & \analam{x}{\ce} & \text{abstraction (unannotated)}\\
% % &&& \acelam{\ctau}{x}{\ce} & \lam{x}{\ctau}{\ce} & \text{abstraction (annotated)}\\
% % &&& \aceap{\ce}{\ce} & \ap{\ce}{\ce} & \text{application}\\
% % &&& \acetlam{t}{\ce} & \Lam{t}{\ce} & \text{type abstraction}\\
% % &&& \acetap{\ce}{\ctau} & \App{\ce}{\ctau} & \text{type application}\\
% % &&& \aceanafold{\ce} & \fold{\ce} & \text{fold}\\
% % &&& \aceunfold{\ce} & \unfold{\ce} & \text{unfold}\\
% % &&& \acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}} & \tpl{\mapschema{\ce}{i}{\labelset}} & \text{labeled tuple}\\
% % &&& \acepr{\ell}{\ce} & \prj{\ce}{\ell} & \text{projection}\\
% % &&& \aceanain{\ell}{\ce} & \inj{\ell}{\ce} & \text{injection}\\
% % &&& \acematchwithb{n}{\ce}{\seqschemaX{\urv}} & \matchwith{\ce}{\seqschemaX{\crv}} & \text{match}\\%\LCC &&& \gray & \gray & \gray\\
% % &&& \acesplicede{m}{n} & \splicede{m}{n} & \text{spliced}\\%\ECC
% % &&& \acesplicedet{m}{n}{\ctau} & \splicedet{m}{n}{\ctau} & \text{spliced (analytic)}\\
% \mathsf{PrRule} & \crv & ::= & \cdots & \cdots & \text{(as in $\miniVersePat$)}\\
% \mathsf{PrPat} & \cpv & ::= & \cdots & \cdots & \text{(as in $\miniVersePat$)}\\
% % &&& \acefoldp{p} & \foldp{p} & \text{fold pattern}\\
% % &&& \acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}} & \tplp{\mapschema{\cpv}{i}{\labelset}} & \text{labeled tuple pattern}\\
% % &&& \aceinjp{\ell}{\cpv} & \injp{\ell}{\cpv} & \text{injection pattern}\\
% % &&& \acesplicedp{m}{n} & \splicedp{m}{n} & \text{spliced}
% \end{array}\]

\subsubsection{Common Proto-Expansion Terms}
Each expanded term, except variable patterns, maps onto a proto-expansion term. We refer to these as the \emph{common proto-expansion terms}. In particular:
\begin{itemize}
  \item Each type, $\tau$, maps onto a proto-type, $\Cof{\tau}$, as follows:
  \[\arraycolsep=1pt\begin{array}{rl}
  \Cof{t} & = t\\
  \Cof{\aparr{\tau_1}{\tau_2}} & = \aceparr{\Cof{\tau_1}}{\Cof{\tau_2}}\\
  \Cof{\aall{t}{\tau}} & = \aceall{t}{\Cof{\tau}}\\
  \Cof{\arec{t}{\tau}} & = \acerec{t}{\Cof{\tau}}\\
  \Cof{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \aceprod{\labelset}{\mapschemax{\Cofv}{\tau}{i}{\labelset}}\\
  \Cof{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}} & = \acesum{\labelset}{\mapschemax{\Cofv}{\tau}{i}{\labelset}}
  \end{array}\]
  \item Each expanded expression, $e$, maps onto a proto-expression, $\Cof{e}$, as follows:
  \[\arraycolsep=1pt\hspace{-15px}\begin{array}{rl}
  \Cof{x} & = x\\
  \Cof{\aelam{\tau}{x}{e}} & = \acelam{\Cof{\tau}}{x}{\Cof{e}}\\
  \Cof{\aeap{e_1}{e_2}} & = \aceap{\Cof{e_1}}{\Cof{e_2}}\\
  \Cof{\aetlam{t}{e}} & = \acetlam{t}{\Cof{e}}\\
  \Cof{\aetap{e}{\tau}} & = \acetap{\Cof{e}}{\Cof{\tau}}\\
  \Cof{\aefold{e}} & = \aceasc{\acerec{t}{\Cof{\tau}}}{\acefold{\Cof e}}\\
  \Cof{\aeunfold{e}} & = \aceunfold{\Cof{e}}\\
  \Cof{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}} & = \acetpl{\labelset}{\mapschemax{\Cofv}{e}{i}{\labelset}}\\
  \Cof{\aein{\ell}{e}} &= \aceasc
    {
      \acesum{\labelset}{\mapschemax{\Cofv}{\tau}{i}{\labelset}}
    }{\acein{\ell}{\Cof{e}}}\\
  \Cof{\aematchwith{n}{e}{\seqschemaX{r}}} & = \aceasc{\Cof{\tau}}{\acematchwith{n}{\Cof{e}}{\seqschemaXx{\Cofv}{r}}}
  \end{array}\]
  \item Each expanded rule, $r$, maps onto the proto-rule, $\Cof{r}$, as follows:
  \begin{align*}
  \Cof{\aematchrule{p}{e}} & = \acematchrule{p}{\Cof{e}}
  \end{align*}
  \item Each expanded pattern, $p$, except for the variable patterns, maps onto a proto-pattern, $\Cof{p}$, as follows:
  \begin{align*}
  \Cof{\aewildp} & = \acewildp\\
  \Cof{\aefoldp{p}} & = \acefoldp{\Cof{p}}\\
  \Cof{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}} & = \acetplp{\labelset}{\mapschemax{\Cofv}{p}{i}{\labelset}}\\
  \Cof{\aeinjp{\ell}{p}} & = \aceinjp{\ell}{\Cof{p}}
  \end{align*}
\end{itemize}

These definitions differ from those given in Sec. \ref{appendix:proto-expansions-SES} in that they include the type information necessary for bidirectional typechecking.

\subsubsection{Proto-Expression Encoding and Decoding}
The type $\tCEExp$ and the judgements $\encodeCondE{\ce}{e}$ and $\decodeCondE{e}{\ce}$ are characterized as described in Sec. \ref{appendix:proto-expansions-SES}.

\subsubsection{Proto-Pattern Encoding and Decoding}
The type $\tCEPat$ and the judgements $\encodeCEPat{\cpv}{e}$ and $\decodeCEPat{e}{\cpv}$ are characterized as described in Sec. \ref{appendix:proto-expansions-SES}.

\subsubsection{Splice Summaries}
The \emph{splice summary} of a proto-expression, $\summaryOf{\ce}$, or proto-pattern, $\summaryOf{\cpv}$, is the finite set of references to spliced types, expressions {and patterns} that it mentions.

\subsubsection{Segmentations}
A \emph{segment set}, $\psi$, is a finite set of pairs of natural numbers indicating the locations of spliced terms. The \emph{segmentation} of a proto-expression, $\segof{\ce}$, or proto-pattern, $\segof{\cpv}$, is the segment set implied by its splice summary.

\subsection{Proto-Expansion Validation}\label{appendix:proto-expansion-validation-BS}
\subsubsection{Proto-Type Validation}
The \emph{proto-type validation judgement}, $\cvalidT{\Delta}{\tscenev}{\ctau}{\tau}$, is inductively defined by Rules (\ref{rules:cvalidT-U}), which were defined in Sec. \ref{appendix:proto-type-validation-SES}.

\subsubsection{Bidirectional Proto-Expression and Proto-Rule Validation}
\emph{Expression splicing scenes}, $\escenev$, are of the form $\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}$. We write $\tsfrom{\escenev}$ for the type splicing scene constructed by dropping unnecessary contexts from $\escenev$:
\[\tsfrom{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}} = \tsceneUP{\uDelta}{b}\]

\noindent\fbox{$\strut\csynX{\ce}{e}{\tau}$}~~$\ce$ has expansion $e$ synthesizing type $\tau$
\begin{subequations}\label{rules:csyn}
\begin{equation}\label{rule:csyn-var}
  \inferrule{ }{ 
    \csyn{\Delta}{\Gamma, \Ghyp{x}{\tau}}{\escenev}{x}{x}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:csyn-asc}
  \inferrule{
    \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau}{\tau}\\
    \canaX{\ce}{e}{\tau}
  }{
    \csynX{\aceasc{\ctau}{\ce}}{e}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:csyn-let}
  \inferrule{
    \csynX{\ce}{e}{\tau}\\
    \csyn{\Delta}{\Gamma, \Ghyp{x}{\tau}}{\escenev}{\ce'}{e'}{\tau'}
  }{
    \csynX{\aceletsyn{x}{\ce}{\ce'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
  }
\end{equation}
\begin{equation}\label{rule:csyn-lam}
  \inferrule{
    \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau_1}{\tau_1}\\
    \csyn{\Delta}{\Gamma, \Ghyp{x}{\tau_1}}{\escenev}{\ce}{e}{\tau_2}
  }{
    \csynX{\acelam{\ctau_1}{x}{\ce}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
  }
\end{equation}
\begin{equation}\label{rule:csyn-ap}
  \inferrule{
    \csynX{\ce_1}{e_1}{\aparr{\tau_2}{\tau}}\\
    \canaX{\ce_2}{e_2}{\tau_2}
  }{
    \csynX{\aceap{\ce_1}{\ce_2}}{\aeap{e_1}{e_2}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:csyn-tlam}
  \inferrule{
    \csyn{\Delta, \Dhyp{t}}{\Gamma}{\escenev}{\ce}{e}{\tau}
  }{
    \csynX{\acetlam{t}{\ce}}{\aetlam{t}{e}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:csyn-tap}
  \inferrule{
    \csynX{\ce}{e}{\aall{t}{\tau}}\\
    \cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau'}{\tau'}
  }{
    \csynX{\acetap{\ce}{\ctau'}}{\aetap{e}{\tau'}}{[\tau'/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:csyn-unfold}
  \inferrule{
    \csynX{\ce}{e}{\arec{t}{\tau}}
  }{
    \csynX{\aceunfold{\ce}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
  }
\end{equation}
\begin{equation}\label{rule:csyn-tpl}
  \inferrule{
    \tau = \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
    \{\csynX{\ce_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \csynX{\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:csyn-pr}
  \inferrule{
    \csynX{\ce}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
  }{
    \csynX{\acepr{\ell}{\ce}}{\aepr{\ell}{e}}{\tau}
  }
\end{equation}
% \begin{equation}\label{rule:csyn-match}
%   \inferrule{
%     n > 0\\
%     \csynX{\ce}{e}{\tau}\\
%     \{\crsynX{\crv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
%   }{
%     \csynX{\acematchwithb{n}{\ce}{\seqschemaX{\crv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
%   }
% \end{equation}
\begin{equation}\label{rule:csyn-splicede}
\inferrule{
  \cvalidT{\emptyset}{\tsfrom{\escenev}}{\ctau}{\tau}\\
  \escenev=\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}\\
  \parseUExp{\bsubseq{b}{m}{n}}{\ue}\\
  \eana{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{\ue}{e}{\tau}\\\\
  \Delta \cap \Delta_\text{app} = \emptyset\\
  \domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset
}{
  \csyn{\Delta}{\Gamma}{\escenev}{\acesplicede{m}{n}{\ctau}}{e}{\tau}
}
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\canaX{\ce}{e}{\tau}$}~~$\ce$ has expansion $e$ when analyzed against type $\tau$
\begin{subequations}\label{rules:cana}
\begin{equation}\label{rule:cana-subsume}
  \inferrule{
    \csynX{\ce}{e}{\tau}
  }{
    \canaX{\ce}{e}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cana-let}
  \inferrule{
    \csynX{\ce}{e}{\tau}\\
    \cana{\Delta}{\Gamma, \Ghyp{x}{\tau}}{\escenev}{\ce'}{e'}{\tau'}
  }{
    \canaX{\aceletsyn{x}{\ce}{\ce'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
  }
\end{equation}
% \begin{equation}\label{rule:cana-analam}
%   \inferrule{
%     \cana{\Delta}{\Gamma, \Ghyp{x}{\tau_1}}{\escenev}{\ce}{e}{\tau_2}
%   }{
%     \canaX{\aceanalam{x}{\ue}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
%   }
% \end{equation}
\begin{equation}\label{rule:cana-tlam}
  \inferrule{
    \cana{\Delta, \Dhyp{t}}{\Gamma}{\escenev}{\ce}{e}{\tau}
  }{
    \canaX{\acetlam{t}{\ce}}{\aetlam{t}{e}}{\aall{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cana-fold}
  \inferrule{
    \canaX{\ce}{e}{[\arec{t}{\tau}/t]\tau}
  }{
    \canaX{\aceanafold{\ce}}{\aefold{e}}{\arec{t}{\tau}}
  }
\end{equation}
\begin{equation}\label{rule:cana-tpl}
  \inferrule{
    \tau = \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
    \{\canaX{\ce_i}{e_i}{\tau_i}\}_{i \in \labelset}
  }{
    \canaX{\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\tau}
  }
\end{equation}
\begin{equation}\label{rule:cana-in}
  \inferrule{
    \canaX{\ce}{e}{\tau'}
  }{
    % \left(\shortstack{$\Delta~\Gamma \vdash^{\escenev} \aceanain{\ell}{\ce}$\\$\leadsto$\\$\aein{\ell} \Leftarrow \asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}$\vspace{-1.2em}}\right)
    \canaX{\acein{\ell}{\ce}}{\aein{\ell}{e}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}
  }
\end{equation}
\begin{equation}\label{rule:cana-match}
  \inferrule{
    \csynX{\ce}{e}{\tau}\\
    \{\cranaX{\crv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
  }{
    \canaX{\acematchwithb{n}{\ce}{\seqschemaX{\crv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
  }
\end{equation}
\end{subequations}

\noindent\fbox{$\strut\crana{\Delta}{\Gamma}{\escenev}{\crv}{r}{\tau}{\tau'}$}~~$\crv$ has expansion $r$ taking values of type $\tau$ to values of type $\tau'$
\begin{equation}\label{rule:crana}
\inferrule{
  \patType{\pctx}{p}{\tau}\\
  \cana{\Delta}{\Gcons{\Gamma}{\pctx}}{\escenev}{\ce}{e}{\tau'}
}{
  \crana{\Delta}{\Gamma}{\escenev}{\acematchrule{p}{\ce}}{\aematchrule{p}{e}}{\tau}{\tau'}
}
\end{equation}

\subsubsection{Proto-Pattern Validation}
\emph{Pattern splicing scenes}, $\pscenev$, are of the form $\pscene{\uDelta}{\uPhi}{b}$.

\vspace{10px}\noindent\fbox{\strut$\cvalidP{\upctx}{\pscenev}{\cpv}{p}{\tau}$}~~$\cpv$ has expansion $p$ matching against $\tau$ generating hypotheses $\upctx$
\begin{subequations}\label{rules:cvalidP-B}
\begin{equation}\label{rule:cvalidP-B-wild}
\inferrule{ }{
  \cvalidP{\uGG{\emptyset}{\emptyset}}{\pscenev}{\acewildp}{\aewildp}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-B-fold}
\inferrule{
  \cvalidP{\upctx}{\pscenev}{\cpv}{p}{[\arec{t}{\tau}/t]\tau}
}{
  \cvalidP{\upctx}{\pscenev}{\acefoldp{\cpv}}{\aefoldp{p}}{\arec{t}{\tau}}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-B-tpl}
\inferrule{
  \tau = \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
  \{\cvalidP{\upctx_i}{\pscenev}{\cpv_i}{p_i}{\tau_i}\}_{i \in \labelset}
}{
% \left(\shortstack{$\vdash^{\pscenev} \acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}$\\$\leadsto$\\$\aetplp{\labelset}{\mapschema{p}{i}{\labelset}} : \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}~\dashVx^{\,\Gconsi{i \in \labelset}{\upctx_i}}$\vspace{-1.2em}}\right)
  \cvalidP{\GIconsi{i \in \labelset}{\upctx_i}}{\pscenev}{\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\tau}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-B-in}
\inferrule{
  \cvalidP{\upctx}{\pscenev}{\cpv}{p}{\tau}
}{
  \cvalidP{\upctx}{\pscenev}{\aceinjp{\ell}{\cpv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
}
\end{equation}
\begin{equation}\label{rule:cvalidP-B-spliced}
\inferrule{
  \cvalidT{\emptyset}{\tsceneUP{\uDelta}{b}}{\ctau}{\tau}\\
  \parseUPat{\bsubseq{b}{m}{n}}{\upv}\\
  \patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}
}{
  \cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\acesplicedp{m}{n}{\ctau}}{p}{\tau}
}
\end{equation}
\end{subequations}
\section{Metatheory}
\subsection{Typed Pattern Expansion}\label{appendix:SES-typed-pattern-expansion}
\begin{theorem}[Typed Pattern Expansion]\label{thm:typed-pattern-expansion-B} ~
\begin{enumerate}
  \item If $\pExpandsSP{\uDD{\uD}{\Delta}}{\uASI{\uA}{\Phi}{\uI}}{\upv}{p}{\tau}{\uGG{\uG}{\pctx}}$ then $\patType{\pctx}{p}{\tau}$.
  \item If $\cvalidP{\uGG{\uG}{\pctx}}{\pscene{\uDD{\uD}{\Delta}}{\uAP{\uA}{\Phi}}{b}}{\cpv}{p}{\tau}$ then $\patType{\pctx}{p}{\tau}$.
\end{enumerate}
\end{theorem}
\begin{proof}
  By mutual rule induction over Rules (\ref{rules:patExpands-B}) and Rules (\ref{rules:cvalidP-B}
  \begin{enumerate}
  \item We induct on the premise. In the following, let $\uDelta=\uDD{\uD}{\Delta}$ and $\upctx=\uGG{\uG}{\pctx}$ and $\uPhi=\uASI{\uA}{\Phi}{\uI}$.
  \begin{byCases}
    \item[\text{(\ref{rule:patExpands-B-var}) \textbf{through} (\ref{rule:patExpands-B-apuptsm})}] These cases follow by identical argument to the corresponding cases of Theorem \ref{thm:typed-pattern-expansion}.

    \item[\text{(\ref{rule:patExpands-B-lit})}]~
    \resetpfcounter
    \begin{pfsteps}
      \item \upv = \lit{b} \BY{assumption}
      \item \Phi = \Phi', \xuptsmbnd{a}{\tau}{\eparse} \BY{assumption}
      \item \uI = \uI', \designate{\tau}{a} \BY{assumption}
      \item   \encodeBody{b}{\ebody} \BY{assumption}
      \item   \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessP}}\cdot{\ecand}} \BY{assumption}
      \item  \decodeCEPat{\ecand}{\cpv} \BY{assumption}
      \item  \cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau} \BY{assumption} \pflabel{cvalidP}
      \item \patType{\pctx}{p}{\tau} \BY{IH, part 2 on \pfref{cvalidP}}
    \end{pfsteps}
    \resetpfcounter
%     \item[\text{(\ref{rule:patExpands-var})}] ~
%       \begin{pfsteps*}
%         \item $\upv=\ux$ \BY{assumption}
%         \item $p=x$ \BY{assumption}
%         \item $\pctx=\Ghyp{x}{\tau}$ \BY{assumption}
%         \item $\patType{\Ghyp{x}{\tau}}{x}{\tau}$ \BY{Rule (\ref{rule:patType-var})}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:patExpands-wild})}] ~
%       \begin{pfsteps*}
%         \item $p=\aewildp$ \BY{assumption}
%         \item $\pctx = \emptyset$ \BY{assumption}
%         \item $\patType{\emptyset}{\aewildp}{\tau}$ \BY{Rule (\ref{rule:patType-wild})}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:patExpands-fold})}] ~
%       \begin{pfsteps*}
%         \item $\upv=\foldp{\upv'}$ \BY{assumption}
%         \item $p=\aefoldp{p'}$ \BY{assumption}
%         \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
%         %\item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
%         \item $\patExpands{\upctx}{\uPhi}{\upv'}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption} \pflabel{patExpands}
%         \item $\patType{\pctx}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{IH, part 1 on \pfref{patExpands}} \pflabel{patType}
%         \item $\patType{\pctx}{\aefoldp{p'}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:patType-fold}) on \pfref{patType}}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:patExpands-tpl})}] ~
%       \begin{pfsteps*}
%         \item $\upv=\tplp{\mapschema{\upv}{i}{\labelset}}$ \BY{assumption}
%         \item $p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}$ \BY{assumption}
%         \item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
%         \item $\{\patExpands{\uGG{\uG_i}{\pctx_i}}{\uPhi}{\upv_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{patExpands}
%         \item $\pctx = \Gconsi{i \in \labelset}{\pctx_i}$ \BY{assumption}
%         %\item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
%         \item $\{\patType{\pctx_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{IH, part 1 over \pfref{patExpands}}\pflabel{patType}
%         \item $\patType{\Gconsi{i \in \labelset}{\pctx_i}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:patType-tpl}) on \pfref{patType}}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:patExpands-in})}] ~
%       \begin{pfsteps*}
%         \item $\upv=\injp{\ell}{\upv'}$ \BY{assumption}
%         \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
%         \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
%         \item $\patExpands{\upctx}{\uPhi}{\upv'}{p'}{\tau'}$ \BY{assumption} \pflabel{patExpands}
% %        \item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
%         \item $\patType{\pctx}{p'}{\tau'}$ \BY{IH, part 1 on \pfref{patExpands}} \pflabel{patType}
%         \item $\patType{\pctx}{\aeinjp{\ell}{p'}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}$ \BY{Rule (\ref{rule:patType-inj}) on \pfref{patType}}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:patExpands-apuptsm})}] ~
%       \begin{pfsteps*}
%         \item $\upv=\utsmap{\tsmv}{b}$ \BY{assumption}
%         \item $\uA=\uA', \vExpands{\tsmv}{a}$ \BY{assumption}
%         \item $\Phi=\Phi', \xuptsmbnd{a}{\tau}{\eparse}$ \BY{assumption}
%         \item $\encodeBody{b}{\ebody}$ \BY{assumption}
%         \item $\evalU{\eparse(\ebody)}{{\lbltxt{SuccessP}}\cdot{\ecand}}$ \BY{assumption}
%         \item $\decodeCEPat{\ecand}{\cpv}$ \BY{assumption}
%         \item $\cvalidP{\uGG{\uG}{\pctx}}{\pscene{\uDelta}{\uAP{\uA}{\Phi}}{b}}{\cpv}{p}{\tau}$ \BY{assumption} \pflabel{cvalidP}
% %        \item $\uptsmenv{\Delta}{\Phi', \xuptsmbnd{a}{\tau}{\eparse}}$ \BY{assumption} \pflabel{env}
%         \item $\patType{\pctx}{p}{\tau}$ \BY{IH, part 2 on \pfref{cvalidP}}
%       \end{pfsteps*}
%       \resetpfcounter
  \end{byCases}

  \item We induct on the premise. All cases follow by identical argument to the corresponding cases of Theorem \ref{thm:typed-pattern-expansion}.
%   \begin{byCases}
%     \item[\text{(\ref{rule:cvalidP-B-wild})}] ~
%       \begin{pfsteps*}
%         \item $p=\aewildp$ \BY{assumption}
%         \item $\pctx=\emptyset$ \BY{assumption}
%         \item $\patType{\emptyset}{\aewildp}{\tau}$ \BY{Rule (\ref{rule:patType-wild})}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:cvalidP-UP-fold})}] ~
%       \begin{pfsteps*}
%         \item $\cpv=\acefoldp{\cpv'}$ \BY{assumption}
%         \item $p=\aefoldp{p'}$ \BY{assumption}
%         \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
%         % \item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
%         \item $\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv'}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption} \pflabel{cvalidP}
%         \item $\patType{\pctx}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{IH, part 2 on \pfref{cvalidP}} \pflabel{patType}
%         \item $\patType{\pctx}{\aefoldp{p'}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:patType-fold}) on \pfref{patType}}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:cvalidP-UP-tpl})}] ~
%       \begin{pfsteps*}
%         \item $\cpv=\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}$ \BY{assumption}
%         \item $p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}$ \BY{assumption}
%         \item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
%         \item $\{\cvalidP{\uGG{\uG_i}{\pctx_i}}{\pscene{\uDelta}{\uPhi}{b}}{\cpv_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{cvalidP}
%         \item $\pctx = \Gconsi{i \in \labelset}{\pctx_i}$ \BY{assumption}
%         %\item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
%         \item $\{\patType{\pctx_i}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{IH, part 2 over \pfref{cvalidP}}\pflabel{patType}
%         \item $\patType{\Gconsi{i \in \labelset}{\pctx_i}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:patType-tpl}) on \pfref{patType}}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:cvalidP-UP-in})}] ~
%       \begin{pfsteps*}
%         \item $\cpv=\aceinjp{\ell}{\cpv'}$ \BY{assumption}
%         \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
%         \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
%         \item $\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv'}{p'}{\tau'}$ \BY{assumption} \pflabel{cvalidP}
% %        \item $\uptsmenv{\Delta}{\Phi}$ \BY{assumption} \pflabel{env}
%         \item $\patType{\pctx}{p'}{\tau'}$ \BY{IH, part 2 on \pfref{cvalidP}} \pflabel{patType}
%         \item $\patType{\pctx}{\aeinjp{\ell}{p'}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}$ \BY{Rule (\ref{rule:patType-inj}) on \pfref{patType}}
%       \end{pfsteps*}
%       \resetpfcounter
%     \item[\text{(\ref{rule:cvalidP-UP-spliced})}] ~
%       \begin{pfsteps*}
%         \item $\cpv=\acesplicedp{m}{n}{\ctau}$ \BY{assumption}
%         \item $\cvalidT{\emptyset}{\tsceneUP{\uDelta}{b}}{\ctau}{\tau}$ \BY{assumption}
%         \item $\parseUExp{\bsubseq{b}{m}{n}}{\upv}$ \BY{assumption}
%         \item $\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}$ \BY{assumption} \pflabel{patExpands}
%         \item $\patType{\pctx}{p}{\tau}$ \BY{IH, part 1 on \pfref{patExpands}}
%       \end{pfsteps*}
%       \resetpfcounter
%   \end{byCases}
  \end{enumerate}
The mutual induction can be shown to be well-founded by an argument nearly identical to that that given in the proof of Theorem \ref{thm:typed-pattern-expansion}, differing only in that the appeal to Condition \ref{condition:pattern-parsing} is replaced by an appeal to the analagous Condition \ref{condition:pattern-parsing-BS}.

% showing that the following numeric metric on the judgements that we induct on is decreasing:
% \begin{align*}
% \sizeof{\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}} & = \sizeof{\upv}\\
% \sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}}} & = \sizeof{b}
% \end{align*}
% where $\sizeof{b}$ is the length of $b$ and $\sizeof{\upv}$ is the sum of the lengths of the literal bodies in $\upv$, as defined in Sec. \ref{appendix:SES-syntax}.

% The only case in the proof of part 1 that invokes part 2 is Case (\ref{rule:patExpands-apuptsm}). There, we have that the metric remains stable: \begin{align*}
%  & \sizeof{\patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}}\\
% =& \sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\cpv}{p}{\tau}}}\\
% =&\sizeof{b}\end{align*}

% The only case in the proof of part 2 that invokes part 1 is Case (\ref{rule:cvalidP-UP-spliced}). There, we have that $\parseUPat{\bsubseq{b}{m}{n}}{\upv}$ and the IH is applied to the judgement $\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}$. Because the metric is stable when passing from part 1 to part 2, we must have that it is strictly decreasing in the other direction:
% \[\sizeof{\patExpands{\upctx}{\uPhi}{\upv}{p}{\tau}} < \sizeof{{\cvalidP{\upctx}{\pscene{\uDelta}{\uPhi}{b}}{\acesplicedp{m}{n}{\ctau}}{p}{\tau}}}\]
% i.e. by the definitions above, 
% \[\sizeof{\upv} < \sizeof{b}\]

% This is established by appeal to Condition \ref{condition:body-subsequences}, which states that subsequences of $b$ are no longer than $b$, and the Condition \ref{condition:pattern-parsing}, which states that an unexpanded pattern constructed by parsing a textual sequence $b$ is strictly smaller, as measured by the metric defined above, than the length of $b$, because some characters must necessarily be used to apply the pattern TSM and delimit each literal body. Combining Conditions \ref{condition:body-subsequences} and \ref{condition:pattern-parsing}, we have that $\sizeof{\upv} < \sizeof{b}$ as needed.
\end{proof}
\subsection{Typed Expression Expansion}\label{appendix:SES-typed-expression-expansion}
\begin{theorem}[Typed Expansion (Full)]\label{thm:typed-expansion-full-U} ~
\begin{enumerate}
  \item \begin{enumerate}
    \item If $\esyn{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ then $\hastypeU{\Delta}{\Gamma}{e}{\tau}$.
    \item If $\eana{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ and $\istypeU{\Delta}{\tau}$ then $\hastypeU{\Delta}{\Gamma}{e}{\tau}$.
    \item If $\rana{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$ and $\istypeU{\Delta}{\tau'}$ then $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$.
  \end{enumerate}
  \item \begin{enumerate}
    \item If $\csyn{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ then $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$. 
    \item If $\cana{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ and $\istypeU{\Delta}{\tau}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ then $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$. 
    \item If $\crana{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\crv}{r}{\tau}{\tau'}$ and $\istypeU{\Delta}{\tau'}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ then $\ruleType{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{r}{\tau}{\tau'}$.
  \end{enumerate}
\end{enumerate}
\end{theorem}
\begin{proof}
By mutual rule induction over Rules (\ref{rules:esyn-S}), Rules (\ref{rules:eana-S}), Rule (\ref{rule:rana-S}), Rules (\ref{rules:csyn}), Rules (\ref{rules:cana}) and Rule (\ref{rule:crana}).

\begin{enumerate}
\item In the following, let $\uDelta=\uDD{\uD}{\Delta}$ and $\uGamma=\uGG{\uG}{\Gamma}$.
  \begin{enumerate}
    \item \todo{1a}
    \item \todo{1b}
    \item \todo{1c}
  \end{enumerate}
\item \todo{2}
  \begin{enumerate}
    \item \todo{2a}
    \item \todo{2b}
    \item \todo{2c}
  \end{enumerate}
\end{enumerate}
\end{proof}

% % \subsection{Expressibility}
% The following lemma establishes that each type can be expressed as a well-formed proto-type, under the same type formation context and any type splicing scene.
% \begin{lemma}[Proto-Expansion Type Expressibility]\label{lemma:proto-type-expressibility-U} If $\istypeU{\Delta}{\tau}$ then $\cvalidT{\Delta}{\tscenev}{\Cof{\tau}}{\tau}$. \end{lemma}
% \begin{proof}
% By rule induction over Rules (\ref{rules:istypeU}). In each case, we apply the IH on or over each premise, then apply the corresponding proto-type validation rule in Rules (\ref{rules:cvalidT-U}).
% \end{proof}

% The Type Expressibility Lemma establishes that every well-formed type, $\tau$, can be expressed as a well-formed unexpanded type, $\Uof{\tau}$. This requires defining the metafunction $\Uof{\Delta}$ which maps $\Delta$ onto an unexpanded type formation context as follows:
% \begin{align*}
% \Uof{\emptyset} &= \uDD{\emptyset}{\emptyset}\\
% \Uof{\Delta, \Dhyp{t}} &= \Uof{\Delta}, \uDhyp{\sigilof{t}}{t}
% \end{align*}
% \begin{lemma}[Type Expressibility]\label{lemma:type-expressibility} If $\istypeU{\Delta}{\tau}$ then $\expandsTU{\Uof{\Delta}}{\Uof{\tau}}{\tau}$.\end{lemma}
% \begin{proof} By rule induction over Rules (\ref{rules:istypeU}) using the definitions of $\Uof{\tau}$ and $\Uof{\Delta}$ above. In each case, we apply the IH to or over each premise, then apply the corresponding type expansion rule in Rules (\ref{rules:expandsTU}).\end{proof}


% The following lemma establishes that each well-typed expanded expression, $e$, can be expressed as a valid proto-expression, $\Cof{e}$, that is assigned the same type under any expression splicing scene.
% \begin{theorem}[Proto-Expansion Expression Expressibility]\label{theorem:proto-expressions-expressibility-U} If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\cvalidE{\Delta}{\Gamma}{\escenev}{\Cof{e}}{e}{\tau}$.\end{theorem}
% \begin{proof} By rule induction over Rules (\ref{rules:hastypeU}). The rule transformation above guarantees that this lemma holds by construction. In particular, in each case, we apply Lemma \ref{lemma:proto-type-expressibility-U} to or over each type formation premise, the IH to or over each typing premise, then apply the corresponding proto-expression validation rule in Rules (\ref{rule:cvalidE-U-var}) through (\ref{rule:cvalidE-U-case}).
% \end{proof}

% The following lemma establishes that each well-typed expanded expression, $e$, can be expressed as a valid ce-expression, $\Cof{e}$, that is assigned the same type under any expression splicing scene.
% \begin{theorem}[Candidate Expansion Expression Expressibility]\label{lemma:ce-expressions-expressibility-UP} Both of the following hold:
% \begin{enumerate}
% \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\cvalidE{\Delta}{\Gamma}{\escenev}{\Cof{e}}{e}{\tau}$.
% \item If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ then $\cvalidR{\Delta}{\Gamma}{\escenev}{\Cof{r}}{r}{\tau}{\tau'}$.
% \end{enumerate}
% \end{theorem}
% \begin{proof} By mutual rule induction over Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}). 

% For part 1, we induct on the assumption. 
% \begin{byCases}
% \item[\text{(\ref{rule:hastypeUP-var}) through (\ref{rule:hastypeUP-in})}] In each of these cases, we apply Lemma \ref{lemma:ce-type-expressibility-U} to or over each type formation premise, the IH (part 1) to or over each typing premise, then apply the corresponding ce-expression validation rule in Rules (\ref{rule:cvalidE-UP-var}) through (\ref{rule:cvalidE-UP-in}).
% \item[\text{(\ref{rule:hastypeUP-match})}] ~
%   \begin{pfsteps}
%   \item e = \aematchwith{n}{e'}{\seqschemaX{r}} \BY{assumption}
%   \item \Cof{e} = \acematchwith{n}{\Cof{\tau}}{\Cof{e'}}{\seqschemaXx{\Cofv}{r}} \BY{definition of $\Cof{e}$}
%   \item \hastypeU{\Delta}{\Gamma}{e'}{\tau'} \BY{assumption} \pflabel{hasType}
%   \item \istypeU{\Delta}{\tau} \BY{assumption} \pflabel{isType}
%   \item \{\ruleType{\Delta}{\Gamma}{r_i}{\tau'}{\tau}\}_{1 \leq i \leq n} \BY{assumption} \pflabel{ruleType}
%   \item \cvalidE{\Delta}{\Gamma}{\escenev}{\Cof{e'}}{e'}{\tau'} \BY{IH, part 1 on \pfref{hasType}} \pflabel{cvalidE}
%   \item \cvalidT{\Delta}{\tsfrom{\escenev}}{\Cof{\tau}}{\tau} \BY{Lemma \ref{lemma:candidate-expansion-type-validation} on \pfref{isType}} \pflabel{cvalidT}
%   \item \{\cvalidR{\Delta}{\Gamma}{\escenev}{\Cof{r_i}}{r_i}{\tau'}{\tau}\}_{1 \leq i \leq n} \BY{IH, part 2 over \pfref{ruleType}} \pflabel{cvalidR}
%   \item \cvalidE{\Delta}{\Gamma}{\escenev}{\acematchwith{n}{\Cof{\tau}}{\Cof{e'}}{\seqschemaXx{\Cofv}{r}}}{\aematchwith{n}{e'}{\seqschemaX{r}}}{\tau} \BY{Rule (\ref{rule:cvalidE-UP-match}) on \pfref{cvalidE}, \pfref{cvalidT} and \pfref{cvalidR}}
%   \end{pfsteps}
% \end{byCases}
% \resetpfcounter

% For part 2, we induct on the assumption. There is only one case.
% \begin{byCases}
% \item[\text{(\ref{rule:ruleType})}] ~
%   \begin{pfsteps}
%     \item r = \aematchrule{p}{e} \BY{assumption}
%     \item \Cof{r} = \acematchrule{p}{\Cof{e}} \BY{definition of $\Cof{r}$}
%     \item \patType{\pctx}{p}{\tau} \BY{assumption} \pflabel{patType}
%     \item \hastypeU{\Delta}{\Gcons{\Gamma}{\pctx}}{e}{\tau'} \BY{assumption} \pflabel{hasType}
%     \item \cvalidE{\Delta}{\Gcons{\Gamma}{\pctx}}{\escenev}{\Cof{e}}{e}{\tau'} \BY{IH, part 1 on \pfref{hasType}} \pflabel{cvalidE}
%     \item \cvalidR{\Delta}{\Gamma}{\escenev}{\acematchrule{p}{\Cof{e}}}{\aematchrule{p}{e}}{\tau}{\tau'} \BY{Rule (\ref{rule:cvalidR-UP}) on \pfref{patType} and \pfref{cvalidE}}
%   \end{pfsteps}
%   \resetpfcounter
% \end{byCases}
% \end{proof}

% The following lemma establishes that every well-typed expanded pattern that generates no hypotheses can be expressed as a ce-pattern.
% \begin{lemma}[Candidate Expansion Pattern Expressibility]\label{lemma:ce-pattern-expressibility-U} If $\patType{\emptyset}{p}{\tau}$ then $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p}}{p}{\tau}$.\end{lemma}
% \begin{proof} By rule induction over Rules (\ref{rules:patType}).
% \begin{byCases}
% \item[\text{(\ref{rule:patType-var})}] This case does not apply.
% \item[\text{(\ref{rule:patType-wild})}] ~
%   \begin{pfsteps*}
%     \item $p=\aewildp$ \BY{assumption}
%     \item $\Cof{p}=\acewildp$ \BY{definition of $\Cof{p}$}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\acewildp}{\aewildp}{\tau}$ \BY{Rule (\ref{rule:cvalidP-UP-wild})}
%   \end{pfsteps*}
%   \resetpfcounter
% \item[\text{(\ref{rule:patType-fold})}] ~
%   \begin{pfsteps*}
%     \item $p=\aefoldp{p'}$ \BY{assumption}
%     \item $\Cof{p}=\acefoldp{\Cof{p'}}$ \BY{definition of $\Cof{p}$}
%     \item $\tau=\arec{t}{\tau'}$ \BY{assumption}
%     \item $\patType{\emptyset}{p'}{[\arec{t}{\tau'}/t]\tau'}$ \BY{assumption} \pflabel{patType}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p'}}{p}{[\arec{t}{\tau'}/t]\tau'}$ \BY{IH on \pfref{patType}} \pflabel{cvalidP}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\acefoldp{\Cof{p'}}}{\aefoldp{p'}}{\arec{t}{\tau'}}$ \BY{Rule (\ref{rule:cvalidP-UP-fold}) on \pfref{cvalidP}}
%   \end{pfsteps*}
%   \resetpfcounter
% \item[\text{(\ref{rule:patType-tpl})}] ~
%   \begin{pfsteps*}
%     \item $p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}$ \BY{assumption}
%     \item $\Cof{p}=\acetpl{\labelset}{\mapschemax{\Cofv}{p}{i}{\labelset}}$ \BY{definition of $\Cof{p}$}
%     \item $\tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}$ \BY{assumption}
%     \item $\{\patType{\emptyset}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{assumption} \pflabel{patType}
%     \item $\{\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p_i}}{p_i}{\tau_i}\}_{i \in \labelset}$ \BY{IH over \pfref{patType}} \pflabel{cvalidP}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\acetpl{\labelset}{\mapschemax{\Cofv}{p}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}$ \BY{Rule (\ref{rule:cvalidP-UP-tpl}) on \pfref{cvalidP}}
%   \end{pfsteps*}
%   \resetpfcounter
% \item[\text{(\ref{rule:patType-inj})}] ~
%   \begin{pfsteps*}
%     \item $p=\aeinjp{\ell}{p'}$ \BY{assumption}
%     \item $\Cof{p}=\aceinjp{\ell}{\Cof{p'}}$ \BY{definition of $\Cof{p}$}
%     \item $\tau=\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}$ \BY{assumption}
%     \item $\patType{\emptyset}{p'}{\tau'}$ \BY{assumption}\pflabel{patType}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\Cof{p'}}{p'}{\tau'}$ \BY{IH on \pfref{patType}}\pflabel{cvalidP}
%     \item $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\uDelta}{\uPhi}{b}}{\aceinjp{\ell}{\Cof{p'}}}{\aeinjp{\ell}{p'}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}}$ \BY{Rule (\ref{rule:cvalidP-UP-in}) on \pfref{cvalidP}}
%   \end{pfsteps*}
%   \resetpfcounter
% \end{byCases}
% \end{proof}

% \subsubsection{Expressibility}
% The following lemma establishes that each well-typed expanded pattern can be expressed as an unexpanded pattern matching values of the same type and generating the same hypotheses and corresponding identifier updates. The metafunction $\Uof{\pctx}$ maps $\pctx$ to an unexpanded typing context as follows:
% \begin{align*}
% \Uof{\emptyset} & = \uGG{\emptyset}{\emptyset}\\
% \Uof{\pctx, x : \tau} & = \Uof{\pctx}, \uGhyp{\sigilof{x}}{x}{\tau}\\
% \Uof{\Gconsi{i \in \labelset}{\pctx_i}} & = \Gconsi{i \in \labelset}{\Uof{\pctx_i}}
% \end{align*}
% \begin{lemma}[Pattern Expressibility]\label{lemma:pattern-expressibility} If $\patType{\pctx}{p}{\tau}$ then $\patExpands{\Uof{\pctx}}{\uPhi}{\Uof{p}}{p}{\tau}$.\end{lemma}
% \begin{proof} By rule induction over Rules (\ref{rules:patType}), using the definitions of $\Uof{\pctx}$ and $\Uof{p}$ given above. In each case, we can apply the IH to or over each premise, then apply the corresponding rule in Rules (\ref{rules:patExpands}).\end{proof}

% We can now establish the Expressibility Theorem -- that each well-typed expanded expression, $e$, can be expressed as an unexpanded expression, $\ue$, and assigned the same type under the corresponding contexts.

% \begin{theorem}[Expressibility] Both of the following hold:
% \begin{enumerate}
% \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\expandsUP{\Uof{\Delta}}{\Uof{\Gamma}}{\uPsi}{\uPhi}{\Uof{e}}{e}{\tau}$.
% \item If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ then $\ruleExpands{\Uof{\Delta}}{\Uof{\Gamma}}{\uPsi}{\uPhi}{\Uof{r}}{r}{\tau}{\tau'}$.
% \end{enumerate}
% \end{theorem}
% \begin{proof} By mutual rule induction over Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}). 

% For part 1, we induct on the assumption. The rule transformation defined above guarantees that this part holds by its construction. In particular, in each case, we can apply Lemma \ref{lemma:type-expressibility} to or over each type formation premise, the IH (part 1) to or over each typing premise, the IH (part 2) over each rule typing premise, then apply the corresponding rule in Rules (\ref{rules:expandsUP}).

% For part 2, we induct on the assumption. There is only one case:
% \begin{byCases}
% \item[(\ref{rule:ruleType})] ~
% \begin{pfsteps*}
% \item $r = \aematchrule{p}{e}$ \BY{assumption}
% \item $\patType{\pctx}{p}{\tau}$ \BY{assumption} \pflabel{patType}
% \item $\hastypeU{\Delta}{\Gamma \cup \pctx}{e}{\tau'}$ \BY{assumption} \pflabel{hasType}
% \item $\Uof{\Gamma}=\uGG{\uG}{\Gamma}$, for some $\uG$ \BY{definition of $\Uof{\Gamma}$}
% \item $\Uof{\pctx} =\uGG{\uG'}{\pctx}$, for some $\uG'$ \BY{definition of $\Uof{\pctx}$}
% \item $\Uof{\Gamma \cup \pctx} = \uGG{\uG \uplus \uG'}{\Gamma \cup \pctx}$ \BY{definition of $\Uof{\pctx}$}
% \item $\Uof{r} = \aumatchrule{\Uof{p}}{\Uof{e}}$ \BY{definition of $\Uof{r}$}
% \item $\patExpands{\uGG{\uG'}{\pctx}}{\uPhi}{\Uof{p}}{p}{\tau}$ \BY{Lemma \ref{lemma:pattern-expressibility} on \pfref{patType}} \pflabel{patExpands}
% \item $\expandsUP{\uDelta}{\uGG{\uGcons{\uG}{\uG'}}{\Gcons{\Gamma}{\pctx}}}{\uPsi}{\uPhi}{\Uof{e}}{e}{\tau'}$ \BY{IH, part 1 on \pfref{hasType}} \pflabel{expandsUP}
% \item $\ruleExpands{\Uof{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\aumatchrule{\Uof{p}}{\Uof{e}}}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleExpands}) on \pfref{patExpands} and \pfref{expandsUP}}
% \end{pfsteps*}
% \resetpfcounter
% \end{byCases}
% \end{proof}

\subsection{Reasoning Principles}
The following theorem, together with Theorem \ref{thm:typed-expansion-short-U}, establishes \textbf{Typing}, \textbf{Segmentation} and \textbf{Context Independence} as discussed in Sec. \ref{sec:uetsms-validation}.

\begin{theorem}[Typing, Segmentation and Context Independence]
\label{thm:tsc-B}
If $\expandsSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\utsmap{\tsmv}{b}}{e}{\tau}$ then:
\begin{enumerate}
\item (\textbf{Typing}) $\uPsi = \uPsi', \uShyp{\tsmv}{a}{\tau}{\eparse}$
\item $\encodeBody{b}{\ebody}$
\item $\evalU{\ap{\eparse}{\ebody}}{\lbltxt{SuccessE}\cdot\ecand}$
\item $\decodeCondE{\ecand}{\ce}$
\item (\textbf{Segmentation}) $\segOK{\segof{\ce}}{b}$
\item (\textbf{Context Independence}) $\cvalidE{\emptyset}{\emptyset}{\esceneSG{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ 
\end{enumerate}
\end{theorem}
\begin{proof} By rule induction over Rules (\ref{rules:expandsU}). The only rule that applies is Rule (\ref{rule:expandsU-tsmap}). The conclusions of the theorem are the premises of this rule.
\end{proof}

The following theorem establishes a prohibition on \textbf{Shadowing} as discussed in Sec. \ref{sec:uetsms-validation}.

\begin{theorem}[Shadowing Prohibition]
\label{thm:shadowing-prohibition-SES} ~
\begin{enumerate}
\item If $\cvalidT{\Delta}{\tsceneU{\uDD{\uD}{\Delta_\text{app}}}{b}}{\acesplicedt{m}{n}}{\tau}$ then:\begin{enumerate}
\item $\parseUTyp{\bsubseq{b}{m}{n}}{\utau}$
\item $\expandsTU{\uDD{\uD}{\Delta_\text{app}}}{\utau}{\tau}$
\item $\Delta \cap \Delta_\text{app} = \emptyset$
\end{enumerate}
\item If $\cvalidE{\Delta}{\Gamma}{\escenev}{\acesplicede{m}{n}{\ctau}}{e}{\tau}$ then:
\begin{enumerate}
\item $\cvalidT{\emptyset}{\tsfrom{\escenev}}{\ctau}{\tau}$
\item $  \escenev=\esceneU{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{b}$
\item $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$
\item $\expandsU{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\ue}{e}{\tau}$
\item $\Delta \cap \Delta_\text{app} = \emptyset$
\item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset$
\end{enumerate}
\end{enumerate}
\end{theorem}
\begin{proof} ~
\begin{enumerate}
\item By rule induction over Rules (\ref{rules:cvalidT-U}). The only rule that applies is Rule (\ref{rule:cvalidT-U-splicedt}). The conclusions are the premises of tihs rule.
\item By rule induction over Rules (\ref{rules:cvalidE-U}). The only rule that applies is Rule (\ref{rule:cvalidE-U-splicede}). The conclusions are the premises of tihs rule.
\end{enumerate}
\end{proof}

\begin{grayparbox}
The following theorem, together with Theorem \ref{thm:typed-pattern-expansion} part 1, establishes \textbf{Typing} and \textbf{Segmentation}, as discussed in Sec. \ref{sec:ptsms-validation}.

\begin{theorem}[spTSM Typing and Segmentation]
\label{thm:spTSM-Typing-Segmentation-B}
If $\patExpands{\upctx}{\uPhi}{\utsmap{\tsmv}{b}}{p}{\tau}$ then 
\begin{enumerate}
        \item (\textbf{Typing}) $\uPhi=\uPhi', \uPhyp{\tsmv}{a}{\tau}{\eparse}$
        \item $\encodeBody{b}{\ebody}$
        \item $\evalU{\eparse(\ebody)}{{\lbltxt{SuccessP}}\cdot{\ecand}}$
        \item $\decodeCEPat{\ecand}{\cpv}$
        \item (\textbf{Segmentation}) $\segOK{\segof{\cpv}}{b}$
\end{enumerate}
\end{theorem}
\begin{proof} By rule induction over Rules (\ref{rules:patExpands}). The only rule that applies is Rule (\ref{rule:patExpands-apuptsm}). The conclusions are premises of this rule.
\end{proof}
\end{grayparbox}

% \subsubsection{Candidate Expansion Expressibility}
% The following lemma establishes that each well-typed expanded expression, $e$, can be expressed as a valid ce-expression, $\Cof{e}$, that synthesizes the same type under the same contexts and any expression splicing scene.
% \begin{theorem}[Candidate Expansion Expression Expressibility]\label{lemma:ce-expressions-expressibility-B} Both of the following hold:
% \begin{enumerate}
% \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\csyn{\Delta}{\Gamma}{\escenev}{\Cof{e}}{e}{\tau}$.
% \item If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ then $\crsyn{\Delta}{\Gamma}{\escenev}{\Cof{r}}{r}{\tau}{\tau'}$.
% \end{enumerate}
% \end{theorem}
% \begin{proof} By mutual rule induction over Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}). In each case, we apply the IH, part 1 to or over each typing premise, the IH, part 2 over each rule typing premise, Lemma \ref{lemma:ce-type-expressibility-U} to or over each type formation premise and then derive the conclusion by applying Rules (\ref{rules:csyn}) and Rule (\ref{rule:crsyn}) as needed.
% \end{proof}

% The following lemma establishes that every well-typed expanded pattern that generates no hypotheses can be expressed as a ce-pattern.
% \begin{lemma}[Candidate Expansion Pattern Expressibility]\label{lemma:ce-pattern-expressibility-B} If $\patType{\emptyset}{p}{\tau}$ then $\cvalidP{\uGG{\emptyset}{\emptyset}}{\pscene{\Delta}{\uPhi}{b}}{\Cof{p}}{p}{\tau}$.\end{lemma}
% \begin{proof} The proof is nearly identical to the proof of Lemma \ref{lemma:ce-pattern-expressibility-U}, differing only in that each mention of a rule in Rules (\ref{rules:cvalidP-UP}) is replaced by a mention of the corresponding rule in Rules (\ref{rules:cvalidP-B}).
% \end{proof}

% \subsubsection{Outer Surface Expressibility}
% The following lemma establishes that each well-typed expanded pattern can be expressed as an unexpanded pattern matching values of the same type and generating the same hypotheses and corresponding sigil updates. The metafunction $\Uof{\pctx}$ was defined in \ref{sec:typed-expansion-UP}.
% \begin{lemma}[Pattern Expressibility]\label{lemma:pattern-expressibility-B} If $\patType{\pctx}{p}{\tau}$ then $\patExpands{\Uof{\pctx}}{\uPhi}{\Uof{p}}{p}{\tau}$.\end{lemma}
% \begin{proof} By rule induction over Rules (\ref{rules:patType}), using the definitions of $\Uof{\pctx}$ and $\Uof{p}$. In each case, we can apply the IH to or over each premise, then apply the corresponding rule in Rules (\ref{rules:patExpands-B}).\end{proof}

% We can now establish the Expressibility Theorem -- that each well-typed expanded expression, $e$, can be expressed as an unexpanded expression, $\ue$, which synthesizes the same type under the corresponding contexts.

% \begin{theorem}[Expressibility] Both of the following hold:
% \begin{enumerate}
% \item If $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ then $\esyn{\Uof{\Delta}}{\Uof{\Gamma}}{\uPsi}{\uPhi}{\Uof{e}}{e}{\tau}$.
% \item If $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$ then $\rsyn{\Uof{\Delta}}{\Uof{\Gamma}}{\uPsi}{\uPhi}{\Uof{r}}{r}{\tau}{\tau'}$.
% \end{enumerate}
% \end{theorem}
% \begin{proof} By mutual rule induction over Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}) using the definitions of $\Uof{\Delta}$, $\Uof{\Gamma}$, $\Uof{e}$ and $\Uof{r}$. In each case, we apply the IH, part 1 to or over each typing premise, the IH, part 2 over each rule typing premise, Lemma \ref{lemma:type-expressibility} to or over each type formation premise, Lemma \ref{lemma:pattern-expressibility-B} to each pattern typing premise, then derive the conclusion by applying Rules (\ref{rules:esyn}) and Rule (\ref{rule:rsyn}).  
% \end{proof} 

% \chapter{Parametric Implicits}
% ...

% \subsubsection{Kinds and Constructors}
% Kind expansion

% \begin{subequations}\label{rules:kExpands}
% \begin{equation}\label{rule:kExpands-darr}
% \inferrule{
%   \kExpandsX{\ukappa_1}{\kappa_1}\\
%   \kExpands{\uOmega, \uKhyp{\uu}{u}{\kappa_1}}{\ukappa_2}{\kappa_2}
% }{
%   \kExpandsX{\kdarr{\uu}{\ukappa_1}{\ukappa_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \begin{equation}\label{rule:kExpands-unit}
% \inferrule{ }{
%   \kExpandsX{\kunit}{\akunit}
% }
% \end{equation}
% \begin{equation}\label{rule:kExpands-dprod}
% \inferrule{
%   \kExpandsX{\ukappa_1}{\kappa_1}\\
%   \kExpands{\uOmega, \uKhyp{\uu}{u}{\kappa_1}}{\ukappa_2}{\kappa_2}
% }{
%   \kExpandsX{\kdbprod{\uu}{\ukappa_1}{\ukappa_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \begin{equation}\label{rule:kExpands-ty}
% \inferrule{ }{
%   \kExpandsX{\kty}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:kExpands-sing}
% \inferrule{
%   \kanaX{\utau}{\tau}{\akty}
% }{
%   \kExpandsX{\ksing{\utau}}{\aksing{\tau}}
% }
% \end{equation}
% \end{subequations}

% Synthetic constructor expansion
% \begin{subequations}\label{rules:ksyn}
% \begin{equation}\label{rule:ksyn-var}
% \inferrule{ }{\ksyn{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\uu}{u}{\kappa}}
% \end{equation}
% \begin{equation}\label{rule:ksyn-asc}
% \inferrule{
%   \kExpandsX{\ukappa}{\kappa}\\
%   \kanaX{\uc}{c}{\kappa}
% }{
%   \ksynX{\casc{\uc}{\ukappa}}{c}{\kappa}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-app}
% \inferrule{
%   \ksynX{\uc_1}{c_1}{\akdarr{\kappa_2}{u}{\kappa}}\\
%   \kanaX{\uc_2}{c_2}{\kappa_2}
% }{
%   \ksynX{\capp{\uc_1}{\uc_2}}{\acapp{c_1}{c_2}}{[c_1/u]\kappa}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-unit}
% \inferrule{ }{
%   \ksynX{\ctriv}{\actriv}{\akunit}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-prl}
% \inferrule{
%   \ksynX{\uc}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }{
%   \ksynX{\cprl{\uc}}{\acprl{c}}{\kappa_1}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-prr}
% \inferrule{
%   \ksynX{\uc}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }{
%   \ksynX{\cprr{\uc}}{\acprr{c}}{[\acprl{c}/u]\kappa_2}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-parr}
% \inferrule{
%   \kanaX{\utau_1}{\tau_1}{\akty}\\
%   \kanaX{\utau_2}{\tau_2}{\akty}
% }{
%   \ksynX{\parr{\utau_1}{\utau_2}}{\aparr{\tau_1}{\tau_2}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-all}
% \inferrule{
%   \kExpandsX{\ukappa}{\kappa}\\
%   \kana{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\utau}{\tau}{\akty}
% }{
%   \ksynX{\forallu{\uu}{\ukappa}{\utau}}{\aallu{\kappa}{u}{\tau}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-rec}
% \inferrule{
%   \kana{\uOmega, \uKhyp{\ut}{t}{\akty}}{\utau}{\tau}{\akty}
% }{
%   \ksynX{\rect{\ut}{\utau}}{\arec{t}{\tau}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-prod}
% \inferrule{
%   \{\kanaX{\utau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
% }{
%   \ksynX{\prodt{\mapschema{\utau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-sum}
% \inferrule{
%   \{\kanaX{\utau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
% }{
%   \ksynX{\sumt{\labelset}{\mapschema{\utau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ksyn-stat}
% \inferrule{ }{
%   \ksyn{\uOmega, \uMhyp{\uX}{X}{\asignature{\kappa}{u}{\tau}}}{\mcon{\uX}}{\amcon{X}}{\kappa}
% }
% \end{equation}
% \end{subequations}

% Analytic constructor expansion
% \begin{subequations}\label{rules:kana}
% \begin{equation}\label{rule:kana-subsume}
% \inferrule{
%   \ksynX{\uc}{c}{\kappa_1}\\
%   \ksubX{\kappa_1}{\kappa_2}
% }{
%   \kanaX{\uc}{c}{\kappa_2}
% }
% \end{equation}
% \begin{equation}\label{rule:kana-sing}
% \inferrule{
%   \kanaX{\uc}{c}{\akty}
% }{
%   \kanaX{\uc}{c}{\aksing{c}}
% }
% \end{equation}
% \begin{equation}\label{rule:kana-abs}
% \inferrule{
%   \kana{\uOmega, \uKhyp{\uu}{u}{\kappa_1}}{\uc_2}{c_2}{\kappa_2}
% }{
%   \kanaX{\cabs{\uu}{\uc_2}}{\acabs{u}{c_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \begin{equation}\label{rule:kana-pair}
% \inferrule{
%   \kanaX{\uc_1}{c_1}{\kappa_1}\\
%   \kanaX{\uc_2}{c_2}{[c_1/u]\kappa_2}
% }{
%   \kanaX{\cpair{\uc_1}{\uc_2}}{\acpair{c_1}{c_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \end{subequations}


% \subsubsection{Types, Expressions, Rules and Patterns}
% Type expansion
% \begin{equation}\label{rule:tExpandsP-B}
% \inferrule{
%   \kanaX{\utau}{\tau}{\akty}
% }{
%   \cExpandsX{\utau}{\tau}{\akty}
% }
% \end{equation}

% Synthetic typed expression expansion
% \begin{subequations}\label{rules:esynP}
% \begin{equation}\label{rule:esynP-var}
%   \inferrule{ }{ 
%     \esynP{\uOmega, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ux}{x}{\tau}
%   }
% \end{equation}

% %A \emph{type ascription} can be placed on an unexpanded expression to specify the type that it should be analyzed against. The ascribed type is synthesized if type analysis succeeds.
% \begin{equation}\label{rule:esynP-asc}
%   \inferrule{
%     \cExpandsX{\utau}{\tau}{\akty}\\
%     \eanaPX{\ue}{e}{\tau}
%   }{
%     \esynPX{\asc{\ue}{\utau}}{e}{\tau}
%   }
% \end{equation}

% %We define let-binding of a value in synthetic position primitively in $\miniVerseUB$. The following rule governs such bindings in synthetic position.
% \begin{equation}\label{rule:esynP-let}
%   \inferrule{
%     \esynPX{\ue}{e}{\tau}\\
%     \esynP{\uOmega, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ue'}{e'}{\tau'}
%   }{
%     \esynPX{\letsyn{\ux}{\ue}{\ue'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
%   }
% \end{equation}

% %Functions with an argument type annotation can appear in synthetic position.
% \begin{equation}\label{rule:esynP-lam}
%   \inferrule{
%     \cExpandsX{\utau_1}{\tau_1}{\akty}\\
%     \esynP{\uOmega, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue}{e}{\tau_2}
%   }{
%     \esynPX{\lam{\ux}{\utau_1}{\ue}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
%   }
% \end{equation}

% %Function applications can appear in synthetic position. The argument is analyzed against the argument type synthesized by the function.
% \begin{equation}\label{rule:esynP-ap}
%   \inferrule{
%     \esynPX{\ue_1}{e_1}{\aparr{\tau_2}{\tau}}\\
%     \eanaPX{\ue_2}{e_2}{\tau_2}
%   }{
%     \esynPX{\ap{\ue_1}{\ue_2}}{\aeap{e_1}{e_2}}{\tau}
%   }
% \end{equation}

% %Type lambdas and type applications can appear in synthetic position.
% \begin{equation}\label{rule:esynP-tlam}
%   \inferrule{
%     \kExpandsX{\ukappa}{\kappa}\\
%     \esynP{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\uPsi}{\uPhi}{\ue}{e}{\tau}
%   }{
%     \esynPX{\clam{\uu}{\ukappa}{\ue}}{\aeclam{\kappa}{u}{e}}{\aallu{\kappa}{u}{\tau}}
%   }
% \end{equation}
% \begin{equation}\label{rule:esynP-tap}
%   \inferrule{
%     \esynPX{\ue}{e}{\aallu{\kappa}{u}{\tau}}\\
%     \ksynX{\uc}{c}{\kappa}
%   }{
%     \esynPX{\cAp{\ue}{\uc}}{\aecap{e}{c}}{[c/t]\tau}
%   }
% \end{equation}

% %Unfoldings can appear in synthetic position.
% \begin{equation}\label{rule:esynP-unfold}
%   \inferrule{
%     \esynPX{\ue}{e}{\arec{t}{\tau}}
%   }{
%     \esynPX{\unfold{\ue}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
%   }
% \end{equation}

% %Labeled tuples can appear in synthetic position. Each of the field values are then in synthetic position. 
% \begin{equation}\label{rule:esynP-tpl}
%   \inferrule{
%     \{\esynPX{\ue_i}{e_i}{\tau_i}\}_{i \in \labelset}
%   }{
%     \esynPX{\tpl{\mapschema{\ue}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
%   }
% \end{equation}

% %Fields can be projected out of a labeled tuple in synthetic position.
% \begin{equation}\label{rule:esynP-pr}
%   \inferrule{
%     \esynPX{\ue}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
%   }{
%     \esynPX{\prj{\ue}{\ell}}{\aepr{\ell}{e}}{\tau}
%   }
% \end{equation}

% %Match expressions can appear in synthetic position.
% \begin{equation}\label{rule:esynP-match}
%   \inferrule{
%     n > 0\\
%     \esynPX{\ue}{e}{\tau}\\
%     \{\rsynPX{\urv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
%   }{
%     \esynPX{\matchwith{\ue}{\seqschemaX{\urv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
%   }
% \end{equation}

% \begin{equation}\label{rule:esynP-mval}
%   \inferrule{ }{
%     \esynP{\uOmega, \uMhyp{\uX}{X}{\asignature{\kappa}{u}{\tau}}}{\uPsi}{\uPhi}{\mval{\uX}}{\amval{X}}{[\amcon{X}/u]\tau}
%   }
% \end{equation}

% % ueTSMs can be defined and applied in synthetic position.
% % \begin{equation}\label{rule:esynP-defpetsm}
% % \inferrule{
% %   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
% %   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\\\\
% %   \esynP{\uOmega}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\uI}}{\uPhi}{\ue}{e}{\tau}
% % }{
% %   \esynP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\usyntaxueP{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% % }
% % \end{equation}

% % \begin{equation}\label{rule:esynP-letpetsm}
% % \inferrule{
% %   \tsmexpExpandsExp{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
% %   \esynP{\uOmega}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Psi}{\uI}}{\uPhi}{\ue}{e}{\tau}
% % }{
% %   \esynP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\uletpetsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% % }
% % \end{equation}

% \begin{equation}\label{rule:esynP-apuetsm}
% \inferrule{
%   \uOmega = \uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
%   \uPsi=\uAS{\uA}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\uI}\\\\
%   \tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\aetype{\tau_\text{final}}}\\
%   \tsmexpEvalsExp{\Omega_\text{app}}{\Psi}{\epsilon}{\epsilon_\text{normal}}\\\\
%   \tsmdefof{\epsilon_\text{normal}}=a\\
%   \encodeBody{b}{\ebody}\\
%   \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{SuccessE}}\cdot{e_\text{pproto}}}\\\\
%   \decodePCEExp{e_\text{pproto}}{\pce}\\\\
%   \prepce{\Omega_\text{app}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\pce}{\ce}{\epsilon_\text{normal}}{\aetype{\tau_\text{proto}}}{\omega}{\Omega_\text{params}}\\\\
%   \segOK{\segof{\ce}}{b}\\
%   \canaP{\Omega_\text{params}}{\esceneP{\OParams}{\uOmega}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau_\text{proto}}
% }{
%   \esynP{\uOmega}{\uPsi}{\uPhi}{\utsmap{\uepsilon}{b}}{[\omega]e}{[\omega]\tau_\text{proto}}
% }
% \end{equation}

% % These rules are nearly identical to Rules (\ref{rule:expandsUP-syntax}) and (\ref{rule:expandsUP-tsmap}), differing only in that the typed expansion premises have been replaced by corresponding synthetic typed expansion premises. The premises of these rules can be understood as described in Sections \ref{sec:U-uetsm-definition} and \ref{sec:U-uetsm-application}. The body encoding judgement and candidate expansion expression decoding judgements were characterized in Sec. \ref{sec:typed-expansion-UP}. We discuss candidate expansion validation in Sec. \ref{sec:ce-validation-B} below.

% % To support ueTSM implicits, ueTSM contexts, $\uPsi$, are redefined to take the form $\uASI{\uA}{\Psi}{\uI}$. TSM naming contexts, $\uA$, and ueTSM definition contexts, $\Psi$, were defined in Sec. \ref{sec:typed-expansion-UP}. We write $\uPsi, \uShyp{\tsmv}{a}{\tau}{\eparse}$ when $\uPsi=\uASI{\uA}{\Psi}{\uI}$ as shorthand for \[\uASI{\ctxUpdate{\uA}{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}\]

% % \emph{TSM designation contexts}, $\uI$, are finite functions that map each type $\tau \in \domof{\uI}$ to the \emph{TSM designation} $\designate{\tau}{a}$, for some symbol $a$. We write $\uI \uplus \designate{\tau}{a}$ for the TSM designation context that maps $\tau$ to $\designate{\tau}{a}$ and defers to $\uI$ for all other types (i.e. the previous designation, if any, is updated). 

% % The TSM designation context in the ueTSM context is updated by expressions of ueTSM designation form. Such expressions can appear in synthetic position, where they are governed by the following rule:% We write $\uIOK{\Delta}{\uI}$ when each type in $\uI$ is well-formed assuming $\Delta$.
% %\begin{definition}[TSM Designation Context Well-Formedness] $\uIOK{\Delta}{{\uI}$ iff for each $\designate{\tau}{a}$ we have $\istypeU{\Delta}{\tau}$.\end{definition}

% % \todo{peTSM implicit designation}
% % \begin{equation}\label{rule:esynP-implicite}
% %   \inferrule{
% %     \esyn{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\ue}{e}{\tau'}
% %   }{
% %     \esyn{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\uPhi}{\implicite{\tsmv}{\ue}}{e}{\tau'}
% %   }
% % \end{equation}

% % % Like ueTSMs, upTSMs can be defined in synthetic position.
% % \begin{equation}\label{rule:esynP-syntaxup}
% % \inferrule{
% %   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
% %   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat}}\\\\
% %   \esynP{\uOmega}{\uPsi}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\uI}}{\ue}{e}{\tau}
% % }{
% %   \esynP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\usyntaxup{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% % }
% % \end{equation}


% % \begin{equation}\label{rule:esynP-letpptsm}
% % \inferrule{
% %   \tsmexpExpandsPat{\uOmega}{\uASI{\uA}{\Phi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
% %   \esynP{\uOmega}{\uPsi}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Phi}{\uI}}{\ue}{e}{\tau}
% % }{
% %   \esynP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\uletpptsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% % }
% % \end{equation}

% % % This rule is nearly identical to Rule (\ref{rule:expandsUP-defuptsm}), differing only in that the typed expansion premise has been replaced by the corresponding synthetic typed expansion premise. The premises can be understood as described in Section \ref{sec:uptsm-definition}.

% % % To support upTSM implicits, upTSM contexts, $\uPhi$, are redefined to take the form $\uASI{\uA}{\Phi}{\uI}$. upTSM definition contexts, $\Phi$, were defined in Sec. \ref{sec:uptsm-definition}. We write $\uPhi, \uPhyp{\tsmv}{a}{\tau}{\eparse}$ when $\uPhi=\uASI{\uA}{\Phi}{\uI}$ as shorthand for \[\uASI{\ctxUpdate{\uA}{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI}\]

% % % The TSM designation context in the upTSM context is updated by expressions of upTSM designation form. Such expressions can appear in synthetic position, where they are governed by the following rule:% We write $\uIOK{\Delta}{\uI}$ when each type in $\uI$ is well-formed assuming $\Delta$.
% % %\begin{definition}[TSM Designation Context Well-Formedness] $\uIOK{\Delta}{{\uI}$ iff for each $\designate{\tau}{a}$ we have $\istypeU{\Delta}{\tau}$.\end{definition}
% % \todo{ppTSM implicit designation}
% % \begin{equation}\label{rule:esynP-implicitp}
% %   \inferrule{
% %     \esyn{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau'}
% %   }{
% %     \esyn{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\implicitp{\tsmv}{\ue}}{e}{\tau'}
% %   }
% % \end{equation}
% \end{subequations}


% Analytic typed expression expansion
% \begin{subequations}\label{rules:eanaP}
% % Type analysis subsumes type synthesis, in that when a type can be synthesized for an unexpanded expression, that unexpanded expression can also be analyzed against that type, producing the same expansion. This is expressed by the following \emph{subsumption rule} for unexpanded expressions.
% \begin{equation}\label{rule:eanaP-subsume}
%   \inferrule{
%     \esynPX{\ue}{e}{\tau}\\
%     \issubtypePX{\tau}{\tau'}
%   }{
%     \eanaPX{\ue}{e}{\tau'}
%   }
% \end{equation}

% % Additional rules are needed for certain forms in order to propagate types for analysis into subexpressions, and for forms that can appear only in analytic position.

% % Rule (\ref{rule:esyn-let}) governed value bindings in synthetic position. The following rule governs value bindings in analytic position.
% \begin{equation}\label{rule:eanaP-let}
%   \inferrule{
%     \esynPX{\ue}{e}{\tau}\\
%     \eanaP{\uOmega, \uGhyp{\ux}{x}{\tau}}{\uPsi}{\uPhi}{\ue'}{e'}{\tau'}
%   }{
%     \eanaPX{\letsyn{\ux}{\ue}{\ue'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
%   }
% \end{equation}

% % An unannotated function can appear only in analytic position. The argument type is determined from the type that the unannotated function is being analyzed against. 
% \begin{equation}\label{rule:eanaP-analam}
%   \inferrule{
%     \eanaP{\uOmega, \uGhyp{\ux}{x}{\tau_1}}{\uPsi}{\uPhi}{\ue}{e}{\tau_2}
%   }{
%     \eanaPX{\analam{\ux}{\ue}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
%   }
% \end{equation}

% % Rule (\ref{rule:esyn-tlam}) governed type lambdas in synthetic position. The following rule governs type lambdas in analytic position.
% % \begin{equation}\label{rule:eanaP-tlam}
% %   \inferrule{
% %     \eana{\uDelta, \uDhyp{\ut}{t}}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}
% %   }{
% %     \eanaPX{\clam{\uu}{\ue}}{\aetlam{t}{e}}{\aall{t}{\tau}}
% %   }
% % \end{equation}

% % Values of recursive types can be introduced only in analytic position.
% \begin{equation}\label{rule:eanaP-fold}
%   \inferrule{
%     \eanaPX{\ue}{e}{[\arec{t}{\tau}/t]\tau}
%   }{
%     \eanaPX{\fold{\ue}}{\aefold{e}}{\arec{t}{\tau}}
%   }
% \end{equation}

% % Rule (\ref{rule:esyn-tpl}) governed labeled tuples in synthetic position. The following rule governs labeled tuples in analytic position.
% \begin{equation}\label{rule:eanaP-tpl}
%   \inferrule{
%     \{\eanaPX{\ue_i}{e_i}{\tau_i}\}_{i \in \labelset}
%   }{
%     \eanaPX{\tpl{\mapschema{\ue}{i}{\labelset}}}{\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
%   }
% \end{equation}

% % Values of labeled sum type can appear only in analytic position.
% \begin{equation}\label{rule:eanaP-in}
%   \inferrule{
%     \tau = \asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau'}}\\\\
%     \eanaPX{\ue'}{e'}{\tau'}
%   }{
%     \eanaPX{\inj{\ell}{\ue}}{\aein{\ell}{e'}}{\tau}
%     % \uOmega \vdash_{\uPsi; \uPhi} \left(\shortstack{$\ue \leadsto $\\$\Leftarrow$\vspace{-1.2em}}\right)
%     %\eanaPX{\auanain{\ell}{\ue}}{\aein{\ell}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
%   }
% \end{equation}

% % Rule (\ref{rule:esyn-match}) governed match expressions in synthetic position. The following rule governs match expressions in analytic position.
% \begin{equation}\label{rule:eanaP-match}
%   \inferrule{
%     \esynPX{\ue}{e}{\tau}\\
%     \{\ranaPX{\urv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
%   }{
%     \eanaPX{\matchwith{\ue}{\seqschemaX{\urv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
%   }
% \end{equation}

% % Rule (\ref{rule:esyn-defuetsm}) governed ueTSM definitions in synthetic position. The following rule governs ueTSM definitions in analytic position.
% % \begin{equation}\label{rule:eanaP-defpetsm}
% % \inferrule{
% %   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
% %   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\\\\
% %   \eanaP{\uOmega}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\uI}}{\uPhi}{\ue}{e}{\tau}
% % }{
% %   \eanaP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\usyntaxueP{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% % }
% % \end{equation}

% % \begin{equation}\label{rule:eanaP-letpetsm}
% % \inferrule{
% %   \tsmexpExpandsExp{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
% %   \eanaP{\uOmega}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Psi}{\uI}}{\uPhi}{\ue}{e}{\tau}
% % }{
% %   \eanaP{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\uletpetsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% % }
% % \end{equation}

% % \todo{peTSM implicit designation}
% % Rule (\ref{rule:esyn-implicite}) governed ueTSM designations in synthetic position. The following rule governs ueTSM designations in analytic position.
% % \begin{equation}\label{rule:eanaP-implicite}
% %   \inferrule{
% %     \eana{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\ue}{e}{\tau'}
% %   }{
% %     \eana{\uDelta}{\uGamma}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\uPhi}{\implicite{\tsmv}{\ue}}{e}{\tau'}
% %   }
% % \end{equation}

% % \todo{peTSM implicit application}
% % % An expression of unadorned literal form can appear only in analytic position. The following rule extracts the TSM designated at the type that the expression is being analyzed against from the TSM designation context in the ueTSM context and applies it implicitly, i.e. the premises correspond to those of Rule (\ref{rule:esyn-apuetsm}).
% \begin{equation}\label{rule:eanaP-lit}
%   \inferrule{
%     \encodeBody{b}{\ebody}\\
%     \evalU{\ap{\eparse}{\ebody}}{\inj{\lbltxt{Success}}{\ecand}}\\
%     \decodeCondE{\ecand}{\ce}\\\\
%     \cana{\emptyset}{\emptyset}{\esceneUP{\uDelta}{\uGamma}{\uASI{\uA}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{b}}{\ce}{e}{\tau}
%   }{
%     \eana{\uDelta}{\uGamma}{\uASI{\uA}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\auelit{b}}{e}{\tau}
%   }
% \end{equation}

% % Rule (\ref{rule:esyn-defuptsm}) governed upTSM definitions in synthetic position. The following rule governs upTSM definitions in analytic position.
% % \begin{equation}\label{rule:eanaP-syntaxup}
% % \inferrule{
% %   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
% %   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat}}\\\\
% %   \eanaP{\uOmega}{\uPsi}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\uI}}{\ue}{e}{\tau}
% % }{
% %   \eanaP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\usyntaxup{\tsmv}{\urho}{\eparse}{\ue}}{e}{\tau}
% % }
% % \end{equation}


% % \begin{equation}\label{rule:eanaP-letpptsm}
% % \inferrule{
% %   \tsmexpExpandsPat{\uOmega}{\uASI{\uA}{\Phi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
% %   \eanaP{\uOmega}{\uPsi}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Phi}{\uI}}{\ue}{e}{\tau}
% % }{
% %   \eanaP{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\uletpptsm{\tsmv}{\uepsilon}{\ue}}{e}{\tau}
% % }
% % \end{equation}


% % \todo{ppTSM implicit designation}
% % % Rule (\ref{rule:esyn-implicitp}) governed upTSM designations in synthetic position. The following rule governs upTSM designations in analytic position.
% % \begin{equation}\label{rule:eanaP-implicitp}
% %   \inferrule{
% %     \eana{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau'}
% %   }{
% %     \eana{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA\uplus\vExpands{\tsmv}{a}}{\Phi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI}}{\implicitp{\tsmv}{\ue}}{e}{\tau'}
% %   }
% % \end{equation}

% \end{subequations}

% Synthetic rule expansion
% %The synthetic typed rule expansion judgement is invoked iteratively by Rule (\ref{rule:esyn-match}) to synthesize a type, $\tau'$, from the branch expressions in the rule sequence. This judgement is defined mutually inductively with Rules (\ref{rules:esyn}) and Rules (\ref{rules:eana}) by the following rule. 
% \begin{equation}\label{rule:rsynP}
%   \inferrule{
%     \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}\\
%     \patExpandsP{\uOmegaEx{\emptyset}{\uG'}{\emptyset}{\Omega'}}{\uPhi}{\upv}{p}{\tau}\\
%     \esynP{\uOmegaEx{\uD}{\uG \uplus \uG'}{\uMctx}{\Omega \cup \Omega'}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}
%   }{
%     \rsynP{\uOmega}{\uPsi}{\uPhi}{\matchrule{\upv}{\ue}}{\aematchrule{p}{e}}{\tau}{\tau'}
%   }
% \end{equation}

% Analytic rule expansion
% %The analytic typed rule expansion judgement is invoked iteratively by Rule (\ref{rule:eana-match}). This judgement is defined mutually inductively with Rules (\ref{rules:esyn}), Rules (\ref{rules:eana}), and Rule (\ref{rule:rsyn}) by the following rule, which is the analytic analag of Rule (\ref{rule:rsyn}).
% \begin{equation}\label{rule:ranaP}
%   \inferrule{
%     \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}\\
%     \patExpandsP{\uOmegaEx{\emptyset}{\uG'}{\emptyset}{\Omega'}}{\uPhi}{\upv}{p}{\tau}\\
%     \eanaP{\uOmegaEx{\uD}{\uG \uplus \uG'}{\uMctx}{\Omega \cup \Omega'}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}
%   }{
%     \ranaP{\uOmega}{\uPsi}{\uPhi}{\matchrule{\upv}{\ue}}{\aematchrule{p}{e}}{\tau}{\tau'}
%   }
% \end{equation}

% %The premises of these rules can be understood as described in Sec. \ref{sec:typed-expansion-UP}.% We will define typed pattern expansion below.

% Typed pattern expansion
% % The typed pattern expansion judgement is inductively defined by Rules (\ref{rules:patExpandsP}) as follows. %As in $\miniVersePat$, \emph{unexpanded pattern typing contexts}, $\upctx$, are defined identically to unexpanded typing contexts (i.e. we only use a distinct metavariable to emphasize their distinct roles in the judgements above). 

% % The following rules are written identically to the typed pattern expansion rules for shared pattern forms in $\miniVersePat$, i.e. Rules (\ref{rule:patExpands-var}) through (\ref{rule:patExpands-in}).
% \begin{subequations}\label{rules:patExpandsP-B}
% \begin{equation}\label{rule:patExpandsP-B-subsume}
% \inferrule{
%   \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}\\\\
%   \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau}\\
%   \issubtypeP{\Omega}{\tau}{\tau'}
% }{
%   \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau'}
% }
% \end{equation}
% \begin{equation}\label{rule:patExpandsP-B-var}
% \inferrule{ }{
%   \patExpandsP{\uOmegaEx{\emptyset}{\vExpands{\ux}{x}}{\emptyset}{\Ghyp{x}{\tau}}}{\uPhi}{\ux}{x}{\tau}
% }
% \end{equation}
% \begin{equation}\label{rule:patExpandsP-B-wild}
% \inferrule{ }{
%   \patExpandsP{\uOmegaEx{\emptyset}{\emptyset}{\emptyset}{\emptyset}}{\uPhi}{\wildp}{\aewildp}{\tau}
% }
% \end{equation}
% \begin{equation}\label{rule:patExpandsP-B-fold}
% \inferrule{ 
%   \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{[\arec{t}{\tau}/t]\tau}
% }{
%   \patExpandsP{\uOmega'}{\uPhi}{\foldp{\upv}}{\aefoldp{p}}{\arec{t}{\tau}}
% }
% \end{equation}
% \begin{equation}\label{rule:patExpandsP-B-tpl}
% \inferrule{
%   \tau=\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}\\\\
%   \{\patExpandsP{{\uOmega_i}}{\uPhi}{\upv_i}{p_i}{\tau_i}\}_{i \in \labelset}
% }{
%   %\patExpandsP{\Gconsi{i \in \labelset}{\upctx_i}}{A}{B}{C}
%   \patExpandsP{\Gconsi{i \in \labelset}{\uOmega_i}}{\uPhi}{\tplp{\mapschema{\upv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}}{\tau}
%   % \patExpands{\Gconsi{i \in \labelset}{\pctx_i}}{\Phi}{
%   %   \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}
%   % }{
%   %   \aetplp{\labelset}{\mapschema{p}{i}{\labelset}}
%   % }{
%   %   \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}
%   % } %{\autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}}{\aetplp{\labelset}{\mapschema}{p}{i}{\labelset}}{...}
%   %\left(\shortstack{$\Delta \vdash_{\uPhi} \autplp{\labelset}{\mapschema{\upv}{i}{\labelset}}$\\$\leadsto$\\$\aetplp{\labelset}{\mapschema{p}{i}{\labelset}} : \aprod{\labelset}{\mapschema{\tau}{i}{\labelset}} \dashV \Gconsi{i \in \labelset}{\upctx_i}$\vspace{-1.2em}}\right)
% }
% \end{equation}
% \begin{equation}\label{rule:patExpandsP-B-in}
% \inferrule{
%   \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau}
% }{
%   \patExpandsP{\uOmega'}{\uPhi}{\injp{\ell}{\upv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
% }
% \end{equation}

% \begin{equation}\label{rule:patExpandsP-B-apuptsm}
% \inferrule{
%   \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
%   \uPhi=\uASI{\uA}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\uI}\\\\
%   \tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aetype{\tau_\text{final}}}\\
%   \tsmdefof{\epsilon}=a\\\\
%   \encodeBody{b}{\ebody}\\
%   \evalU{\ap{\eparse}{\ebody}}{{\lbltxt{Success}}\cdot{\ecand}}\\
%   \decodeCEPat{\ecand}{\cpv}\\\\
%   \prepcp{\Omega_\text{app}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\pcp}{\cpv}{\epsilon}{\aetype{\tau_\text{cand}}}{\omega}{\Omega_\text{params}}\\\\
%   \cvalidPP{\uOmega'}{\psceneP{\uOmega}{\uPhi}{b}}{\cpv}{p}{\tau_\text{cand}}
% }{
%   \patExpandsP{\uOmega'}{\uPhi}{\utsmap{\uepsilon}{b}}{p}{[\omega]\tau_\text{cand}}
% }
% \end{equation}

% \todo{ppTSM implicit application}
% % Unexpanded patterns of unadorned literal form are governed by the following rule, which extracts the designated upTSM from the upTSM context and applies it implicitly, i.e. the premises correspond to those of Rule (\ref{rule:patExpandsP-apuptsm}).
% \begin{equation}\label{rule:patExpandsP-B-lit}
% \inferrule{
%   \encodeBody{b}{\ebody}\\
%   \evalU{\ap{\eparse}{\ebody}}{\inj{\lbltxt{Success}}{\ecand}}\\
%   \decodeCEPat{\ecand}{\cpv}\\\\
%   \cvalidPP{\uOmega}{\pscene{\uDelta}{\uASI{\uA}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI, \designate{\tau}{a}}}{b}}{\cpv}{p}{\tau}
% }{
%   \patExpands{\uOmega}{\uASI{\uA}{\Phi, \xuptsmbnd{a}{\tau}{\eparse}}{\uI, \designate{\tau}{a}}}{\lit{b}}{p}{\tau}
% }
% \end{equation}

% \end{subequations}


% \subsubsection{Unexpanded Signatures and Module Expressions}
% Signature expansion
% \begin{equation}\label{rule:sigExpandsP-B}
% \inferrule{
%   \kExpandsX{\ukappa}{\kappa}\\
%   \cExpands{\uOmega, \uKhyp{\uu}{u}{\kappa}}{\utau}{\tau}{\akty}
% }{
%   \sigExpandsPX{\signature{\uu}{\ukappa}{\utau}}{\asignature{\kappa}{u}{\tau}}
% }
% \end{equation}

% Synthetic module expression expansion
% \begin{subequations}\label{rules:msyn}
% \begin{equation}\label{rule:msyn-var}
% \inferrule{ }{
%   \msyn{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPsi}{\uPhi}{\uX}{X}{\sigma}
% }
% \end{equation}
% \begin{equation}\label{rule:msyn-seal}
% \inferrule{
%   \sigExpandsPX{\usigma}{\sigma}\\
%   \manaX{\uM}{M}{\sigma}
% }{
%   \msynX{\seal{\uM}{\usigma}}{\aseal{\sigma}{M}}{\sigma} 
% }
% \end{equation}
% \begin{equation}\label{rule:msyn-mlet}
% \inferrule{
%   \msynX{\uM}{M}{\sigma}\\
%   \sigExpandsPX{\usigma'}{\sigma'}\\\\
%   \mana{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPsi}{\uPhi}{\uM'}{M'}{\sigma'}
% }{
%   \msynX{\mlet{\uX}{\uM}{\uM'}{\usigma'}}{\amlet{\sigma'}{M}{X}{M'}}{\sigma'}
% }
% \end{equation}
% \begin{equation}\label{rule:msyn-syntaxpe}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\\\\
%   \msyn{\uOmega}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\uI}}{\uPhi}{\uM}{M}{\sigma}
% }{
%   \msyn{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\usyntaxueP{\tsmv}{\urho}{\eparse}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \begin{equation}\label{rule:msyn-letpetsm}
% \inferrule{
%   \tsmexpExpandsExp{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \msyn{\uOmega}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Psi}{\uI}}{\uPhi}{\uM}{M}{\sigma}
% }{
%   \msyn{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\uletpetsm{\tsmv}{\uepsilon}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \todo{peTSM implicit designation at module level}
% \begin{equation}\label{rule:msyn-implicitpe}
% \inferrule{
%   ...
% }{
%   ...
% }
% \end{equation}
% \begin{equation}\label{rule:msyn-syntaxpp}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat}}\\\\
%   \msyn{\uOmega}{\uPsi}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\uI}}{\uM}{M}{\sigma}
% }{
%   \msyn{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\usyntaxup{\tsmv}{\urho}{\eparse}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \begin{equation}\label{rule:msyn-letpptsm}
% \inferrule{
%   \tsmexpExpandsPat{\uOmega}{\uASI{\uA}{\Phi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \msyn{\uOmega}{\uPsi}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Phi}{\uI}}{\uM}{M}{\sigma}
% }{
%   \msyn{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\uletpptsm{\tsmv}{\uepsilon}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \todo{ppTSM implicit designation at module level}
% \begin{equation}\label{rule:msyn-implicitpp}
% \inferrule{
%   ...
% }{
%   ...
% }
% \end{equation}
% \end{subequations}

% Analytic module expression expansion
% \begin{subequations}\label{rules:mana}
% \begin{equation}\label{rule:mana-subsumes}
% \inferrule{
%   \msynX{\uM}{M}{\sigma}\\
%   \sigsub{\uOmega}{\sigma}{\sigma'}
% }{
%   \manaX{\uM}{M}{\sigma'}
% }
% \end{equation}
% \begin{equation}\label{rule:mana-struct}
% \inferrule{
%   \kanaX{\uc}{c}{\kappa}\\
%   \eanaPX{\ue}{e}{[c/u]\tau}
% }{
%   \manaX{\struct{\uc}{\ue}}{\astruct{c}{e}}{\asignature{\kappa}{u}{\tau}}
% }
% \end{equation}
% \begin{equation}\label{rule:mana-syntaxpe}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultPCEExp}}\\\\
%   \mana{\uOmega}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\uI}}{\uPhi}{\uM}{M}{\sigma}
% }{
%   \mana{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\usyntaxueP{\tsmv}{\urho}{\eparse}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \begin{equation}\label{rule:mana-letpetsm}
% \inferrule{
%   \tsmexpExpandsExp{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \mana{\uOmega}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Psi}{\uI}}{\uPhi}{\uM}{M}{\sigma}
% }{
%   \mana{\uOmega}{\uASI{\uA}{\Psi}{\uI}}{\uPhi}{\uletpetsm{\tsmv}{\uepsilon}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \todo{peTSM implicit designation at module level}
% \begin{equation}\label{rule:mana-implicitpe}
% \inferrule{
%   ...
% }{
%   ...
% }
% \end{equation}
% \begin{equation}\label{rule:mana-syntaxpp}
% \inferrule{
%   \tsmtyExpands{\uOmega}{\urho}{\rho}\\
%   \hastypeP{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultCEPat}}\\\\
%   \mana{\uOmega}{\uPsi}{\uASI{\uA \uplus \mapitem{\tsmv}{\adefref{a}}}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\uI}}{\uM}{M}{\sigma}
% }{
%   \mana{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\usyntaxup{\tsmv}{\urho}{\eparse}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \begin{equation}\label{rule:mana-letpptsm}
% \inferrule{
%   \tsmexpExpandsPat{\uOmega}{\uASI{\uA}{\Phi}{\uI}}{\uepsilon}{\epsilon}{\rho}\\
%   \mana{\uOmega}{\uPsi}{\uASI{\uA\uplus\mapitem{\tsmv}{\epsilon}}{\Phi}{\uI}}{\uM}{M}{\sigma}
% }{
%   \mana{\uOmega}{\uPsi}{\uASI{\uA}{\Phi}{\uI}}{\uletpptsm{\tsmv}{\uepsilon}{\uM}}{M}{\sigma}
% }
% \end{equation}
% \todo{ppTSM implicit designation at module level}
% \begin{equation}\label{rule:mana-implicitpp}
% \inferrule{
%   ...
% }{
%   ...
% }
% \end{equation}
% \end{subequations}

% \subsubsection{TSM Types and Expressions}
% TSM Expression Typing

% \vspace{10px}
% $\begin{array}{ll}
% \textbf{Judgement Form} & \textbf{Description}\\
% \istsmty{\Omega}{\rho} & \text{$\rho$ is a well-formed TSM type}\\
% \hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho} & \text{peTSM expression $\epsilon$ has TSM type $\rho$}\\
% \hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho} & \text{ppTSM expression $\epsilon$ has TSM type $\rho$}
% \end{array}$
% \vspace{10px}

% peTSM Expression Evaluation

% \vspace{10px}
% $\begin{array}{ll}
% \textbf{Judgement Form} & \textbf{Description}\\
% \tsmexpNormalExp{\Omega}{\Psi}{\epsilon} & \text{peTSM expression $\epsilon$ is in normal form}\\
% \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'} & \text{peTSM expression $\epsilon$ transitions to $\epsilon'$}\\
% \end{array}$
% \vspace{10px}

% + auxiliary judgements for multi-step transitions and evaluation

% unexpanded TSM types and expressions

% \vspace{10px}
% $\begin{array}{ll}
% \textbf{Judgement Form} & \textbf{Description}\\
% \tsmtyExpands{\uOmega}{\urho}{\rho} & \text{$\urho$ has expansion $\rho$}\\
% \tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\rho} & \text{unexpanded peTSM expression $\uepsilon$ has expansion $\epsilon$ and type $\rho$}\\
% \tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\rho} & \text{unexpanded ppTSM expression $\uepsilon$ has expansion $\epsilon$ and type $\rho$}
% \end{array}$
% \vspace{10px}

% TSM type formation
% \begin{subequations}\label{rules:istsmty-B}
% \begin{equation}\label{rule:istsmty-B-type}
% \inferrule{
%   \haskindX{\tau}{\akty}
% }{
%   \istsmty{\Omega}{\aetype{\tau}}
% }
% \end{equation}
% \begin{equation}\label{rule:istsmty-B-alltypes}
% \inferrule{
%   \istsmty{\Omega, t :: \akty}{\rho}
% }{
%   \istsmty{\Omega}{\aealltypes{t}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:istsmty-B-allmods}
% \inferrule{
%   \issig{\Omega}{\sigma}\\
%   \istsmty{\Omega, X : \sigma}{\rho}
% }{
%   \istsmty{\Omega}{\aeallmods{\sigma}{X}{\rho}}
% }
% \end{equation}
% \end{subequations}

% Unexpanded TSM type expansion
% \begin{subequations}\label{rules:tsmtyExpands-B}
% \begin{equation}\label{rule:tsmtyExpands-B-type}
% \inferrule{
%   \cExpandsX{\utau}{\tau}{\akty}
% }{
%   \tsmtyExpands{\uOmega}{{\utau}}{\aetype{\tau}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmtyExpands-B-alltypes}
% \inferrule{
%   \tsmtyExpands{\uOmega, \uKhyp{\ut}{t}{\akty}}{\urho}{\rho}
% }{
%   \tsmtyExpands{\uOmega}{\alltypes{\ut}{\urho}}{\aealltypes{t}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmtyExpands-B-allmods}
% \inferrule{
%   \sigExpandsPX{\usigma}{\sigma}\\
%   \tsmtyExpands{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\urho}{\rho}
% }{
%   \tsmtyExpands{\uOmega}{\allmods{\uX}{\usigma}{\urho}}{\aeallmods{\sigma}{X}{\rho}}
% }
% \end{equation}
% \end{subequations}
% peTSM Expression Typing
% \begin{subequations}\label{rules:hastsmtypeExp-B}
% \begin{equation}\label{rule:hastsmtypeExp-B-defref}
% \inferrule{ }{
%   \hastsmtypeExp{\Omega}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\adefref{a}}{\rho}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypeExp-B-abstype}
% \inferrule{
%   \hastsmtypeExp{\Omega, t :: \akty}{\Psi}{\epsilon}{\rho}
% }{
%   \hastsmtypeExp{\Omega}{\Psi}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypeExp-B-absmod}
% \inferrule{
%   \issigX{\sigma}\\
%   \hastsmtypeExp{\Omega, X : \sigma}{\Psi}{\epsilon}{\rho}
% }{
%   \hastsmtypeExp{\Omega}{\Psi}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypeExp-B-aptype}
% \inferrule{
%   \hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\aealltypes{t}{\rho}}\\
%   \haskindX{\tau}{\akty}
% }{
%   \hastsmtypeExp{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypeExp-B-apmod}
% \inferrule{
%   \hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
%   \hassig{\Omega}{X}{\sigma}
% }{
%   \hastsmtypeExp{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
% }
% \end{equation}
% \end{subequations}

% ppTSM Expression Typing
% \begin{subequations}\label{rules:hastsmtypePat-B}
% \begin{equation}\label{rule:hastsmtypePat-B-defref}
% \inferrule{ }{
%   \hastsmtypePat{\Omega}{\Phi, \pptsmdefn{a}{\rho}{\eparse}}{\adefref{a}}{\rho}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypePat-B-abstype}
% \inferrule{
%   \hastsmtypePat{\Omega, t :: \akty}{\Phi}{\epsilon}{\rho}
% }{
%   \hastsmtypePat{\Omega}{\Phi}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypePat-B-absmod}
% \inferrule{
%   \issigX{\sigma}\\
%   \hastsmtypePat{\Omega, X : \sigma}{\Phi}{\epsilon}{\rho}
% }{
%   \hastsmtypePat{\Omega}{\Phi}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypePat-B-aptype}
% \inferrule{
%   \hastsmtypePat{\Omega}{\Phi}{\epsilon}{\aealltypes{t}{\rho}}\\
%   \haskindX{\tau}{\akty}
% }{
%   \hastsmtypePat{\Omega}{\Phi}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho}
% }
% \end{equation}
% \begin{equation}\label{rule:hastsmtypePat-B-apmod}
% \inferrule{
%   \hastsmtypePat{\Omega}{\Phi}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
%   \hassig{\Omega}{X}{\sigma}
% }{
%   \hastsmtypePat{\Omega}{\Phi}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
% }
% \end{equation}

% \end{subequations}

% peTSM Expression Expansion
% \begin{subequations}\label{rules:tsmexpExpandsExp-B}
% \begin{equation}\label{rule:tsmexpExpandsExp-B-bindref}
% \inferrule{
%   \hastsmtypeExp{\Omega}{\Psi}{\epsilon}{\rho}  
% }{
%   \tsmexpExpandsExp{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uASI{\uA, \mapitem{\tsmv}{\epsilon}}{\Psi}{\uI}}{{\tsmv}}{\epsilon}{\rho}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsExp-B-abstype}
% \inferrule{
%   \tsmexpExpandsExp{\uOmega, \uKhyp{\ut}{t}{\akty}}{\uPsi}{\uepsilon}{\epsilon}{\rho}
% }{
%   \tsmexpExpandsExp{\uOmega}{\uPsi}{\abstype{\ut}{\uepsilon}}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsExp-B-absmod}
% \inferrule{
%   \sigExpandsPX{\usigma}{\sigma}\\
%   \tsmexpExpandsExp{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPsi}{\uepsilon}{\epsilon}{\rho}
% }{
%   \tsmexpExpandsExp{\uOmega}{\uPsi}{\absmod{\uX}{\usigma}{\uepsilon}}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsExp-B-aptype}
% \inferrule{
%   \tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\aealltypes{t}{\rho}}\\
%   \cExpandsX{\utau}{\tau}{\akty}
% }{
%   \tsmexpExpandsExp{\uOmega}{\uPsi}{\aptype{\uepsilon}{\utau}}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho} 
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsExp-B-apmod}
% \inferrule{
%   \tsmexpExpandsExp{\uOmega}{\uPsi}{\uepsilon}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
%   \manaX{\uX}{X}{\sigma}
% }{
%   \tsmexpExpandsExp{\uOmega}{\uPsi}{\apmod{\uepsilon}{\uX}}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
% }
% \end{equation}
% \end{subequations}

% ppTSM expression expansion
% \begin{subequations}\label{rules:tsmexpExpandsPat-B}
% \begin{equation}\label{rule:tsmexpExpandsPat-B-bindref}
% \inferrule{
%   \hastsmtypePat{\Omega}{\Phi}{\epsilon}{\rho}  
% }{
%   \tsmexpExpandsPat{\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega}}{\uASI{\uA, \mapitem{\tsmv}{\epsilon}}{\Phi}{\uI}}{{\tsmv}}{\epsilon}{\rho}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsPat-B-abstype}
% \inferrule{
%   \tsmexpExpandsPat{\uOmega, \uKhyp{\ut}{t}{\akty}}{\uPhi}{\uepsilon}{\epsilon}{\rho}
% }{
%   \tsmexpExpandsPat{\uOmega}{\uPhi}{\abstype{\ut}{\uepsilon}}{\aeabstype{t}{\epsilon}}{\aealltypes{t}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsPat-B-absmod}
% \inferrule{
%   \sigExpandsPX{\usigma}{\sigma}\\
%   \tsmexpExpandsPat{\uOmega, \uMhyp{\uX}{X}{\sigma}}{\uPhi}{\uepsilon}{\epsilon}{\rho}
% }{
%   \tsmexpExpandsPat{\uOmega}{\uPhi}{\absmod{\uX}{\usigma}{\uepsilon}}{\aeabsmod{\sigma}{X}{\epsilon}}{\aeallmods{\sigma}{X}{\rho}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsPat-B-aptype}
% \inferrule{
%   \tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aealltypes{t}{\rho}}\\
%   \cExpandsX{\utau}{\tau}{\akty}
% }{
%   \tsmexpExpandsPat{\uOmega}{\uPhi}{\aptype{\uepsilon}{\utau}}{\aeaptype{\tau}{\epsilon}}{[\tau/t]\rho} 
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpExpandsPat-B-apmod}
% \inferrule{
%   \tsmexpExpandsPat{\uOmega}{\uPhi}{\uepsilon}{\epsilon}{\aeallmods{\sigma}{X'}{\rho}}\\
%   \manaX{\uX}{X}{\sigma}
% }{
%   \tsmexpExpandsPat{\uOmega}{\uPhi}{\apmod{\uepsilon}{\uX}}{\aeapmod{X}{\epsilon}}{[X/X']\rho}
% }
% \end{equation}
% \end{subequations}

% peTSM expression normal forms
% \begin{subequations}\label{rules:tsmexpNormalExp-B}
% \begin{equation}\label{rule:tsmexpNormalExp-B-defref}
% \inferrule{ }{
%   \tsmexpNormalExp{\Omega}{\Psi, \petsmdefn{a}{\rho}{\eparse}}{\adefref{a}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpNormalExp-B-abstype}
% \inferrule{ }{
%   \tsmexpNormalExp{\Omega}{\Psi}{\aeabstype{t}{\epsilon}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpNormalExp-B-absmod}
% \inferrule{ }{
%   \tsmexpNormalExp{\Omega}{\Psi}{\aeabsmod{\sigma}{X}{\epsilon}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpNormalExp-B-aptype}
% \inferrule{
%   \epsilon \neq \aeabstype{t}{\epsilon'}\\
%   \tsmexpNormalExp{\Omega}{\Psi}{\epsilon}
% }{
%   \tsmexpNormalExp{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpNormalExp-B-apmod}
% \inferrule{
%   \epsilon \neq \aeabsmod{\sigma}{X'}{\epsilon'}\\
%   \tsmexpNormalExp{\Omega}{\Psi}{\epsilon}
% }{
%   \tsmexpNormalExp{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}
% }
% \end{equation}
% \end{subequations}

% peTSM transitions
% \begin{subequations}\label{rules:tsmexpStepsExp-B}
% \begin{equation}\label{rule:tsmexpStepsExp-B-aptype-1}
% \inferrule{
%   \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
% }{
%   \tsmexpStepsExp{\Omega}{\Psi}{\aeaptype{\tau}{\epsilon}}{\aeaptype{\tau}{\epsilon'}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpStepsExp-B-aptype-2}
% \inferrule{ }{
%   \tsmexpStepsExp{\Omega}{\Psi}{\aeaptype{\tau}{\aeabstype{t}{\epsilon}}}{[\tau/t]\epsilon}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpStepsExp-B-apmod-1}
% \inferrule{
%   \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
% }{
%   \tsmexpStepsExp{\Omega}{\Psi}{\aeapmod{X}{\epsilon}}{\aeapmod{X}{\epsilon'}}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpStepsExp-B-apmod-2}
% \inferrule{ }{
%   \tsmexpStepsExp{\Omega}{\Psi}{\aeapmod{X}{\aeabsmod{\sigma}{X'}{\epsilon}}}{[X/X']\epsilon}
% }
% \end{equation}
% \end{subequations}

% peTSM reflexive, transitive transitions
% \begin{subequations}\label{rules:tsmexpMultistepsExp-B}
% \begin{equation}\label{rule:tsmexpMultistepsExp-B-refl}
% \inferrule{ }{
%   \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpMultistepsExp-B-steps}
% \inferrule{
%   \tsmexpStepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
% }{
%   \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
% }
% \end{equation}
% \begin{equation}\label{rule:tsmexpMultistepsExp-B-trans}
% \inferrule{
%   \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}\\
%   \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon'}{\epsilon''}
% }{
%   \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon''}
% }
% \end{equation}
% \end{subequations}

% peTSM normalization
% \begin{equation}\label{rule:tsmexpEvalsExp-B}
% \inferrule{
%   \tsmexpMultistepsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}\\
%   \tsmexpNormalExp{\Omega}{\Psi}{\epsilon'}
% }{
%   \tsmexpEvalsExp{\Omega}{\Psi}{\epsilon}{\epsilon'}
% }
% \end{equation}

% TSM expression definition extraction

% \begin{subequations}
% \begin{align}
% \tsmdefof{\adefref{a}} & = a\\
% \tsmdefof{\aeabstype{t}{\epsilon}} & = \tsmdefof{\epsilon}\\
% \tsmdefof{\aeabsmod{\sigma}{X}{\epsilon}} & = \tsmdefof{\epsilon}\\
% \tsmdefof{\aeaptype{\tau}{\epsilon}} & = \tsmdefof{\epsilon}\\
% \tsmdefof{\aeapmod{X}{\epsilon}} & = \tsmdefof{\epsilon}
% \end{align}
% \end{subequations}

% \subsubsection{Candidate Expansion Kind and Constructor Validation}
% %The \emph{ce-type validation judgement}, $\cvalidT{\Delta}{\tscenev}{\ctau}{\tau}$, is inductively defined by Rules (\ref{rules:cvalidT-U}), which were defined in Sec. \ref{sec:ce-validation-U}.

% ce-kind validation
% \begin{subequations}\label{rules:cvalidK-B}
% \begin{equation}\label{rule:cvalidK-B-darr}
% \inferrule{
%   \cvalidKX{\cekappa_1}{\kappa_1}\\
%   \cvalidK{\Omega, u :: \kappa_1}{\cscenev}{\cekappa_2}{\kappa_2}
% }{
%   \cvalidKX{\acekdarr{\cekappa_1}{u}{\cekappa_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidK-B-unit}
% \inferrule{ }{
%   \cvalidKX{\acekunit}{\akunit}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidK-B-dprod}
% \inferrule{
%   \cvalidKX{\cekappa_1}{\kappa_1}\\
%   \cvalidK{\Omega, u :: \kappa_1}{\cscenev}{\cekappa_2}{\kappa_2}
% }{
%   \cvalidKX{\acekdbprod{\cekappa_1}{u}{\cekappa_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidK-B-ty}
% \inferrule{ }{
%   \cvalidKX{\acekty}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidK-B-sing}
% \inferrule{
%   \ccanaX{\ctau}{\tau}{\akty}
% }{
%   \cvalidKX{\aceksing{\ctau}}{\aksing{\tau}}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidK-B-spliced}
% \inferrule{
%   \parseUKind{\bsubseq{b}{m}{n}}{\ukappa}\\
%   \kExpands{\uOmega}{\ukappa}{\kappa}\\\\
%   \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
%   \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
% }{
%   \cvalidK{\Omega}{\tsceneP{\uOmega}{b}}{\acesplicedk{m}{n}}{\kappa}
% }
% \end{equation}
% \end{subequations}

% Synthetic ce-constructor validation
% \begin{subequations}\label{rules:ccsyn}
% \begin{equation}\label{rule:ccsyn-var}
% \inferrule{ }{\ccsyn{\Omega, {u} :: {\kappa}}{\cscenev}{u}{u}{\kappa}}
% \end{equation}
% \begin{equation}\label{rule:ccsyn-asc}
% \inferrule{
%   \cvalidKX{\cekappa}{\kappa}\\
%   \ccanaX{\cec}{c}{\kappa}
% }{
%   \ccsynX{\acecasc{\cekappa}{\cec}}{c}{\kappa}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-app}
% \inferrule{
%   \ccsynX{\cec_1}{c_1}{\akdarr{\kappa_2}{u}{\kappa}}\\
%   \ccsynX{\cec_2}{c_2}{\kappa_2}
% }{
%   \ccsynX{\acecapp{\cec_1}{\cec_2}}{\acapp{c_1}{c_2}}{[c_1/u]\kappa}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-unit}
% \inferrule{ }{
%   \ccsynX{\acectriv}{\actriv}{\akunit}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-prl}
% \inferrule{
%   \ccsynX{\cec}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }{
%   \ccsynX{\acecprl{\cec}}{\acprl{c}}{\kappa_1}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-prr}
% \inferrule{
%   \ccsynX{\cec}{c}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }{
%   \ccsynX{\acecprr{\cec}}{\acprr{c}}{[\acprl{c}/u]\kappa_2}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-parr}
% \inferrule{
%   \ccanaX{\ctau_1}{\tau_1}{\akty}\\
%   \ccanaX{\ctau_2}{\tau_2}{\akty}
% }{
%   \ccsynX{\aceparr{\ctau_1}{\ctau_2}}{\aparr{\tau_1}{\tau_2}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-all}
% \inferrule{
%   \cvalidKX{\cekappa}{\kappa}\\
%   \ccana{\Omega, u :: \kappa}{\cscenev}{\ctau}{\tau}{\akty}
% }{
%   \ccsynX{\aceallu{\cekappa}{u}{\ctau}}{\aallu{\kappa}{u}{\tau}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-rec}
% \inferrule{
%   \ccana{\Omega, t :: \akty}{\cscenev}{\ctau}{\tau}{\akty}
% }{
%   \ccsynX{\acerec{t}{\ctau}}{\arec{t}{\tau}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-prod}
% \inferrule{
%   \{\ccanaX{\ctau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
% }{
%   \ccsynX{\aceprod{\labelset}{\mapschema{\ctau}{i}{\labelset}}}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-sum}
% \inferrule{
%   \{\ccanaX{\ctau_i}{\tau_i}{\akty}\}_{1 \leq i \leq n}
% }{
%   \ccsynX{\acesum{\labelset}{\mapschema{\ctau}{i}{\labelset}}}{\asum{\labelset}{\mapschema{\tau}{i}{\labelset}}}{\akty}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-stat}
% \inferrule{ }{
%   \ccsyn{\Omega, X : {\asignature{\kappa}{u}{\tau}}}{\cscenev}{\acemcon{X}}{\amcon{X}}{\kappa}
% }
% \end{equation}
% \begin{equation}\label{rule:ccsyn-spliced}
% \inferrule{
%   \parseUCon{\bsubseq{b}{m}{n}}{\uc}\\
%   \ksyn{\uOmega}{\uc}{c}{\kappa}\\\\
%   \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
%   \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
% }{
%   \ccsyn{\Omega}{\tsceneP{\uOmega}{b}}{\acesplicedc{m}{n}{\cekappa}}{c}{\kappa}
% }
% \end{equation}
% \end{subequations}

% Analytic constructor expansion
% \begin{subequations}\label{rules:ccana}
% \begin{equation}\label{rule:ccana-subsume}
% \inferrule{
%   \ccsynX{\cec}{c}{\kappa_1}\\
%   \ksubX{\kappa_1}{\kappa_2}
% }{
%   \ccanaX{\cec}{c}{\kappa_2}
% }
% \end{equation}
% \begin{equation}\label{rule:ccana-sing}
% \inferrule{
%   \kanaX{\cec}{c}{\akty}
% }{
%   \kanaX{\cec}{c}{\aksing{c}}
% }
% \end{equation}
% \begin{equation}\label{rule:ccana-abs}
% \inferrule{
%   \ccana{\Omega, u :: \kappa_1}{\cscenev}{\cec_2}{c_2}{\kappa_2}
% }{
%   \ccanaX{\acecabs{u}{\cec_2}}{\acabs{u}{c_2}}{\akdarr{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \begin{equation}\label{rule:ccana-pair}
% \inferrule{
%   \ccanaX{\cec_1}{c_1}{\kappa_1}\\
%   \ccanaX{\cec_2}{c_2}{[c_1/u]\kappa_2}
% }{
%   \ccanaX{\acecpair{\cec_1}{\cec_2}}{\acpair{c_1}{c_2}}{\akdbprod{\kappa_1}{u}{\kappa_2}}
% }
% \end{equation}
% \begin{equation}\label{rule:ccana-spliced}
% \inferrule{
%   \parseUCon{\bsubseq{b}{m}{n}}{\uc}\\
%   \kana{\uOmega}{\uc}{c}{\kappa}\\\\
%   \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
%   \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
% }{
%   \ccana{\Omega}{\tsceneP{\uOmega}{b}}{\acesplicedc{m}{n}{\cekappa}}{c}{\kappa}
% }
% \end{equation}
% \end{subequations}

% \subsubsection{Bidirectional Candidate Expansion Expression Validation}
% Like the bidirectionally typed expression expansion judgements, the bidirectional ce-expression validation judgements distinguish type synthesis from type analysis. The \emph{synthetic ce-expression validation judgement}, $\csynX{\ce}{e}{\tau}$, and the \emph{analytic ce-expression validation judgement}, $\canaX{\ce}{e}{\tau}$, are defined mutually inductively with Rules (\ref{rules:esyn}) and Rules (\ref{rules:eana}) by Rules (\ref{rules:csyn}) and Rules (\ref{rules:cana}), respectively, as follows.


% \begin{equation}
% \inferrule{
%   \ccanaX{\ctau}{\tau}{\akty}
% }{
%   \cvalidTP{\Omega}{\cscenev}{\ctau}{\tau}
% }
% \end{equation}

% \paragraph{Type Synthesis} \begin{subequations}\label{rules:csynP}
% Synthetic ce-expression validation is governed by the following rules.
% \begin{equation}\label{rule:csynP-var}
%   \inferrule{ }{ 
%     \csynP{\Omega, \Ghyp{x}{\tau}}{\escenev}{x}{x}{\tau}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-asc}
%   \inferrule{
%     \cvalidTP{\Omega}{\csfrom{\escenev}}{\ctau}{\tau}\\
%     \canaPX{\ce}{e}{\tau}
%   }{
%     \csynPX{\aceasc{\ctau}{\ce}}{e}{\tau}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-let}
%   \inferrule{
%     \csynPX{\ce}{e}{\tau}\\
%     \csynP{\Omega, \Ghyp{x}{\tau}}{\escenev}{\ce'}{e'}{\tau'}
%   }{
%     \csynPX{\aceletsyn{x}{\ce}{\ce'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-lam}
%   \inferrule{
%     \cvalidTP{\Omega}{\csfrom{\escenev}}{\ctau_1}{\tau_1}\\
%     \csynP{\Omega, \Ghyp{x}{\tau_1}}{\escenev}{\ce}{e}{\tau_2}
%   }{
%     \csynPX{\acelam{\ctau_1}{x}{\ce}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-ap}
%   \inferrule{
%     \csynPX{\ce_1}{e_1}{\aparr{\tau_2}{\tau}}\\
%     \canaPX{\ce_2}{e_2}{\tau_2}
%   }{
%     \csynPX{\aceap{\ce_1}{\ce_2}}{\aeap{e_1}{e_2}}{\tau}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-clam}
%   \inferrule{
%     \cvalidK{\Omega}{\csfrom{\escenev}}{\cekappa}{\kappa}\\
%     \csynP{\Omega, u :: \kappa}{\escenev}{\ce}{e}{\tau}
%   }{
%     \csynX{\aceclam{\cekappa}{u}{\ce}}{\aeclam{\kappa}{u}{e}}{\aallu{\kappa}{u}{\tau}}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-cap}
%   \inferrule{
%     \csynPX{\ce}{e}{\aallu{\kappa}{u}{\tau}}\\
%     \ccana{\Omega}{\csfrom{\escenev}}{\cec}{c}{\kappa}
%   }{
%     \csynPX{\acecap{\ce}{\cec}}{\aecap{e}{c}}{[c/u]\tau}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-unfold}
%   \inferrule{
%     \csynPX{\ce}{e}{\arec{t}{\tau}}
%   }{
%     \csynPX{\aceunfold{\ce}}{\aeunfold{e}}{[\arec{t}{\tau}/t]\tau}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-tpl}
%   \inferrule{
%     \ce=\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}\\
%     e=\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}\\\\
%     \{\csynPX{\ce_i}{e_i}{\tau_i}\}_{i \in \labelset}
%   }{
%     \csynPX{\ce}{e}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-pr}
%   \inferrule{
%     \csynPX{\ce}{e}{\aprod{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
%   }{
%     \csynPX{\acepr{\ell}{\ce}}{\aepr{\ell}{e}}{\tau}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-match}
%   \inferrule{
%     n > 0\\
%     \csynPX{\ce}{e}{\tau}\\
%     \{\crsynPX{\crv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
%   }{
%     \csynPX{\acematchwithb{n}{\ce}{\seqschemaX{\crv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
%   }
% \end{equation}
% \begin{equation}\label{rule:csynP-mval}
% \inferrule{ }{
%   \csynP{\Omega, X : \asignature{\kappa}{u}{\tau}}{\escenev}{\acemval{X}}{\amval{X}}{[\amcon{X}/u]\tau}
% }
% \end{equation}
% \begin{equation}\label{rule:csynP-splicede}
% \inferrule{
%   \parseUExp{\bsubseq{b}{m}{n}}{\ue}\\
%   \esynP{\uOmega}{\uPsi}{\uPhi}{\ue}{e}{\tau}\\\\
%   \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
%   \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
% }{
%   \csynP{\Omega}{\esceneP{\OParams}{\uOmega}{\uPsi}{\uPhi}{b}}{\acesplicede{m}{n}{\ctau}}{e}{\tau}
% }
% \end{equation}
% \end{subequations}

% Rules (\ref{rule:csyn-var}) through (\ref{rule:csyn-match}) are analagous to Rules (\ref{rule:esyn-var}) through (\ref{rule:esyn-match}). Rule (\ref{rule:csyn-splicede}) governs references to spliced unexpanded expressions in synthetic position, and can be understood as described in Sec. \ref{sec:ce-validation-U}.


% \paragraph{Type Analysis} \begin{subequations}\label{rules:canaP}
% Analytic ce-expression validation is governed by the following rules.
% \begin{equation}\label{rule:canaP-subsume}
%   \inferrule{
%     \csynPX{\ce}{e}{\tau}\\
%     \issubtypePX{\tau}{\tau'}
%   }{
%     \canaPX{\ce}{e}{\tau'}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-let}
%   \inferrule{
%     \csynPX{\ce}{e}{\tau}\\
%     \canaP{\Omega, \Ghyp{x}{\tau}}{\escenev}{\ce'}{e'}{\tau'}
%   }{
%     \canaPX{\aceletsyn{x}{\ce}{\ce'}}{\aeap{\aelam{\tau}{x}{e'}}{e}}{\tau'}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-analam}
%   \inferrule{
%     \canaP{\Gamma, \Ghyp{x}{\tau_1}}{\escenev}{\ce}{e}{\tau_2}
%   }{
%     \canaPX{\aceanalam{x}{\ue}}{\aelam{\tau_1}{x}{e}}{\aparr{\tau_1}{\tau_2}}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-clam}
%   \inferrule{
%     \cvalidKX{\cekappa}{\kappa}\\
%     \canaP{\Omega, u :: \kappa}{\escenev}{\ce}{e}{\tau}
%   }{
%     \canaPX{\aceclam{\cekappa}{u}{\ce}}{\aeclam{\kappa}{u}{e}}{\aallu{\kappa}{u}{\tau}}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-fold}
%   \inferrule{
%     \canaPX{\ce}{e}{[\arec{t}{\tau}/t]\tau}
%   }{
%     \canaPX{\aceanafold{\ce}}{\aefold{e}}{\arec{t}{\tau}}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-tpl}
%   \inferrule{
%     \ce=\acetpl{\labelset}{\mapschema{\ce}{i}{\labelset}}\\
%     e=\aetpl{\labelset}{\mapschema{e}{i}{\labelset}}\\\\
%     \{\canaPX{\ce_i}{e_i}{\tau_i}\}_{i \in \labelset}
%   }{
%     \canaPX{\ce}{e}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-in}
%   \inferrule{
%     \ce=\aceanain{\ell}{\ce'}\\
%     e=\aein{\labelset, \ell}{\ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}{e'}\\\\
%     \canaX{\ce'}{e'}{\tau}
%   }{
%     \canaPX{\ce}{e}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
%     %\left(\shortstack{$\Delta~\Gamma \vdash^{\escenev} $\\$\leadsto$\\$ \Leftarrow $\vspace{-1.2em}}\right)
%     %\eanaX{\auanain{\ell}{\ue}}{\aein{\ell}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-match}
%   \inferrule{
%     \csynPX{\ce}{e}{\tau}\\
%     \{\cranaPX{\crv_i}{r_i}{\tau}{\tau'}\}_{1 \leq i \leq n}
%   }{
%     \canaPX{\acematchwithb{n}{\ce}{\seqschemaX{\crv}}}{\aematchwith{n}{e}{\seqschemaX{r}}}{\tau'}
%   }
% \end{equation}
% \begin{equation}\label{rule:canaP-splicede}
% \inferrule{
%   \parseUExp{\bsubseq{b}{m}{n}}{\ue}\\
%   \eanaP{\uOmega}{\uPsi}{\uPhi}{\ue}{e}{\tau}\\\\
%   \uOmega=\uOmegaEx{\uD}{\uG}{\uMctx}{\Omega_\text{app}}\\
%   \domof{\Omega} \cap \domof{\Omega_\text{app}} = \emptyset
% }{
%   \canaP{\Omega}{\esceneP{\OParams}{\uOmega}{\uPsi}{\uPhi}{b}}{\acesplicede{m}{n}{\ctau}}{e}{\tau}
% }
% \end{equation}
% \end{subequations}

% Rules (\ref{rule:cana-subsume}) through (\ref{rule:cana-match}) are analagous to Rules (\ref{rule:eana-subsume}) through (\ref{rule:eana-match}). Rule (\ref{rule:cana-splicede}) governs references to spliced unexpanded expressions in analytic position. 

% \subsubsection{Bidirectional Candidate Expansion Rule Validation}
% The \emph{synthetic ce-rule validation judgement} is defined mutually inductively with Rules (\ref{rules:esyn}) by the following rule.
% \begin{equation}\label{rule:crsynP}
% \inferrule{
%   \patTypeP{\Omega'}{p}{\tau}\\
%   \csynP{\Gcons{\Omega}{\Omega'}}{\escenev}{\ce}{e}{\tau'}
% }{
%   \crsynPX{\acematchrule{p}{\ce}}{\aematchrule{p}{e}}{\tau}{\tau'}
% }
% \end{equation}

% The \emph{analytic ce-rule validation judgement} is defined mutually inductively with Rules (\ref{rules:eana}) by the following rule.
% \begin{equation}\label{rule:cranaP}
% \inferrule{
%   \patType{\Omega'}{p}{\tau}\\
%   \canaP{\Gcons{\Omega}{\Omega'}}{\escenev}{\ce}{e}{\tau'}
% }{
%   \cranaPX{\acematchrule{p}{\ce}}{\aematchrule{p}{e}}{\tau}{\tau'}
% }
% \end{equation}

% \subsubsection{Candidate Expansion Pattern Validation}
% The \emph{ce-pattern validation judgement} is inductively defined by the following rules, which are written identically to Rules (\ref{rules:cvalidP-UP}).
% \begin{subequations}\label{rules:cvalidP-P}
% \begin{equation}\label{rule:cvalidP-P-wild}
% \inferrule{ }{
%   \cvalidPP{\uOmegaEx{\emptyset}{\emptyset}{\emptyset}{\emptyset}}{\pscenev}{\acewildp}{\aewildp}{\tau}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidP-P-fold}
% \inferrule{
%   \cvalidPP{\uOmega}{\pscenev}{\cpv}{p}{[\arec{t}{\tau}/t]\tau}
% }{
%   \cvalidPP{\uOmega}{\pscenev}{\acefoldp{\cpv}}{\aefoldp{p}}{\arec{t}{\tau}}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidP-P-tpl}
% \inferrule{
%   \cpv=\acetplp{\labelset}{\mapschema{\cpv}{i}{\labelset}}\\
%   p=\aetplp{\labelset}{\mapschema{p}{i}{\labelset}}\\\\
%   \{\cvalidPP{\upctx_i}{\pscenev}{\cpv_i}{p_i}{\tau_i}\}_{i \in \labelset}
% }{
%   \cvalidPP{\Gconsi{i \in \labelset}{\uOmega_i}}{\pscenev}{\cpv}{p}{\aprod{\labelset}{\mapschema{\tau}{i}{\labelset}}}
%   %\cvalidPP{}{\cpv}{p}{}
% %\left(\shortstack{$\vdash^{\pscenev} $\\$\leadsto$\\$ :~\dashVx^{\,\Gconsi{i \in \labelset}{\upctx_i}}$\vspace{-1.2em}}\right)
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidP-P-in}
% \inferrule{
%   \cvalidPP{\uOmega}{\pscenev}{\cpv}{p}{\tau}
% }{
%   \cvalidPP{\uOmega}{\pscenev}{\aceinjp{\ell}{\cpv}}{\aeinjp{\ell}{p}}{\asum{\labelset, \ell}{\mapschema{\tau}{i}{\labelset}; \mapitem{\ell}{\tau}}}
% }
% \end{equation}
% \begin{equation}\label{rule:cvalidP-P-spliced}
% \inferrule{
%   \parseUPat{\bsubseq{b}{m}{n}}{\upv}\\
%   \patExpandsP{\uOmega'}{\uPhi}{\upv}{p}{\tau}
% }{
%   \cvalidPP{\uOmega'}{\pscene{\uOmega}{\uPhi}{b}}{\acesplicedp{m}{n}{\ctau}}{p}{\tau}
% }
% \end{equation}
% \end{subequations}

% Finally, the following theorem establishes that bidirectionally typed expression and rule expansion produces expanded expressions and rules of the appropriate type under the appropriate contexts. These statements must be stated mutually with the corresponding statements about birectional ce-expression and ce-rule validation because the judgements are mutually defined. 

% \begin{theorem}[Typed Expansion] Letting $\uPsi=\uASI{\uA}{\Psi}{\uI}$, if $\uetsmenv{\Delta}{\Psi}$ then all of the following hold:
% \begin{enumerate}
%   \item \begin{enumerate}
%     \item \begin{enumerate}
%       \item If $\esyn{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ then $\hastypeU{\Delta}{\Gamma}{e}{\tau}$.
%       \item If $\rsyn{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$  then $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$.
%     \end{enumerate}
%     \item \begin{enumerate}
%       \item If $\eana{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ and $\istypeU{\Delta}{\tau}$ then $\hastypeU{\Delta}{\Gamma}{e}{\tau}$.
%       \item If $\rana{\uDD{\uD}{\Delta}}{\uGG{\uG}{\Gamma}}{\uPsi}{\uPhi}{\urv}{r}{\tau}{\tau'}$ and $\istypeU{\Delta}{\tau'}$ then $\ruleType{\Delta}{\Gamma}{r}{\tau}{\tau'}$.
%     \end{enumerate}
%   \end{enumerate}
%   \item \begin{enumerate}
%     \item \begin{enumerate}
%       \item If $\csyn{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ then $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$. 
%       \item If $\crsyn{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\crv}{r}{\tau}{\tau'}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ then $\ruleType{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{r}{\tau}{\tau'}$.
%     \end{enumerate}
%     \item \begin{enumerate}
%       \item If $\cana{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ and $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau}$ then $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$. 
%       \item If $\crana{\Delta}{\Gamma}{\esceneUP{\uDD{\uD}{\Delta_\text{app}}}{\uGG{\uG}{\Gamma_\text{app}}}{\uPsi}{\uPhi}{b}}{\crv}{r}{\tau}{\tau'}$ and $\Delta \cap \Delta_\text{app}=\emptyset$ and $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ and $\istypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\tau'}$ then $\ruleType{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{r}{\tau}{\tau'}$.
%     \end{enumerate}
%   \end{enumerate}
% \end{enumerate}
% \end{theorem}
% \begin{proof} By mutual rule induction over Rules (\ref{rules:esyn}), Rules (\ref{rules:eana}), Rule (\ref{rule:rsyn}), Rule (\ref{rule:rana}), Rules (\ref{rules:csyn}), Rules (\ref{rules:cana}), Rule (\ref{rule:crsyn}) and Rule (\ref{rule:crana}). In the following, we refer to the induction hypothesis applied to the assumption $\uetsmenv{\Delta}{\Psi}$ as simply the ``IH''. When we apply the induction hypothesis to a different argument, we refer to it as the ``Outer IH''.

% \begin{enumerate}
%   \item In the following, let $\uDelta=\uDD{\uD}{\Delta}$ and $\uGamma=\uGG{\uG}{\Gamma}$. We have:
%   \begin{enumerate}
%     \item \begin{enumerate}
%       \item We induct on the assumption.
%         \begin{byCases}
%           \item[\text{(\ref{rule:esyn-var})}] We have:
%             \begin{pfsteps*}
%               \item $e=x$ \BY{assumption}
%               \item $\Gamma=\Gamma', \Ghyp{x}{\tau}$ \BY{assumption}
%               \item $\hastypeU{\Delta}{\Gamma', \Ghyp{x}{\tau}}{x}{\tau}$ \BY{Rule (\ref{rule:hastypeUP-var})}
%             \end{pfsteps*}
%             \resetpfcounter
%           \item[\text{(\ref{rule:esyn-asc})}] We have:
%             \begin{pfsteps*}
%                \item $\ue=\auasc{\utau}{\ue'}$ \BY{assumption}
%                \item $\expandsTU{\uDelta}{\utau}{\tau}$ \BY{assumption}\pflabel{expandsTU}
%                \item $\eanaX{\ue'}{e}{\tau}$ \BY{assumption}\pflabel{eanaX}
%                \item $\istypeU{\Delta}{\tau}$ \BY{Lemma \ref{lemma:type-expansion-U} on \pfref{expandsTU}}\pflabel{istype}
%                \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(b)(i) to \pfref{eanaX} and \pfref{istype}}
%              \end{pfsteps*}
%              \resetpfcounter
%           \item[\text{(\ref{rule:esyn-let}) through (\ref{rule:esyn-match})}] In each of these cases, we apply:
%             \begin{itemize}
%               \item Lemma \ref{lemma:type-expansion-U} to or over all type expansion premises.
%               \item The IH, part 1(a)(i) to or over all synthetic typed expression expansion premises.
%               \item The IH, part 1(a)(ii) to or over all synthetic rule expansion premises.
%               \item The IH, part 1(b)(i) to or over all analytic typed expression expansion premises.
%             \end{itemize}
%             We then derive the conclusion by applying Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}) as needed.
%           \item[\text{(\ref{rule:esyn-defuetsm})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\audefuetsm{\utau'}{\eparse}{\tsmv}{\ue'}$ \BY{assumption}
%               \item $\expandsTU{\uDelta}{\utau'}{\tau'}$ \BY{assumption} \pflabel{expandsTU}
%               \item $\hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}}$ \BY{assumption}\pflabel{eparse}
%               \item $\esyn{\uDelta}{\uGamma}{\uASI{\ctxUpdate{\uA}{\tsmv}{a}}{\Psi, \xuetsmbnd{a}{\tau'}{\eparse}}{\uI}}{\uPhi}{\ue'}{e}{\tau}$ \BY{assumption}\pflabel{expandsU}
%               \item $\uetsmenv{\Delta}{\Psi}$ \BY{assumption}\pflabel{uetsmenv1}
%               \item $\istypeU{\Delta}{\tau'}$ \BY{Lemma \ref{lemma:type-expansion-U} to \pfref{expandsTU}} \pflabel{istype}
%               \item $\uetsmenv{\Delta}{\Psi, \xuetsmbnd{\tsmv}{\tau'}{\eparse}}$ \BY{Definition \ref{def:ueTSM-def-ctx-formation-UP} on \pfref{uetsmenv1}, \pfref{istype} and \pfref{eparse}}\pflabel{uetsmenv3}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{Outer IH, part 1(a)(i) on \pfref{uetsmenv3} and \pfref{expandsU}}
%             \end{pfsteps*}
%             \resetpfcounter
%           \item[\text{(\ref{rule:esyn-apuetsm})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\autsmap{b}{\tsmv}$ \BY{assumption}
%               \item $\uPsi = \uASI{\ctxUpdate{\uA'}{\tsmv}{a}}{\Psi', \xuetsmbnd{a}{\tau}{\eparse}}{\uI}$ \BY{assumption}
%               \item $\encodeBody{b}{\ebody}$ \BY{assumption}
%               \item $\evalU{\eparse(\ebody)}{\inj{\lbltxt{Success}}{\ecand}}$ \BY{assumption}
%               \item $\decodeCondE{\ecand}{\ce}$ \BY{assumption}
%               \item $\cana{\emptyset}{\emptyset}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ \BY{assumption}\pflabel{cvalidE}
%               \item $\uetsmenv{\Delta}{\Psi}$ \BY{assumption} \pflabel{uetsmenv}
%               \item $\istypeU{\Delta}{\tau}$ \BY{Definition \ref{def:ueTSM-def-ctx-formation-UP} on \pfref{uetsmenv}} \pflabel{istype}
%               \item $\emptyset \cap \Delta = \emptyset$ \BY{finite set intersection identity} \pflabel{delta-cap}
%               \item ${\emptyset} \cap \domof{\Gamma} = \emptyset$ \BY{finite set intersection identity} \pflabel{gamma-cap}
%               \item $\hastypeU{\emptyset \cup \Delta}{\emptyset \cup \Gamma}{e}{\tau}$ \BY{IH, part 2(a)(i) on \pfref{cvalidE}, \pfref{delta-cap}, \pfref{gamma-cap} and \pfref{istype}} \pflabel{penultimate}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{definition of finite set and finite function union over \pfref{penultimate}}               
%              \end{pfsteps*} 
%              \resetpfcounter
%           \item[\text{(\ref{rule:esyn-implicite})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\auimplicite{\tsmv}{\ue}$ \BY{assumption}
%               \item $\uPsi=\uASI{\uA' \uplus \vExpands{\tsmv}{a}}{\Psi', \xuetsmbnd{a}{\tau'}{\eparse}}{\uI}$ \BY{assumption}
%               \item $\esyn{\uDelta}{\uGamma}{\uASI{\uA' \uplus \vExpands{\tsmv}{a}}{\Psi', \xuetsmbnd{a}{\tau'}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{\ue}{e}{\tau}$ \BY{assumption} \pflabel{esyn}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(a)(i) on \pfref{esyn}}
%             \end{pfsteps*}
%             \resetpfcounter
%           \item[\text{(\ref{rule:esyn-defuptsm})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\audefuptsm{\utau'}{\eparse}{\tsmv}{\ue'}$ \BY{assumption}
%               \item $\expandsTU{\uDelta}{\utau'}{\tau'}$ \BY{assumption} \pflabel{expandsTU}
%             %  \item \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}} \BY{assumption}\pflabel{eparse}
%               \item $\esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi, \uPhyp{\tsmv}{a}{\tau'}{\eparse}}{\ue'}{e}{\tau}$ \BY{assumption}\pflabel{expandsU}
%             %  \item \uetsmenv{\Delta}{\Psi} \BY{assumption}\pflabel{uetsmenv1}
%             %  \item \istypeU{\Delta}{\tau'} \BY{Lemma \ref{lemma:type-expansion-U} to \pfref{expandsTU}} \pflabel{istype}
%             %  \item \uetsmenv{\Delta}{\Psi, \xuetsmbnd{\tsmv}{\tau'}{\eparse}} \BY{Definition \ref{def:ueTSM-def-ctx-formation} on \pfref{uetsmenv1}, \pfref{istype} and \pfref{eparse}}\pflabel{uetsmenv3}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(a)(i) on \pfref{expandsU}}
%             \end{pfsteps*}
%             \resetpfcounter
%           \item[\text{(\ref{rule:esyn-implicitp})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\auimplicitp{\tsmv}{\ue}$ \BY{assumption}
%               \item $\uPhi=\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau'}{\eparse}}{\uI}$ \BY{assumption}
%               \item $\esyn{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau'}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau}$ \BY{assumption} \pflabel{esyn}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(a)(i) on \pfref{esyn}}
%             \end{pfsteps*}
%             \resetpfcounter
%         \end{byCases}
%       \item We induct on the assumption. There is one case.
%         \begin{byCases}
%           \item[\text{(\ref{rule:rsyn})}] We have:
%             \begin{pfsteps*}
%               \item $\urv=\aumatchrule{\upv}{\ue}$ \BY{assumption}
%               \item $r=\aematchrule{p}{e}$ \BY{assumption}
%               \item $\patExpands{\uGG{\uA'}{\pctx}}{\uPhi}{\upv}{p}{\tau}$ \BY{assumption} \pflabel{patExpands}
%               \item $\esyn{\uDelta}{\uGG{{\uA}\uplus{\uA'}}{\Gcons{\Gamma}{\pctx}}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}$ \BY{assumption} \pflabel{expandsUP}
%               \item $\patType{\pctx}{p}{\tau}$ \BY{Theorem \ref{thm:typed-pattern-expansion-B}, part 1 on \pfref{patExpands}}\pflabel{patType}
%               \item $\hastypeU{\Delta}{\Gcons{\Gamma}{\pctx}}{e}{\tau'}$ \BY{IH, part 1(a)(i) on \pfref{expandsUP}} \pflabel{hasType}
%               \item $\ruleType{\Delta}{\Gamma}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleType}) on \pfref{patType} and \pfref{hasType}}
%             \end{pfsteps*}
%             \resetpfcounter
%         \end{byCases}
%     \end{enumerate}
%     \item \begin{enumerate}
%       \item We induct on the assumption.
%         \begin{byCases}
%           \item[\text{(\ref{rule:eana-subsume})}] We have:
%             \begin{pfsteps*}
%               \item $\esynX{\ue}{e}{\tau}$ \BY{assumption} \pflabel{esyn}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(a)(i) on \pfref{esyn}}
%             \end{pfsteps*}
%           \item[\text{(\ref{rule:eana-let}) through (\ref{rule:eana-match})}] In each of these cases, we apply:
%             \begin{itemize}
%               \item Lemma \ref{lemma:type-expansion-U} to or over all type expansion premises.
%               \item The IH, part 1(a)(i) to or over all synthetic typed expression expansion premises.
%               \item The IH, part 1(a)(ii) to or over all synthetic rule expansion premises.
%               \item The IH, part 1(b)(i) to or over all analytic typed expression expansion premises.
%             \end{itemize}
%             We then derive the conclusion by applying Rules (\ref{rules:hastypeUP}) and Rule (\ref{rule:ruleType}) as needed. 
%           \item[\text{(\ref{rule:eana-defuetsm})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\audefuetsm{\utau'}{\eparse}{\tsmv}{\ue'}$ \BY{assumption}
%               \item $\expandsTU{\uDelta}{\utau'}{\tau'}$ \BY{assumption} \pflabel{expandsTU}
%               \item $,$ \BY{assumption}\pflabel{eparse}
%               \item $\eana{\uDelta}{\uGamma}{\uPsi, \uShyp{\tsmv}{a}{\tau'}{\eparse}}{\uPhi}{\ue'}{e}{\tau}$ \BY{assumption}\pflabel{expandsU}
%               \item $\uetsmenv{\Delta}{\Psi}$ \BY{assumption}\pflabel{uetsmenv1}
%               \item $\istypeU{\Delta}{\tau'}$ \BY{Lemma \ref{lemma:type-expansion-U} to \pfref{expandsTU}} \pflabel{istype}
%               \item $\uetsmenv{\Delta}{\Psi, \xuetsmbnd{\tsmv}{\tau'}{\eparse}}$ \BY{Definition \ref{def:ueTSM-def-ctx-formation-UP} on \pfref{uetsmenv1}, \pfref{istype} and \pfref{eparse}}\pflabel{uetsmenv3}
%             %  \item \uetsmenv{\Delta}{\Psi} \BY{assumption}\pflabel{uetsmenv1}
%             %  \item \istypeU{\Delta}{\tau'} \BY{Lemma \ref{lemma:type-expansion-U} to \pfref{expandsTU}} \pflabel{istype}
%             %  \item \uetsmenv{\Delta}{\Psi, \xuetsmbnd{\tsmv}{\tau'}{\eparse}} \BY{Definition \ref{def:ueTSM-def-ctx-formation} on \pfref{uetsmenv1}, \pfref{istype} and \pfref{eparse}}\pflabel{uetsmenv3}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(b)(i) on \pfref{expandsU}}
%             \end{pfsteps*}
%             \resetpfcounter
%           \item[\text{(\ref{rule:eana-implicite})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\autsmap{b}{\tsmv}$ \BY{assumption}
%               \item $\uPsi = \uPsi', \uShyp{\tsmv}{a}{\tau}{\eparse}$ \BY{assumption}
%               \item $\encodeBody{b}{\ebody}$ \BY{assumption}
%               \item $\evalU{\eparse(\ebody)}{\inj{\lbltxt{Success}}{\ecand}}$ \BY{assumption}
%               \item $\decodeCondE{\ecand}{\ce}$ \BY{assumption}
%               \item $\cana{\emptyset}{\emptyset}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}$ \BY{assumption}\pflabel{cvalidE}
%             %  \item \uetsmenv{\Delta}{\Psi} \BY{assumption} \pflabel{uetsmenv}
%               \item $\emptyset \cap \Delta = \emptyset$ \BY{finite set intersection identity} \pflabel{delta-cap}
%               \item ${\emptyset} \cap \domof{\Gamma} = \emptyset$ \BY{finite set intersection identity} \pflabel{gamma-cap}
%               \item $\hastypeU{\emptyset \cup \Delta}{\emptyset \cup \Gamma}{e}{\tau}$ \BY{IH, part 2(b)(i) on \pfref{cvalidE}, \pfref{delta-cap}, and \pfref{gamma-cap}} \pflabel{penultimate}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{definition of finite set union over \pfref{penultimate}}               
%              \end{pfsteps*} 
%              \resetpfcounter
%           \item[\text{(\ref{rule:eana-lit})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\auelit{b}$ \BY{assumption}
%               \item $\uPsi=\uASI{\uA}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}$ \BY{assumption}
%               \item $\encodeBody{b}{\ebody}$ \BY{assumption}
%               \item $\evalU{\ap{\eparse}{\ebody}}{\inj{\lbltxt{Success}}{\ecand}}$ \BY{assumption}
%               \item $\decodeCondE{\ecand}{\ce}$ \BY{assumption}
%               \item $\cana{\emptyset}{\emptyset}{\esceneUP{\uDelta}{\uGamma}{\uASI{\uA}{\Psi, \xuetsmbnd{a}{\tau}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\uPhi}{b}}{\ce}{e}{\tau}$ \BY{assumption} \pflabel{cvalidE}
%               \item $\emptyset \cap \Delta = \emptyset$ \BY{finite set intersection identity} \pflabel{delta-cap}
%               \item ${\emptyset} \cap \domof{\Gamma} = \emptyset$ \BY{finite set intersection identity} \pflabel{gamma-cap}
%               \item $\hastypeU{\emptyset \cup \Delta}{\emptyset \cup \Gamma}{e}{\tau}$ \BY{IH, part 2(a)(i) on \pfref{cvalidE}, \pfref{delta-cap}, and \pfref{gamma-cap}} \pflabel{penultimate}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{definition of finite set union over \pfref{penultimate}}
%             \end{pfsteps*}
%             \resetpfcounter
%           \item[\text{(\ref{rule:eana-defuptsm})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\audefuptsm{\utau'}{\eparse}{\tsmv}{\ue'}$ \BY{assumption}
%               \item $\expandsTU{\uDelta}{\utau'}{\tau'}$ \BY{assumption} \pflabel{expandsTU}
%             %  \item \hastypeU{\emptyset}{\emptyset}{\eparse}{\aparr{\tBody}{\tParseResultExp}} \BY{assumption}\pflabel{eparse}
%               \item $\eana{\uDelta}{\uGamma}{\uPsi}{\uPhi, \uPhyp{\tsmv}{a}{\tau'}{\eparse}}{\ue'}{e}{\tau}$ \BY{assumption}\pflabel{expandsU}
%             %  \item \uetsmenv{\Delta}{\Psi} \BY{assumption}\pflabel{uetsmenv1}
%             %  \item \istypeU{\Delta}{\tau'} \BY{Lemma \ref{lemma:type-expansion-U} to \pfref{expandsTU}} \pflabel{istype}
%             %  \item \uetsmenv{\Delta}{\Psi, \xuetsmbnd{\tsmv}{\tau'}{\eparse}} \BY{Definition \ref{def:ueTSM-def-ctx-formation} on \pfref{uetsmenv1}, \pfref{istype} and \pfref{eparse}}\pflabel{uetsmenv3}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(b)(i) on \pfref{expandsU}}
%             \end{pfsteps*}
%             \resetpfcounter
%           \item[\text{(\ref{rule:eana-implicitp})}] We have:
%             \begin{pfsteps*}
%               \item $\ue=\auimplicitp{\tsmv}{\ue}$ \BY{assumption}
%               \item $\uPhi=\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau'}{\eparse}}{\uI}$ \BY{assumption}
%               \item $\eana{\uDelta}{\uGamma}{\uPsi}{\uASI{\uA \uplus \vExpands{\tsmv}{a}}{\Phi, \xuptsmbnd{a}{\tau'}{\eparse}}{\uI \uplus \designate{\tau}{a}}}{\ue}{e}{\tau}$ \BY{assumption} \pflabel{esyn}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 1(b)(i) on \pfref{esyn}}
%             \end{pfsteps*}
%             \resetpfcounter
%         \end{byCases}
%       \item We induct on the assumption. There is one case.
%         \begin{byCases}
%           \item[\text{(\ref{rule:rana})}] We have:
%             \begin{pfsteps*}
%               \item $\urv=\aumatchrule{\upv}{\ue}$ \BY{assumption}
%               \item $r=\aematchrule{p}{e}$ \BY{assumption}
%               \item $\patExpands{\uGG{\uA'}{\pctx}}{\uPhi}{\upv}{p}{\tau}$ \BY{assumption} \pflabel{patExpands}
%               \item $\eana{\uDelta}{\uGG{{\uA}\uplus{\uA'}}{\Gcons{\Gamma}{\pctx}}}{\uPsi}{\uPhi}{\ue}{e}{\tau'}$ \BY{assumption} \pflabel{expandsUP}
%               \item $\patType{\pctx}{p}{\tau}$ \BY{Theorem \ref{thm:typed-pattern-expansion-B}, part 1 on \pfref{patExpands}}\pflabel{patType}
%               \item $\hastypeU{\Delta}{\Gcons{\Gamma}{\pctx}}{e}{\tau'}$ \BY{IH, part 1(b)(i) on \pfref{expandsUP}} \pflabel{hasType}
%               \item $\ruleType{\Delta}{\Gamma}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleType}) on \pfref{patType} and \pfref{hasType}}
%             \end{pfsteps*}
%             \resetpfcounter
%         \end{byCases}
%     \end{enumerate}
%   \end{enumerate}
%   \item In the following, let $\uDelta=\uDD{\uD}{\Delta_\text{app}}$ and $\uGamma=\uGG{\uG}{\Gamma_\text{app}}$ and $\escenev=\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}$.
%   \begin{enumerate}
%     \item \begin{enumerate}
%       \item We induct on the assumption.
%         \begin{byCases}
%           \item[\text{(\ref{rule:csyn-var})}] We have:
%             \begin{pfsteps*}
%               \item $e=x$ \BY{assumption}
%               \item $\Gamma=\Gamma', \Ghyp{x}{\tau}$ \BY{assumption}
%               \item $\hastypeU{\Delta}{\Gamma', \Ghyp{x}{\tau}}{x}{\tau}$ \BY{Rule (\ref{rule:hastypeUP-var})}
%             \end{pfsteps*}
%             \resetpfcounter 
%           \item[\text{(\ref{rule:csyn-asc})}] We have:
%             \begin{pfsteps*}
%                \item $\ce=\aceasc{\ctau}{\ce'}$ \BY{assumption}
%                \item $\Delta \cap \Delta_\text{app}=\emptyset$ \BY{assumption} \pflabel{delta-disjoint}
%                \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ \BY{assumption} \pflabel{gamma-disjoint}
%                \item $\cvalidT{\Delta}{\tsfrom{\escenev}}{\ctau}{\tau}$ \BY{assumption}\pflabel{expandsTU}
%                \item $\canaX{\ce'}{e}{\tau}$ \BY{assumption}\pflabel{eanaX}
%                \item $\istypeU{\Delta \cup \Delta_\text{app}}{\tau}$ \BY{Lemma \ref{lemma:candidate-expansion-type-validation} on \pfref{expandsTU}}\pflabel{istype}
%                \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 2(b)(i) to \pfref{eanaX}, \pfref{delta-disjoint}, \pfref{gamma-disjoint} and  \pfref{istype}}
%              \end{pfsteps*}
%              \resetpfcounter
%           \item[\text{(\ref{rule:csyn-let}) through (\ref{rule:csyn-match})}] In each of these cases, we apply:
%             \begin{itemize}
%               \item Lemma \ref{lemma:candidate-expansion-type-validation} to or over all ce-type validation premises.
%               \item The IH, part 2(a)(i) to or over all synthetic ce-expression validation premises.
%               \item The IH, part 2(a)(ii) to or over all synthetic ce-rule validation premises.
%               \item The IH, part 2(b)(i) to or over all analytic ce-expression validation premises.
%             \end{itemize}
%             We then derive the conclusion by applying Rules (\ref{rules:hastypeUP}), Rule (\ref{rule:ruleType}), Lemma \ref{lemma:weakening-UP},  the identification convention and exchange as needed.
%           \item[\text{(\ref{rule:csyn-splicede})}] We have:
%             \begin{pfsteps*}
%               \item $\ce=\acesplicede{m}{n}{\ctau}$ \BY{assumption}
%               \item $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$ \BY{assumption}
%               \item $\esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ \BY{assumption} \pflabel{expands}
%             %  \item $\uetsmenv{\Delta_\text{app}}{\Psi}$ \BY{assumption} \pflabel{uetsmenv}
%               \item $\Delta \cap \Delta_\text{app}=\emptyset$ \BY{assumption} \pflabel{delta-disjoint}
%               \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ \BY{assumption} \pflabel{gamma-disjoint}
%               \item $\hastypeU{\Delta_\text{app}}{\Gamma_\text{app}}{e}{\tau}$ \BY{IH, part 1(a)(i) on \pfref{expands}} \pflabel{hastype}
%               \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$ \BY{Lemma \ref{lemma:weakening-UP} over $\Delta$ and $\Gamma$ and exchange on \pfref{hastype}}
%             \end{pfsteps*}
%             \resetpfcounter
%         \end{byCases}
%       \item We induct on the assumption. There is one case.
%         \begin{byCases}
%           \item[\text{(\ref{rule:crsyn})}] We have:
%             \begin{pfsteps*}
%               \item $\crv=\acematchrule{p}{\ce}$ \BY{assumption}
%               \item $r=\aematchrule{p}{e}$ \BY{assumption}
%               \item $\patType{\pctx}{p}{\tau}$ \BY{assumption} \pflabel{patType}
%               \item $\csyn{\Delta}{\Gcons{\Gamma}{\pctx}}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau'}$ \BY{assumption} \pflabel{cvalidE}
%               \item $\Delta \cap \Delta_\text{app} = \emptyset$ \BY{assumption}\pflabel{delta-disjoint}
%               \item $\domof{\Gamma} \cap \domof{\pctx} = \emptyset$ \BY{identification convention}\pflabel{gamma-disjoint1}
%               \item $\domof{\Gamma_\text{app}} \cap \domof{\pctx} = \emptyset$ \BY{identification convention}\pflabel{gamma-disjoint2}
%               \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset$ \BY{assumption}\pflabel{gamma-disjoint3}
%               \item $\domof{\Gcons{\Gamma}{\pctx}} \cap \domof{\Gamma_\text{app}} = \emptyset$ \BY{standard finite set definitions and identities on \pfref{gamma-disjoint1}, \pfref{gamma-disjoint2} and \pfref{gamma-disjoint3}}\pflabel{gamma-disjoint4}
%               \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gcons{\Gamma}{\pctx}}{\Gamma_\text{app}}}{e}{\tau'}$ \BY{IH, part 2(a)(i) on \pfref{cvalidE}, \pfref{delta-disjoint} and \pfref{gamma-disjoint4}}\pflabel{hastype}
%               \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gcons{\Gamma}{\Gamma_\text{app}}}{\pctx}}{e}{\tau'}$ \BY{exchange of $\pctx$ and $\Gamma_\text{app}$ on \pfref{hastype}}\pflabel{hastype2}
%               \item $\ruleType{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleType}) on \pfref{patType} and \pfref{hastype2}}
%             \end{pfsteps*}
%             \resetpfcounter
%         \end{byCases}
%     \end{enumerate}
%     \item  \begin{enumerate}
%       \item We induct on the assumption.
%         \begin{byCases}
%           \item[\text{(\ref{rule:cana-subsume})}] We have:
%             \begin{pfsteps*}
%               \item $\csynX{\ce}{e}{\tau}$ \BY{assumption} \pflabel{esyn}
%               \item $\hastypeU{\Delta}{\Gamma}{e}{\tau}$ \BY{IH, part 2(a)(i) on \pfref{esyn}}
%             \end{pfsteps*}
%           \item[\text{(\ref{rule:cana-let}) through (\ref{rule:eana-match})}] In each of these cases, we apply:
%             \begin{itemize}
%               \item Lemma \ref{lemma:candidate-expansion-type-validation} to or over all ce-type validation premises.
%               \item The IH, part 2(a)(i) to or over all synthetic ce-expression validation premises.
%               \item The IH, part 2(a)(ii) to or over all synthetic ce-rule validation premises.
%               \item The IH, part 2(b)(i) to or over all analytic ce-expression validation premises.
%             \end{itemize}
%             We then derive the conclusion by applying Rules (\ref{rules:hastypeUP}), Rule (\ref{rule:ruleType}), Lemma \ref{lemma:weakening-UP},  the identification convention and exchange as needed.
%           \item[\text{(\ref{rule:cana-splicede})}] We have:
%             \begin{pfsteps*}
%               \item $\ce=\acesplicede{m}{n}{\ctau}$ \BY{assumption}
%               \item $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$ \BY{assumption}
%               \item $\eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ \BY{assumption} \pflabel{expands}
%               \item $\istypeU{\Delta \cup \Delta_\text{app}}{\tau}$ \BY{assumption} \pflabel{istype}
%             %  \item $\uetsmenv{\Delta_\text{app}}{\Psi}$ \BY{assumption} \pflabel{uetsmenv}
%               \item $\Delta \cap \Delta_\text{app}=\emptyset$ \BY{assumption} \pflabel{delta-disjoint}
%               \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}}=\emptyset$ \BY{assumption} \pflabel{gamma-disjoint}
%               \item $\hastypeU{\Delta_\text{app}}{\Gamma_\text{app}}{e}{\tau}$ \BY{IH, part 1(b)(i) on \pfref{expands}, \pfref{delta-disjoint}, \pfref{gamma-disjoint} and \pfref{istype}} \pflabel{hastype}
%               \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{e}{\tau}$ \BY{Lemma \ref{lemma:weakening-UP} over $\Delta$ and $\Gamma$ and exchange on \pfref{hastype}}
%             \end{pfsteps*}
%             \resetpfcounter
%         \end{byCases}
%       \item We induct on the assumption. There is one case.
%         \begin{byCases}
%           \item[\text{(\ref{rule:crana})}] We have:    
%             \begin{pfsteps*}
%                 \item $\crv=\acematchrule{p}{\ce}$ \BY{assumption}
%                 \item $r=\aematchrule{p}{e}$ \BY{assumption}
%                 \item $\patType{\pctx}{p}{\tau}$ \BY{assumption} \pflabel{patType}
%                 \item $\cana{\Delta}{\Gcons{\Gamma}{\pctx}}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau'}$ \BY{assumption} \pflabel{cvalidE}
%                 \item $\istypeU{\Delta \cup \Delta_\text{app}}{\tau'}$ \BY{assumption} \pflabel{istype}
%                 \item $\domof{\Gamma} \cap \domof{\Gamma_\text{app}} = \emptyset$ \BY{assumption}\pflabel{gamma-disjoint3}
%                 \item $\Delta \cap \Delta_\text{app} = \emptyset$ \BY{assumption}\pflabel{delta-disjoint}
%                 \item $\domof{\Gamma} \cap \domof{\pctx} = \emptyset$ \BY{identification convention}\pflabel{gamma-disjoint1}
%                 \item $\domof{\Gamma_\text{app}} \cap \domof{\pctx} = \emptyset$ \BY{identification convention}\pflabel{gamma-disjoint2}
%                 \item $\domof{\Gcons{\Gamma}{\pctx}} \cap \domof{\Gamma_\text{app}} = \emptyset$ \BY{standard finite set definitions and identities on \pfref{gamma-disjoint1}, \pfref{gamma-disjoint2} and \pfref{gamma-disjoint3}}\pflabel{gamma-disjoint4}
%                 \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gcons{\Gamma}{\pctx}}{\Gamma_\text{app}}}{e}{\tau'}$ \BY{IH, part 2(b)(i) on \pfref{cvalidE}, \pfref{delta-disjoint}, \pfref{gamma-disjoint4} and \pfref{istype}}\pflabel{hastype}
%                 \item $\hastypeU{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gcons{\Gamma}{\Gamma_\text{app}}}{\pctx}}{e}{\tau'}$ \BY{exchange of $\pctx$ and $\Gamma_\text{app}$ on \pfref{hastype}}\pflabel{hastype2}
%                 \item $\ruleType{\Dcons{\Delta}{\Delta_\text{app}}}{\Gcons{\Gamma}{\Gamma_\text{app}}}{\aematchrule{p}{e}}{\tau}{\tau'}$ \BY{Rule (\ref{rule:ruleType}) on \pfref{patType} and \pfref{hastype2}}
%               \end{pfsteps*}
%               \resetpfcounter

%         \end{byCases}
%     \end{enumerate}
%   \end{enumerate}
% \end{enumerate}

% We must now show that the induction is well-founded. All applications of the IH are on subterms except the following.  

% \begin{itemize}
% \item The only cases in the proof of part 1 that invoke the IH, part 2 are Case (\ref{rule:esyn-apuetsm}) in the proof of part 1(a)(i) and Case (\ref{rule:eana-lit}) in the proof of part 1(b)(i). The only cases in the proof of part 2 that invoke the IH, part 1 are Case (\ref{rule:csyn-splicede}) in the proof of part 2(a)(i) and Case (\ref{rule:cana-splicede}) in the proof of part 2(b)(i). We can show that the following metric on the judgements that we induct on is stable in one direction and strictly decreasing in the other direction:
% \begin{align*}
% \sizeof{\esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}} & = \sizeof{\ue}\\
% \sizeof{\eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}} & = \sizeof{\ue}\\
% \sizeof{\csyn{\Delta}{\Gamma}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}} & = \sizeof{b}\\
% \sizeof{\cana{\Delta}{\Gamma}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}} & = \sizeof{b}
% \end{align*}
% where $\sizeof{b}$ is the length of $b$ and $\sizeof{\ue}$ is the sum of the lengths of the ueTSM literal bodies in $\ue$,
% \begin{align*}
% \sizeof{\ux} & = 0\\
% \sizeof{\auasc{\utau}{\ue}} & = \sizeof{\ue}\\
% \sizeof{\auletsyn{\ux}{\ue}{\ue'}} & = \sizeof{\ue} + \sizeof{\ue'}\\
% \sizeof{\auanalam{\ux}{\ue}} & = \sizeof{\ue}\\
% \sizeof{\aulam{\utau}{\ux}{\ue}} &= \sizeof{\ue}\\
% \sizeof{\auap{\ue_1}{\ue_2}} & = \sizeof{\ue_1} + \sizeof{\ue_2}\\
% \sizeof{\autlam{\ut}{\ue}} & = \sizeof{\ue}\\
% \sizeof{\autap{\ue}{\utau}} & = \sizeof{\ue}\\
% \sizeof{\auanafold{\ue}} & = \sizeof{\ue}\\
% \sizeof{\auunfold{\ue}} & = \sizeof{\ue}\\
% %\end{align*}
% %\begin{align*}
% \sizeof{\autpl{\labelset}{\mapschema{\ue}{i}{\labelset}}} & = \sum_{i \in \labelset} \sizeof{\ue_i}\\
% \sizeof{\aupr{\ell}{\ue}} & = \sizeof{\ue}\\
% \sizeof{\auanain{\ell}{\ue}} & = \sizeof{\ue}\\
% %\sizeof{\aucase{\labelset}{\utau}{\ue}{\mapschemab{\ux}{\ue}{i}{\labelset}}} & = \sizeof{\ue} + \sum_{i \in \labelset} \sizeof{\ue_i}\\
% \sizeof{\aumatchwithb{n}{\ue}{\seqschemaX{\urv}}} & = \sizeof{\ue} + \sum_{1 \leq i \leq n} \sizeof{r_i}\\
% \sizeof{\audefuetsm{\utau}{\eparse}{\tsmv}{\ue}} & = \sizeof{\ue}\\
% \sizeof{\auimplicite{\tsmv}{\ue}} & = \sizeof{\ue}\\
% \sizeof{\autsmap{b}{\tsmv}} & = \sizeof{b}\\
% \sizeof{\auelit{b}} & = \sizeof{b}\\
% \sizeof{\audefuptsm{\utau}{\eparse}{\tsmv}{\ue}} & = \sizeof{\ue}\\
% \sizeof{\auimplicitp{\tsmv}{\ue}} & = \sizeof{\ue}
% \end{align*}
% and $\sizeof{r}$ is defined as follows:
% \begin{align*}
% \sizeof{\aumatchrule{\upv}{\ue}} & = \sizeof{\ue}
% \end{align*}

% Going from part 1 to part 2, the metric remains stable:
% \begin{align*}
%  & \sizeof{\esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\autsmap{b}{\tsmv}}{e}{\tau}}\\
% =& \sizeof{\eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\auelit{b}}{e}{\tau}}\\
% =& \sizeof{\cana{\emptyset}{\emptyset}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\ce}{e}{\tau}}\\
% =&\sizeof{b}\end{align*}

% Going from part 2 to part 1, in each case we have that $\parseUExp{\bsubseq{b}{m}{n}}{\ue}$ and the IH is applied to the judgements $\esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$ and $\eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}$, respectively. Because the metric is stable when passing from part 1 to part 2, we must have that it is strictly decreasing in the other direction:
% \[\sizeof{\esyn{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}} < \sizeof{\csyn{\Delta}{\Gamma}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\acesplicede{m}{n}{\ctau}}{e}{\tau}}\]
% and
% \[\sizeof{\eana{\uDelta}{\uGamma}{\uPsi}{\uPhi}{\ue}{e}{\tau}} < \sizeof{\cana{\Delta}{\Gamma}{\esceneUP{\uDelta}{\uGamma}{\uPsi}{\uPhi}{b}}{\acesplicede{m}{n}{\ctau}}{e}{\tau}}\]
% i.e. by the definitions above, 
% \[\sizeof{\ue} < \sizeof{b}\]

% This is established by appeal to Condition \ref{condition:body-subsequences}, which states that subsequences of $b$ are no longer than $b$, and the following condition, which states that an unexpanded expression constructed by parsing a textual sequence $b$ is strictly smaller, as measured by the metric defined above, than the length of $b$, because some characters must necessarily be used to delimit each literal body.
% \begin{condition}[Expression Parsing Monotonicity]\label{condition:body-parsing-B} If $\parseUExp{b}{\ue}$ then $\sizeof{\ue} < \sizeof{b}$.\end{condition}

% Combining Conditions \ref{condition:body-subsequences} and \ref{condition:body-parsing-B}, we have that $\sizeof{\ue} < \sizeof{b}$ as needed.
% \item In Case (\ref{rule:eana-subsume}) of the proof of part 1(b)(i), we apply the IH, part 1(a)(i), with $\ue=\ue$. This is well-founded because all applications of the IH, part 1(b)(i) elsewhere in the proof are on strictly smaller terms.
% \item Similarly, in Case (\ref{rule:cana-subsume}) of the proof of part 2(b)(i), we apply the IH, part 2(a)(i), with $\ce=\ce$. This is well-founded because all applications of the IH, part 2(b)(i) elsewhere in the proof are on strictly smaller terms.
% \end{itemize}
% \end{proof} 

